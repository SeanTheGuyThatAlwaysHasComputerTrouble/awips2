C MEMBER COX13
C  (from old member FCCOX13)
C
      SUBROUTINE COX13(POLD,COLD,PNEW,CNEW)
C
C     THIS IS THE CARRYOVER TRANSFER SUBROUTINE FOR THE
C     TATUM COEFFICIENT ROUTING
C
C      THIS SUBROUTINE INITIALLY WRITTEN BY
C           DAVID B. REED- HRL    DEC 1979
C
C
      DIMENSION POLD(1),COLD(1),PNEW(1),CNEW(1)
C
C     COMMON BLOCKS
C
      INCLUDE 'common/fdbug'
      INCLUDE 'common/ionum'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcinit_cox/RCS/cox13.f,v $
     . $',                                                             '
     .$Id: cox13.f,v 1.1 1995/09/17 18:47:10 dws Exp $
     . $' /
C    ===================================================================
C
C
C     CHECK TRACE LEVEL - FOR THIS SUBROUTINE =1
C
      IF(ITRACE.GE.1)WRITE(IODBUG,900)
  900 FORMAT(1H0,16H** COX13 ENTERED)
C
C     CHECK TO SEE IF DEBUG OUTPUT IS NEEDED
C
      IBUG=0
      IF(IDBALL.GT.0)IBUG=1
      IF(NDEBUG.EQ.0) GO TO 12
      DO 10 I=1,NDEBUG
      IF(IDEBUG(I).EQ.13)GO TO 11
   10 CONTINUE
      GO TO 12
   11 IBUG=1
   12 NLOLD=POLD(16)
      NLNEW=PNEW(16)
      NQNST=17+NLNEW
      NQOST=17+NLOLD
      NLNM1=NLNEW-1
      NLOM1=NLOLD-1
      NLNM2=NLNEW-2
C     WRITE(6,9999) NLOLD,NLNEW,NQOST,NQNST,NLOM1,NLNM1,NLNM2
C9999 FORMAT(//' NLOLD NLNEW NQOST NQNST NLOM1 NLNM1 NLNM2'/
C    17I6)
      NCOLD=0
      NCNEW=0
      DO 20 I=1,NLOLD
   20 NCOLD=NCOLD+POLD(16+I)
      DO 21 I=1,NLNEW
   21 NCNEW=NCNEW+PNEW(16+I)
      NCOST=NQOST+NLOM1
      NCNST=NQNST+NLNM1
      NCARN=NCNEW-NLNEW
      NCARO=NCOLD-NLOLD
C     WRITE(6,9998) NCOLD,NCNEW,NCOST,NCNST,NCARO,NCARN
C9998 FORMAT(// 'NCOLD NCNEW NCOST NCNST NCARO NCARN'/6I6)
      DO 22 I=1,NCARN
   22 CNEW(I)=0.
C
C     CHECK FOR DEBUG OUTPUT
C
      IF(IBUG.EQ.0)GO TO 100
      WRITE(IODBUG,901)
  901 FORMAT(1H0,10X,20HOLD CARRYOVER VALUES)
      WRITE(IODBUG,902)(COLD(I),I=1,NCARO)
  902 FORMAT(1H0,14F8.3)
C
C     CHECK TO SEE IF LAYERS ARE THE SAME
C
  100 IDT1=POLD(10)
      IDT2=PNEW(10)
C
      IF(NLOLD.NE.NLNEW)GO TO 200
C
C     CHECK TO SEE IF NUMBER OF COEFFICIENTS PER LAYER IS THE SAME
C
      IERFLG=0
      DO 101 I=1,NLOLD
      NCLN=PNEW(16+I)
      NCLO=POLD(16+I)
  101 IF(NCLN.NE.NCLO)IERFLG=1
C     WRITE(6,9997) IDT1,IDT2,NCLO,NCLN,IERFLG
C9997 FORMAT(//' IDT1 IDT2 NCLO NCLN IERFLG'/5I5)
      IF(IERFLG.EQ.1)GO TO 200
      IF(IDT1.NE.IDT2)GO TO 200
C
C     CHECK TO SEE IF MAXIMUM LIMITS OF FLOW FOR EACH LAYER ARE THE SAME
C
      IERFLG=0
      IF(NLNM1.EQ.0) GO TO 104
      DO 102 I=1,NLNM1
      DIFF=ABS(POLD(NQNST+I-1)-PNEW(NQNST+I-1))
  102 IF(DIFF.GT.0.001)IERFLG=1
      IF(IERFLG.EQ.1)GO TO 200
C
C     SET NEW CARRYOVER EQUAL TO OLD
C
  104 DO 103 I=1,NCARO
  103 CNEW(I)=COLD(I)
      GO TO 998
  200 MAX=POLD(17)
C
C     DETERMINE MINIMUM NUMBER OF COEFFICIENTS FOR OLD CARRYOVER
C
      IF(NLOLD.EQ.1)GO TO 210
      DO 201 I=1,NLOM1
      IF(MAX.LT.IFIX(POLD(17+I)))MAX=POLD(17+I)
  201 CONTINUE
  210 MAX=MAX-1
C
      IF(MAX.EQ.0)GO TO 999
C
C     DETERMINE PREVIOUS FLOW AND PLACE IN NEW CARRYOVER ARRAY
C
      DO 220 I=1,MAX
      IF(IDT1.NE.IDT2)GO TO 202
      I1=I
      GO TO 203
  202 IRATIO=IDT1*I/IDT2
      IF((IRATIO*IDT2).EQ.(IDT1*I))GO TO 205
      GO TO 220
  205 I1=IRATIO
  203 CONTINUE
      FLOW=0.
      IPTR=1
      JPOLD = POLD(17)-1.
      IF(I.GT.JPOLD)GO TO 221
      DIFF=ABS(POLD(NQOST)-COLD(I))
      IF(DIFF.GT.0.001)GO TO 222
      FLOW=POLD(NQOST)
      GO TO 221
  222 FLOW=COLD(I)
      GO TO 242
  221 DO 223 J=2,NLOLD
      NCLAYR=POLD(16+J)
      IF(I.GE.NCLAYR)GO TO 223
      JM1=J-1
      IPTR=0
      DO 225 JK=1,JM1
  225 IPTR=IPTR+POLD(16+JK)-1
      IPTR=IPTR+I
      IF(COLD(IPTR).LT.0.001)GO TO 223
      FLOW=POLD(NQOST+J-2)+COLD(IPTR)
  223 CONTINUE
  242 IPTR=I1
C     WRITE(6,9996) I1,PNEW(17),FLOW,PNEW(NQNST)
C9996 FORMAT(/'  I1 NCLN      FLOW         Q'/I5,F5.0,2F10.3)
      DO 294 J=1,NLNEW
      NCLO=POLD(16+J)
      NCLN=PNEW(16+J)
      IF(J.GT.1)IPTR=IPTR+PNEW(16+J-1)-1
C     WRITE(6,9995) NCLN,I1,IPTR
C9995 FORMAT('      NCLN   I1 IPTR'/5X,3I5)
      IF(NCLN.LE.I1)GO TO 294
      IF(J.GT.1) GO TO 291
      IF(NLNEW.EQ.1) CNEW(IPTR)=FLOW
      IF(NLNEW.EQ.1) GO TO 293
      IF((FLOW.LT.PNEW(NQNST)))CNEW(IPTR)=FLOW
      IF((FLOW.GE.PNEW(NQNST)))CNEW(IPTR)=PNEW(NQNST)
      GO TO 293
  291 IF((J.EQ.NLNEW).AND.(FLOW.GT.PNEW(NQNST+NLNM2)))CNEW(IPTR)=FLOW-
     1PNEW(NQNST+NLNM2)
      IF((J.EQ.NLNEW).AND.(FLOW.LE.PNEW(NQNST+NLNM2)))CNEW(IPTR)=0.
      IF(J.EQ.NLNEW)GO TO 293
      IF(PNEW(NQNST+J-2).GT.FLOW)CNEW(IPTR)=0.
      IF((PNEW(NQNST+J-2).LE.FLOW).AND.(PNEW(NQNST+J-1).GT.FLOW))
     1CNEW(IPTR)=FLOW-PNEW(NQNST+J-2)
      IF(PNEW(NQNST+J-1).LE.FLOW)CNEW(IPTR)=PNEW(NQNST+J-1)-PNEW(NQNST+J
     1-2)
C 293 WRITE(6,9994) IPTR,CNEW(IPTR),CNEW(IPTR-1),FLOW
C9994 FORMAT(/' IPTR   CNEWNEW   CNEWOLD      FLOW'/I5,3F10.3)
C     IF(ABS(CNEW(IPTR)).LT.0.0001.AND.IPTR.GT.1)CNEW(IPTR)=CNEW(IPTR-1)
  293 CONTINUE
      IF(I.LT.MAX) GO TO 294
      IF(I1.EQ.I) GOTO 295
      IF(I1.GE.NCLN) GO TO 295
      NX1=I1+1
      DO 296 JK=NX1,NCLN
      IPTR=IPTR+1
      CNEW(IPTR)=CNEW(IPTR-1)
  296 CONTINUE
  295 IF(NCLN.LE.NCLO) GO TO 294
      NX1=NCLO+1
      DO 292 JK=NX1,NCLN
      IPTR=IPTR+1
      CNEW(IPTR)=CNEW(IPTR-1)
  292 CONTINUE
  294 CONTINUE
      IF(IDT2.GE.IDT1)GO TO 220
      NDTS=IDT1/IDT2
      IF(I.GT.1)GO TO 230
      FLOWPR=FLOW
  230 SLOPE=-(FLOWPR-FLOW)/FLOAT(NDTS)
      NDTSM=NDTS-1
      I1STRT=I1-NDTS
      DO 232 JK=1,NDTSM
      I1ST=I1STRT+JK
      FLOWP=FLOWPR+SLOPE*FLOAT(JK)
      IP=((I-1)*IDT1)/IDT2+JK
      IPTR=IP
      DO 303 J=1,NLNEW
      NCLN=PNEW(16+J)
      IF(J.GT.1)IPTR=IPTR+PNEW(16+J-1)-1
      IF(NCLN.LE.I1ST)GO TO 303
      IF(J.GT.1) GO TO 304
      IF(NLNEW.EQ.1) CNEW(IPTR)=FLOWP
      IF(NLNEW.EQ.1) GO TO 303
      IF(FLOWP.LT.PNEW(NQNST))CNEW(IPTR)=FLOWP
      IF(FLOWP.GE.PNEW(NQNST))CNEW(IPTR)=PNEW(NQNST)
      GO TO 303
  304 IF((J.EQ.NLNEW).AND.(FLOWP.GT.PNEW(NQNST+NLNM2)))CNEW(IPTR)=FLOWP-
     1PNEW(NQNST+NLNM2)
      IF((J.EQ.NLNEW).AND.(FLOWP.LE.PNEW(NQNST+NLNM2)))CNEW(IPTR)=0.
      IF(J.EQ.NLNEW)GO TO 303
      IF(PNEW(NQNST+J-2).GT.FLOWP)CNEW(IPTR)=0.
      IF((PNEW(NQNST+J-2).LE.FLOWP).AND.(PNEW(NQNST+J-1).GT.FLOWP))
     1CNEW(IPTR)=FLOWP-PNEW(NQNST+J-2)
      IF(PNEW(NQNST+J-1).LE.FLOWP)CNEW(IPTR)=PNEW(NQNST+J-1)-PNEW(NQNST+
     1J-2)
  303 CONTINUE
  232 CONTINUE
      FLOWPR=FLOW
  220 CONTINUE
C
C     CHECK FOR DEBUG OUTPUT
C
  998 IF(IBUG.EQ.0)GO TO 999
      WRITE(IODBUG,903)
  903 FORMAT(1H0,15X,20HNEW CARRYOVER VALUES)
      WRITE(IODBUG,902)(CNEW(I),I=1,NCARN)
  999 RETURN
C     DEBUG SUBTRACE,SUBCHK,INIT
      END
