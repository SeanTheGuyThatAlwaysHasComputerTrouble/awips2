C MEMBER STAT21
C  (from old member FCSTAT21)
C DESC -- THIS SUBROUTINE DETERMINES THE STATISTICS ASSOCIATED WITH THE
C DESC -- COMPUTED VS OBSERVED HYDROGRAPHS
C                             LAST UPDATE: 03/04/94.17:59:57 BY $WC30JL
C
C @PROCESS LVL(77)
C
      SUBROUTINE STAT21(PO,NRT1,STT,LOSTT,STC,LOSTC,QTC,LOQTC,STTNAM,NT,
     1 TII,T1,ISTRT,INOW,ST0,QT0,YDI,QDI,NB,GZ,LOSTE,STE,IRF,FRMS,
     2 FBIAS,RRMS,RBIAS)
C
C           THIS SUBROUTINE WAS WRITTEN ORIGINALLY BY:
C           DR. DANNY FREAD   HRL   APRIL 1978
C
C           THIS SUBROUTINE WAS MODIFIED TO MEET VER. NO. 5 STANDARDS
C           OF THE NWSRFS BY:
C           JANICE LEWIS      HRL   NOVEMBER,1982     VERSION NO. 1
C               MODIFIED BY JML  NOV 1997   VERSION NO. 2
C                   ADD OPTION TO BLEND COM & OBS STAGES
C
      COMMON/FDBUG/IODBUG,ITRACE,IDBALL,NDEBUG,IDEBUG(20)
      COMMON/IONUM/IN,IPR,IPU
      COMMON/FNOPR/NOPROT
      COMMON/OZ21/LONQSL,LOSLIC,LOFRMO,LOFBIO,LORRMO,LORBIO
      COMMON/M121/N,NU,NS1,JN,JJ,KIT,G,DT,TT,TIMF,F1,GZN,NYQD
      COMMON/M621/KTIME,DHF,J1,KX
      COMMON/M3221/KTERM,KPL,KPL2,JNK,TE,TM,KITPR
      COMMON/KTT21/IPLT,TMPR
      COMMON/NSLC21/NSLICE
C
      DIMENSION PO(*),NRT1(*),STT(*),LOSTT(*),STC(*),LOSTC(*)
      DIMENSION QTC(*),LOQTC(*),STTNAM(3,*),NT(*),TII(*),T1(*),SNAME(2)
      DIMENSION ST0(*),QT0(*),YDI(*),QDI(*),NB(*),GZ(*),STE(*),LOSTE(*)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_dwoper/RCS/stat21.f,v $
     . $',                                                             '
     .$Id: stat21.f,v 1.5 1998/07/06 11:54:01 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SNAME/4HSTAT,4H21  /
C
C
      CALL FPRBUG(SNAME,1,21,IBUG)
C
      INO=1
      INC=1
C     WRITE(6,999) TMPR,DHF
C 999 FORMAT(2X,'TMPR=',F5.1,3X,'DHF=',F5.1)
      IF(DHF.LT.TMPR) INO=TMPR/DHF+0.50
      IF(DHF.GT.TMPR) INC=DHF/TMPR+0.50
      NPT=NU/INO+1
      LSLC=0

      DO 2000 J=1,JN
      NRT=NRT1(J)
      IF(NRT) 2000,2000,1920
 1920 IF (KPL2) 2000,2000,1930
 1930 LKJ=LCAT21(1,J,NRT1)-1
      IJ=LCAT21(1,J,NB)-1

      DO 1990 KK=1,NRT
      NTT=NT(KK+LKJ)
      GZERO=GZ(KK+LKJ)
      MISS=0
      IF(NOPROT.EQ.0) WRITE(IPR,2140) J,NTT,(STTNAM(KJ,KK+LKJ), KJ=1,2)
      LOSC=LOSTC(KK+LKJ)-1
      LOST=LOSTT(KK+LKJ)-1
      IF(KPL2.GT.1) LOSE=LOSTE(KK+LKJ)-1
      LOQC=LOQTC(KK+LKJ)-1

      IF(KPL2.EQ.1) GO TO 20
      IF(KK.EQ.NRT.AND.NTT.EQ.NB(J).AND.J.EQ.1) GO TO 15

      CALL ADJTS21(KK+LKJ,J,PO(LONQSL),PO(LOSLIC+LSLC),PO(LOFRMO+LSLC),
     .  PO(LOFBIO+LSLC),PO(LORRMO+LSLC),PO(LORBIO+LSLC),STE(LOSE+1),IRF,
     .  FRMS,FBIAS,RRMS,RBIAS,STC(LOSC+1),QTC(LOQC+1),STT(LOST+1),KTIME,
     .  JNK)

 15   LSLC=LSLC+NSLICE

   20 SDHO=0.
      SDHOE=0.
      SD=0.0
      SDE=0.

CC      K=0
CC 1940 K=K+1
CC      IF(K.GT.KTIME) GO TO 1990
CC      IF(STT(K+KK+LKJ-1).LT.-900.0) GO TO 1940

      IF(KPL.EQ.2) GO TO 1941
      STMIN=ST0(KK+LKJ)
      STMN=ST0(KK+LKJ)
      STTM=YDI(NTT+IJ)
      GO TO 1943
 1941 STMIN=QT0(KK+LKJ)
      STMN = QT0(KK+LKJ)
      STTMN = QDI(NTT+IJ)
 1943 KTTTT = 0
      IT1=1
cew additions from RTI
c  index is changed to begin at 2 instead of 1 because at k=1 (TT=0)
c  no observed data are available.  Three IF if statements in the
c  vicinity of 1945 and 1950 have been changed to test for K=2
c  instead of k=1
      DO 1970 K=2,NPT
      KO=INO*(K-1)
      KC=INC*(K-1)
cew not used
cew      IF(K.EQ.1) GO TO 1946
      T=T1(KO)
      IF(IPLT.EQ.1) GO TO 1942
      IF(KPL2.GT.1) SE=TERP21(T,KTIME,IT1,IT2,TII,STE,LOSE)
      SC=TERP21(T,KTIME,IT1,IT2,TII,STC,LOSC)
      QC=TERP21(T,KTIME,IT1,IT2,TII,QTC,LOQC)
      GO TO 1944
 1942 IF(KPL2.GT.1) SE=STE(KC+LOSE)
      SC=STC(KC+LOSC)
      QC=QTC(KC+LOQC)
 1944 ST=STT(KO+LOST)
      IF(KPL.EQ.2) ST=ST*0.001
      GO TO 1948
cew not used
cew 1946 T=0.
cew      SC=ST0(KK+LKJ)
cew      QC=QT0(KK+LKJ)
cew      ST=YDI(NTT+IJ)
cew      IF(KPL.EQ.2) ST=QDI(NTT+IJ)*0.001
 1948 NHRS = ISTRT+(K-1)*DHF
      IF (NHRS.GT.INOW) GO TO 1970
C
C         CHECK FOR MISSING DATA POINT AND SKIP IF IT IS
C
      IK=IFMSNG(ST)
      IF(IK.EQ.1) THEN
        DHO=-999.
        DHOE=-999.
        DHC=SC-SE
        MISS=MISS+1
        GO TO 1940
      ENDIF
C
      KTTTT = KTTTT + 1
      IF(KPL.NE.2) THEN
        DHO=SC-ST
        DHC=SE-ST
      ELSE
        DHO=QC-ST
        DHC=QC-SE
      ENDIF
      DHOE=SE-ST
      SDHO=SDHO+DHO*DHO
      SDHOE=SDHOE+DHOE*DHOE
      SD=SD+DHO
      SDE=SDE+DHOE
      IF (KPL.NE.2.AND.SC.GT.STMIN) STMIN = SC
      IF (KPL.EQ.2.AND.QC.GT.STMIN) STMIN = QC
      IF (ST.GT.STTM) STTM = ST
      IF (KPL.NE.2.AND.SC.LT.STMIN) STMN = SC
      IF (KPL.EQ.2.AND.QC.LT.STMIN) STMN = QC
      IF (ST.LT.STTMN) STTMN = ST
cew changed if statement
 1940 IF(JNK.GE.1.AND.NOPROT.EQ.0) THEN
      IF(KPL2.EQ.1.OR.(KK.EQ.NRT.AND.NTT.EQ.NB(J).AND.J.EQ.1)) THEN
          IF(KPL.EQ.3.AND.K.EQ.2) WRITE(IPR,1945)
 1945     FORMAT (31X,4HTIME,10X,14HOBSERVED STAGE,6X,14HCOMPUTED STAGE,
     2      9X,11HCOMP - OBS ,8X,9HDISCHARGE/39X,
     3      2(11X,4H(FT),5X),12X,4H(FT),12X,10H(1000 CFS))
cew changed if statement
          IF(KPL.LT.2.AND.K.EQ.2) WRITE(IPR,1950)
 1950     FORMAT(31X,4HTIME,8X,18HOBSERVED ELEVATION,2X,
     2      18HCOMPUTED ELEVATION,7X,11HCOMP - OBS ,8X,9HDISCHARGE/39X,
     3      2(6X,14H(FT ABOVE MSL)),12X,4H(FT),12X,10H(1000 CFS))
cew changed if statement
          IF(KPL.EQ.2.AND.K.EQ.2) WRITE(IPR,1955)
 1955     FORMAT (31X,4HTIME,11X,18HOBSERVED DISCHARGE,2X,
     2      18HCOMPUTED DISCHARGE,3X,11HCOMP - OBS ,9X,9HELEVATION/40X,
     3      2(10X,10H(1000 CFS)),7X,10H(1000 CFS),8X,14H(FT ABOVE MSL))
        ELSE
          IF(KPL.EQ.3.AND.K.EQ.2)  WRITE(IPR,1951)
 1951     FORMAT (/6X,'TIME',19X,'STAGE (FT)',20X,'DIFFERENCE (FT)'/
     .      14X,'OBSERVED',4X,'COMPUTED',3X,'ESTIMATED',5X,'COM-OBS'5X,
     .      'EST-OBS',5X,'COM-EST',9X,'FLOW(CFS)')
          IF(KPL.LT.2.AND.K.EQ.2) WRITE(IPR,1952)
 1952     FORMAT (/6X,'TIME',11X,'ELEVATION (FT-MSL)',20X,
     .    'DIFFERENCE (FT)'/14X,'OBSERVED',4X,'COMPUTED',3X,'ESTIMATED'
     .    ,5X,'COM-OBS'5X,'EST-OBS',5X,'COM-EST',9X,'FLOW(CFS)')
          IF(KPL.EQ.2.AND.K.EQ.2) WRITE(IPR,1956)
 1956     FORMAT(/6X,'TIME',10X,'DISCHARGE(1000 CFS)',12X,
     .    'DIFFERENCE(CFS)'14X,'OBSERVED'4X,'COMPUTED',3X,'ESTIMATED',
     .    5X,'COM-OBS',5X,'EST-OBS',5X,'COM-EST',7X,'WSEL(FT-MSL)')
        ENDIF
      ENDIF
 1960 IF(JNK) 1970,1970,1965
 1965 IF(KPL.EQ.3) THEN
        SC=SC-GZERO
        ST=ST-GZERO
        SE=SE-GZERO
      ENDIF
      IF(NOPROT.EQ.0) THEN
        IF(KPL2.EQ.1) THEN
          IF(KPL.NE.2) WRITE(IPR,2100) KO,ST,SC,DHO,QC
          IF(KPL.EQ.2) WRITE(IPR,2100) KO,ST,QC,DHO,SC
        ELSE
          IF(KPL.NE.2) WRITE(IPR,2110) KO,ST,SC,SE,DHO,DHOE,DHC,QC
          IF(KPL.EQ.2) WRITE(IPR,2120) KO,ST,QC,SE,DHO,DHOE,DHC,SC
        ENDIF
      ENDIF
 1970 CONTINUE
 1975 STTD = STTM-STTMN
      PE = 0.0
      IF(STTD.GT.0.0) PE = (STMIN-STTM)*100.0/STTD
      PEA=STMIN-STTM
      IF(STTM.EQ.0.0) STTM=0.1
      IF(KTTTT.EQ.0) THEN
        SE=-999.
        SEA=-999.
        SEAN=-999.
        AVD=-999.
        AVDN=-999.
      ELSE
        SE = SQRT(SDHO/(KTTTT*STTM*STTM))*100.
        SEA = SQRT(SDHO/KTTTT)
        AVD = SD/KTTTT
        SEAN = SQRT(SDHOE/KTTTT)
        AVDN = SDE/KTTTT
      ENDIF
      IF(NOPROT.EQ.0.AND.MISS.EQ.0) WRITE(IPR,1980) SEA,AVD
 1980 FORMAT(12X,13H RMS ERROR = ,F8.3,8H BIAS = ,F8.3)
      IF(NOPROT.EQ.0.AND.MISS.GT.0) WRITE(IPR,1985) SEA,AVD,MISS
 1985 FORMAT(12X,13H RMS ERROR = ,F8.3,8H BIAS = ,F8.3,
     . 5X,I3,' POINTS MISSING')
      IF(KPL2.GT.1) WRITE(IPR,1981 ) SEAN,AVDN
 1981 FORMAT(8X,17H NEW RMS ERROR = ,F8.3,8H BIAS = ,F8.3)
 1990 CONTINUE
 2000 CONTINUE
 2100 FORMAT(30X,I5,4F20.2)
 2110 FORMAT(5X,I5,6F12.3,5X,F13.1)
 2120 FORMAT(5X,I5,6F12.3,5X,F13.2)
 2140 FORMAT (/17H           RIVER ,I3,10H, STATION ,I3,5X,5A4)
C
      IF(ITRACE.EQ.1) WRITE(IODBUG,9000) SNAME
 9000 FORMAT(1H0,2H**,1X,2A4,8H EXITED.)
      RETURN
      END
