C MEMBER BWTR21
C  (from old member FCBWTR21)
C DESC -- THIS SUBROUTINE DOES BACKWATER COMPUTATIONS
C
C                             LAST UPDATE: 03/01/94.13:09:13 BY $WC30JL
C
C @PROCESS LVL(77)
C
      SUBROUTINE BWTR21(PO,Z,NB,YDI,QDI,NJUN,HS,NNYQ,CM,X,XFACT,NRCM1,
     1 NCML,STT,LOSTT,PLTI,NUMLAD,LAD,NUMRCP,EPSY,K6,K7,K9)
C
C           THIS SUBROUTINE WAS WRITTEN ORIGINALLY BY:
C           DR. DANNY FREAD   HRL   APRIL 1978
C
C           THIS SUBROUTINE WAS MODIFIED TO MEET VER. NO. 5 STANDARDS
C           OF THE NWSRFS BY:
C           JANICE LEWIS      HRL   NOVEMBER,1982     VERSION NO. 1
C
      COMMON/FDBUG/IODBUG,ITRACE,IDBALL,NDEBUG,IDEBUG(20)
      COMMON/IONUM/IN,IPR,IPU
      COMMON/CM21/LONYQ,LONM1,LONCM,LOCM,LOYCM
      COMMON/LD21/LONLD,LOCTW,LOLAD,LOPTR
      COMMON/OX21/LOFKC,LONT1,LONQL,LOLQ,LZRCP,LZQQD,LZYQD,LONT
      COMMON/XS21/LOAS,LOBS,LOHS,LOASS,LOBSS,LOHSS,LONSS,LONS1
      COMMON/M121/N,NU,NS1,JN,JJ,KIT,G,DT,TT,TIMF,F1,GZN,NYQD
      COMMON/SS21/NCS,A,B,DB,R,DR,AT,BT,NCSS,P,DP,ZH,NP,NPEND
      COMMON/M3221/KTERM,KPL,KPL2,JNK,TE,TM,KITPR
      COMMON/IVRSN21/IVER
C
      DIMENSION PO(*),NB(*),YDI(*),QDI(*),NJUN(*),NNYQ(*),SNAME(2)
      DIMENSION HS(K7,*),CM(K6,*),X(*),LOSTT(*),NRCM1(*),PLTI(*)
      DIMENSION Z(*),NUMLAD(*),LAD(*),NUMRCP(*),STT(*)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_dwoper/RCS/bwtr21.f,v $
     . $',                                                             '
     .$Id: bwtr21.f,v 1.3 1998/07/06 11:51:50 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SNAME/4HBWTR,4H21  /
C
C
      CALL FPRBUG(SNAME,1,21,IBUG)
C
C           CHECK TO SEE IF MANNING'S N VALUES HAVE BEEN READ IN
C
      KCM=0
      IF(CM(1,LCAT21(1,1,NRCM1)).LT.0.001) KCM=1
C
C           FIND LOCATION OF THE FIRST CROSS SECTION
C
      IRC1=0
      LRC1=0
      IF(NYQD.EQ.0) GO TO 2
      IRC1=1
      LRC1=NUMRCP(1)
C
    2 L1=LCAT21(1,1,NB)-1
C
      LLD=1
      DO 60 J=1,JN
C
C  REVERSE THE ORDER OF THE RATING CURVES
C
      LRC=LRC1
      IRC=IRC1
      LLDJ=1
      DO 4 JJ=1,J
      NUM=NUMLAD(JJ)
      IF(NUM.EQ.0) GO TO 4
      LLAD=LCAT21(1,JJ,NUMLAD)-1
      DO 3 L=1,NUM
      IF(IVER.LT.3) LLDJ=L+LLAD
      IF(LAD(LLDJ).GE.0) GO TO 1
      IRC=IRC+1
      LRC=LRC+NUMRCP(IRC)
 1    IF(IVER.GE.3) LLDJ=LLDJ+2
    3 CONTINUE
    4 CONTINUE
C     WRITE(IODBUG,8000) J,IRC,LRC,NYQD
C8000 FORMAT(/5X,10(1H=),' J=',I2,'  IRC=',I2,'  LRC=',I5,'  NYQD=',I5)
C
C           COMPUTE MANNING'S N VALUES
C
      IF(KCM.EQ.1) CALL BWCM21(PO,J,PO(LONCM),NRCM1,CM,NCML,X,
     1XFACT,QDI,PO(LONT1),STT,LOSTT,NB,K6,K7,K9)
C
      LO1=LCAT21(1,J,NB)-1
      NN=NB(J)
C
      IF(J.EQ.1) GO TO 7
C      WRITE(6,9998) YDI(1+LO1)
C 9998 FORMAT(1H ,10X,7HYDI(1)=,F10.2)
      IF(ABS(YDI(1+LO1)).GT.0.0001) GO TO 60
      IF(ABS(YDI(NN+LO1)).GT.0.0001) GO TO 7
C
C         COMPUTE WSEL AT THE DOWNSTREAM END OF EACH TRIBUTARY
C
      II=NJUN(J)
      YDI(NN+LO1)=0.5*(YDI(II+L1)+YDI(II+1+L1))
C
    7 YLL=YDI(NN+LO1)
      NNS=NB(J)-1
      KK=0
C
C         BACKWATER COMPUTATIONS
C
      DO 50 K=1,NNS
      KTR=0
      IF(K.EQ.1.AND.IBUG.EQ.1.AND.JNK.GE.1) WRITE(IODBUG,6)
    6 FORMAT(/)
C
C         DETERMINE THE COMPUTATIONAL REACH, ITS AVERAGE FLOW, AND THE
C         DEPTH A THE DOWN STREAM END
C
      I=NN-K
C     WRITE(6,9999) I,YDI(I+LO1)
C9999 FORMAT(1H ,10X,2HI=,I3,5X,4HYDI=,F10.2)
      IF(ABS(YDI(I+LO1)).GT.0.0001) GO TO 50
      IR=I+1
      YDS=YDI(IR+LO1)
      QQ=QDI(I+LO1)
      A=0.
      KK=0
      YLLI=YDI(I+LO1)
      IF(YLLI.GT.0.1) GO TO 25
      INTB=0
      CALL INBI21(Z,INTB,I,J,LLD,IVER,QQ,YDS,YLLI,PO(LONLD),PO(LOLAD),
     . PLTI,PO(LOCTW),Z(LZRCP),HS,K7,IRC,LRC)
      IF(INTB.EQ.0) GO TO 8
      YDI(I+LO1)=YLLI
      GO TO 25
    8 IRR=IR+1
      QA=QDI(I+LO1)+QDI(IR+LO1)
      QB=QA/2.
      YLR=YDI(IR+LO1)
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,IR,YLR,K7,K9)
      AD=A
      BD=B
      DEP=YLR-HS(1,IR+LO1)
      IF(K.EQ.1.AND.KTR.EQ.0.AND.JNK.GE.1.AND.IBUG.EQ.1)
     1 WRITE(IODBUG,51) NN,KK,KTR,QDI(NN+LO1),YDI(NN+LO1),YDI(NN+LO1),
     2 DEP,AD
      IF(NNYQ(J).EQ.1) YQ=QA/2.
      IF(NNYQ(J).EQ.0) YQ=0.5*(YLR+YLL)
      CALL FRCT21(NRCM1,PO(LONCM),CM,PO(LOYCM),J,I,YQ,CMM,DCM,K6)
      DX=ABS(X(IR+LO1)-X(I+LO1))*XFACT
      CONST=CMM*CMM*DX*QA*ABS(QA)/2.21
      IF(K.EQ.1) Y=HS(1,I+LO1)+DEP
      IF(K.GT.1) Y=HS(1,I+LO1)+0.5*(DEP+YDI(IRR+LO1)-HS(1,IRR+LO1))
      IF(K.EQ.1) GO TO 9
      IF(KTR.LT.2) GO TO 9
C
C        USE INTERPOLATION TO GET THE GUESS FOR WSEL (Y)
C
      DELY=YDI(IR+LO1)-YDI(IRR+LO1)
      DELX=ABS(X(IR+LO1)-X(IRR+LO1))*XFACT
      Y=YLR+DX/DELX*DELY
    9 YLL=Y
      IF(KTR.EQ.0) GO TO 10
      IF(KTR.EQ.2) GO TO 10
      IF(NNYQ(J).EQ.0) YQ=YLR
      CALL FRCT21(NRCM1,PO(LONCM),CM,PO(LOYCM),J,IR,YQ,CMR,DCM,
     1 K6)
      VD=QDI(IR+LO1)/AD
      AEO=100.
      SFD=CMR*CMR*VD*VD/(2.21*(AD/BD)**(4./3.))
      HGIRI=YLR+VD*VD/64.4
   84 FORMAT(30X,2HY=,F8.2,5X,3HQQ=,F10.2,5X,4HQDI=,F10.2)
      GO TO 98
   95 IF(Y.LE.HS(1,I+LO1)) YLL=HS(1,I+LO1)+DEP
      IF(Y.LE.HS(1,I+LO1)) GO TO 10
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,I,Y,K7,K9)
      BA=0.5*(B+BD)
      IF(A.LE.0.00.OR.B.LE.0.00) GO TO 17
      VU=QDI(I+LO1)/A
      VH=VU*VU/64.4
      HGI=Y+VH
      AA=0.5*(A+AD)
      IF(NNYQ(J).EQ.0) YQ=Y
      CALL FRCT21(NRCM1,PO(LONCM),CM,PO(LOYCM),J,I,YQ,CMU,DCM,K6)
      SFU=CMU*CMU*VU*VU/(2.21*(A/B)**(4./3.))
      SFH=DX*CMU**2*QB*ABS(QB)*BA**(4./3.)/2.21/AA**(10./3.)
      HGIR=HGIRI+SFH
      AE=ABS(HGIR-HGI)
      IF(AE.GT.AEO) GO TO 10
      IF(AE.GT.0.01) GO TO 96
      GO TO 10
   96 DY=(HGIR-HGI)/(1.-VU*VU*B/32.2/A+1.5*SFU*DX*B/A)
      YLL=Y+DY
      IF(JNK.EQ.3.AND.IBUG.EQ.1) WRITE(IODBUG,88)I,Y,A,VH,HGI,SFU,YLR,
     1 SFD,SFH,HGIRI,HGIR,AE,DY
      IF(ABS(DY).LT.0.01) GO TO 10
      AEO=AE
      Y=Y+DY
      GO TO 95
   98 Y=HS(1,I+LO1)+0.10
      DH=HS(1,I+LO1)-HS(1,IR+LO1)
      DELX=DX
      IF(DH.LT.0.0001) DELX=ABS(X(1+LO1)-X(NN+LO1))*XFACT
      IF(DH.LT.0.0001) DH=HS(1,1+LO1)-HS(1,NN+LO1)
      IF(DH.LT.0.0001) Y=YLL
      IF(DH.LT.0.0001) GO TO 95
      S=SQRT(DH/DELX)
   88 FORMAT(1H ,10X,2HI=,I3,1X,2HY=,F10.2,1X,2HA=,F10.2,1X,3HVH=,F10.2,
     1 1X,4HHGI=,F10.2,1X,4HSFU=,F10.6/1H ,10X,4HYLR=,F10.2,1X,4HSFD=,
     2 F10.6,1X,4HSFH=,F10.2,1X,6HHGIRI=,F10.2,1X,5HHGIR=,F10.2,1X,
     3 3HAE=,F10.2,1X,3HDY=,F10.2)
      IF(YLR.GT.HS(1,I+LO1)+0.10) Y=YLR-0.50
   99 Y=Y+0.5
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,I,Y,K7,K9)
      IF(NNYQ(J).EQ.0) YQ=0.5*(YLR+Y)
      CALL FRCT21(NRCM1,PO(LONCM),CM,PO(LOYCM),J,I,YQ,CMM,DCM,K6)
      QQ=1.486*S/CMM*A**(5./3.)/B**(2./3.)
      IF(JNK.EQ.3.AND.IBUG.EQ.1) WRITE(IODBUG,84) Y,QQ,QDI(I+LO1)
      IF(QQ.LT.QDI(I+LO1)) GO TO 99
      IF(Y.LT.YLL) Y=YLL
      GO TO 95
   10 YLL=Y
      YLLI=YLL
      YDI(I+LO1)=YLL
      DO 15 KR=1,10
      IF(NNYQ(J).EQ.0) YQ=0.5*(YLR+YLL)
      CALL FRCT21(NRCM1,PO(LONCM),CM,PO(LOYCM),J,I,YQ,CMM,DCM,K6)
      CONST=CMM*CMM*DX*QA*ABS(QA)/2.21
      KK=KR
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,I,YLL,K7,K9)
      IF(A.LE.0.00.OR.B.LE.0.00) GO TO 17
      AB=0.5*(AD+A)
      BB=0.5*(BD+B)
      SFB=CMM**2/2.21*QB*ABS(QB)*BB**(4./3.)/AB**(10./3.)
      GSFX=32.2*DX*AB*SFB
      F=QDI(IR+LO1)**2/AD-QDI(I+LO1)**2/A+32.2*AB*(YLR-YLL)+GSFX
      FP=QDI(I+LO1)**2*B/A**2+32.2*(-AB+B/2.*(YLR-YLL))+GSFX*(4./6.*DB/
     1BB-10./6.*B/AB)
   57 FORMAT(1H ,10X,2HI=,I5,1X,3HKK=,I5,1X,3HQB=,F9.1,1X,5HYLLN=,F9.2,
     1 1X,4HYLL=,F9.2,1X,2HA=,F9.1,1X,2HB=,F9.1,1X,4HCMM=,F9.3,1X,
     2 4HSFB=,F9.6)
      YLLN=YLL-F/FP
      IF(JNK.GE.2.AND.IBUG.EQ.1) WRITE(IODBUG,57) I,KK,QB,YLLN,YLL,A,B,
     1 CMM,SFB
      IF(ABS(YLL-YLLN).LE.EPSY) GO TO 16
   15 YLL=YLLN
   16 YDI(I+LO1)=YLLN
      IF(KK.LT.10) GO TO 25
   22 FORMAT(1H0,10X,74H**WARNING** STEP-BACKWATER ALGORITHM DID NOT CON
     1VERGE AT CROSS-SECTION NO.,I5,13H ON RIVER NO.,I3,1H.)
   17 KTR=KTR+1
      IF(KTR.GE.1) WRITE(IPR,22) I,J
      IF(KTR.GE.1) CALL WARN
      IF(KTR.LE.2) GO TO 8
   25 CONTINUE
      DEPI=YDI(I+LO1)-HS(1,I+LO1)
      IF(JNK.GE.1.AND.IBUG.EQ.1) WRITE(IODBUG,51) I,KK,KTR,QDI(I+LO1),
     1 YDI(I+LO1),YLLI,DEPI,A
   51 FORMAT(1H ,10X,2HI=,I3,3X,3HKK=,I2,3X,4HKTR=,I1,3X,4HQDI=,F10.2,
     13X,4HYDI=,F10.2,3X,5HYLLI=,F10.2,3X,6HDEPTH=,F6.2,3X,2HA=,F10.2)
   50 CONTINUE
   60 CONTINUE
C
      IF(ITRACE.EQ.1) WRITE(IODBUG,9000) SNAME
 9000 FORMAT(1H0,2H**,2A4,1X,8H EXITED.)
C
      RETURN
      END
