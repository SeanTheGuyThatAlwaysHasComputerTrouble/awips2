C MEMBER BDRY21
C  (from old member FCBDRY21)
C DESC -- THE FUNCTION OF THIS SUBROUTINE IS TO SET UP BOUNDARY
C DESC -- CONDITIONS.
C                             LAST UPDATE: 03/01/94.13:12:26 BY $WC30JL
C
C @PROCESS LVL(77)
C
      SUBROUTINE BDRY21(PO,HS,QD,QU,YD,YU,DDX,QDI,KD,YJ,NN2,KU,STN,
     1 ST1,LOST1,T1,C,D,YQD,QYQD,NYQ,NB,STM,YDI,K6,K7,K9)
C
C           THIS SUBROUTINE WAS WRITTEN ORIGINALLY BY:
C           DR. DANNY FREAD   HRL   APRIL 1978
C
C           THIS SUBROUTINE WAS MODIFIED TO MEET VER. NO. 5 STANDARDS
C           OF THE NWSRFS BY:
C           JANICE LEWIS      HRL   NOVEMBER,1982     VERSION NO. 1
C
C           MODIFIED BY J.LEWIS TO ALLOW TIDE BDARY D/S (KD(1)=0)
C
      COMMON/FDBUG/IODBUG,ITRACE,IDBALL,NDEBUG,IDEBUG(20)
      COMMON/XS21/LOAS,LOBS,LOHS,LOASS,LOBSS,LOHSS,LONSS,LONS1
      COMMON/CM21/LONYQ,LONM1,LONCM,LOCM,LOYCM
      COMMON/M121/N,NU,NS1,JN,JJ,KIT,G,DT,TT,TIMF,F1,GZN,NYQD
      COMMON/M621/KTIME,DHF,J1,KX
      COMMON/M821/TP,RHO,GAMMA,YI,SO
      COMMON/SS21/NCS,A,B,DB,R,DR,AT,BT,NCSS,P,DP,ZH,NP,NPEND
      COMMON/NT21/NIT,SF1
      COMMON/XCED21/NBDXCD,NCMXCD,NFRXCD,NICXCD,NINXCD,NONXCD,MTXDV
C
      DIMENSION PO(*),KD(*),QD(*),HS(K7,*),QU(*),STM(*)
      DIMENSION YD(*),YJ(*),YU(*),DDX(*),NN2(*),STN(*),NB(*)
      DIMENSION ST1(*),LOST1(*),T1(*),KU(*),QDI(*),C(*),D(4,*),YQD(*)
      DIMENSION QYQD(*),YDI(*),SNAME(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_dwoper/RCS/bdry21.f,v $
     . $',                                                             '
     .$Id: bdry21.f,v 1.4 1997/12/31 19:27:52 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SNAME/4HBDRY,4H21  /
C
C
      CALL FPRBUG(SNAME,1,21,IBUG)
C
C        COMPUTE COEFFICIENTS NEEDED IN MTRX21 AT UPSTREAM BOUNDARY
C
      J=JJ
      I=NN2(J)
      LOS1=LOST1(J)-1
cc      LOST=LOSTN-1
      L1J=LCAT21(1,J,NB)-1
C
      CALL INTP21(NU,TINP,IT1,IT2,T1)
      YQM=STM(J)
C
      IF(NU) 10,10,40
C
C        INFLOW HYDROGRAPH IS GENERATED
C
   10 ALPH=1./(GAMMA-1.)
      IF(KU(J)-1) 20,20,30
C
C        STAGE INFLOW HYDROGRAPH
C
   20 YQ1=YI*(1.+(RHO-1.)*(TT/TP)**ALPH*EXP(ALPH*(1.-TT/TP))) +
     1 HS(1,1+L1J)
      IF(YQ1.LT.YQM) YQ1=YQM
      GO TO 50
C
C        DISCHARGE INFLOW HYDROGRAPH
C
   30 YQ1=QDI(1+L1J)*(1.+(RHO-1.)*(TT/TP)**ALPH*EXP(ALPH*(1.-TT
     1/TP)))
      IF(YQ1.LT.YQM) YQ1=YQM
      GO TO 50
C
C        INFLOW HYDROGRAPH WAS READ IN
C
   40 YQ1=ST1(IT2+LOS1)+(ST1(IT1+LOS1)-ST1(IT2+LOS1))*TINP
      IF(TT.LT.DHF.AND.KU(J).EQ.1) YQ1=YDI(1+L1J)+(ST1(1+LOS1)-
     1 YDI(1+L1J))*TT/DHF
      IF(TT.LT.DHF.AND.KU(J).EQ.2) YQ1=QDI(1+L1J)+(ST1(1+LOS1)-
     1 QDI(1+L1J))*TT/DHF
C      WRITE(6,999) TT,DHF,YQ1,YQM,YDI(1+L1J),QDI(1+L1J),ST1(1+LOS1)
C  999 FORMAT(3X,'TT  DHF      YQ1      YQM      YDI      QDI      ST1='
C     1 /  F5.0,F5.0,2F10.0,F10.2,2F10.0)
      IF(YQ1.LT.YQM) YQ1=YQM
C
   50 IF(KU(J)-2) 60,70,70
C
C        STAGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
   60 YU(1+L1J)=YQ1
      C(1)=-(YU(1+L1J)-YQ1)
      D(1,1)=1.
      D(2,1)=0.
      GO TO 80
C
C        DISCHARGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
   70 QU(1+L1J)=YQ1
      C(1)=-(QU(1+L1J)-YQ1)
      D(1,1)=1.
      D(2,1)=0.
C
C        COMPUTE COEFFICIENT NEEDED IN MATRX AT DOWNSTREAM BOUNDARY
C
   80 IF(KD(J)-2) 90,90,190
C
C        DOWNSTREAM BOUNDARY IS A HYDROGRAPH
C
   90 IF(J-2) 110,100,100
  100 IF(NP.GE.1) GO TO 110
C
C        ON A TRIBUTARY
C
      IF(KD(J).LE.1) YQ1=YJ(J)
      IF(KD(J).EQ.2) YQ1=QDI(N+L1J)
      GO TO 120
C
C        ON THE MAIN STEM

cew additions from RTI
c inf the following two if statements the index to stn was changed
c from stn(n+lost) to stn(it1+lost)
C
  110 YQ1=STN(IT2)+(STN(IT1)-STN(IT2))*TINP
      IF(TT.LT.DHF.AND.KD(J).LE.1) YQ1=YDI(N+L1J)+(STN(IT1)-
     1 YDI(N+L1J))*TT/DHF
      IF(TT.LT.DHF.AND.KD(J).EQ.2) YQ1=QDI(N+L1J)+(STN(IT1)-
     1 QDI(N+L1J))*TT/DHF
      IF(NYQD.GE.1) GO TO 200
  120 IF(KD(J)-2) 130,160,190
C
C        DOWNSTREAM BOUNDARY IS A STAGE HYDROGRAPH
C
  130 YU(N+L1J)=YQ1
      C(I)=0.
      IF(KU(J)-1) 140,140,150
C
C        STAGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  140 D(3,I)=1.
      D(4,I)=0.
      GO TO 330
C
C        DISCHARGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  150 D(3,I)=0.
      D(4,I)=1.
      GO TO 330
C
C        DOWNSTREAM BOUNDARY IS A DISCHARGE HYDROGRAPH
C
  160 QU(N+L1J)=YQ1
      C(I)=0.
      IF(KU(J)-1) 170,170,180
C
C        STAGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  170 D(3,I)=0.
      D(4,I)=1.
      GO TO 330
C
C        DISCHARGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  180 D(3,I)=1.
      D(4,I)=0.
      GO TO 330
  190 IF(KD(J)-4) 200,240,250
C
C        DOWNSTREAM BOUNDARY IS A SINGLE VALUE RATING CURVE
C        FIND THE FLOW (QN) AND ITS PARTIAL DERIVATIVES
C
  200 Y = YU(N+L1J)
      IF(KD(1).LE.1) Y=YU(N+L1J)-YQ1
      DO 220 K = 1, NYQD
      KR=K
      IF(Y-YQD(K)) 230,230,220
  220 CONTINUE
C
C        RATING TABLE HAS BEEN EXCEEDED -- MUST LINEARLY EXTRAPOLATE
C
      NBDXCD=NBDXCD+1
C
  230 KL = KR - 1
      DQNY = (QYQD(KR)-QYQD(KL))/(YQD(KR)-YQD(KL))
      QN = QYQD(KL)+DQNY*(Y-YQD(KL))
      DQNQ=0.
      GO TO 300
C
C        DOWNSTREAM BOUNDARY IS A LOOP (DYNAMIC) RATING CURVE
C        FIND THE FRICTION SLOPE (SF) AND SET PARTIAL DERIVATIVES
C        EQUAL TO ZERO
C
  240 Y=YD(NS1+L1J)
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,NS1,Y,K7,K9)
      AL=A
      Y=YD(N+L1J)
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,N,Y,K7,K9)
      AR=A
      AA=0.5*(AL+AR)
      TERM1=(YD(NS1+L1J)-YD(N+L1J))/DDX(NS1+L1J)
      TERM2=(QD(N+L1J)-QU(N+L1J))/(G*AA*DT)
      TERM3=(QD(NS1+L1J)**2/AL-QD(N+L1J)**2/AR)/(G*AA*DDX(NS1+L1J))
      SF=TERM1+TERM2+TERM3
      IF(JNK.GE.3.AND.IBUG.GT.0) WRITE(IODBUG,245) YD(NS1+L1J),YD(N+L1J)
     1,DDX(NS1+L1J),TERM1,TERM2,TERM3,SF,NS1,N
  245 FORMAT(1H0,13X,7HYD(NS1),5X,5HYD(N),2X,8HDDX(NS1),5X,5HTERM1,5X,
     1 5HTERM2,5X,5HTERM3,8X,2HSF,5H  NS1,4X,1HN/10X,3F10.2,4F10.6,2I5)
      IF (TT.LE.0.00001.AND.KIT.EQ.1) SFI=SF
      IF (SF.GT.0.00) SF1=SF
      IF (SF.LE.0.00) SF=SF1
      IF (SF.LE.0.000) SF=SFI
      PSFY = 0.
      PSFQ=0.
      GO TO 260
C
C        DOWNSTREAM BOUNDARY IS A RATING CURVE WITH THE FRICTION SLOPE
C        (SF) EQUAL TO THE BOTTOM SLOPE (SO).  SET PARTIAL DERIVATIVES
C        EQUAL TO ZERO
C
  250 SF=SO
      PSFY=0.
      PSFQ=0.
C
C        SOLVE MANNING'S EQUATION FOR DISCHARGE (QN) AND FIND THE
C        PARTIAL DERIVATIVES
C
  260 Y=YU(N+L1J)
      CALL SECT21(PO(LOAS),PO(LOBS),HS,PO(LOASS),PO(LOBSS),PO(LOHSS),
     1 PO(LONSS),PO(LONS1),NB,J,N,Y,K7,K9)
      IF(A.LE.0.0.OR.B.LE.0.0) NIT=1
      IF(A.LE.0.0.OR.B.LE.0.0) RETURN
      R=(A/B)**(2./3.)
      DR=2./3.*R*(B/A-DB/B)
      IF(NYQ) 270,270,280
  270 YQ = YD(N+L1J)
      GO TO 290
  280 YQ = QD(N+L1J)
  290 M = N + 1
      CALL FRCT21(PO(LONM1),PO(LONCM),PO(LOCM),PO(LOYCM),J,M,YQ,CMU,DCMU
     1,K6)
      QN=1.486/CMU*A*R*SQRT(SF)
      DQNQ=QN*(0.5/SF*PSFQ)
      DQNY=QN*(DR/R+B/A+0.5/SF*PSFY)
C
C        SET THE COEFFICIENTS
C
  300 C(I)=-(QU(N+L1J)-QN)
      IF(KU(J)-1) 310,310,320
C
C        STAGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  310 D(3,I)=-DQNY
      D(4,I)=1.-DQNQ
      GO TO 330
C
C        DISCHARGE BOUNDARY UPSTREAM -- SET COEFFICIENTS
C
  320 D(3,I)=1.-DQNQ
      D(4,I)=-DQNY
C
  330 IF(ITRACE.EQ.1) WRITE(IODBUG,9000) SNAME
 9000 FORMAT(1H0,2H**,1X,2A4,8H EXITED.)
      RETURN
      END
