C MEMBER WERQ21
C  (from old member FCWERQ21)
C
      SUBROUTINE WERQ21(HWH,WC,NWJX,YU,YD,QLLU,QLLD,DQL,DQR,JM,JT,L,DDX
     1,KLF,TTL,TFL,BBL,HFL,HMINL,NB,NWJ,QLUTOT)
C
C      THIS SUBROUTINE COMPUTES WEIR FLOW
C
C           THIS SUBROUTINE WAS WRITTEN ORIGINALLY BY:
C           DR. DANNY FREAD   HRL   APRIL 1978
C
C           THIS SUBROUTINE WAS MODIFIED TO MEET VER. NO. 5 STANDARDS
C           OF THE NWSRFS BY:
C           JANICE LEWIS      HRL   NOVEMBER,1982     VERSION NO. 1
C
      COMMON/FDBUG/IODBUG,ITRACE,IDBALL,NDEBUG,IDEBUG(20)
      COMMON/IONUM/IN,IPR,IPU
      COMMON/M121/N,NU,NS1,JN,JJ,KIT,G,DT,TT,TIMF,F1,GZN,NYQD
      COMMON/M3221/KTERM,KPL,KPL2,JNK,TE,TM,KITPR
      COMMON/M3421/NCT,ICD,ITMAX
C
      DIMENSION HWH(1),WC(1),NWJX(1),YU(1),NB(1),NWJ(1)
      DIMENSION YD(1),DDX(1),KLF(1),TTL(1),TFL(1),BBL(1),HFL(1)
      DIMENSION HMINL(1),SNAME(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_dwoper/RCS/werq21.f,v $
     . $',                                                             '
     .$Id: werq21.f,v 1.1 1995/09/17 18:56:21 dws Exp $
     . $' /
C    ===================================================================
C
C
      DATA SNAME/4HWERQ,4H21  /
C
C
      CALL FPRBUG(SNAME,1,21,IBUG)
C
      J=JJ
      BBU=0.00
      SUB=1.00
      SUBL=1.00
      DSUBL=0.00
      QLLD=0.00
      QLLU=0.00
      DQL=0.00
      DH=0.01
C
      LJMW=LCAT21(1,JM,NWJ)-1
      LJTW=LCAT21(1,JT,NWJ)-1
      LJMN=LCAT21(1,JM,NB)-1
      LJTN=LCAT21(1,JT,NB)-1
      KML=NWJX(L+LJMW)
      KMR=NWJX(L+LJMW)+1
      KTL=NWJX(L+LJTW)
      KTR=NWJX(L+LJTW)+1
      DXM=DDX(KML+LJMN)
      DXT=DDX(KTL+LJTN)
      DX=DXM
      WMU=0.5*(YU(KML+LJMN)+YU(KMR+LJMN))
      WMD=0.5*(YD(KML+LJMN)+YD(KMR+LJMN))
      WTU=0.5*(YU(KTL+LJTN)+YU(KTR+LJTN))
      WTD=0.5*(YD(KTL+LJTN)+YD(KTR+LJTN))
      HWE=HWH(L)
      HMD=WMD-HWE
      HTD=WTD-HWE
      HMU=WMU-HWE
      HTU=WTU-HWE
      WCC=WC(L)
      SUB=1.
      DSUB=0.
      HFLF=HFL(L)
      HFF=HWE
      IF(HFLF.LT.HWE) HFF=HFLF
      HLBU=HFF
      HLBD=HFF
      DQL=0.
      IF(BBL(L).LE.0.001) GO TO 200
      IF(WMU.GT.HFLF.AND.KLF(L).EQ.0) TTL(L)=TT-DT/3600.*0.5
      IF(WMU.GT.HFLF) KLF(L)=1
      IF(KLF(L).EQ.0) GO TO 200
      IF(TFL(L).LE.0.001) TFL(L)=0.1
      DEPL=HFF-HMINL(L)
      BBU=(TT-TTL(L))/TFL(L)*BBL(L)
      IF(BBU.GT.BBL(L)) BBU=BBL(L)
      TTD=TT-DT/3600.
      BBD=(TTD-TTL(L))/TFL(L)*BBL(L)
      IF(BBD.LT.0.0) BBD=0.
      IF(BBD .GT.BBL(L)) BBD=BBL(L)
      HLBU=HFF-(TT-TTL(L))/TFL(L)*DEPL
      IF(HLBU.LT.(HFF-DEPL)) HLBU=HFF-DEPL
      HLBD=HFF-(TTD-TTL(L))/TFL(L)*DEPL
      IF(HLBD.GT.HFF) HLBD=HFF
      IF(HLBD.LT.(HFF-DEPL)) HLBD=HFF-DEPL
      HLMU=WMU-HLBU
      HLMD=WMD-HLBD
      HLTU=WTU-HLBU
      HLTD=WTD-HLBD
  200 CONTINUE
      IF(WCC.GT.7.6) GO TO 1950
      IF(TTL(L).GT.0.00) GO TO 190
      IF(WMD.LE.HWE.AND.WTD.LE.HWE)GO TO 900
  190 IF(ABS(WMD-WTD).LE.DH) GO TO 900
      IF(WMD.GT.WTD)GO TO 300
      IF(WMD.LT.WTD)GO TO 400
  300 SUB=1.0
      IF(J.EQ.JM) JS=-1
      IF(J.EQ.JT) JS=+1
      IF(HMD.LE.0.00) GO TO 320
      IF(HTD.GT.0.67*HMD)SUB=1.0-27.8*(HTD/HMD-0.67)**3
      DQL=0.
      QLLD=JS*SUB*WCC*HMD**1.5
  320 IF(KLF(L).EQ.0) GO TO 1000
      IF(HLMD.LE.0.0) GO TO 1000
      IF(HMD.LE.0.0) HMD=0.001
      IF(HLTD.GT.0.67*HLMD) SUBL=1.-27.8*(HLTD/HLMD-0.67)**3
      QLVD=JS*SUBL*WCC*BBD/DX*HLMD**1.5
      QLLD=QLLD+QLVD-JS*SUB*WCC*BBD/DX*HMD**1.5
      GO TO 1000
  400 SUB=1.0
      IF(J.EQ.JM) JS=+1
      IF(J.EQ.JT) JS=-1
      IF(HTD.LE.0.00) GO TO 420
      IF(HMD.GT.0.67*HTD)SUB=1.0-27.8*(HMD/HTD-0.67)**3
      DQL=0.
      QLLD=JS*SUB*WCC*HTD**1.5
  420 IF(KLF(L).EQ.0) GO TO 1000
      IF(HLTD.LE.0.0) GO TO 1000
      IF(HTD.LE.0.0) HMD=0.001
      IF(HLMD.GT.0.67*HLTD) SUBL=1.-27.8*(HLMD/HLTD-0.67)**3
      QLVD=JS*SUBL*WCC*BBD/DX*HLTD**1.5
      QLLD=QLLD+QLVD-JS*SUB*WCC*BBD/DX*HTD**1.5
      GO TO 1000
  900 JS=0
      QLLD=0.
 1000 IF(TTL(L).GT.0.01) GO TO 1010
      IF(WMU.LE.HWE.AND.WTU.LE.HWE) GO TO 1900
 1010 IF(ABS(WMU-WTU).LE.DH) GO TO 1900
      IF(WMU.GT.WTU)GO TO 1300
      IF(WMU.LT.WTU)GO TO 1400
 1300 SUB=1.0
      DSUB=0.
      IF(J.EQ.JM) GO TO 1308
      IF(J.EQ.JT) GO TO 1318
 1308 IF(HMU.LE.0.00) GO TO 1315
 1310 IF(HTU.GT.0.67*HMU)SUB=1.0-27.8*(HTU/HMU-0.67)**3
      IF(HTU.GT.0.67*HMU)DSUB=41.7*(HTU/HMU-.67)**2*HTU/HMU**2
      QLLU=-1*SUB*WCC*HMU**1.5
      DQL=-1*WCC*(SUB*0.75*HMU**0.5+HMU**1.5*DSUB)
      JS=-1
 1315 IF(KLF(L).EQ.0) GO TO 2000
      IF(HLMU.LE.0.0) GO TO 2000
      IF(HMU.LE.0.0) HMU=0.001
      IF(HLTU.GT.0.67*HLMU) SUBL=1.0-27.8*(HLTU/HLMU-0.67)**3
      IF(HLTU.GT.0.67*HLMU) DSUBL=41.7*(HLTU/HLMU-.67)**2*HLTU/HLMU**2
      QLVU=-1.*SUBL*WCC*BBU/DX*HLMU**1.5+SUB*WCC*BBU/DX*HMU**1.5
      DQLV=-1.*WCC*BBU/DX*(SUBL*.75*HLMU**.5+HLMU**1.5*DSUBL)+WCC*BBU/DX
     1*(SUB*.75*HMU**0.5+HMU**1.5*DSUB)
      QLLU=QLLU+QLVU
      DQL=DQL+DQLV
      GO TO 2000
 1318 IF(HMU.LE.0.00) GO TO 1325
      IF(HTU.GT.0.67*HMU)SUB=1.0-27.8*(HTU/HMU-0.67)**3
      IF(HTU.GT.0.67*HMU)DSUB=-41.7*(HTU/HMU-.67)**2/HMU
      QLLU=+1*SUB*WCC*HMU**1.5
      DQL=+1*WCC*HMU**1.5*DSUB
      JS=+1
 1325 IF(KLF(L).EQ.0) GO TO 2000
      IF(HLMU.LE.0.0) GO TO 2000
      IF(HMU.LE.0.0) HMU=0.001
      IF(HLTU.GT.0.67*HLMU) SUBL=1.0-27.8*(HLTU/HLMU-0.67)**3
      IF(HLTU.GT.0.67*HLMU) DSUBL=-41.7*(HLTU/HLMU-.67)**2/HLMU
      QLVU=+1.*SUBL*WCC*BBU/DX*HLMU**1.5-SUB*WCC*BBU/DX*HMU**1.5
      DQLV=+1.*WCC*BBU/DX*HLMU**1.5*DSUBL-WCC*BBU/DX*HMU**1.5*DSUB
      QLLU=QLLU+QLVU
      DQL=DQL+DQLV
      GO TO 2000
 1400 SUB=1.0
      DSUB=0.
      IF(J.EQ.JM) GO TO 1408
      IF(J.EQ.JT) GO TO 1418
 1408 IF(HTU.LE.0.00) GO TO 1415
      IF(HMU.GT.0.67*HTU)SUB=1.0-27.8*(HMU/HTU-0.67)**3
      IF(HMU.GT.0.67*HTU)DSUB=-41.7*(HMU/HTU-.67)**2/HTU
      QLLU=+1*SUB*WCC*HTU**1.5
      DQL=+1*WCC*HTU**1.5*DSUB
      JS=+1
 1415 IF(KLF(L).EQ.0) GO TO 2000
      IF(HLTU.LE.0.0) GO TO 2000
      IF(HTU.LE.0.0) HTU=0.001
      IF(HLMU.GT.0.67*HLTU) SUBL=1.0-27.8*(HLMU/HLTU-0.67)**3
      IF(HLMU.GT.0.67*HLTU) DSUBL=-41.7*(HLMU/HLTU-.67)**2*HLTU
      QLVU=+1*SUBL*WCC*BBU/DX*HLTU**1.5-SUB*WCC*BBU/DX*HTU**1.5
      DQLV=+1*WCC*BBU/DX*HLTU**1.5*DSUBL-WCC*BBU/DX*HTU**1.5*DSUB
      QLLU=QLLU+QLVU
      DQL=DQL+DQLV
      GO TO 2000
 1418 IF(HTU.LE.0.00) GO TO 1425
      IF(HMU.GT.0.67*HTU)SUB=1.0-27.8*(HMU/HTU-0.67)**3
      IF(HMU.GT.0.67*HTU)DSUB=41.7*(HMU/HTU-.67)**2*HMU/HTU**2
      QLLU=-1*SUB*WCC*HTU**1.5
      DQL=-1*WCC*(SUB*0.75*HTU**0.5+HTU**1.5*DSUB)
      JS=-1
 1425 IF(KLF(L).EQ.0) GO TO 2000
      IF(HLTU.LE.0.0) GO TO 2000
      IF(HTU.LE.0.0) HTU=0.001
      IF(HLMU.GT.0.67*HLTU) SUBL=1.0-27.8*(HLMU/HLTU-0.67)**3
      IF(HLMU.GT.0.67*HLTU) DSUBL=41.7*(HLMU/HLTU-0.67)**2*HLMU/HLTU**2
      QLVU=-1.*SUBL*WCC*HLTU**1.5+SUB*WCC*BBU/DX*HTU**1.5
      DQLV=-1.*WCC*BBU/DX*(SUBL*.75*HLTU**.5+HLTU**1.5*DSUBL)+WCC*BBU/DX
     1*(SUB*.75*HTU**0.5+HTU**1.5*DSUB)
      QLLU=QLLU+QLVU
      DQL=DQL+DQLV
      GO TO 2000
 1900 JS=0
      QLLU=0.
      GO TO 2000
 1950 QLLU=0.
      QLLD=0.
      IF(J.EQ.1) JS=+1
      IF(J.GE.2) JS=-1
      AA=WCC/6.4
      DA=SQRT(4*AA/3.14)
      DR=(WTD-HWE)/DA
      CA=6.4*DR*AA
      IF(DR.GE.1.0) CA=WCC
      IF(WTD.LE.WMD) GO TO 1960
      IF(WTD.LE.HWE) GO TO 1960
      IF(WMD.LT.HWE) WMD=HWE
      QLLD=JS*CA*SQRT(WTD-WMD)
 1960 IF(WTU.LE.WMU) GO TO 2000
      IF(WTU.LE.HWE) GO TO 2000
      DR=(WTU-HWE)/DA
      IF(WMU.LT.HWE) WMU=HWE
      CA=6.4*DR*AA
      QLLU=JS*CA*SQRT(WTU-WMU)
      IF(J.EQ.1) DQL=-CA/4./SQRT(WTU-WMU)
      IF(J.GE.2) DQL=-CA/4./SQRT(WTU-WMU)-6.4*AA/DA/2.*SQRT(WTU-WMU)
      QLLU=QLLU/DXM
      QLLD=QLLD/DXM
      DQL=DQL/DXM
      IF(JNK.EQ.3.AND.IBUG.EQ.1) WRITE(IODBUG,3500) WTD,WMD,QLLD,DR,CA,
     1 WTU,WMU,QLLU,DQL
 3500 FORMAT(1H ,13X,5HWTD =,F10.2,5X,5HWMD =,F10.2,5X,6HQLLD =,
     1 F10.2,5X,4HDR =,F10.2,5X,4HCA =,F10.2/13X,5HWTU =,F10.2,5X,
     1 5HWMU =,F10.2,5X,6HQLLU =,F10.2,5X,5HDQL =,F10.2//)
 2000 IF(JJ.EQ.JT) QLLU=QLLU*DXM/DXT
      IF(JJ.EQ.JT) QLLD=QLLD*DXM/DXT
      IF(JJ.EQ.JT) DQL=DQL*DXM/DXT
      DQR=DQL
      DH1=0.3
      IF(ABS(WMU-HWE).LE.2.00) NCT=0
      IF(ABS(WMU-HFLF).LE.2.00) NCT=0
      IF(ABS(WMD-WTD).LE.DH1) NCT=0
      QLUTOT=QLLU*DXM
      QLDTOT=QLLD*DXM
      IF(JNK.GE.2.AND.IBUG.EQ.1) WRITE(IODBUG,3005) JJ,QLDTOT,QLUTOT,
     1 WMU,WTU,SUB,BBU,HLBU,SUBL,KML
 3005 FORMAT(1H ,10X,3HJJ=,I1,1X,7HQLDTOT=,F10.1,1X,7HQLUTOT=,F10.1,1X,
     1 4HWMU=,F7.2,1X,4HWTU=,F7.2,1X,4HSUB=,F4.2,1X,4HBBU=,F6.1,1X,
     2 5HHLBU=,F7.2,1X,5HSUBL=,F4.2,1X,4HKML=,I2)
C
      IF(ITRACE.EQ.1) WRITE(IODBUG,9000) SNAME
 9000 FORMAT(1H0,2H**,1X,2A4,8H EXITED.)
      RETURN
      END
