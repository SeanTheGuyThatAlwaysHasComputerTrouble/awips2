C MEMBER UNDO21
C  (from old member FCUNDO21)
C
      SUBROUTINE UNDO21 (STT,LOSTT,NRT1,GZ,ST1,LOST1,GZ1,STN,LOSTN,GZN,
     1 QL,LOQL,LQ,NQL,DDX,KD,KU,NB,JN,KPL,NU,KPL2,JNK,QLI,XNOS,TIDE,STE,
     2 LOSTE)
C
C           THIS SUBROUTINE CONVERTS ALL INPUT TIME SERIES BACK TO
C           THEIR ORIGINAL FORMS.
C
C           THIS SUBROUTINE WAS WRITTEN BY:
C           JANICE LEWIS      HRL   NOVEMBER,1982     VERSION NO. 1
C
cew added include
      INCLUDE 'common/fcary'
      COMMON/FDBUG/IODBUG,ITRACE,IDBALL,NDEBUG,IDEBUG(20)

C
      DIMENSION STT(1),LOSTT(1),NRT1(1),GZ(1),ST1(1),LOST1(1),GZ1(1)
      DIMENSION STN(1),QL(1),LOQL(1),LQ(1),NQL(1),DDX(1),KD(1),KU(1)
      DIMENSION SNAME(2),NB(1),QLI(1),XNOS(1),TIDE(1),STE(*),LOSTE(*)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_dwoper/RCS/undo21.f,v $
     . $',                                                             '
     .$Id: undo21.f,v 1.4 1998/07/06 11:54:14 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SNAME/4HUNDO,4H21  /
C
      CALL FPRBUG(SNAME,1,21,IBUG)
C
C         CONVERT THE OBSERVED WATER SURFACE ELEVATIONS TO STAGES
C
      IF(KPL2.EQ.0) GO TO 200
      DO 1999 J=1,JN
      NRT=NRT1(J)
      IF(NRT.LE.0) GO TO 1999
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,1) J
    1 FORMAT(/1H0,10X,30HOBSERVED STAGES FOR RIVER NO. ,I2/)
      LIJ=LCAT21(1,J,NRT1)-1
      DO 1996 I =1, NRT
      LOST=LOSTT(I+LIJ)-1
      DO 1997 K =1, NU
      IK=IFMSNG(STT(K+LOST))
      IF(IK.EQ.1) GO TO 1997
      IF (KPL.EQ.1.OR.KPL.EQ.3) STT(K+LOST)=STT(K+LOST)-GZ(I+LIJ)
 1997 CONTINUE
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,10) (STT(K+LOST),K=1,NU)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,2)
 1996 CONTINUE
    2 FORMAT(//)
   10 FORMAT(1H ,10X,8F10.2)
   12 FORMAT(1H ,10X,8F10.0)
 1999 CONTINUE
C
C         CONVERT THE ADJUSTED WATER SURFACE ELEVATIONS TO STAGES
C
      IF(KPL2.LE.1) GO TO 200
      DO 180 J=1,JN
      NRT=NRT1(J)
      IF(NRT.LE.0) GO TO 180
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,3) J
    3 FORMAT(/1H0,10X,30HADJUSTED STAGES FOR RIVER NO. ,I2/)
      LIJ=LCAT21(1,J,NRT1)-1
      DO 175 I =1, NRT
      LOSE=LOSTE(I+LIJ)-1
      DO 170 K =1, NU
      IK=IFMSNG(STE(K+LOSE))
      IF(IK.EQ.1) GO TO 175
      IF (KPL.EQ.1.OR.KPL.EQ.3) STE(K+LOSE)=STE(K+LOSE)-GZ(I+LIJ)
  170 CONTINUE
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,10) (STE(K+LOSE),K=1,NU)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,2)
  175 CONTINUE
  180 CONTINUE
C
C         CONVERT THE UPSTREAM WATER SURFACE ELEVATIONS TO STAGES
C
  200 IF (NU.LE.0) GO TO 209
      DO 208 J=1,JN
      IF (KU(J).NE.1) GO TO 208
      LOS1=LOST1(J)-1
      DO 207 K=1,NU
  207 ST1(K+LOS1)=ST1(K+LOS1)-GZ1(J)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,110) J
  110 FORMAT(1H0,10X,45HSTAGES AT THE UPSTREAM SECTION FOR RIVER NO. ,
     1 I2/)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,10) (ST1(K+LOS1),K=1,NU)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,2)
  208 CONTINUE
C
  209 IF (KD(1)-2) 210,213,213
C
C         CONVERT THE DOWNSTREAM WATER SURFACE ELEVATIONS TO STAGES
C
  210 LOSN=LOSTN-1
      DO 212 K=1,NU
      IF(STN(K+LOSN).GT.-900.0) STN(K+LOSN)=STN(K+LOSN)-GZN
      IF(KD(1).EQ.0) THEN
        XNOS(K)=XNOS(K)-GZN
        TIDE(K)=TIDE(K)-GZN
      ENDIF
  212 CONTINUE
cc      IF(KD(1).EQ.0) THEN
cc        XNOS(NU+1)=XNOS(NU+1)-GZN
cc        XNOS(NU+2)=XNOS(NU+2)-GZN
cc      ENDIF
      IF(JNK.EQ.1.AND.IBUG.EQ.1) THEN
        WRITE(IODBUG,310)
  310   FORMAT(1H0,10X,32HSTAGES AT THE DOWNSTREAM SECTION/)
        WRITE(IODBUG,10) (STN(K+LOSN),K=1,NU)
        IF(KD(1).EQ.0) THEN
          WRITE(IODBUG,312)
  312     FORMAT(1H0,10X,'NOS TIDE AT THE DOWNSTREAM SECTION'/)
          WRITE(IODBUG,10) (XNOS(K),K=1,NU+2)
          WRITE(IODBUG,314)
  314     FORMAT(1H0,10X,'ADJUSTED TIDE AT THE DOWNSTREAM SECTION'/)
          WRITE(IODBUG,10) (TIDE(K),K=1,NU+2)
        ENDIF
      ENDIF
C
  213 CONTINUE
C
C         CONVERT THE LATERAL FLOWS BACK TO UNITS OF CFS
C
      DO 41 J=1,JN
      IF(NQL(J)) 41,41,36
   36 NQL1 = NQL(J)
      LIJ=LCAT21(1,J,NQL)-1
      L1J=LCAT21(1,J,NB)-1
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,410) J
  410 FORMAT(1H0,10X,29HLATERAL INFLOW FOR RIVER NO. ,I2/)
      DO 500 I = 1,NQL1
      LQ1=LQ(I+LIJ)
      IF(LQ1) 41,41,399
  399 LOQ=LOQL(I+LIJ)-1
cew RTI additions, added if
         if(IFILLC .eq. 0) then
           QLI(I+LIJ)=QLI(I+LIJ)*DDX(LQ1+L1J)
         endif
      DO 400 K=1,NU
  400 QL(K+LOQ)=QL(K+LOQ)*DDX(LQ1+L1J)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,12) (QL(K+LOQ),K=1,NU)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,2)
  500 CONTINUE
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,510) J
  510 FORMAT(1H0,10X,37HINITIAL LATERAL INFLOW FOR RIVER NO. ,I2/)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,12) (QLI(I+LIJ),I=1,NQL1)
      IF(JNK.EQ.1.AND.IBUG.EQ.1) WRITE(IODBUG,2)
   41 CONTINUE
C
      IF(ITRACE.EQ.1) WRITE(IODBUG,9000) SNAME
 9000 FORMAT(1H0,2H**,1X,2A4,8H EXITED.)
C
      RETURN
      END

