C MODULE MWEUPT
C-----------------------------------------------------------------------
C
C
C     DESC - PERFORMS THE WEUPDATE MOD
C
      SUBROUTINE MWEUPT(NCARDS,MODCRD,IDATE,IHZERO)
C
      LOGICAL FIRST
C
      CHARACTER*8 OPNAME,IFIELD,BLANK8,SLASH,MODNAM,OPRNAM
      CHARACTER*4 KEY(2),KEYWRD
C
      INCLUDE 'common/fmodft'
      COMMON/FRAKSW/NRAKSW,RAREKW(6,10)
      INCLUDE 'common/ionum'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'ufreex'
C
      DIMENSION OLDOPN(2),MODCRD(20,NCARDS)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mweupt.f,v $
     . $',                                                             '
     .$Id: mweupt.f,v 1.2 1998/07/02 21:00:58 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA BLANK8/'        '/,SLASH/'/       '/
      DATA MODNAM/'WEUPDATE'/,KEY/'VAR ','GAIN'/
C
      CALL FSTWHR(8HMWEUPT  ,0,OLDOPN,IOLDOP)
C
C     SET DEBUG SWITCH
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HWEUP)
C
      IF(IBUG.GT.0)WRITE(IPR,10)IDATE
10    FORMAT(1H0,10X,'** IN SUBROUTINE MWEUPT - IDATE = ',I11)
C
      ICOMP=((LDACPD-1)*24)+LHRCPD
      IF (IDATE.LE.ICOMP) GOTO 20
         IF (MODWRN.EQ.0) GOTO 350
         ITYPE=2
         CALL MODS1(NCARDS,ICMND,MODNAM,MODCRD,ITYPE)
         GOTO 350
C
C     SEE IF DATE IS WITHIN START OR END OF RUN
C
20    CONTINUE
C
      ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
C
      IF(ISTHR-12.LE.IDATE.AND.IENHR+12.GE.IDATE) GOTO 50
C
C     DATE NOT WITHIN ALLOWABLE WINDOW
C
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,30)IM3,ID3,IY3,IH3,MODTZC,IM1,ID1,IY1,IH1,MODTZC,
     1IM2,ID2,IY2,IH2,MODTZC
30    FORMAT(1H0,10X,'**WARNING** THE DATE FOR CHANGES ENTERED IN THE ',
     1 'WEUPDATE MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'IS NOT WITHIN 12 HOURS OF THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
      WRITE(IPR,40)(MODCRD(I,NRDCRD),I=1,20)
40    FORMAT(15X,'THE MOD CARD IMAGE IS: ',20A4)
      IF(MODWRN.EQ.1)CALL WARN
      GOTO 350
C
50    IF(IUMGEN.EQ.1) GOTO 60
C
C     MUST CONVERT UNITS FROM INCHES TO MM
C
      CALL FCONVT(4HMM  ,4HL   ,ENGUN,AMM2IN,BMM2IN,IER)
C
C     READ MOD CARDS FOR THIS SEGMENT - STORE VALUES IN ARRAYS() -
C     WILL TRANSFER TO CB /FSKDATA/ AFTER ALL INFO IS READ
C
C     READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
60    FIRST=.TRUE.
C
      IF(NRDCRD.EQ.NCARDS) GOTO 80
C
70    IF(NRDCRD.EQ.NCARDS) GOTO 350
C
      OPNAME=BLANK8
C
      IF(MISCMD(NCARDS,MODCRD).EQ.0) GOTO 100
C
      IF(.NOT.FIRST) GOTO 350
C
C     HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
80    IF (MODWRN.EQ.1) WRITE(IPR,90)
90    FORMAT(1H0,10X,'**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'WEUPDATE MOD.  PROCESSING CONTINUES')
      IF (MODWRN.EQ.1) CALL WARN
      GOTO 350
C
100   FIRST=.FALSE.
      NRDCRD=NRDCRD+1
C
C     NOW READ THE 2ND FIELD - MUST BE AN INTEGER OR REAL NUMBER
C
      IOPTION=0
      NFLD=1
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
      VALUE2=-99.0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,VALUE1,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ITYPE.NE.-1) GOTO 130
C
110   IF(MODWRN.EQ.1)WRITE(IPR,120)(MODCRD(I,NRDCRD),I=1,20)
120   FORMAT(1H0,10X,'**WARNING** IN THE WEUPDATE MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THE CARD BEING PROCESSED IS:'/
     2  11X,20A4)
      GOTO 340
C
130   IF(ITYPE.LT.2.AND.NREP.EQ.-1) GOTO 150
C
C     VALUE1 IS NEITHER AN INTEGER NOR A REAL NUMBER
C     AND REPEATED FACTOR (I.E. 5*9.99) IS NOT ALLOWED
C
      IF (MODWRN.EQ.1) WRITE(IPR,140) (MODCRD(I,NRDCRD),I=1,20)
140   FORMAT(1H0,10X,'**WARNING** A NONNUMERIC VALUE WAS DECODED ',
     1  'WHERE ONE WAS EXPECTED'/11X,'THE CURRENT MOD CARD IS'/11X,20A4)
      GOTO 340
C
C     SEE IF THERE IS ANOTHER FIELD - IF NOT PROCESS THE INFO
C     IN ARRAYS() - IF SO IT MUST BE A KEYWORD OR A SLASH (/)
C
150   IF (VALUE1.LT.0.0.OR.VALUE1.GT.20.0) THEN
         IF (MODWRN.EQ.1) WRITE(IPR,220) VALUE1 
         GOTO 340
         ENDIF
C
220   FORMAT(1H0,10X,'**WARNING** IN WEUPDATE MOD - VALUE IS OUT OF ',
     1 'VALID RANGE '/11X,'VALUE = ',G10.4)
C
      ISTRT=-3
      IFIELD=' '
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ISTRT.EQ.-2) GOTO 200
C
C     ANOTHER FIELD - IS IT A SLASH ? - IS NOT SEE IF A KEYWORD
C
      IF (IFIELD.EQ.KEY(1).OR.IFIELD.EQ.KEY(2)) GOTO 161
      IF(IFIELD.EQ.SLASH.AND.LEN.EQ.1) GOTO 170
C
      IF(MODWRN.EQ.1)WRITE(IPR,160)(MODCRD(I,NRDCRD),I=1,20)
160   FORMAT(1H0,10X,'**WARNING** IN THE WEUPDATE MOD - AN INVALID ',
     1  'FIELD WAS FOUND ON THE FOLLOWING MOD CARD'/11X,20A4)
      GOTO 340
C
C  KEYWORD OF 'VAR' OR 'GAIN' FOUND, DECODE VALUE
C   
161   KEYWRD=' '
      KEYWRD=IFIELD(1:4) 
      IF (KEYWRD.EQ.'VAR') IOPTION=1
      IF (KEYWRD.EQ.'GAIN') IOPTION=2
      ISTRT=-3
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,VALUE2,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ITYPE.LT.2.AND.NREP.EQ.-1) GOTO 162
C
C     VALUE2 IS NEITHER AN INTEGER NOR A REAL NUMBER
C     AND REPEATED FACTOR (I.E. 5*9.99) IS NOT ALLOWED
C
      IF(MODWRN.EQ.1) WRITE(IPR,140) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 340
C
C  LOOK FOR A SLASH AFTER VALUE ASSOCIATE WITH EITHER 'VAR' OR 'GAIN'
C 
162   CONTINUE
C
C  CHECK TO SEE IF THE GAIN IS VALID
C
      IF (KEYWRD.EQ.'GAIN') THEN
         IF (VALUE2.LT.0.0.OR.VALUE2.GT.1.0) THEN
            IF (MODWRN.EQ.0) GOTO 340
            WRITE (IPR,163) (MODCRD(I,NRDCRD),I=1,20)           
            GOTO 340
            ENDIF
         ENDIF
163   FORMAT(1H0,10X,'**WARNING** IN THE WEUPDATE MOD - AN INVALID ',
     1'KALMAN GAIN WAS FOUND ON THE FOLLOWING MOD CARD:',/,11X,20A4)
C 
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ISTRT.EQ.-2) GOTO 200
C 
      IF (IFIELD.EQ.SLASH.AND.LEN.EQ.1) GOTO 170
C
      IF (MODWRN.EQ.1) WRITE(IPR,160) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 340
C 

C     GET HERE IF FIELD IS A SLASH
C     NOW READ NEXT FIELD - OPERATION NAME
C
170   ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,OPNAME,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ISTRT.NE.-2) GOTO 190
C
      WRITE (IODBUG,180) (MODCRD(I,NRDCRD),I=1,20)
180   FORMAT(11X,'** WARNING ** NO OPERATION NAME ENTERED ',
     1 'AFTER A SLASH ON THE FOLLOWING MOD CARD'/11X,20A4/
     2 11X,'THIS CARD IS IGNORED.')
      GOTO 340
C
190   CONTINUE
C
C  CONVERT TO MM IF NEEDED
C
200   IF (IUMGEN.EQ.0) VALUE1=VALUE1/AMM2IN 
C
C     SEE IF ANY SETS OF CARRYOVER IN CB /FSKDATA/
C
      IF(NRAKSW.GT.0) GOTO 250
C
C     NONE IN CB - JUST ADD THIS WATER EQUIVALENT TO CB
C
      NRAKSW=1
      CALL UMEMOV(OPNAME,RAREKW(1,1),2)
      RAREKW(3,1)=IDATE
      RAREKW(4,1)=VALUE1
      RAREKW(5,1)=-99.0
      RAREKW(6,1)=-99.0
      IF (IOPTION.EQ.1) RAREKW(5,1)=VALUE2
      IF (IOPTION.EQ.2) RAREKW(6,1)=VALUE2
C
      IF (IBUG.GT.0) WRITE(IODBUG,240) VALUE1
240   FORMAT(11X,'WATER EQUIVALENT VALUE OF ',G10.2,' MM ',
     1 'STORED IN THE 1ST ROW OF ARRAY RAREKW.')
      GOTO 70
C
C     CHECK IF NAME MATCHES ANY NAME IN CB OR IS BLANK -
C       AND IF DATE MATCHES ANY DATE IN CB
C
250   DO 280 I=1,NRAKSW
      IF (IUSAME(OPNAME,RAREKW(1,I),2).EQ.0) GOTO 280
C
C     NAME IN CB MATCHES NAME TO BE STORED
C     NOW SEE IF DATES MATCH
C
      IDTCHK=RAREKW(3,I)
      IF (IDTCHK.NE.IDATE) GOTO 280
C
C
      RAREKW(4,I)=VALUE1
      DO 260 J=5,6
260   RAREKW(J,I)=-99.0
      IF (IOPTION.EQ.1) RAREKW(5,I)=VALUE2
      IF (IOPTION.EQ.2) RAREKW(6,I)=VALUE2
C
      IF (IBUG.GT.0) WRITE(IODBUG,270) VALUE,I
270   FORMAT(11X,'WATER EQUIVALENT VALUE OF ',G10.2,' MM ',
     1 'REPLACED IN THE ROW ',I2,' OF ARRAY RAREKW.')
      GOTO 70
C
280   CONTINUE
C
C     HAVE NOT FOUND MATCH FOR NAME AND DATE -
C     ADD NEW ENTRY TO CB
C
      IF(NRAKSW.LT.10) GOTO 300
C
C     NOT ENOUGH ROOM IN CB
C
      IF(MODWRN.EQ.1)WRITE(IPR,290)(MODCRD(I,NRDCRD),I=1,20)
290   FORMAT(1H0,10X,'**WARNING** NOT ENOUGH ROOM IN COMMON BLOCK ',
     1 '/FRARSW/'/11X,'TO HOLD A NEW WATER EQUIVALENT.  THE CURRENT ',
     2 'MOD CARD IMAGE IS'/11X,20A4)
      GOTO 340
C
C     ENOUGH ROOM - ADD NEW ENTRY TO CB
C
300   NRAKSW=NRAKSW+1
      I=NRAKSW
      CALL UMEMOV(OPNAME,RAREKW(1,I),2)
      RAREKW(3,I)=IDATE+0.01
      RAREKW(4,I)=VALUE1
      DO 310 J=5,6
310   RAREKW(J,I)=-99.0
      IF (IOPTION.EQ.1) RAREKW(5,I)=VALUE2
      IF (IOPTION.EQ.2) RAREKW(6,I)=VALUE2
C
      IF (IBUG.GT.0) WRITE (IODBUG,330) VALUE1,I
330   FORMAT(11X,'WATER EQUIVALENT VALUE OF ',G10.2,' MM ',
     1 'ADDED IN THE ROW ',I2,' OF ARRAY RAREKW.')
      GOTO 70
C
340   IF (MODWRN.EQ.1) CALL WARN
      GOTO 70
C
350   IF (IBUG.EQ.0) GOTO 380
C
      WRITE (IODBUG,360) NRAKSW
360   FORMAT(11X,'***LEAVING SUBROUTINE MWEUPT*** NRAKSW=',I3)
      IF(NRAKSW.GT.0)WRITE(IODBUG,370)((RAREKW(I,J),I=1,6),J=1,NRAKSW)
370   FORMAT(11X,'ARRAY RAREKW ='/(11X,2A4,1X,F11.0,3F9.2))
C
380   CALL FSTWHR (OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      RETURN
      END
