C MODULE MSWTCH
C-----------------------------------------------------------------------
C
C  PERFORMS THE SWITCHTS MOD
C
      SUBROUTINE MSWTCH(MP,P,NCARDS,MODCRD,IIDATE,LLDATE,KKDATE,IHZERO)
C
      LOGICAL FIRST
      CHARACTER*8 OPNAME,IFIELD,SLASH,BLANK8,MODNAM
C
      CHARACTER*8 OPN30
      REAL*4 KEY30
      DIMENSION P(MP)
      COMMON/MOD130/NDT30,KEY30(10),OPN30(10),IDT30(10),LDT30(10)
C
      INCLUDE 'common/fmodft'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'ufreex'
C
      DIMENSION KWRDS(2),MODCRD(20,NCARDS)
      DIMENSION OLDOPN(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mswtch.f,v $
     . $',                                                             '
     .$Id: mswtch.f,v 1.2 1998/07/02 21:02:38 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA KWRDS /4HPCPN,4HINSQ/
      DATA MODNAM/'SWITCHTS'/
      DATA SLASH/'/       '/,BLANK8/'        '/
C
      CALL FSTWHR(8HSWITCHTS,0,OLDOPN,IOLDOP)
C
C     SET DEBUG SWITCH
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HSWIT)
C
      IF(IBUG.GT.0)WRITE(IODBUG,10)IIDATE,LLDATE,KKDATE
10    FORMAT(1H0,10X,'*** SUBROUTINE MSWTCH ENTERED ***  IIDATE=',I11,
     1 ', LLDATE=',I11,', KKDATE=',I11)
C
      FIRST=.TRUE.
      IDATE=IABS(IIDATE)
      LDATE=IABS(LLDATE)
      KDATE=IABS(KKDATE)
      IFLAG=0
      IJUMP=0
C
C     NOW SEE IF LSTCMPDY VALUE EQUAL LASTCMPDATE VALUE
C
      ICOMP=((LDACPD-1)*24)+LHRCPD
C
      IF (KDATE.EQ.ICOMP) GOTO 20
      IF (KDATE.LT.ICOMP.AND.IDATE.LE.KDATE) GOTO 20
C
      IF (MODWRN.EQ.0) GOTO 410
      ITYPE=4
      CALL MODS1(NCARDS,ICMND,MODNAM,MODCRD,ITYPE)
      GOTO 410
C
C     SEE IF DATE IS WITHIN RUN PERIOD
C
20    ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
C
      IF(IDATE.GT.IENHR.OR.LDATE.LT.ISTHR) GOTO 30
      IF (IDATE.LE.ISTHR) THEN
C     find the smallest time interval for merge-ts ops in this segment 
C     changes made to set correct start hour - dp - June 1998
         locopn=1
         nummrg = 0
         icase  = 0
         intrvl = 24
22       call fserch(30,nxtnam,locopn,p,mp)
C
         if(locopn.gt.0) then
            nummrg = nummrg + 1            
            intrv1 = p(locopn-1+6)
            icase  = p(locopn-1+11)
            if((icase.eq.1).and.(intrv1.lt.intrvl)) then
               intrvl = intrv1
            endif
            goto 22
         else
            if(nummrg.gt.0) then
               goto 24
            endif
         endif
C
C        SHOULD NEVER GET HERE - MEANS PROBLEM IN P ARRAY
C
         INTRVL = 6
         IF(MODWRN.EQ.1)
     .   WRITE(IPR,23)NXTNAM
23       FORMAT(1H0,10X,'** WARNING ** IN SWTCHTS MOD - CANNOT FIND ',
     1    'MERGE-TS OPERATION ',A8,' IN THE P ARRAY.')
         GO TO 440
C  Adjust start date to be starthour + 1 time interval        
24       IDATE=ISTHR+INTRVL
         IF (MODWRN.EQ.1) THEN
            WRITE(IPR,25)
            IFLAG=1
            ENDIF
         ENDIF
      IF (LDATE.GT.IENHR) THEN
         LDATE=IENHR
         IF (MODWRN.EQ.1.AND.IFLAG.EQ.0) THEN
            WRITE(IPR,25)
            IFLAG=1
            ENDIF
         ENDIF
      IF (KDATE.EQ.ICOMP) GOTO 35
      IF (KDATE.LT.LDATE) THEN
         LDATE=KDATE
         IF (IDATE.GT.LDATE) THEN
            IJUMP=1
            ENDIF
         IF (MODWRN.EQ.1) THEN
            WRITE(IPR,15)
            IFLAG=1
            ENDIF
         ENDIF
35    IF (IFLAG.NE.0) THEN
         WRITE(IPR,45) (MODCRD(I,NRDCRD),I=1,20)
         CALL WARN
         IF (IJUMP.EQ.1) GOTO 410
         ENDIF
15    FORMAT(1H0,10X,'**WARNING**  CHANGES TO FUTURE PERIODS WILL',
     1 ' BE IGNORED BECAUSE THE EFFECTIVE DATE IS NOT EQUAL TO',
     2 ' LSTCMPDY VALUE.')
25    FORMAT(1H0,10X,'**WARNING** PORTION OF MOD IS NOT WITHIN THE',
     1 ' CURRENT RUN PERIOD AND WILL BE IGNORED.')
45    FORMAT(23X,'THE MOD CARD IMAGE IS:  ',20A4)
      GOTO 40
C
C     PERIOD FOR CHANGES NOT WITHIN RUN PERIOD
C
30    IF(MODWRN.EQ.0)GO TO 410
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
      LXDA=LDATE/24+1
      LXHR=LDATE-(LXDA-1)*24
      IF(LXHR.EQ.0)LXDA=LXDA-1
      IF(LXHR.EQ.0)LXHR=24
      CALL MDYH2(LXDA,LXHR,IM4,ID4,IY4,IH4,DUM1,DUM2,MODTZC)
C
      WRITE(IPR,85)IM3,ID3,IY3,IH3,MODTZC,IM4,ID4,IY4,IH4,MODTZC,
     1IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC
85    FORMAT(1H0,10X,'**WARNING** THE DATES FOR CHANGES IN THE ',
     1 'SWITCHTS MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,
     1 4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'ARE NOT WITHIN THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
      CALL WARN
      GO TO 410
C
40    CONTINUE
C
C     READ MOD CARDS FOR THIS SEGMENT - STORE VALUES IN ARRAYS() -
C      WILL TRANSFER TO CB /MOD130/ AFTER ALL INFO IS READ
C
C     READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
      FIRST=.TRUE.
C
      IF(NRDCRD.EQ.NCARDS)GO TO 80
C
70    IF(NRDCRD.EQ.NCARDS)GO TO 410
C
      OPNAME=BLANK8
C
      IF(MISCMD(NCARDS,MODCRD).EQ.0)GO TO 100
C
      IF(.NOT.FIRST)GO TO 410
C
C     HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
80    IF(MODWRN.EQ.1)
     .WRITE(IPR,90)
90    FORMAT(1H0,10X,'**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'SWITCHTS MOD.  PROCESSING CONTINUES')
      IF(MODWRN.EQ.1) CALL WARN
      GO TO 410
C
100   FIRST=.FALSE.
C
      NRDCRD=NRDCRD+1
C
C     NOW READ 2ND FIELD - MUST BE KEYWORD
C
      NFLD=1
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IVALUE,VALUE,
     1  NCHAR,ISECND,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 140
C
C     ERROR - DATA EXPECTED - PROCESS NEXT CARD
C
120   IF(MODWRN.EQ.1)
     .WRITE(IPR,130)(MODCRD(I,NRDCRD),I=1,20)
130   FORMAT(1H0,10X,'**WARNING** IN THE SWITCHTS MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THE CARD BEING PROCESSED IS:'/
     2  11X,20A4)
      IF(MODWRN.EQ.1) CALL WARN
      GO TO 70
C
140   DO 150 I=1,2
      IKEY=I
      IF(KWRDS(I).EQ.ISECND)GO TO 170
150   CONTINUE
      IF(MODWRN.EQ.1)
     .WRITE(IPR,160)(MODCRD(I,NRDCRD),I=1,20)
160   FORMAT(1H0,10X,'**WARNING** IN THE SWITCHTS MOD - AN INVALID ',
     1  'KEYWORD FOUND ON THE FOLLOWING MOD CARD'/11X,20A4)
      IF(MODWRN.EQ.1) CALL WARN
      GO TO 70
C
170   CONTINUE
C
C     SEE IF THERE IS ANOTHER FIELD - IF NOT PROCESS THE INFO
C     IN ARRAYS() - IF SO IT MUST BE A KEYWORD OR A SLASH (/)
C
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 220
C
C     ANOTHER FIELD - IS IT A SLASH ? - IS NOT SEE IF A KEYWORD
C
      IF(IFIELD.NE.SLASH)GO TO 140
C
C     GET HERE IF FIELD IS A SLASH
C     NOW READ NEXT FIELD - OPERATION NAME
C
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 210
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IODBUG,200)(MODCRD(I,NRDCRD),I=1,20)
200   FORMAT(11X,'** WARNING ** NO OPERATION NAME ENTERED ',
     1 'AFTER A SLASH ON THE FOLLOWING MOD CARD'/11X,20A4/
     2 11X,'THIS CARD IS IGNORED.')
      CALL WARN
      GO TO 70
210   CONTINUE
C
      OPNAME=IFIELD
C
C     SEE IF ANY SETS OF CARRYOVER IN CB /MOD130/
C
220   IF(NDT30.GT.0) GOTO 300
C
C     NONE IN CB - JUST ADD THIS CARRYOVER TO CB
C
      NDT30=1
      CALL UMEMOV(OPNAME,OPN30(1),2)
      CALL UMEMOV(KWRDS(IKEY),KEY30(1),1)
      CALL UMEMOV(IDATE,IDT30(1),1)
      CALL UMEMOV(LDATE,LDT30(1),1)
      GO TO 70
C
300   CONTINUE
      IDATE1=IDATE
      LDATE1=LDATE
      CALL MSWTC1(OPNAME,KWRDS(IKEY),IDATE1,LDATE1,IERR)
      IF (IERR.LT.2) GOTO 70
C
C     CHECK IF OPNAME MATCHES ANY OPNAMES IN CB OR IS BLANK -
C
C     DO 340 I=1,NDT30
C     IF(IUSAME(OPNAME,OPN30(I),2).EQ.0) GOTO 340
C
C     NAME IN CB MATCHES NAME TO BE STORED
C     NOW SEE IF KEYWORD MATCHES TOO
C
C     IF(IUSAME(KWRDS(IKEY),KEY30(I),1).EQ.0) GOTO 340
C
C     KEYWORD MATCHES TOO - ADD INFO TO THIS SPOT IN CB
C
C     IF (IDT30(I).GT.IDATE) IDT30(I)=IDATE
C     IF (LDT30(I).LT.LDATE) LDT30(I)=LDATE
C     GO TO 70
C
C340  CONTINUE
C
C     HAVE NOT FOUND MATCH FOR NAME AND DATE -
C     ADD NEW ENTRY TO CB
C
      IF(NDT30.LT.10)GO TO 360
C
C     NOT ENOUGH ROOM IN CB
C
      IF(MODWRN.EQ.1) WRITE(IPR,350)
350   FORMAT(1H0,10X,'**WARNING** NOT ENOUGH ROOM IN COMMON BLOCK ',
     1 '/MOD130/'/11X,'TO HOLD A NEW ENTRY OF SWITCHTS MOD.')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 70
C
360   CONTINUE
C
C     ENOUGH ROOM - ADD NEW ENTRY TO CB
C
      NDT30=NDT30+1
      CALL UMEMOV(OPNAME,OPN30(NDT30),2)
      CALL UMEMOV(KWRDS(IKEY),KEY30(NDT30),1)
      CALL UMEMOV(IDATE1,IDT30(NDT30),1)
      CALL UMEMOV(LDATE1,LDT30(NDT30),1)
      GO TO 70
C
410   IF(IBUG.EQ.0)GO TO 440
C
      WRITE(IODBUG,420)NDT30
420   FORMAT(11X,'IN SWITCHTS MOD - LEAVING SUBROUTINE MSWTCH - ',
     1 'NDT30 = ',I3)
      IF(NDT30.GT.0)WRITE(IODBUG,430)(OPN30(I),I=1,NDT30)
      IF(NDT30.GT.0)WRITE(IODBUG,431)(KEY30(I),I=1,NDT30)
      IF(NDT30.GT.0)WRITE(IODBUG,432)(IDT30(I),I=1,NDT30)
      IF(NDT30.GT.0)WRITE(IODBUG,433)(LDT30(I),I=1,NDT30)
430   FORMAT(2X,'OPN30 = ',10(A8,2X))
431   FORMAT(2X,'KEY30 = ',10(A4,6X))
432   FORMAT(2X,'IDT30 = ',10(I9,1X))
433   FORMAT(2X,'LDT30 = ',10(I9,1X))
C
440   CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      RETURN
      END
