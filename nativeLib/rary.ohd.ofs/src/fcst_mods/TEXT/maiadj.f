C  MODULE MAIADJ
C
C  DESC - PERFORMS THE AIADJ MOD
C
      SUBROUTINE MAIADJ(NCARDS,MODCRD,P,MP,IDATE,ISTATT,IHZERO)
C
      CHARACTER*8   OPNAME,OPN,BLANK8,OPTYPE,TCONT,TMKC
      LOGICAL FIRST
      INCLUDE 'ufreex'
      INCLUDE 'common/fmodft'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'common/fpwarn'
C
      DIMENSION MODCRD(20,NCARDS),P(MP),IFIELD(3)
      DIMENSION OLDOPN(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/maiadj.f,v $
     . $',                                                             '
     .$Id: maiadj.f,v 1.2 1998/07/02 20:35:21 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA ISLASH/4H/   /,BLANK8/8H        /
      DATA TCONT/8HAPI-CONT/,TMKC/8HAPI-MKC /
C
      CALL FSTWHR('MAIADJ  ',0,OLDOPN,IOLDOP)
C
C  SET DEBUG SWITCH
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HAIAD)
C
      IF(IBUG.GT.0)WRITE(IODBUG,900)IDATE
  900 FORMAT(1H0,10X,'IN SUBROUTINE MAIADJ, IDATE=',I11)
C
      ISTATT=1
C
C  SEE IF DATE IS WITHIN RUN PERIOD
C
      ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
C
      IF(ISTHR.LE.IDATE.AND.IENHR.GE.IDATE)GO TO 11
C
C  DATE NOT WITHIN ALLOWABLE WINDOW
C
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,602)IM3,ID3,IY3,IH3,MODTZC,IM1,ID1,IY1,IH1,MODTZC,
     1 IM2,ID2,IY2,IH2,MODTZC
  602 FORMAT(1H0,10X,'**WARNING** THE DATE FOR CHANGES ENTERED IN THE ',
     1 'AIADJ MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'IS NOT WITHIN THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 999
C
   11 CONTINUE
C
C  READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
      OPNAME=BLANK8
      OPN=BLANK8
      FIRST=.TRUE.
C
      IF(NRDCRD.EQ.NCARDS)GO TO 13
C
    1 IF(NRDCRD.EQ.NCARDS)GO TO 999
C
      IF(MISCMD(NCARDS,MODCRD).EQ.0)GO TO 17
C
      IF(.NOT.FIRST)GO TO 999
C
C  HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
   13 IF(MODWRN.EQ.1)
     .WRITE(IPR,920)
  920 FORMAT(1H0,10X,'**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'AIADJ MOD.  PROCESSING CONTINUES')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 999
C
   17 FIRST=.FALSE.
      NRDCRD=NRDCRD+1
C
C  NOW READ 2ND FIELD - MUST BE A REAL NO. OR INTEGER
C
      NFLD=1
      ISTRT=-3
      NCHAR=3
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IVALUE,VALUE,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(IBUG.GT.0)WRITE(IODBUG,847)NFLD,ISTRT,LEN,ITYPE,NREP,
     1 IVALUE,VALUE,IFIELD,ISTAT
  847 FORMAT(11X,'AFTER CALL TO UFIEL2 - LOOKING FOR VALUE'/
     1 11X,'NFLD,ISTRT,LEN,ITYPE,NREP,IVALUE,VALUE,IFIELD,ISTAT='/
     2 11X,I3,I6,I4,I6,I5,I7,F6.1,1X,3A4,1X,I3)
C
      IF(ISTRT.NE.-2)GO TO 28
C
C  ERROR - DATA EXPECTED - PROCESS NEXT CARD
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,921)(MODCRD(I,NRDCRD),I=1,20)
  921 FORMAT(1H0,10X,'**WARNING** IN THE AIADJ MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THE CARD BEING PROCESSED IS:'/
     2  11X,20A4)
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 1
C
   28 IF(ITYPE.LT.2.AND.NREP.EQ.-1)GO TO 40
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,922)(MODCRD(I,NRDCRD),I=1,20)
  922 FORMAT(1H0,10X,'**WARNING** IN AIADJ MOD - INVALID VALUE FOUND ',
     1  'THE CARD BEING PROCESSED IS:'/11X,20A4)
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 1
C
C  CONVERT TO INCHES IF NEEDED
C
   40 IF(IUMAPI.EQ.0)GO TO 111
C
C  MUST CONVERT FROM MM TO INCHES
C
      CALL FCONVT(4HMM  ,4HL   ,ENGUN,AMM2IN,BMM2IN,IER)
C
      VALUE=VALUE*AMM2IN
C
C  LOOK FOR API OPERATIONS IN THIS SEGMENT WITH NAME OPNAME
C  IF OPNAME IS BLANK - CHANGE FOR ALL API OPERATIONS IN THIS SEGMENT
C
C  READ NEXT FIELD - IF NONE CHANGE ALL API OPERATIONS IN SEGMENT
C  IF A SLASH FOUND - READ OPERATION NAME IN FOLLOWING FIELD
C
  111 ISTRT=-3
      NCHAR=3
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTEGR,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 20
C
C  FIELD FOUND - MUST BE A SLASH
C
      IF(LEN.EQ.1.AND.IFIELD(1).EQ.ISLASH)GO TO 55
C
C  FIELD IS NOT SLASH - ERROR
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,930)(MODCRD(I,NRDCRD),I=1,20)
  930 FORMAT(1H0,10X,'**WARNING** A SLASH WAS EXPECTED AS THE THIRD ',
     1 'FIELD OF THE FOLLOWING MOD CARD:'/11X,20A4,/11X,
     2 'THIS CARD IS IGNORED AND PROCESSING CONTINUES')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 1
C
   55 CONTINUE
C
C  SLASH FOUND - NOW READ OPERATION NAME
C
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTEGR,REAL,
     1  NCHAR,OPNAME,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 57
C
C  NO FIELD FOUND FOR OPERATION NAME - ERROR
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,933)(MODCRD(I,NRDCRD),I=1,20)
  933 FORMAT(1H0,10X,'**WARNING** NO OPERATION NAME WAS FOUND AFTER ',
     1 'THE SLASH ON THE FOLLOWING MOD CARD:'/11X,20A4/11X,
     2 'THIS CARD IS IGNORED AND PROCESSING CONTINUES')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 1
C
C  HAVE A SPECIFIC OPERATION NAME - FIND THAT OPERATION
C
   57 LOCP=0
      IOP=24
      CALL FSERCH(IOP,OPNAME,LOCP,P,MP)
      IF (LOCP.GT.0) GO TO 18
      IOP=29
C
      CALL FSERCH(IOP,OPNAME,LOCP,P,MP)
C
      IF(LOCP.GT.0)GO TO 18
      IOP=33
C
      CALL FSERCH(IOP,OPNAME,LOCP,P,MP)
C
      IF(LOCP.GT.0)GO TO 18
C
C  HAVE NOT FOUND THE REQUESTED OPERATION - ERROR
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,605)OPNAME
  605 FORMAT(1H0,10X,'**WARNING** NO API-CONT, API-MKC OR API-CIN ',
     1 'OPERATION WITH NAME ',A8,' HAS NOT BEEN FOUND IN THIS SEGMENT.',
     2 /11X,'THE AIADJ MOD CANNOT BE PERFORMED FOR THIS SEGMENT.')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 1
C
   18 CONTINUE
C
C  BRANCH TO PROPER RANGE CHECKS DEPENDING ON OPERATION TYPE
C    (API-CONT - NUMBER 24, API-MKC - NUMBER 29 OR API-CIN - NUMBER 33)
C
      IF(IOP.EQ.33)GO TO 120
      IF (IOP.EQ.24) OPTYPE=TCONT
      IF (IOP.EQ.29) OPTYPE=TMKC
C
      IF(VALUE.GE.-5.0.AND.VALUE.LE.5.0)GO TO 115
C
C  BAD AI VALUE ENTERED
C
      IF(MODWRN.EQ.1)WRITE(IPR,604) OPTYPE,VALUE
  604 FORMAT(1H0,10X,'**WARNING** IN AIADJ MOD - VALUE IS OUT OF ',
     1 'VALID RANGE FOR ',A8,' OPERATION '/11X,'VALUE ENTERED AS ',
     2 G10.4)
C
      IF(VALUE.GT.5.0)VALUE=5.0
      IF(VALUE.LT.-5.0)VALUE=-5.0
      IF(MODWRN.EQ.1)WRITE(IPR,607)VALUE
  607 FORMAT(11X,'VALUE RESET TO ',F4.1)
      IF(MODWRN.EQ.1)CALL WARN
C
  115 CONTINUE
      IF (IOP.EQ.29) GO TO 119
C     NO CONVERSION FOR API-CONT
      PVALUE=VALUE
      GO TO 130
C
C  CONVERT VALUE TO INTEGER IN TENTHS AND ADD 0.01
C  THIS WILL BE THE WAY THE AI VALUE IS STORED IN P()
C
  119 IVAL=ABS(VALUE)*10.0+0.5
      PVALUE=IVAL+0.01
      IF(VALUE.LT.0.0)PVALUE=-PVALUE
      GO TO 130
C
  120 IF(VALUE.GE.-4.0.AND.VALUE.LE.4.0)GO TO 125
C
C  BAD AI VALUE ENTERED
C
      IF(MODWRN.EQ.1)WRITE(IPR,614)VALUE
  614 FORMAT(1H0,10X,'**WARNING** IN AIADJ MOD - VALUE IS OUT OF ',
     1 'VALID RANGE FOR API-CIN OPERATION '/11X,'VALUE ENTERED AS ',
     2 G10.4)
C
      IF(VALUE.GT.4.0)VALUE=4.0
      IF(VALUE.LT.-4.0)VALUE=-4.0
      IF(MODWRN.EQ.1)WRITE(IPR,607)VALUE
C
  125 PVALUE=VALUE
C
C  HAVE FOUND OPERATION - CHANGE VALUE IN P ARRAY
C
  130 IF (IOP.NE.24) GO TO 135
      P(LOCP+24)=PVALUE
      GO TO 140
  135 P(LOCP+11)=PVALUE
  140 ISTATT=0
C
      IF(IBUG.GT.0)WRITE(IODBUG,902)PVALUE,IOP,OPNAME
  902 FORMAT(11X,'IN AIADJ MOD - SUBROUTINE MAIADJ'/11X,
     1 'A VALUE OF ',F8.2,' HAS BEEN STORED IN THE P ARRAY OF ',
     2 'OPERATION ',I2,' NAMED ',A8,' AS THE AI ADJUSTMENT.')
      GO TO 1
C
   20 CONTINUE
C
C  CHANGE ALL OCCURENCES OF API-CONT, API-MKC OR API-CIN OPERATION
C  IN THIS SEGMENT
C
      NCHNGE=0
      IOP=24
   25 LOCP=1
   30 CALL FSERCH(IOP,OPN,LOCP,P,MP)
C
      IF(LOCP.EQ.0.AND.NCHNGE.GT.0.AND.IOP.EQ.33)GO TO 1
      IF(LOCP.GT.0)GO TO 35
      IF(IOP.EQ.33)GO TO 33
      IF (IOP.EQ.29) GO TO 31
      IOP=29
      GO TO 25
   31 IOP=33
      GO TO 25
C
C  IF GET HERE HAVE NOT FOUND ANY API-CONT, API-MKC OR API-CIN OPERATION
C
   33 IF(MODWRN.EQ.1)
     .WRITE(IPR,606)
  606 FORMAT(1H0,10X,'**WARNING** AN AIADJ MOD WAS REQUESTED FOR ',
     1 'THIS SEGMENT'/11X,'BUT NO API-CONT, API-MKC OR API-CIN ',
     2 'OPERATIONS WERE FOUND.')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 999
C
   35 CONTINUE
C
C  BRANCH TO PROPER RANGE CHECKS DEPENDING ON OPERATION TYPE
C    (API-CONT - NUMBER 24, API-MKC - NUMBER 29 OR API-CIN - NUMBER 33)
C
      IF(IOP.EQ.33)GO TO 220
      IF (IOP.EQ.24) OPTYPE=TCONT
      IF (IOP.EQ.29) OPTYPE=TMKC
C
      IF(VALUE.GE.-5.0.AND.VALUE.LE.5.0)GO TO 215
C
C  BAD AI VALUE ENTERED
C
      IF(MODWRN.EQ.1)WRITE(IPR,604) OPTYPE,VALUE
C
      IF(VALUE.GT.5.0)VALUE=5.0
      IF(VALUE.LT.-5.0)VALUE=-5.0
      IF(MODWRN.EQ.1)WRITE(IPR,607)VALUE
      IF(MODWRN.EQ.1)CALL WARN
C
  215 CONTINUE
C
      IF (IOP.EQ.29) GO TO 219
C
C   NO CONVERSION FOR API-CONT
C
      PVALUE=VALUE
      GO TO 230
C
C  CONVERT VALUE TO INTEGER IN TENTHS AND ADD 0.01
C  THIS WILL BE THE WAY THE AI VALUE IS STORED IN P()
C
  219 IVAL=ABS(VALUE)*10.0+0.5
      PVALUE=IVAL+0.01
      IF(VALUE.LT.0.0)PVALUE=-PVALUE
      GO TO 230
C
  220 IF(VALUE.GE.-4.0.AND.VALUE.LE.4.0)GO TO 225
C
C  BAD AI VALUE ENTERED
C
      IF(MODWRN.EQ.1)WRITE(IPR,614)VALUE
C
      IF(VALUE.GT.4.0)VALUE=4.0
      IF(VALUE.LT.-4.0)VALUE=-4.0
      IF(MODWRN.EQ.1)WRITE(IPR,607)VALUE
C
  225 PVALUE=VALUE
C
C  HAVE FOUND AN API-CONT, API-MKC OR API-CIN OPERATION - CHANGE P ARRAY
C
  230 NCHNGE=NCHNGE+1
      IF (IOP.NE.24) GO TO 235
      P(LOCP+24)=PVALUE
      GO TO 240
  235 P(LOCP+11)=PVALUE
  240 ISTATT=0
C
      IF(IBUG.GT.0)WRITE(IODBUG,902) PVALUE,IOP,OPN
      GO TO 30
C
  999 CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      IF(IBUG.GT.0)WRITE(IODBUG,919)
  919 FORMAT(11X,'***LEAVING MAIADJ***')
      RETURN
      END
