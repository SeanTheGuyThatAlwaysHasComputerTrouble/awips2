C     MODULE MBSHFT
C-----------------------------------------------------------------------
C
C
C     DESC - PERFORMS THE BUBLSHFT MOD
C
      SUBROUTINE MBSHFT(NCARDS,MODCRD,IIDATE,LLDATE,IHZERO)
C
      LOGICAL FIRST
C
      CHARACTER*8 ALLRC,RCID,IFIELD,BLANK8,SLASH
C
C
      INCLUDE 'common/modrcs'
      INCLUDE 'common/fmodft'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'ufreex'
C
      DIMENSION OLDOPN(2),MODCRD(20,NCARDS)
      CHARACTER*8 BLOCK
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mbshft.f,v $
     . $',                                                             '
     .$Id: mbshft.f,v 1.3 2002/02/11 19:48:24 dws Exp $
     . $' /
C    ===================================================================
C
C
      DATA BLANK8/'        '/,SLASH/'/       '/
      DATA ALLRC/'ALLRC   '/
C
      
      CALL FSTWHR('MBSHFT  ',0,OLDOPN,IOLDOP)
C
C     SET DEBUG SWITCH
C
      
      IBUG=IFBUG(4HMODS)+IFBUG(4HBUBL)
ccav      ibug = 1
      IFLAG=0
      IF(IBUG.GT.0) THEN
         WRITE(IPR,10) IIDATE,LLDATE
10       FORMAT('0** IN MBSHFT - IDATE LDATE = ',I12,2X,I12)
         ENDIF
C
C     SEE IF DATE IS WITHIN HOURS OF START OR END OF RUN
C
      IDATE=IABS(IIDATE)
      LDATE=IABS(LLDATE)
      ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
cc AV added 
cc if mod dates is not within the allowable range then goto the end
cc idate and ldate must be inside the isthr and ienhr range      
      if(ldate .le. isthr .or. idate .ge. ienhr) then 
       if(modwrn .eq. 1)then 
       print *,'0** ERROR IN MBSHFT - DATE NOT WITHIN ALLOWABLE WINDOW'
       WRITE(IPR,11) IIDATE,LLDATE
11     FORMAT('0** WARNING IN MBSHFT - IDATE LDATE = ',I12,2X,I12)
       WRITE(IPR,13) ISTHR,ISTHR
13     FORMAT('0** WARNING IN MBSHFT - ISTHR IENHR = ',I12,2X,I12)
       endif 
       goto 600
      endif
CC AV end  
c      write(IPR,11)(MODCRD(I,NRDCRD),I=1,20)
c11    format('The current modcard is: ',20A4)
C

      IF (LDATE.LE.IDATE) THEN
         IFLAG=1
         GOTO 15
         ENDIF
      IF(ISTHR.LE.IDATE.AND.IENHR.GE.LDATE) GOTO 30
      IDATE1=IDATE
      LDATE1=LDATE
      IF (IDATE1.LT.ISTHR ) IDATE1=ISTHR
      IF (LDATE1.GT.IENHR ) LDATE1=IENHR
      IF (ISTHR.LE.IDATE1.AND.IENHR.GE.LDATE1) THEN
         IDATE=IDATE1
         LDATE=LDATE1
         GOTO 30
         ENDIF
C
C     DATE NOT WITHIN ALLOWABLE WINDOW
C
15    IF (MODWRN.EQ.0) GOTO 380
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
      LXDA=LDATE/24+1
      LXHR=LDATE-(LXDA-1)*24
      IF(LXHR.EQ.0)LXDA=LXDA-1
      IF(LXHR.EQ.0)LXHR=24
      CALL MDYH2(LXDA,LXHR,IM4,ID4,IY4,IH4,DUM1,DUM2,MODTZC)
C
      IF (IFLAG.NE.0) THEN
         WRITE(IPR,25) (MODCRD(I,NRDCRD),I=1,20)
         CALL WARN
         GOTO 380
         ENDIF

C
      WRITE(IPR,20)IM3,ID3,IY3,IH3,MODTZC,IM4,ID4,IY4,IH4,MODTZC,
     1 IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC
20    FORMAT('0**WARNING** THE DATES FOR CHANGES IN THE ',
     1 'BUBLSHFT MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,
     1 4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'ARE NOT WITHIN THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
25    FORMAT('0**WARNING** THE END DATE AND TIME IS BEFORE ',
     1 'OR AT THE BEGINNING DATE AND TIME.  THESE CHANGES WILL BE ',
     2 'IGNORED.'/,23X,'THE CURRENT MOD CARD IS: ',20A4)
      CALL WARN
      GO TO 380
C
30    IF(IUMGEN.EQ.1)GO TO 40
C
C     MUST CONVERT UNITS FROM INCHES TO M
C
      CALL FCONVT(4HM   ,4HL   ,ENGUN,AIN2M,BIN2M,IER)
      CALL FCONVT(4HCMS ,4HV   ,ENGUN,CFS2M,DFS2M,IER)
C
C     READ MOD CARDS FOR THIS SEGMENT - STORE VALUES IN ARRAYS() -
C      WILL TRANSFER TO CB /MODRCS/ AFTER ALL INFO IS READ
C
C     READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
40    FIRST=.TRUE.
C
      IF(NRDCRD.EQ.NCARDS)GO TO 60
C
50    IF(NRDCRD.EQ.NCARDS)GO TO 380
C
      RCID=BLANK8
C
      IF (MISCMD(NCARDS,MODCRD).EQ.0) GOTO 80
C
      IF(.NOT.FIRST)GO TO 380
C
C     HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
60    IF(MODWRN.EQ.1)WRITE(IPR,70)
70    FORMAT('0**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'BUBLSHFT MOD.  PROCESSING CONTINUES')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 380
C
80    FIRST=.FALSE.
      NRDCRD=NRDCRD+1
C
C     NOW READ THE 2ND FIELD - MUST BE AN INTEGER OR REAL NUMBER
C
      NFLD=1
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
C
c      WRITE(IPR,88)(MODCRD(I,NRDCRD),I=1,20)
c88    FORMAT(' THE BUBLSHFT MOD ',
c     1  20A4)

      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,VALUE,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
      
c      WRITE (IPR,8) ITYPE, NREP,INTEGR, VALUE
c8     FORMAT (' *** AFTER CALL UGTFLD - ITYPE=',I2,'nrep =',I2,
c     1      'integr=',i5,' VALUE=', F10.3)
C
      IF(ITYPE.NE.-1)GO TO 100
      
      
C
      IF(MODWRN.EQ.1)WRITE(IPR,90)(MODCRD(I,NRDCRD),I=1,20)
90    FORMAT('0**WARNING** IN THE BUBLSHFT MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THE CARD BEING PROCESSED IS:'/
     2  11X,20A4)
      GO TO 370
C
100   IF(ITYPE.LT.2.AND.NREP.EQ.-1)GO TO 120
C
C     VALUE IS NOT AN INTEGER NOR A REAL NUMBER
C
      IF(MODWRN.EQ.1)WRITE(IPR,110)(MODCRD(I,NRDCRD),I=1,20)
110   FORMAT('0**WARNING** A NONNUMERIC VALUE WAS DECODED ',
     1  'WHERE ONE WAS EXPECTED'/11X,'THE CURRENT MOD CARD IS'/11X,20A4)
      GO TO 370
C
C     SEE IF THERE IS ANOTHER FIELD - IF NOT PROCESS THE INFO
C     IN ARRAYS() - IF SO IT MUST BE A KEYWORD OR A SLASH (/)
C
C     NOW READ THE 3RD FIELD - MUST BE AN INTEGER
C
120   ISTRT=-3
      
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IDISC,DISC,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ITYPE.NE.-1)GO TO 130
C
      IF(MODWRN.EQ.1) WRITE(IPR,90) (MODCRD(I,NRDCRD),I=1,20)
      GO TO 370
C
130   IF(ITYPE.NE.2.AND.NREP.EQ.-1) GOTO 132
C
C     VALUE IS NOT AN INTEGER
C
      IF(MODWRN.EQ.1)WRITE(IPR,140)(MODCRD(I,NRDCRD),I=1,20)
140   FORMAT('0**WARNING** A NON-INTEGER VALUE WAS DECODED ',
     1  'WHERE ONE WAS EXPECTED'/11X,'THE CURRENT MOD CARD IS'/11X,20A4)
      GO TO 370
C
C     NOW READ THE 4TH FIELD - MUST BE AN INTEGER OR REAL
C
132   ISTRT=-3
      
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IDOWN,DOWN,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ITYPE.NE.-1) GOTO  135
C
      IF(MODWRN.EQ.1) WRITE(IPR,90) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 370
C
135   IF (ITYPE.LT.2.AND.NREP.EQ.-1) GOTO 137
C
C     VALUE IS NOT INTEGER OR REAL
C
      IF (MODWRN.EQ.1) WRITE (IPR,110) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 370
C
C     NOW READ THE 5TH FIELD - MUST BE AN INTEGER OR REAL
C
137   ISTRT=-3
C
      
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IUP,UP,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (ITYPE.NE.-1) GOTO 138
C
C
      IF (MODWRN.EQ.1) WRITE(IPR,90) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 370
C
138   IF (ITYPE.LT.2.AND.NREP.EQ.-1) GOTO 150
C
C     VALUE IS NOT INTEGER OR REAL
C
      IF (MODWRN.EQ.1) WRITE (IPR,110) (MODCRD(I,NRDCRD),I=1,20)
      GOTO 370
C
C     NOW READ OPTIONAL FIELD (IF ANY)
C
150   ISTRT=-3
C
      
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REALV,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 200
C
C     ANOTHER FIELD - IS IT A SLASH ? - IS NOT SEE IF A KEYWORD
C
      IF(IFIELD.EQ.SLASH)GO TO 170
C
      IF(MODWRN.EQ.1)WRITE(IPR,160)(MODCRD(I,NRDCRD),I=1,20)
160   FORMAT('0**WARNING** IN THE BUBLSHFT MOD - AN INVALID ',
     1  'FIELD WAS FOUND ON THE FOLLOWING MOD CARD'/11X,20A4)
      GO TO 370
C
C     GET HERE IF FIELD IS A SLASH
C     NOW READ NEXT FIELD - RATING CURVE ID
C
170   ISTRT=-3
C
      
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REALV,
     1  NCHAR,RCID,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 190
      IF(MODWRN.EQ.0)GO TO 50
      WRITE(IODBUG,180)(MODCRD(I,NRDCRD),I=1,20)
180   FORMAT('0**WARNING** NO RATING CURVE ID ENTERED ',
     1 'AFTER A SLASH ON THE FOLLOWING MOD CARD'/11X,20A4/
     2 11X,'THIS CARD IS IGNORED.')
      GO TO 370
190   CONTINUE
C
C     CONVERT VALUES TO METRIC UNIT IF NEEDED
C
      
200   IF(IUMGEN.EQ.0) THEN
         VALUE=VALUE/AIN2M
         DISC=DISC/CFS2M
         DOWN=DOWN/AIN2M
         UP=UP/AIN2M
      
  
         ENDIF
C
C     LOWER STAGE VALUE IS GREATER THAN UPPER STAGE VALUE
C
      IF (DOWN.GT.UP) THEN
         IF (MODWRN.EQ.1) THEN
            IF (IUMGEN.EQ.0) THEN
               DOWN=DOWN*AIN2M
               UP=UP*AIN2M
               ENDIF
            WRITE(IPR,205) DOWN,UP,(MODCRD(I,NRDCRD),I=1,20)
            GOTO 370
            ENDIF
         ENDIF
205   FORMAT('0**WARNING** - IN BUBLSHFT MOD - LOWER STAGE ',
     1 F10.1,' IS GREATER THAN UPPER STAGE ',F10.1,'. THIS CHANGE ',
     2 'WILL BE IGNORED.',/,11X,'THE CURRENT CARD IMAGE IS : ',20A4)
C
      IF (RCID.EQ.BLANK8) CALL UMEMOV(ALLRC,RCID,2)
C
C     CHECK FOR VALID DISCHARGE VALUE
C
      IF (DISC.LT.0.0) THEN
         IF (MODWRN.EQ.1) THEN
            IF (IUMGEN.EQ.0) DISC=DISC*CFS2M
            WRITE(IPR,230) DISC,(MODCRD(IZ,NRDCRD),IZ=1,20)
            GOTO 370
            ENDIF
         ENDIF
C
230   FORMAT('0**WARNING** IN BUBLSHFT MOD - DISCHARGE VALUE ',
     1 F12.2,' IS OUT OF VALID RANGE. THIS CHANGE WILL BE IGNORED.',/,
     2 11X,'THE CURRENT CARD IMAGE IS : ',20A4)
CHU
C     SEE IF ANY EXISTING CURVES IN COMMON BLOCK /MODRCS/
C
      IF (NUMRC.GT.0) GOTO 260
C
240   NUMRC=1
      NSHIFT(NUMRC)=1
      CALL UMEMOV(RCID,RCSID(NUMRC,1),2)
      JROW=NSHIFT(NUMRC)
      IJHSHF(JROW,NUMRC)=IDATE
      LJHSHF(JROW,NUMRC)=LDATE
      ISTYPE(JROW,NUMRC)=2
      HNEW(JROW,NUMRC)=VALUE
      QNEW(JROW,NUMRC)=DISC
      HL(JROW,NUMRC)=DOWN
      HU(JROW,NUMRC)=UP
     
C

      IF(IBUG.GT.0) WRITE(IODBUG,310) HNEW(JROW,NUMRC),QNEW(JROW,NUMRC),
     1              HL(JROW,NUMRC),HU(JROW,NUMRC),JROW,NUMRC
      GO TO 50
C
C     CHECK IF NAME MATCHES ANY NAME IN CB OR IS BLANK -
C
260   DO 330 I=1,NUMRC
      IKEY=I
      IF(IUSAME(RCID,RCSID(1,I),2).EQ.0) GOTO 330
C
      CALL MSHIFT(IKEY,IDATE,LDATE,IERR)
      IF (IERR.NE.0) THEN
         IF (MODWRN.EQ.0) GOTO 370
         WRITE(IPR,320) (MODCRD(IX,NRDCRD),IX=1,20)
320      FORMAT('0**WARNING** NOT ENOUGH ROOM IN COMMON BLOCK ',
     1 '/MODRCS/'/11X,'TO HOLD NEW STAGE & DISCHARGE VALUES.  THE ',
     2 'CURRENT CARD IMAGE IS'/11X,20A4)
         GOTO 370
         ENDIF
      NEW=NSHIFT(IKEY)+1
      IJHSHF(NEW,IKEY)=IDATE
      LJHSHF(NEW,IKEY)=LDATE
      ISTYPE(NEW,IKEY)=2
      HNEW(NEW,IKEY)=VALUE
      QNEW(NEW,IKEY)=DISC
      HL(NEW,IKEY)=DOWN
      HU(NEW,IKEY)=UP
      NSHIFT(IKEY)=NEW
      CALL MORDER(IKEY)
      DO 305 N=1,NSHIFT(IKEY)
         IF (IDATE.EQ.IJHSHF(N,IKEY).AND.LDATE.EQ.LJHSHF(N,IKEY)) THEN
            INEW=N
            ENDIF
305   CONTINUE
      IF(IBUG.GT.0) WRITE(IODBUG,310)HNEW(INEW,IKEY),QNEW(INEW,IKEY),
     1              HL(NEW,IKEY),HU(NEW,IKEY),INEW,IKEY
310   FORMAT(11X,'STAGE, DISCHARGE,LOWER & UPPER STAGE VALUES OF ',
     1 F9.2,1X,F9.2,1X,F9.2,1X,F9.2,' ARE STORED IN ROW ',I1,
     2 ' AND COLUMN ',I1,' .')
      GO TO 50
C
330   CONTINUE
C
C     HAVE NOT FOUND MATCH FOR NAME  -
C     ADD NEW ENTRY TO CB
C
      IF(NUMRC.LT.2)GO TO 350
C
C     NOT ENOUGH ROOM IN CB
C
      IF(MODWRN.EQ.1)WRITE(IPR,340)(MODCRD(I,NRDCRD),I=1,20)
340   FORMAT('0**WARNING** NOT ENOUGH ROOM IN COMMON BLOCK ',
     1 '/MODRCS/'/11X,'TO HOLD A NEW RATING CURVE.  THE CURRENT ',
     2 'MOD CARD IMAGE IS'/11X,20A4)
      GO TO 370
C
C     ENOUGH ROOM - ADD NEW ENTRY TO CB
C
350   NUMRC=NUMRC+1
      NSHIFT(NUMRC)=1
      CALL UMEMOV(RCID,RCSID(1,NUMRC),2)
      IROW=NSHIFT(NUMRC)
      IJHSHF(IROW,NUMRC)=IDATE
      LJHSHF(IROW,NUMRC)=LDATE
      ISTYPE(IROW,NUMRC)=2
      HNEW(IROW,NUMRC)=VALUE
      QNEW(IROW,NUMRC)=DISC
      HL(IROW,NUMRC)=DOWN
      HU(IROW,NUMRC)=UP
      II=IROW
      NN=NUMRC

      IF(IBUG.GT.0) WRITE(IODBUG,310)HNEW(II,NN),QNEW(II,NN),
     1                              HL(II,NN),HU(II,NN),II,NN
      GO TO 50
C
370   IF(MODWRN.EQ.1)CALL WARN
      GO TO 50
C
380   IF(IBUG.EQ.0)GO TO 500
C
      
      WRITE(IODBUG,390) NUMRC
390   FORMAT(11X,'***LEAVING SUBROUTINE MBSHFT*** NUMRC=',I3)
       IF(NUMRC.LE.0) GOTO 500
       DO 490 I=1,NUMRC
          WRITE(IODBUG,400)(RCSID(J,I),J=1,2)
          WRITE(IODBUG,420)(ISTYPE(J,I),J=1,NSHIFT(I))
          WRITE(IODBUG,430)(IJHSHF(K,I),K=1,NSHIFT(I))
          WRITE(IODBUG,440)(LJHSHF(L,I),L=1,NSHIFT(I))
          WRITE(IODBUG,450)(HNEW(N,I),N=1,NSHIFT(I))
          WRITE(IODBUG,460)(QNEW(N,I),N=1,NSHIFT(I))
          WRITE(IODBUG,470)(HL(N,I),N=1,NSHIFT(I))
          WRITE(IODBUG,480)(HU(N,I),N=1,NSHIFT(I))
400   FORMAT(11X,'ARRAY RCSID = ',2A4)
420   FORMAT(11X,'ARRAY ISTYPE = ',3X,5(I1,15X))
430   FORMAT(11X,'ARRAY IJHSHF = ',5(I8,8X))
440   FORMAT(11X,'ARRAY LJHSHF = ',5(I8,8X))
450   FORMAT(11X,'ARRAY HNEW = ',5(F12.2,4X))
460   FORMAT(11X,'ARRAY QNEW = ',5(F12.2,4X))
470   FORMAT(11X,'ARRAY HL = ',5(F10.2,6X))
480   FORMAT(11X,'ARRAY HU = ',5(F10.2,6X))
C
490   CONTINUE


C
500   CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
600   RETURN
      END
