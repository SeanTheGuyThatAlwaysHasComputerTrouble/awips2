c$pragma c (chkdollarsign)
C MODULE MROCHN
C-----------------------------------------------------------------------
C
C  THIS SUBROUTINE PERFORMS THE ROCHNG MOD
C
      SUBROUTINE MROCHN (MP,P,MTS,TS,MD,D,NCARDS,MODCRD,IIDATE,LLDATE,
     *  NXTOPN,NXTNAM,IHZERO)
C
      LOGICAL FIRST
      CHARACTER*8 TSID,NXTNAM,OPID,BLANK8,MODNAM
C
      INCLUDE 'ufreex'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fmodft'
C
      DIMENSION P(MP),TS(MTS),D(MD),VALUES(744),TEMP1(744)
      DIMENSION OLDOPN(2),MODCRD(20,NCARDS),Modstmp(20)
      DIMENSION TSID4(2)
      EQUIVALENCE (TSID4,TSID)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mrochn.f,v $
     . $',                                                             '
     .$Id: mrochn.f,v 1.9 2004/09/08 16:15:14 aivo Exp $
     . $' /
C    ===================================================================
C
      DATA ISLASH/4H/   /,BLANK8/'        '/
      DATA MODNAM/'ROCHNG  '/
C
C
      CALL FSTWHR(8HMROCHN  ,0,OLDOPN,IOLDOP)
C
C     SET DEBUG FLAG
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HROCH)
C
      IF (IBUG.GT.0) WRITE (IODBUG,10)IIDATE,NXTOPN,NXTNAM
   10 FORMAT('0*** SUBROUTINE MROCHN ENTERED ***  IIDATE=',I11,
     1 ', NXTOPN=',I3,', NXTNAM= ',A8)
C
      IF (NXTOPN.NE.2) GO TO 460
C
      IDATE=IABS(IIDATE)
      LDATE=IABS(LLDATE)
C
      ICOMP=((LDACPD-1)*24)+LHRCPD
C
C  CHECK IF DATE IS LESS THAN LASTCOMPDATE OR LSTCMPDY DATE
C  AND LASTCOMPDATE EQUALS LSTCMPDY DATE FOR ROCHNG MOD
C
c     IF ((IDATE.LE.LDATE).OR.(IDATE.LE.ICOMP)) GO TO 20
c     IF (LDATE.EQ.ICOMP) GO TO 20
      IF (idate.le.ldate.and.ldate.gt.0) GO TO 20
      IF (idate.le.icomp.and.ldate.eq.0) GO TO 20
      IF (ldate.eq.icomp) GO TO 20
C
         ITYPE=4
         IF (LDATE.EQ.0) ITYPE=2
         IF (MODWRN.EQ.0) GO TO 460
         CALL MODS1 (NCARDS,ICMND,MODNAM,MODCRD,ITYPE)
         GO TO 460
C
C     SEE IF DATE IS WITHIN RUN PERIOD
C
   20 ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
C
C     IF (IENHR.GE.IDATE.AND.ISTHR.LE.IDATE) GO TO 40
      IF (ldate.ge.isthr.and.ldate.ne.0) GO TO 40
      IF (IENHR.GE.IDATE) GO TO 40
C
C     START DATE FOR CHANGES AFTER ALLOWABLE WINDOW
C
   25 CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF (IXHR.EQ.0)IXDA=IXDA-1
      IF (IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
C
      IF (MODWRN.EQ.0) GO TO 460
      WRITE (IPR,30) IM3,ID3,IY3,IH3,MODTZC,IM1,ID1,IY1,IH1,MODTZC,
     1 IM2,ID2,IY2,IH2,MODTZC
   30 FORMAT('0**WARNING** THE STARTING DATE FOR CHANGES ENTERED FOR ',
     1    'THE ROCHNG MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H) /
     2 13X,'IS NOT WITHIN THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3    1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H) /
     4 13X,'THESE CHANGES WILL BE IGNORED.')
      CALL WARN
      GO TO 460
C
   40 MXVALS=744
C
C  READ CARD - IF COMMAND LEAVE
C
      FIRST=.TRUE.
      IF (NRDCRD.EQ.NCARDS) GO TO 60
C
   50 IF (NRDCRD.EQ.NCARDS) GO TO 460
C
      OPID=BLANK8
C
      IF (MISCMD(NCARDS,MODCRD).EQ.0) GO TO 80
C
      IF (.NOT.FIRST) GO TO 460
C
C  HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD
C
   60 IF (MODWRN.EQ.1) THEN
         WRITE (IPR,70)
   70 FORMAT('0**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1 'ROCHNG MOD.  PROCESSING CONTINUES.')
         CALL WARN
         ENDIF
      GO TO 50
C
   80 FIRST=.FALSE.
C
C     CALL SUBROUTINE TO READ VALUES
C
      NFLD=1
      NRDCRD=NRDCRD+1
C     IF (NRDCRD.EQ.NCARDS) GO TO 460
C
      CALL MRDVAL (NCARDS,MODCRD,NFLD,MXVALS,NVALS,VALUES,ISTAT)
C
      do j = 1, 20          
          Modstmp(j) = modcrd(j,nrdcrd)  
      end do
      call chkdollarsign(iret,Modstmp)
      if (iret .eq. 1) goto 50
C


      IF (IBUG.GT.0) WRITE (IODBUG,90)ISTAT,FIRST,NVALS
   90 FORMAT (' IN MROCHN AFTER CALL TO MRDVAL - ISTAT=',I3,
     1 ', FIRST=',L4,', NVALS=',I3)
      IF (IBUG.GT.0.AND.NVALS.GT.0.AND.ISTAT.NE.-1) WRITE (IODBUG,100)
     1 (VALUES(I),I=1,NVALS)
  100 FORMAT(' VALUES:' / (1X,10G10.2))
C
C     ISTAT RETURNED FROM MRDVAL MEANS
C       =0, VALUES READ OK, NO ADDITIONAL FIELDS ON CARD
C       =2, VALUES READ OK, ADDITIONAL FIELDS ON CARD
C       =-1, NO VALUES ENTERED
C       ELSE, TOO MANY VALUES ENTERED
C
      IF (ISTAT.EQ.0) GO TO 200
      IF (ISTAT.EQ.2) GO TO 140
      IF (ISTAT.EQ.-1) GO TO 120
C
      IF (MODWRN.EQ.1) THEN
         WRITE (IPR,110) MXVALS,NVALS,(MODCRD(I,NRDCRD),I=1,20)
  110 FORMAT ('0**WARNING** IN ROCHNG MOD - MORE THAN ',I3,
     *    ' VALUES ENTERED. THE FIRST ',I3,
     *    ' VALUES ENTERED WILL BE USED.' /
     * 13X,'THE CURRENT CARD IS:' /
     * 13X,20A4)
         CALL WARN
         ENDIF
      GO TO 200
C
  120 IF (MODWRN.EQ.1) THEN
         WRITE (IPR,130) (MODCRD(I,NRDCRD),I=1,20)
  130 FORMAT ('0**WARNING** NO VALUES ENTERED ON A SUBSEQUENT CARD ',
     *    'FOR ROCHNG MOD.' /
     * 13X,'THE CURRENT MOD CARD IS:' /
     * 13X,20A4)
         CALL WARN
         ENDIF
      GO TO 50
C
C     HAVE ADDITIONAL FIELDS - LOOK FOR A SLASH (/) AND
C     AN OPERATION NAME - REPROCESS CURRENT FIELD TO SEE IF A SLASH
C
  140 ISTRT=-1
      NCHAR=1
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF (IFIELD.EQ.ISLASH) GO TO 160
C
      IF (MODWRN.EQ.1) WRITE (IPR,150)(MODCRD(I,NRDCRD),I=1,20)
  150 FORMAT ('0**WARNING** IN ROCHNG MOD - A SLASH WAS NOT FOUND ',
     *   'WHERE EXPECTED ON THE FOLLOWING MOD CARD:' /
     * 13X,20A4 /
     * 13X,'NO CHANGES ENTERED ON THIS CARD WILL BE MADE.')
      GO TO 450
C
C  NOW READ OPERATION NAME
  160 ISTRT=-3
      NCHAR=2
      ICKDAT=0
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,OPID,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
      IF (ISTRT.NE.-2) GO TO 180
      IF (MODWRN.EQ.0) GO TO 50
      WRITE (IODBUG,170) (MODCRD(I,NRDCRD),I=1,20)
  170 FORMAT(11X,'**WARNING** NO OPERATION NAME ENTERED ',
     *   'AFTER A SLASH ON THE FOLLOWING MOD CARD:' /
     * 13X,20A4 /
     * 13X,'THIS CARD WILL BE IGNORED.')
      GO TO 450
  180 CONTINUE
C
C     CHECK THAT OPERATION NAME ENTERED MATCHES NXTNAM -
C     IF NOT, READ NEXT CARD
C
      IF (IBUG.GT.0) WRITE (IODBUG,190) OPID,NXTNAM
  190 FORMAT(11X,'COMPARING THE OPERATION NAME ENTERED - ',A8,
     1 ' WITH THE NEXT OPERATION NAME - ',A8)
      IF (OPID.EQ.NXTNAM) GO TO 200
      GO TO 50
C
C     FIND START OF SECOND PORTION OF P ARRAY FOR THE OPERATION
C
  200 LOCOPN=0
      CALL FSERCH(2,NXTNAM,LOCOPN,P,MP)
C
      IF (LOCOPN.GT.0) GO TO 220
C
C     SHOULD NEVER GET HERE - MEANS PROBLEM IN P ARRAY
C
      IF (MODWRN.EQ.1) THEN
         WRITE (IPR,210) NXTNAM
  210 FORMAT ('0**WARNING** IN ROCHNG MOD - CANNOT FIND ',
     1 'UNIT-HG OPERATION ',A8,' IN THE P ARRAY.')
         CALL WARN
         ENDIF
      GO TO 50
C
C     CHECK FOR NEGATIVE RUNOFF VALUES
C
  220 DO 240 I=1,NVALS
         IF (VALUES(I).GE.0.0) GO TO 240
         IF (MODWRN.EQ.1) WRITE (IPR,230)(MODCRD(J,NRDCRD),J=1,20)
  230 FORMAT('0**WARNING** IN THE ROCHNG MOD - ',
     1 'A NEGATIVE RUNOFF VALUE WAS ENTERED.' /
     2 11X,'NO CHANGES ON THIS CARD WILL BE MADE.  ',
     3 'THE CURRENT MOD CARD IMAGE IS: '/ 13X,20A4)
         GO TO 450
  240    CONTINUE
C
C  TIME SERIES ID IS IN POSITIONS 13-14 OF P ARRAY
C  DATA TYPE IS IN POSITION 15, TIME INTERVAL IS IN POSITION 16
      LOCP=LOCOPN-1
CCC      TSID4(1)=P(LOCP+13)
CCC      TSID4(2)=P(LOCP+14)
      CALL UMEMOV (P(LOCP+13),TSID,2)
      DTYPE=P(LOCP+15)
      IDT=P(LOCP+16)
C
      IF (IBUG.GT.0) THEN
         WRITE (IODBUG,250) IDATE,TSID,DTYPE,IDT,NVALS,OPID
  250 FORMAT (' IN MROCHN - ROCHNG MOD : IDATE=',I6,' TSID=',A,
     *   ' DTYPE=',A4,' IDT=',I3,' NVALS=',I3,' OPID=',A8)
         IF (NVALS.GT.0) WRITE (IODBUG,260) (VALUES(I),I=1,NVALS)
  260 FORMAT (' VALUES:' / (1X,10G9.2))
         ENDIF
C
C  GET LOCATION OF TIME SERIES IN SEGMENT
      CALL FINDTS (TSID,DTYPE,IDT,LOCD,LOCTS,DIMS)
C
      IF (LOCD.EQ.0) THEN
         IF (MODWRN.EQ.1) THEN
            WRITE (IPR,280) TSID,DTYPE,IDT
  280 FORMAT ('0**WARNING** IN ROCHNG MOD - TIME SERIES ',
     1 A8,1X,A4,I3,' NOT IN THIS SEGMENT.')
            CALL WARN
            ENDIF
         GO TO 50
         ENDIF
C
C     SEE IF THIS DATA TYPE ALLOWS MISSING DATA
C     AND GET VALUE FOR NUMBER OF VALUES PER DELTA T (NVPDT)
C
      CALL FDCODE(DTYPE,UNITS,DIMS,MISALW,NVPDT,TSCALE,NADINF,IERR)
C
C     CHECK TIME PERIOD AGAINST RUN PERIOD - PRINT WARNING ONLY IF
C     ENTIRE PERIOD BEING CHANGED IS OUTSIDE OF RUN PERIOD
C
C     IF START HOUR NOT ENTERED - USE START OF INTERNAL DAY (12Z)
C     IF START HOUR ENTERED - SET TO CLOSEST DT OF TIME SERIES
C
C     IF HOUR ENTERED IIDATE LESS THAN ZERO
C
C     CHECK IF ALL VALUES IN VALUES() ARRAY ARE USED
C
      IF (IDATE.GT.ISTHR) GO TO 295
C
      NDEL=((ISTHR-IDATE+(IDT/2))/IDT) + 1
      IDATE=ISTHR
      DO 291 III=1,MXVALS
         TEMP1(III)=0.0
  291    CONTINUE
      JJ=0
      DO 292 IIII=NDEL+1,NVALS
         TEMP1(JJ+1)=VALUES(IIII)
         JJ=JJ+1
  292    CONTINUE
      CALL UMEMOV(TEMP1,VALUES,MXVALS)
      NVALS=JJ
C
      IF (NVALS.GT.0) GO TO 294
c     IF (MODWRN.EQ.0) GO TO 295
C
      IF (LDATE.LT.ISTHR) THEN
         IDATE=IABS(IIDATE)
         GO TO 25
         ENDIF
C
      IF (MODWRN.EQ.0) GO TO 450
C
      IXDA=(IABS(IIDATE)/24)+1
      IXHR=IABS(IIDATE)-(IXDA-1)*24
      IF (IXHR.EQ.0)IXDA=IXDA-1
      IF (IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
c
      CALL MDYH2(IDA,IHZERO,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
C
      WRITE (IPR,293)IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC
  293 FORMAT('0**WARNING** IN ROCHNG MOD - THERE ARE NO ',
     1'VALUES AFTER RESETTING THE START DATE ON THE MOD CARD (',I2,
     2'/',I2,'/',I4,'-'I2,1X,A4,')',/,25X,'TO THE STARTRUN ',
     3'TECHNIQUE (',I2,'/',I2,'/',I4,'-',I2,1X,A4,')')
      GO TO 450
C
  294 IF (modwrn.eq.0) GO TO 295
      IXDA=(IABS(IIDATE)/24)+1
      IXHR=IABS(IIDATE)-(IXDA-1)*24
      IF (IXHR.EQ.0)IXDA=IXDA-1
      IF (IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(IDA,IHZERO,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      WRITE (IPR,444)IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC,NDEL
  444 FORMAT('0**WARNING** IN ROCHNG MOD - START DATE (',I2,
     1  '/',I2,'/',I4,'-',I2,1X,A4,') IS BEFORE START RUN DATE (',I2,
     2  '/',I2,'/',I4,'-',I2,1X,A4,')'/,25X,'THE FIRST ',I4,' VALUE(S)',
     3  ' BEFORE AND AT START DATE ON THE MOD CARD ARE IGNORED.')
      CALL WARN
C
  295 IF (LDATE.GE.ICOMP) GO TO 299
c     if (ldate.le.icomp.and.idate.ge.isthr) GO TO 299
      ldate1=ldate
      if (ldate.eq.0) then
         ldate1=icomp
         endif
C
c     NOFF=(ICOMP-LDATE+(IDT/2))/IDT
      nslect=(ldate1-idate+(idt/2))/idt+1
      IF (ldate1.eq.idate) nslect=1
      IF (ldate1.lt.idate) then
         GO TO 25 
         endif
      n1=nslect
      nvalso=nvals
      if (nslect.gt.nvals) nslect=nvals
      DO 296 LL=1,MXVALS
            TEMP1(LL)=0.0
  296 CONTINUE
      KK=0
      do 297 lll=1,nslect
c     DO 297 LLL=1,NOFF
         TEMP1(LLL)=VALUES(LLL)
         KK=KK+1
  297 CONTINUE
C
      NVALS=KK
      CALL UMEMOV(TEMP1,VALUES,MXVALS)
C
      IF (nvalso.le.n1) GO TO 299
      IF (MODWRN.EQ.0) GO TO 299
c
      ndiff=nvalso-n1
c
      IXDA=ICOMP/24+1
      IXHR=ICOMP-(IXDA-1)*24
      IF (IXHR.EQ.0)IXDA=IXDA-1
      IF (IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
c
      IF (ldate.eq.0) then
        WRITE (ipr,301) ndiff,IM1,ID1,IY1,IH1,MODTZC
        GO TO 302
        endif
  301 format('0**WARNING** IN ROCHNG MOD - ',I2,
     1  ' VALUE(S) AFTER LSTCMPDY (',I2,'/',I2,'/',I4,'-',I2,1X,A4,')',
     2  /,25X,' ARE IGNORED BECAUSE VALID DATE IS NOT ON THE MOD CARD.')
c
      IXDA=LDATE/24+1
      IXHR=LDATE-(IXDA-1)*24
      IF (IXHR.EQ.0)IXDA=IXDA-1
      IF (IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
C 
      WRITE (IPR,298)IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC,ndiff
  298 FORMAT('0**WARNING** IN ROCHNG MOD - LSTCMPDY (',I2,'/',   
     1  I2,'/',I4,'-',I2,1X,A4,') IS BEYOND VALID DATE (',I2,'/',I2,
     2  '/',I4,'-',I2,1X,A4,')'/,25X,'THE ',I2,' VALUE(S) AFTER VALID ',
     3  'DATE ARE IGNORED.')  
  302 CALL WARN
C
  299 CONTINUE
C
      IF (IIDATE.LT.0) GO TO 300
C
C     HOUR NOT ENTERED - IDATE SHOULD BE DIVISIBLE BY 24
C
      JSTHR=IDATE
      GO TO 310
C
  300 CONTINUE
C
C     HOUR ENTERED - SET TO NEAREST DT
C
      JSTHR=MISTDT(IDATE,IDT)
C
  310 CONTINUE
C
C     NOW COMPUTE ENDING HOUR FOR TIME SERIES VALUES ENTERED
C
      ISPAN=IDT*(((NVALS-1)/NVPDT)*NVPDT)
      JENHR=JSTHR+ISPAN
C
C  GET LOCATIONS TO START CHANGES AND NUMBER OF VALUES TO MOVE
C
      CALL MLOCCH(8HROCHNG  ,ISTHR,IENHR,JSTHR,JENHR,
     1 TSID,DTYPE,IDT,NVALS,NVPDT,LOCD,IBUG,
     2 IOFFST,LDSTRT,NMOVE,ISTART,ISTATT)
C
      IF (ISTATT.EQ.1) GO TO 50
C
C     GET UNITS CONVERSION FACTORS IF NEEDED
C
      IF (IUMGEN.EQ.0)CALL FCONVT(UNITS,DIMS,EUNITS,XMULT,XADD,IER)
C
      IGOTO = (IUMGEN*4 + MISALW*2)/2 + 1
C
C     GO TO ONE OF FOUR CASES
C      IGOTO = 1,    UNITS CONVERSION, MISSING NOT ALLOWED
C              2,    UNITS CONVERSION, MISSING ALLOWED
C              3, NO UNITS CONVERSION, MISSING NOT ALLOWED
C              4, NO UNITS CONVERSION, MISSING ALLOWED
C
      IF (IBUG.GT.0) WRITE (IODBUG,320)NMOVE,TSID,DTYPE,IDT,
     1 ISTART,LOCD,LDSTRT,IOFFST,IGOTO,NXTOPN,NXTNAM
  320 FORMAT (' ABOUT TO MOVE ',I4,' VALUES INTO TIME SERIES ',
     1 A8,1X,A4,I3 /
     2 ' ISTART, LOCD,LDSTRT,IOFFST,IGOTO,NXTOPN,NXTNAM =' /
     2 5X,I11,I6,I7,I7,I6,I7,2X,A8)
C
      GO TO (400,430,340,380),IGOTO
C
      IF (MODWRN.EQ.1) WRITE (IPR,330) IUMGEN,MISALW
  330 FORMAT ('0**WARNING** IN ROCHNG MOD - ILLEGAL VALUE ',
     1 'FOR IUMGEN (',I5,') OR MISALW (',I5,'). NO VALUES CHANGED.')
      GO TO 450
C
  340 DO 360 I=1,NMOVE
         IF (IFMSNG(VALUES(IOFFST+I)).EQ.0) GO TO 360
            IF (MODWRN.EQ.1) WRITE (IPR,350) I,TSID,DTYPE,IDT,DTYPE
  350 FORMAT('0**WARNING** IN ROCHNG MOD - VALUE NUMBER ',
     1 I3,' FOR TIME SERIES ',A8,1X,A4,I3,' IS A MISSING VALUE.' /
     2 13X,'MISSING VALUES ARE NOT ALLOWED FOR DATA TYPE ',A4,'.' /
     3 13X,'NO VALUES WILL BE CHANGED FOR THIS TIME SERIES.')
            GO TO 450
  360    CONTINUE
C
      DO 370 I=1,NMOVE
  370    D(LDSTRT+I)=VALUES(IOFFST+I)
      CALL MF27CB (TSID,DTYPE,IDT,ISTART,NMOVE,IBUG)
      GO TO 50
C
  380 DO 390 I=1,NMOVE
  390    D(LDSTRT+I)=VALUES(IOFFST+I)
      CALL MF27CB (TSID,DTYPE,IDT,ISTART,NMOVE,IBUG)
      GO TO 50
C
  400 DO 410 I=1,NMOVE
         IF (IFMSNG(VALUES(IOFFST+I)).EQ.0) GO TO 410
         IF (MODWRN.EQ.1) WRITE (IPR,350) I,TSID,DTYPE,IDT,DTYPE
         GO TO 450
  410    CONTINUE
C
      DO 420 I=1,NMOVE
  420    D(LDSTRT+I)=(VALUES(IOFFST+I)-XADD)/XMULT
      CALL MF27CB (TSID,DTYPE,IDT,ISTART,NMOVE,IBUG)
      GO TO 50
C
  430 DO 440 I=1,NMOVE
         TEMP=VALUES(IOFFST+I)
         IF (IFMSNG(TEMP).EQ.0) TEMP=(TEMP-XADD)/XMULT
  440    D(LDSTRT+I)=TEMP
      CALL MF27CB (TSID,DTYPE,IDT,ISTART,NMOVE,IBUG)
      GO TO 50
C
  450 IF (MODWRN.EQ.1) CALL WARN
      GO TO 50
C
  460 IF (IBUG.GT.0) WRITE (IODBUG,*) 'EXIT MROCHN'
C
      CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      RETURN
C
      END
