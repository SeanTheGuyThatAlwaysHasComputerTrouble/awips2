c$pragma C (parse_dhm_precip_mods)
c$pragma C (parse_dhm_sac_mods)
c$pragma C (init_dhm_mods)
C MODULE MODS
C-----------------------------------------------------------------------
C
C     THIS IS THE MAIN ROUTINE FOR DECODING RUNTIME MODS.
C
      SUBROUTINE MODS (NCARDS,MODCRD,MP,P,MC,C,MTS,TS,
     1                MT,T,MD,D,NXTOPN,NXTNAM,IHZERO,iuhgd)
C
      LOGICAL PERM,CHANGE
      INTEGER T
      CHARACTER*8 NXTNAM,MODNAM
      character*1024 message
      integer messagelength
C
      INCLUDE 'common/fcassm'
      INCLUDE 'common/mod138'
      COMMON/HDFLTS/DX1,INPTZN,INPHCL,DX2(18),LCLHCL,LTZHCL,DX3(2)
      COMMON/MOD102/NDT02,IDT02(5),VAL02(5)
      COMMON/MOD126/M126ON,MJ126,NVM126,VM126(744)
      LOGICAL M126ON
      COMMON/MOD129/NDT29,IDT29(5),VAL29(5)
      COMMON/MOD135/NDT35,IDT35(5),VAL35(5)
      COMMON/MOD136/NDT36,IDT36(10),IUT36(10),VAL36(8,10)
      COMMON/FIGNOR/NIGNOR,IGNOPT(10),IGSDAT(10),IGEDAT(10)
      common/rcflag/ircflg,iqcqp,ibuble
C
      INCLUDE 'common/fmodft'
      INCLUDE 'common/fctim2'
      INCLUDE 'common/fctime'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/modctl'
      INCLUDE 'ufreex'
      INCLUDE 'common/moduhg'
C
      DIMENSION MODCRD(20,NCARDS)
      DIMENSION P(MP),C(MC),TS(MTS),T(MT),D(MD)
      DIMENSION OLDOPN(2)
C
C  IASSIM - TEST IF ASSIMILATOR OPERATION IS IN SEGMENT
      INTEGER IASSIM, IOPNUM
      integer iuhgd
      DIMENSION ASSIM(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mods.f,v $
     . $',                                                             '
     .$Id: mods.f,v 1.11 2004/08/05 18:06:59 wkwock Exp $
     . $' /
C    ===================================================================
C
      DATA ASSIM/4HASSI,4HM   /
C
      CHARACTER*4 IDOTS/4H..../
C
      call init_dhm_mods()
C
      CALL FSTWHR('MODS    ',0,OLDOPN,IOLDOP)
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HMNMD)
      IF(IBUG.GT.0)WRITE(IODBUG,900)NCARDS,NXTOPN,NXTNAM,IHZERO
  900 FORMAT(11X,'** ROUTINE MODS ENTERED **   NCARDS = ',
     1  I3,', NXTOPN=',I3,', NXTNAM=',A8,', IHZERO=',I3)
      IF(IBUG.GT.0.AND.NCARDS.GT.0)WRITE(IODBUG,901)
     1  ((MODCRD(I,J),I=1,20),J=1,NCARDS)
  901 FORMAT(11X,20A4)

C
C  SET VALUE IN UFREEX COMMON BLOCK
C
      IPRBLN=0
C
      DO 321 I=1,100
  321 ICDBUF(I:I)=IDOTS
C
C   SEARCH FOR ASSIMILATOR OPERATION
      CALL FOPCDE (ASSIM,IOPNUM)
      IASSIM = 0
      CALL FSERCH( IOPNUM, ASSIM, IASSIM, P, MP )
C
      IPASS=0
      INPNCH=INPTZN
      INPTCH=INPTZC
      INPHCH=INPHCL
      CALL HCKDTC(MODTZC,INPTZN,ISTCK)
      IF(ISTCK.EQ.0)GO TO 432
      WRITE(IPR,953)MODTZC,INPTZC
  953 FORMAT(1H0,10X,'**WARNING** AN INVALID TIME ZONE CODE HAS BEEN ',
     1'ENTERED FOR MOD INPUT (',A4,')'/11X,'DEFAULT MOD TIME ZONE ',
     2'CODE WILL BE SET TO ',A4,'.')
      CALL WARN
      MODTZC=INPTZC
      CALL HCKDTC(MODTZC,INPTZN,ISTCK)
  432 INPHCL=MODTZC
      INPTZC=MODTZC
      NDT02=0
      M126ON=.FALSE.
      MJ126=0
      NVM126=0
      NDT29=0
      NDT35=0
      NDT36=0
      NDT38=0
      NIGNOR=0
C
      DO 101 I=1,5
      IDT02(I)=0
      VAL02(I)=0.0
      IDT29(I)=0
      VAL29(I)=0.0
      IDT35(I)=0
      VAL35(I)=0.0
  101 CONTINUE
      DO 102 I=1,10
      IDT36(I)=0
      IUT36(I)=0
      IGNOPT(I)=0
      IGSDAT(I)=0
      IGEDAT(I)=0
  102 CONTINUE
      DO 103 I=1,744
      VM126(I)=0.0
  103 CONTINUE
      DO 104 I=1,MXDT38
      IDT38(I)=0
      VAL38(I)=0.0
  104 CONTINUE
C
C
      IF(IBUG.GT.0)WRITE(IODBUG,947)INPTZC,INPTZN,INPHCL
  947 FORMAT(11X,'INPTZC= ',A4,', INPTZN= ',I3,', INPHCL= ',A4)
      GO TO 2
C
    1 IF(IBUG.GT.0)WRITE(IODBUG,902)IPASS,CHANGE
  902 FORMAT(11X,'AT LABEL 1, IPASS=',I2,', CHANGE=',L4)
C
      IF(CHANGE)CALL FPUTSG(P,T,TS,0,1,0,0,0,IER)
C
    2 IF(IBUG.GT.0)WRITE(IODBUG,903)IPASS
  903 FORMAT(11X,'AT LABEL 2, IPASS=',I3)
C
      IPASS=IPASS+1
      NRDCRD=0
      PERM=.FALSE.
      CHANGE=.FALSE.
      IF(IWHERE.GT.1.OR.IPASS.GT.1)GO TO 5
      PERM=.TRUE.
C
    5 IF(IBUG.GT.0)WRITE(IODBUG,904)NRDCRD,NCARDS
  904 FORMAT(11X,'AT LABEL 5, NRDCRD=',I3,', NCARDS=',I3)
C
      ILINE=NRDCRD
      IF(NRDCRD.GE.NCARDS)GO TO 9999
C
C     CHECK FOR COMMAND TO SEE IF PERMANENT OR NONPERMANENT
C
      ICMND=MISCMD(NCARDS,MODCRD)
C
C     IF NOT A COMMAND - READ NEXT CARD, NO MORE CARDS - RETURN
C
      IF(ICMND.EQ.-1)GO TO 9999
      IF(ICMND.GT.0)GO TO 8
    7 IF(IBUG.GT.0)WRITE(IODBUG,905)ICMND
  905 FORMAT(11X,'AT LABEL 7, ICMND=',I3)
C
      NRDCRD=NRDCRD+1
      GO TO 5
C
C     SKIP DECODING PERMANENT MODS DURING NONPERMANENT PASS
C     AND VICE VERSA
C
C     DECODE REST OF COMMAND CARD IMAGE IF PERM MOD IN PERM PASS
C     OR NONPERM MOD IN NONPERM PASS
C
C     NOTE THAT THE BFRCHNG MOD CAN MAKE EITHER PERM OR NONPERM
C     CHANGES DEPENDING ON BASEFLOW OPERATION PARAMETER VALUES
C
    8 IF(.NOT.PERM)GO TO ( 10, 10,  7, 10, 10, 10, 10,  7,  7, 10,
     1                     10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
     2                     10, 10, 10, 10,  7,  7, 10, 10, 10, 10,
     3                     10, 10, 10, 10,  7, 10, 10, 10, 10, 10,
     4                     10, 10, 10, 10, 10, 10, 10),ICMND
C
      IF(     PERM)GO TO (  7,  7, 10,  7,  7,  7, 10, 10, 10,  7,
     1                      7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
     2                      7,  7,  7,  7, 10, 10,  7,  7,  7,  7,
     3                      7,  7,  7,  7, 10,  7,  7,  7,  7,  7,
     4                      7,  7,  7,  7,  7,  7,  7),ICMND
C
C     IF GET HERE HAVE A COMMAND NUMBER OUT OF RANGE
C
      WRITE(IPR,502)ICMND
  502 FORMAT(1H0,10X,'** WARNING ** A MOD COMMAND NUMBER IS OUT OF ',
     1 'RANGE.'/11X,'ICMND = ',I11)
      CALL WARN
      GO TO 5
C
   10 IF(IBUG.GT.0)WRITE(IODBUG,906)
  906 FORMAT(11X,'AT LABEL 10')
C
    
      CALL MFCMND(NCARDS,MODCRD,ICMND,IDATE,LDATE,KDATE)

C
C     ICMND LT ZERO IF DATES ON MOD CARD ARE INVALID
C     SKIP MOD IF THIS IS THE CASE
C
      IF(ICMND.LT.0)GO TO 5
C
C     GO TO PROPER ROUTINE TO DECODE THE SUBSEQUENT CARDS
C
      IF(IBUG.EQ.0)GO TO 11
      CALL MCMDNA(ICMND,MODNAM)
      WRITE(IODBUG,907)ICMND,MODNAM,IWHERE
  907 FORMAT(11X,'BEFORE BRANCHING TO COMMANDS, ICMND=',I3,
     1 ', MODNAM=',A8,', IWHERE=',I2)
   11 CONTINUE
C
C     BRANCH TO LABEL 500 IF MOD NOT YET TESTED
C     ELSE GO TO APPROPRIATE ROUTINE TO PROCESS MOD
C
C     GO TO (AEIC,AESC,AIAD,APICQ,BASE,BFRA,BFRC,CBAS,CBFR,IGNO,
C    1       MFC ,RAIN,ROCH,ROMU,RRIC,RRIM,SACB,SACC,SETM,SETQ,
C    2       TSAD,TSCH,TSMU,TSRE,UCBA,UCBF,UHGA,UHGC,WECH,XINC,
C    3       APICB,APICC,WEADD,ZERODIF,CHGBLEND,MATCHNG,
C    4       QCSHIFT,QPSHIFT,BUBLSHFT,SWITCHTS,SSARREG,WEUPDATE,
C    5       UADJ,UHGCD),ICMND  
C
      GOTO (1010,1020,1030,1040,1050,1060,1070,1080,1090,1100,
     1      1110,1120,1130,1140,1150,1160,1170,1180,1190,1200,
     2      1210,1220,1230,1240,1250,1260,1270,1280,1290,1300,
     3      1310,1320,1330,1340,1350,1360,1370,1380,1390,1400,
     4      1410,1420,1430,1435,1440,1445,1440),ICMND
C
C     CODE HERE TO WRITE MESSAGE FOR MODS NOT YET TESTED
C
  500 IF(IWHERE.NE.1)GO TO 5
      CALL MCMDNA(ICMND,MODNAM)
      WRITE(IPR,501)MODNAM
  501 FORMAT(1H0,10X,'**WARNING** THE ',A8,' MOD IS NOT ',
     1 'CURRENTLY AVAILABLE - PROCESSING OF OTHER MODS CONTINUES.')
      CALL WARN
      GO TO 5
C
C     CALLS TO ROUTINES TO PROCESS MODS
C     LISTED IN ALPHABETICAL ORDER
C
 1010 IF(IWHERE.EQ.2)CALL MAEICQ(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1  NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1020 IF(IWHERE.EQ.1)CALL MAESCC(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1030 IF(IWHERE.EQ.1)CALL MAIADJ(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1040 IF(IWHERE.EQ.2)CALL MAPICQ(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1  NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1050 IF(IWHERE.EQ.2)CALL MBASEF(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1 IABS(LDATE),NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1060 IF(IWHERE.EQ.2)CALL MBFRAT(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1 NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1070 IF(IWHERE.GT.1)GO TO 1075
      IF(.NOT.PERM)GO TO 5
C
C  BEFORE OPERATIONS TABLE - MAKE PERMANENT PARM CHANGE IF NEEDED
C
      CALL MBFRCP(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1075 IF(IWHERE.EQ.3)GO TO 5
C
C  DURING OPERATIONS TABLE (IWHERE.EQ.2) MAKE ENTRIES TO /MOD138/
C  ** NOTE ** HAVE SET IBTWEN=1 IN MBFRCP IF NEEDED
C
      CALL MBFRCH(MP,P,NCARDS,MODCRD,IABS(IDATE),NXTOPN,NXTNAM)
      GO TO 5
C
 1080 IF(IWHERE.EQ.1)CALL MCBASE(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1090 IF(IWHERE.EQ.1)CALL MCBFRA(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1100 IF(IWHERE.EQ.2)CALL MIGNOR(NCARDS,MODCRD,IDATE,
     1  LDATE,NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1110 IF(IWHERE.EQ.1)CALL MMFC(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1 IABS(LDATE),IHZERO)
      GO TO 5
C
 1120 IF(IWHERE.EQ.1)CALL MRAINS (NCARDS,MODCRD,IHZERO)
      GO TO 5
C
 1130 IF(IWHERE.EQ.2)CALL MROCHN(MP,P,MTS,TS,MD,D,NCARDS,MODCRD,IDATE,
     1  LDATE,NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1140 IF(IWHERE.EQ.2)CALL MROMUL(MP,P,MTS,TS,MD,D,NCARDS,MODCRD,IDATE,
     1  LDATE,KDATE,NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1150 IF(IWHERE.EQ.2)CALL MRRICH(MP,P,MTS,TS,MD,D,NCARDS,MODCRD,IDATE,
     1  LDATE,NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1160 IF(IWHERE.EQ.2)CALL MRRIMU(MP,P,MTS,TS,MD,D,NCARDS,MODCRD,IDATE,
     1  LDATE,KDATE,NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1170 IF(IWHERE.EQ.1)CALL MSACBA(NCARDS,MODCRD,P,MP,IABS(IDATE),IHZERO)
      GO TO 5
C
 1180 IF(IWHERE.EQ.1)CALL MSACCO(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1190 IF(IWHERE.EQ.1)CALL MSETMS(NCARDS,MODCRD,MTS,TS,MD,D,IHZERO)
      GO TO 5
C
 1200 IF(IWHERE.EQ.2)CALL MSETQM(MP,P,NCARDS,MODCRD,IDATE,LDATE,
     1  NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GO TO 5
C
 1210 IF((IASSIM.EQ.0).OR.(ASSMRUN.EQ.0))
     1  CALL MTSADD(MTS,TS,MD,D,NCARDS,MODCRD,IDATE,LDATE,KDATE,
     2   NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      IAFTER=1
      GO TO 5
C
 1220 IF((IASSIM.EQ.0).OR.(ASSMRUN.EQ.0))
     1  CALL MTSCHN(MTS,TS,MD,D,NCARDS,MODCRD,IDATE,LDATE,
     2   NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      IAFTER=1
      GO TO 5
C
 1230 IF((IASSIM.EQ.0).OR.(ASSMRUN.EQ.0))
     1  CALL MTSMUL(MTS,TS,MD,D,NCARDS,MODCRD,IDATE,LDATE,KDATE,
     2   NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      IAFTER=1
      GO TO 5
C
 1240 IF((IASSIM.EQ.0).OR.(ASSMRUN.EQ.0))
     1  CALL MTSREP(MTS,TS,MD,D,NCARDS,MODCRD,IDATE,LDATE,KDATE,
     2   NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      IAFTER=1
      GO TO 5
C
 1250 IF(IWHERE.EQ.1)CALL MUCBAS(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1260 IF(IWHERE.EQ.1)CALL MUCBFR(NCARDS,MODCRD,P,MP,IABS(IDATE),ISTAT,
     1 IHZERO)
      IF(ISTAT.EQ.0)CHANGE=.TRUE.
      GO TO 5
C
 1270 IF(IWHERE.EQ.1)CALL MUHGAD(MP,P,NCARDS,MODCRD,
     1 IABS(IDATE),IHZERO)
      GO TO 5
C
 1280 IF(IWHERE.EQ.1)CALL MUHGCH(MP,P,NCARDS,MODCRD,
     1 IABS(IDATE),IHZERO)
      GO TO 5
C
 1290 IF(IWHERE.EQ.1)CALL MWECHN(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1300 IF(IWHERE.EQ.2)CALL MXINCO(NCARDS,MODCRD,IABS(IDATE),
     .                NXTOPN,NXTNAM,IHZERO)
      IBTWEN=1
      GOTO 5
C
 1310 IF(IWHERE.EQ.1) CALL MAPICB(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1320 IF(IWHERE.EQ.1) CALL MAPICC(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1330 IF(IWHERE.EQ.1)CALL MWEADD(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GO TO 5
C
 1340 IF(IWHERE.EQ.1) CALL MZRODF(MP,P,MC,C,NCARDS,MODCRD,IDATE,IHZERO)
      GOTO 5
C
 1350 IF(IWHERE.EQ.1)CALL MCBLND(MP,P,NCARDS,MODCRD,IDATE,IHZERO,ISTATT)
      IF(ISTATT.EQ.0) CHANGE=.TRUE.
      GOTO 5
C
 1360 IF(IWHERE.EQ.1)CALL MATCHN(D,MD,TS,MTS,NCARDS,MODCRD,IDATE,LDATE,
     1   IHZERO)
      GOTO 5
C
 1370 IF(IWHERE.EQ.1) then
         CALL MCSHFT(NCARDS,MODCRD,IDATE,LDATE,IHZERO)
C         iqcqp=1
C  iqcqp setted in fcfstgq.f 11/28/01---kwz
         endif
      GOTO 5
C
 1380 IF(IWHERE.EQ.1) then
         CALL MPSHFT(NCARDS,MODCRD,IDATE,LDATE,IHZERO)
         iqcqp=1
         endif
      GOTO 5
C
 1390 IF(IWHERE.EQ.1) then 
         CALL MBSHFT(NCARDS,MODCRD,IDATE,LDATE,IHZERO)
         ibuble=1
         endif
      GOTO 5
C
 1400 IF(IWHERE.EQ.1)CALL MSWTCH(MP,P,NCARDS,MODCRD,IDATE,LDATE,KDATE,
     1IHZERO)
      GOTO 5
C
 1410 IF(IWHERE.NE.2 .OR. NXTOPN.NE.51) GO TO 1411
      CALL MSSARR(MP,P,NCARDS,MODCRD,IDATE,NXTOPN,NXTNAM,IHZERO)
 1411 IBTWEN=1
      GOTO 5
C
 1420 IF(IWHERE.EQ.1)CALL MWEUPT(NCARDS,MODCRD,IABS(IDATE),IHZERO)
      GOTO 5
C
 1430 IF(IWHERE.EQ.1)CALL MUADJ(MP,P,NCARDS,MODCRD,IABS(IDATE),
     1 IABS(LDATE),IHZERO)
      GO TO 5
C
 1435 IF(IWHERE.EQ.1)then
      iuhgd = 1
      CALL MUHGCD(MP,P,NCARDS,MODCRD,
     1 IABS(IDATE),IABS(LDATE),IABS(KDATE),iuhgd)
	  end if
      GO TO 5 
C
C add dhm precip mod feature OB8.2, 05/2007
 1440 IF(IWHERE.EQ.1) then
          ILHRCPD = (LDACPD -1) *24 + LHRCPD
          CALL parse_dhm_precip_mods(MP,P,MODCRD,
     1    IABS(IDATE),IABS(LDATE),IABS(KDATE),IABS(ILHRCPD),NRDCRD,
     1    MESSAGE,MESSAGELENGTH)      
          WRITE(IPR,*)MESSAGE(1:MESSAGELENGTH)
      ENDIF
      GO TO 5 
	  
 1445 IF(IWHERE.EQ.1) then
          ILHRCPD = (LDACPD -1) *24 + LHRCPD
          CALL parse_dhm_sac_mods(MP,P,MODCRD,
     1    IABS(IDATE),IABS(ILHRCPD),NRDCRD,MESSAGE,MESSAGELENGTH)      
cIABS(IDATE) is actually validate of the mod(because it has only 1 date)
          WRITE(IPR,*)MESSAGE(1:MESSAGELENGTH)
      ENDIF
      GO TO 5 
c
 9999 IF(IBUG.GT.0)WRITE(IODBUG,908)PERM
  908 FORMAT(11X,'AT LABEL 9999, PERM=',L4)
C
      IF(PERM)GO TO 1
      INPTZN=INPNCH
      INPTZC=INPTCH
      INPHCL=INPHCH
      CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
      RETURN
      END
c
      subroutine rcfset(iset)
      common/rcflag/ircflg,iqcqp,ibuble
      if (iqcqp .gt. 0) ircflg=1
      if (ibuble .gt. 0) ircflg=2
      iset=ircflg
      end
