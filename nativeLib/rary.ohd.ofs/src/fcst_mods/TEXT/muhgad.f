C MODULE MUHGAD
C-----------------------------------------------------------------------
C
C
C     DESC - THIS SUBROUTINE PERFORMS THE UHGADJ MOD
C
      SUBROUTINE MUHGAD(MP,P,NCARDS,MODCRD,IDATE,IHZERO)
C
      LOGICAL FIRST,ONEOP
      CHARACTER*8 OPNAME,MODNAM,BLANK8,KWRDS,IFIELD,SLASH,UNAME
      INTEGER*4 STRCPD,ENDCPD
C
      INCLUDE 'ufreex'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fmodft'
C
      DIMENSION P(MP),VALUES(2),KWRDS(4),WORK1(100),WORK2(100)
      DIMENSION OLDOPN(2),MODCRD(20,NCARDS)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/muhgad.f,v $
     . $',                                                             '
     .$Id: muhgad.f,v 1.3 1998/07/02 20:52:02 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SLASH/'/       '/,BLANK8/'        '/
      DATA KWRDS/'H       ','HADJ    ','V       ','VADJ    '/
      DATA MODNAM/'UHGADJ  '/
C
      CALL FSTWHR(8HMUHGAD  ,0,OLDOPN,IOLDOP)
C
C     SET DEBUG FLAG
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HUHGA)
C
      IF(IBUG.GT.0)WRITE(IODBUG,10)IDATE
10    FORMAT(11X,'*** SUBROUTINE MUHGAD ENTERED *** - IDATE=',I11)
C
      FIRST=.TRUE.
C
C     CHECK TIME PERIOD AGAINST OBSERVED DATA PERIOD - PRINT WARNING IF
C     ENTIRE OBS. DATA PERIOD IS NOT WITHIN THE PERIOD BEING CHANGED
C
C     STRCPD=(IDA-1)*24+IHZERO
C     ENDCPD=(LDACPD-1)*24+LHRCPD
      STRCPD=(IDA-1)*24+IHZERO
      ENDCPD=(LDA-1)*24+LHR
C
      IF(IBUG.GT.0)WRITE(IODBUG,20)IDATE,STRCPD,ENDCPD
20    FORMAT(11X,' IDATE,  STRCPD,  ENDCPD ='/8X,3I9)
C
C     CHECK IF THE DATE IS THE SAME AS LSTCMPDY VALUE
C
      ICOMP=((LDACPD-1)*24)+LHRCPD
      IF(IDATE.EQ.ICOMP) GOTO 30
      IF(MODWRN.EQ.0) GOTO 440
        ITYPE=3
        CALL MODS1(NCARDS,ICMND,MODNAM,MODCRD,ITYPE)
        GOTO 440
C
C     NOW SEE IF ALL OF OBS. DATA PERIOD IS WITHIN THE PERIOD ENTERED
C
C 221 IF(IDATE.LT.STRCPD.OR.IDATE.GT.ENDCPD)GO TO 130
30    IF(IDATE.LT.STRCPD) GOTO 40
C
C     ALL OF THE OBS. DATA PERIOD IS WITHIN THE PERIOD BEING CHANGED
C
      GO TO 60
C
40    CONTINUE
C
C     OBS. DATA PERIOD IS NOT ENTIRELY WITHIN THE PERIOD BEING CHANGED
C
      IF(MODWRN.EQ.0)GO TO 440
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDACPD,LHRCPD,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,50)IM3,ID3,IY3,IH3,MODTZC,IM1,ID1,IY1,IH1,MODTZC,
     1IM2,ID2,IY2,IH2,MODTZC
50    FORMAT(1H0,10X,'**WARNING** THE DATE FOR CHANGES ENTERED IN THE ',
     1 'UHGADJ MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'IS NOT WITHIN 12 HOURS OF THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
C
C     LXDA=LDATE/24+1
C     LXHR=LDATE-(LXDA-1)*24
C     IF(LXHR.EQ.0)LXDA=LXDA-1
C     IF(LXHR.EQ.0)LXHR=24
C     CALL MDYH2(LXDA,LXHR,IM4,ID4,IY4,IH4,DUM1,DUM2,MODTZC)
C
C     WRITE(IPR,602)IM3,ID3,IY3,IH3,MODTZC,IM4,ID4,IY4,IH4,MODTZC,
C    1 IM1,ID1,IY1,IH1,MODTZC,IM2,ID2,IY2,IH2,MODTZC
C 602 FORMAT(1H0,10X,'**WARNING** THE DATE FOR CHANGES IN THE ',
C    1 'UHGADJ MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/15X,
C    2 'IS COMPLETELY OUTSIDE THE OBSERVED DATA PERIOD (',I2,1H/,I2,
C    3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
C    4 15X,'THESE CHANGES WILL BE IGNORED.')
C
      CALL WARN
      GO TO 440
C
60    MXVALS=100
C
C     READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
      FIRST=.TRUE.
C
      IF(NRDCRD.EQ.NCARDS)GO TO 80
C
70    IF(NRDCRD.EQ.NCARDS)GO TO 440
      NOPERS=0
C
      OPNAME=BLANK8
      UNAME=BLANK8
C
      IF(MISCMD(NCARDS,MODCRD).EQ.0)GO TO 100
C
      IF(.NOT.FIRST)GO TO 440
C
C     HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
80    IF(MODWRN.EQ.1)
     .WRITE(IPR,90)
90    FORMAT(1H0,10X,'**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'UHGADJ MOD.  PROCESSING CONTINUES')
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 440
C
100   FIRST=.FALSE.
C
      DO 110 I=1,2
110   VALUES(I)=1.
C
      NRDCRD=NRDCRD+1
C
C     NOW READ 2ND FIELD - MUST BE KEYWORD
C
      NFLD=1
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,IVALUE,VALUE,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 140
C
C     ERROR - DATA EXPECTED - PROCESS NEXT CARD
C
120   IF(MODWRN.EQ.1)
     .WRITE(IPR,130)(MODCRD(I,NRDCRD),I=1,20)
130   FORMAT(1H0,10X,'**WARNING** IN THE UHGADJ MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THE CARD BEING PROCESSED IS:'/
     2  11X,20A4)
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 70
C
140   DO 150 I=1,4
      IKEY=(I-1)/2 + 1
      IF(KWRDS(I).EQ.IFIELD)GO TO 170
150   CONTINUE
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IPR,160)(MODCRD(I,NRDCRD),I=1,20)
160   FORMAT(1H0,10X,'**WARNING** IN THE UHGADJ MOD - AN INVALID ',
     1  'KEYWORD FOUND ON THE FOLLOWING MOD CARD'/11X,20A4)
      GO TO 430
C
170   CONTINUE
C
C     NOW READ THE 3RD FIELD - MUST BE AN INTEGER OR REAL NUMBER
C
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 120
C
      IF(ITYPE.LT.2.AND.NREP.EQ.-1)GO TO 190
C
C     VALUE IS NOT AN INTEGER NOR A REAL NUMBER
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,180)(MODCRD(I,NRDCRD),I=1,20)
180   FORMAT(1H0,10X,'**WARNING** A NONNUMERIC VALUE WAS DECODED ',
     1  'WHERE ONE WAS EXPECTED'/11X,'THE CURRENT MOD CARD IS'/11X,20A4)
      IF(MODWRN.EQ.1)CALL WARN
      GO TO 70
C
190   VALUES(IKEY)=REAL
C
C     SEE IF THERE IS ANOTHER FIELD - IF NOT PROCESS THE INFO
C     IN ARRAYS() - IF SO IT MUST BE A KEYWORD OR A SLASH (/)
C
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 240
C
C     ANOTHER FIELD - IS IT A SLASH ? - IS NOT SEE IF A KEYWORD
C
      IF(IFIELD.NE.SLASH)GO TO 140
C
C     GET HERE IF FIELD IS A SLASH
C     NOW READ NEXT FIELD - OPERATION NAME
C
      ONEOP=.TRUE.
      ISTRT=-3
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTGER,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 210
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IODBUG,200)(MODCRD(I,NRDCRD),I=1,20)
200   FORMAT(11X,'** WARNING ** NO OPERATION NAME ENTERED ',
     1 'AFTER A SLASH ON THE FOLLOWING MOD CARD'/11X,20A4/
     2 11X,'THIS CARD IS IGNORED.')
      GO TO 430
210   CONTINUE
C
      OPNAME=IFIELD
C
C     CHECK THAT OPERATION NAME ENTERED IS IN SEGMENT
C     IF NOT, READ NEXT CARD
C
      LOCOPN=0
      CALL FSERCH(2,OPNAME,LOCOPN,P,MP)
C
      IF(IBUG.GT.0)WRITE(IODBUG,220)OPNAME,ONEOP,LOCOPN
220   FORMAT(11X,'BACK FROM FSERCH LOOKING FOR OPERATION NAMED ',A8/
     1 11X,'ONEOP = ',L4,', LOCOPN = ',I5)
C
      IF(LOCOPN.GT.0)GO TO 280
C
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IPR,230)OPNAME
230   FORMAT(1H0,10X,'** WARNING ** IN UHGADJ MOD - ',
     1 'UNIT-HYDROGRAPH OPERATION ',A8,' NOT IN THIS SEGMENT.')
      GO TO 430
C
C     FIND START OF SECOND PORTION OF P ARRAY FOR THE OPERATION
C
240   LOCOPN=1
      ONEOP=.FALSE.
250   CALL FSERCH(2,OPNAME,LOCOPN,P,MP)
C
      IF(IBUG.GT.0)WRITE(IODBUG,260)OPNAME,ONEOP,LOCOPN,NOPERS
260   FORMAT(11X,'BACK FROM FSERCH LOOKING FOR ALL UNIT-HYDROGRAPH ',
     1 'OPERATIONS IN THIS SEGMENT'/11X,'OPNAME= ',A8,
     2 ', ONEOP= ',L4,', LOCOPN= ',I5,', NOPERS= ',I3)
C
      IF(LOCOPN.GT.0)GO TO 280
C
C     NO MORE UNIT-HYDROGRAPH OPERATIONS IN THIS SEGMENT
C     PRINT WARNING IF NO UNIT-HG OPERS WERE FOUND
C
      IF(NOPERS.GT.0)GO TO 70
C
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IPR,270)
270   FORMAT(1H0,10X,'** WARNING ** IN UHGADJ MOD - NO ',
     1 'UNIT-HYDROGRAPH OPERATIONS FOUND IN THIS SEGMENT.')
      GO TO 430
C
C     CHECK FOR HORIZONTAL OR VERTICAL ADJUSTMENTS OUT OF RANGE
C
280   IF(VALUES(1).GE.0.2.AND.VALUES(1).LE.5.0)GO TO 300
      VALTMP=VALUES(1)
      IF(VALUES(1).GT.5.0)VALUES(1)=5.0
      IF(VALUES(1).LT.0.2)VALUES(1)=0.2
      IF(MODWRN.EQ.0)GO TO 300
      WRITE(IPR,290)VALTMP,VALUES(1)
290   FORMAT(1H0,10X,'** WARNING ** IN THE UHGADJ MOD - ',
     1 'THE HORIZONTAL ADJUSTMENT FACTOR ENTERED (',F9.2,
     2 ') IS OUT OF RANGE.'/11X,'IT WILL BE RESET TO ',F9.2)
      CALL WARN
C
300   IF(VALUES(2).GE.0.7.AND.VALUES(2).LE.5.0)GO TO 320
      VALTMP=VALUES(2)
      IF(VALUES(2).GT.5.0)VALUES(2)=5.0
      IF(VALUES(2).LT.0.5)VALUES(2)=0.5
      IF(MODWRN.EQ.0)GO TO 300
      WRITE(IPR,310)VALTMP,VALUES(2)
310   FORMAT(1H0,10X,'** WARNING ** IN THE UHGADJ MOD - ',
     1 'THE VERTICAL ADJUSTMENT FACTOR ENTERED (',F9.2,
     2 ') IS OUT OF RANGE.'/11X,'IT WILL BE RESET TO ',F9.2)
      CALL WARN
C
C     NUMBER OF UNIT-HG ORDINATES IS IN POSITION 10 OF P ARRAY
C     ORDINATES START IN POSITION 27
C
320   LOCP=LOCOPN-1
      NOPERS=NOPERS+1
      NORDS=P(LOCP+10)
      LORDS=LOCP+27-1
      CALL UMEMOV(P(LOCOPN-5),UNAME,2)
      IF(NORDS.LE.MXVALS)GO TO 340
C
C     MORE ORDINATES IN THIS UNIT-HYDROGRAPH THAN WORK SPACE
C
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IPR,330)MXVALS,UNAME,NORDS
330   FORMAT(1H0,10X,'** WARNING ** A MAXIMUM OF ',I3,
     1 'ORDINATES CAN BE CHANGED WITH THE UHGADJ MOD.'/11X,
     2 'UNIT-HYDROGRAPH OPERATION ',A8,' HAS ',I3,' ORDINATES.'/
     3 11X,'NO CHANGES WILL BE MADE TO THIS OPERATION.')
      GO TO 430
C
340   IF(IBUG.LT.1)GO TO 370
C
      WRITE(IODBUG,350)IDATE,LDATE,VALUES,NORDS,OPNAME,UNAME
350   FORMAT(11X,'IN SUBROUTINE MUHGAD - UHGADJ MOD'/11X,
     1 'IDATE,     LDATE,  HADJ,  VADJ, NORDS, OPNAME,  UNAME ='/5X,
     1 2I11,2F7.2,I6,2X,A8,1X,A8)
      IF(NORDS.GT.0)WRITE(IODBUG,360)(P(LORDS+I),I=1,NORDS)
360   FORMAT(11X,'CURRENT UNIT HYDROGRAPH ORDINATES ='/(11X,10G9.2))
C
C     CALL SUBROUTINE OPUGAJ TO GET ADJUSTED UNIT-HYDROGRAPH
C
370   CALL OPUGAJ(VALUES(1),VALUES(2),P(LORDS+1),WORK1,WORK2,NORDS,IST)
C
      IF(IST.EQ.0)GO TO 390
C
      IF(MODWRN.EQ.0)GO TO 70
      WRITE(IPR,380)IST,VALUES,UNAME,LOCOPN
380   FORMAT(1H0,10X,'** WARNING ** IN UHGADJ MOD - STATUS OF ',I3,
     1 ' RETURNED FROM SUBROUTINE OPUGAJ.'/
     2 11X,'HORIZONTAL ADJUSTMENT = ',F7.2,', VERTICAL ADJUSTMENT =',
     3 F7.2,', UNIT-HYDROGRAPH OPERATION NAME IS ',A8,', LOCOPN =',I5)
      CALL WARN
C
C     STORE NEW VALUES IN P ARRAY
C
390   IF(IBUG.GT.0)WRITE(IODBUG,400)NORDS,LORDS,(WORK1(I),I=1,NORDS)
400   FORMAT(11X,'ABOUT TO MOVE ',I3,' UNIT-HYDROGRAPH ORDINATES INTO ',
     1 'THE P ARRAY'/11X,'STARTING AT LOCATION ',I5,'+1, THE VALUES ARE'
     2 /(11X,10G10.2))
C
      DO 410 I=1,NORDS
410   P(LORDS+I)=WORK1(I)
C
      WRITE(IPR,420)UNAME,VALUES,(P(LORDS+I),I=1,NORDS)
420   FORMAT(1H0,10X,'THE UNIT-HYDROGRAPH FOR OPERATION ',A8,
     1 ' HAS BEEN CHANGED WITH THE UHGADJ MOD.'/11X,
     2 'THE HORIZONTAL ADJUSTMENT IS ',F7.2,', THE VERTICAL ',
     3 'ADJUSTMENT IS ',F7.2/11X,'THE NEW UNIT-HYDROGRAPH ',
     4 'ORDINATES ARE'/(11X,10F9.2))
C
C     IF A SPECIFIC OPERATION NAME WAS ENTERED READ NEXT CARD,
C     IF NO OPERATION NAME WAS ENTERED, SEARCH P ARRAY FOR ANOTHER
C     UNIT-HYDROGRAPH OPERATION
C
      IF(ONEOP)GO TO 70
      GO TO 250
C
430   IF(MODWRN.EQ.1)CALL WARN
      GO TO 70
C
440   CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
      IF(IBUG.GT.0)WRITE(IODBUG,450)
450   FORMAT(11X,'*** LEAVING SUBROUTINE MUHGAD ***')
      RETURN
      END
