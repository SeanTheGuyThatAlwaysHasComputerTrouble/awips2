C MODULE MCBLND
C----------------------------------------------------------------------
C
C
C     DESC - THIS SUBROUTINE PERFORMS THE CHGBLEND MOD
C
      SUBROUTINE MCBLND(MP,P,NCARDS,MODCRD,IDATE,IHZERO,ISTATT)
C
      LOGICAL FIRST
      CHARACTER*8 OPNAME,OPN,BLANK8
C
      INCLUDE 'ufreex'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fctim2'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fpwarn'
      INCLUDE 'common/fmodft'
C
      DIMENSION P(MP),IFIELD(3)
      DIMENSION OLDOPN(2),MODCRD(20,NCARDS)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mods/RCS/mcblnd.f,v $
     . $',                                                             '
     .$Id: mcblnd.f,v 1.2 1998/07/02 20:44:40 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA ISLASH/4H/   /,BLANK8/'        '/
C
      CALL FSTWHR(8HMCBLND  ,0,OLDOPN,IOLDOP)
C
C  SET DEBUG SWITCH
C
      IBUG=IFBUG(4HMODS)+IFBUG(4HCHGB)
C
      IF (IBUG.GT.0) WRITE(IODBUG,10) IDATE
10    FORMAT(1H0,10X,'IN SUBROUTINE MCBLND, IDATE = ',I11)
C
      IDATE=IABS(IDATE)
      ISTATT=1
C
C  SEE IF DATE IS WITHIN RUN PERIOD
C
      ISTHR=(IDA-1)*24+IHZERO
      IENHR=(LDA-1)*24+LHR
C
      IF(ISTHR.LE.IDATE.AND.IENHR.GE.IDATE) GOTO 30
C
C  DATE NOT WITHIN ALLOWABLE WINDOW
C
      CALL MDYH2(IDA,IHZERO,IM1,ID1,IY1,IH1,DUM1,DUM2,MODTZC)
      CALL MDYH2(LDA,LHR,IM2,ID2,IY2,IH2,DUM1,DUM2,MODTZC)
      IXDA=IDATE/24+1
      IXHR=IDATE-(IXDA-1)*24
      IF(IXHR.EQ.0)IXDA=IXDA-1
      IF(IXHR.EQ.0)IXHR=24
      CALL MDYH2(IXDA,IXHR,IM3,ID3,IY3,IH3,DUM1,DUM2,MODTZC)
C
      IF(MODWRN.EQ.1)
     .WRITE(IPR,20)IM3,ID3,IY3,IH3,MODTZC,IM1,ID1,IY1,IH1,MODTZC,
     1IM2,ID2,IY2,IH2,MODTZC
20    FORMAT(1H0,10X,'**WARNING** THE DATE FOR CHANGES ENTERED IN THE ',
     1 'CHGBLEND MOD (',I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/11X,
     2 'IS NOT WITHIN THE CURRENT RUN PERIOD (',I2,1H/,I2,
     3 1H/,I4,1H-,I2,1X,A4,4H TO ,I2,1H/,I2,1H/,I4,1H-,I2,1X,A4,1H)/
     4 11X,'THESE CHANGES WILL BE IGNORED.')
      IF (MODWRN.EQ.1) CALL WARN
      GOTO 280
C
30    CONTINUE
C
C     READ CARD - IF COMMAND, LEAVE - IF COMMAND AND 1ST CARD, ERROR
C
      OPNAME=BLANK8
      OPN=BLANK8
      FIRST=.TRUE.
C
      IF (NRDCRD.EQ.NCARDS) GOTO 50
C
40    IF (NRDCRD.EQ.NCARDS) GOTO 280
C
      IF (MISCMD(NCARDS,MODCRD).EQ.0) GOTO 70
C
      IF (.NOT.FIRST) GOTO 280
C
C     HAVE FOUND COMMAND AS FIRST SUBSEQUENT CARD - ERROR
C
50    IF (MODWRN.EQ.1) WRITE(IPR,60)
60    FORMAT(1H0,10X,'**WARNING** NO SUBSEQUENT CARDS FOUND FOR THE ',
     1  'CHGBLEND MOD.  PROCESSING CONTINUES')
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 280
C
70    FIRST=.FALSE.
      NRDCRD=NRDCRD+1
C
C     NOW READ 2ND FIELD - MUST BE AN INTEGER
C
      NFLD=1
      ISTRT=-3
      NCHAR=3
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTEGR,VALUE,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTAT.EQ.0)GO TO 90
C
C     ERROR - DATA EXPECTED - PROCESS NEXT CARD
C
      IF (MODWRN.EQ.1) WRITE(IPR,80) (MODCRD(I,NRDCRD),I=1,20)
80    FORMAT(1H0,10X,'**WARNING** IN CHGBLEND MOD - NOT ENOUGH ',
     1  'FIELDS ON SUBSEQUENT CARD.  THIS CHANGE WILL BE IGNORED.'/,
     2  11X,'THE CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
90    IF (ITYPE.EQ.0.OR.ITYPE.EQ.1) THEN
         IF(NREP.EQ.-1) GOTO 110
         ENDIF
C
      IF (MODWRN.EQ.1) WRITE(IPR,100)(MODCRD(I,NRDCRD),I=1,20)
100   FORMAT(1H0,10X,'**WARNING** IN CHGBLEND MOD - INVALID VALUE ',
     1  'FOUND.  THIS CARD WILL BE IGNORED.',/,11X,'THE CURRENT ',
     2  'CARD IMAGE IS: ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
110   IF(INTEGR.GT.0.OR.VALUE.GT.0.0) GOTO 130
C
C     BAD CHGBLEND VALUE ENTERED
C
      IF (MODWRN.EQ.1) WRITE(IPR,120) INTEGR,(MODCRD(I,NRDCRD),I=1,20)
120   FORMAT(1H0,10X,'**WARNING** IN  MOD - VALUE ',I7,' IS OUT OF ',
     1 'VALID RANGE.  THIS CARD WILL BE IGNORED.',/,11X,'THE ',
     2 'CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
130   CONTINUE
C
      IF (ITYPE.EQ.0) CBLEND=INTEGR
      IF (ITYPE.EQ.1) THEN
         ITEMP=IFIX(VALUE)
         CBLEND=ITEMP
         ENDIF
      CBLEND=CBLEND+0.01
C
C     LOOK FOR ADJUST-Q OPERATIONS IN THIS SEGMENT WITH NAME OPNAME
C     IF OPNAME BLANK - CHANGE FOR ALL ADJUST-Q OPERS IN THIS SEGMENT
C
C     READ NEXT FIELD - IF NONE CHANGE ALL ADJUST-Q OPERS IN SEGMENT
C     IF A SLASH FOUND - READ OPERATION NAME IN FOLLOWING FIELD
C
      ISTRT=-3
      NCHAR=3
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTEGR,REAL,
     1  NCHAR,IFIELD,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.EQ.-2)GO TO 230
C
C     FIELD FOUND - MUST BE A SLASH
C
      IF(LEN.EQ.1.AND.IFIELD(1).EQ.ISLASH)GO TO 150
C
C     FIELD IS NOT SLASH - ERROR
C
      IF (MODWRN.EQ.1) WRITE(IPR,140) (MODCRD(I,NRDCRD),I=1,20)
140   FORMAT(1H0,10X,'**WARNING** A SLASH WAS EXPECTED AS THE THIRD ',
     1 'FIELD OF THE INPUT CARD.  THIS CARD WILL BE IGNORED.',/,11X,
     2 'THE CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
150   CONTINUE
C
C     SLASH FOUND - NOW READ OPERATION NAME
C
      ISTRT=-3
      NCHAR=2
      ICKDAT=0
C
      CALL UFIEL2(NCARDS,MODCRD,NFLD,ISTRT,LEN,ITYPE,NREP,INTEGR,REAL,
     1  NCHAR,OPNAME,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
      IF(ISTRT.NE.-2)GO TO 170
C
C     NO FIELD FOUND FOR OPERATION NAME - ERROR
C
      IF (MODWRN.EQ.1) WRITE(IPR,160) (MODCRD(I,NRDCRD),I=1,20)
160   FORMAT(1H0,10X,'**WARNING** NO OPERATION NAME WAS FOUND AFTER ',
     1 'THE SLASH OF THE INPUT CARD.  THIS CARD WILL BE IGNORED.',/11X,
     2 'THE CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
C     HAVE A SPECIFIC OPERATION NAME - FIND THAT OPERATION
C
170   LOCP=0
      CALL FSERCH(14,OPNAME,LOCP,P,MP)
C
      IF (LOCP.GT.0) GOTO 190
C
C     HAVE NOT FOUND THE REQUESTED OPERATION - ERROR
C
      IF (MODWRN.EQ.1) WRITE(IPR,180) OPNAME,(MODCRD(I,NRDCRD),I=1,20)
180   FORMAT(1H0,10X,'**WARNING** A ADJUST-Q OPERATION WITH NAME ',
     1 A8,' HAS NOT BEEN FOUND.  THIS CARD WILL BE IGNORED.',/,11X,
     2 'THE CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 40
C
190   CONTINUE
C
C     HAVE FOUND OPERATION - CHANGE VALUE IN P ARRAY
C
      LPO=(LOCP+17-1)
      IF((LPO.GT.0).AND.(LPO.LE.MP)) GOTO 210
C
C     POINTER LOCATION OF PADJ(17) IS OUT OF RANGE - CANNOT USE CHGBLEND
C
      IF (MODWRN.EQ.0) GOTO 40
      WRITE(IPR,200) P(LC),OPNAME,(MODCRD(I,NRDCRD),I=1,20)
200   FORMAT(1H0,10X,'**WARNING** IN CHGBLEND MOD - POINTER LOCATION ',
     1 'OF PADJ(17) IS ',I5,' IN ADJUST-Q OPERATION ',A8,/,11X,'THE ',
     2 'CURRENT CARD IMAGE IS : ',20A4)
      CALL WARN
      GO TO 40
C
C     CHANGE BLEND PERIOD OF ADJUST-Q IN P ARRAY AT START OF RUN
C
210   P(LPO)=CBLEND
      ISTATT=0
C
      IF(IBUG.GT.0) WRITE(IODBUG,220) CBLEND,LPO,OPNAME
220   FORMAT(11X,'IN CHGBLEND MOD - SUBROUTINE MCBLND'/11X,
     1'A VALUE OF ',F7.2,' HAS BEEN STORED IN LOCATION ',I6,
     2 ' OF THE P ARRAY FOR OPERATION ',A8)
      GO TO 40
C
230   CONTINUE
C
C     CHANGE ALL OCCURENCES OF ADJUST-Q OPERATION IN THIS SEGMENT
C
      NCHNGE=0
      LOCP=1
240   CALL FSERCH(14,OPN,LOCP,P,MP)
C
      IF(LOCP.EQ.0.AND.NCHNGE.GT.0)GO TO 40
      IF(LOCP.GT.0)GO TO 260
C
C     IF GET HERE HAVE NOT FOUND ANY ADJUST-Q OPERATIONS IN THIS SEGMENT
C
      IF (MODWRN.EQ.1) WRITE(IPR,250) (MODCRD(I,NRDCRD),I=1,20)
250   FORMAT(1H0,10X,'**WARNING** A CHGBLEND MOD WAS REQUESTED FOR ',
     1 'THIS SEGMENT BUT NO ADJUST-Q OPERATIONS WERE FOUND.',/,11X,
     2 'THE CURRENT CARD IMAGE IS : ',20A4)
      IF (MODWRN.EQ.1) CALL WARN
      GO TO 280
C
260   CONTINUE
C
C     HAVE FOUND A ADJUST-Q OPERATION - CHANGE P ARRAY
C
      LPO=(LOCP+17-1)
      IF((LPO.GT.0).AND.(LPO.LE.MP)) GOTO 270
C
C    POINTER LOCATION OF PADJ(17) IS OUT OF RANGE - CANNOT USE CHGBLEND
C
      IF(MODWRN.EQ.0)GO TO 240
      WRITE(IPR,200)P(LC),OPN
      CALL WARN
      GO TO 240
C
C    CHANGE BLEND PERIOD IN P ARRAY AT START OF RUN
C
270   P(LPO)=CBLEND
      NCHNGE=NCHNGE+1
      ISTATT=0
C
      IF (IBUG.GT.0) WRITE(IODBUG,220) CBLEND,LPO,OPN
      GO TO 240
C
280   CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
      IF(IBUG.GT.0)WRITE(IODBUG,290)
290   FORMAT(11X,'*** LEAVING MCBLND ***')
C
      RETURN
      END
