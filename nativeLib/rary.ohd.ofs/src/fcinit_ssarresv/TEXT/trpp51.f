C MEMBER TRPP51
C--------------------------------------------------------------------
C
C@PROCESS LVL(77)
C
      SUBROUTINE TRPP51(WK,IUSEW,LEFTW,NPTRP)
C
C DESC READ AND STORE PARAMETERS FOR TRP SECTION OF OPERATION 51
C
C----------------------------------------------------------------------
C  ARGS:
C     WK - ARRAY TO BE FILLED WITH THE PARAMETERS
C    IUSEW - NUMBER OF WORDS ALREADY USED IN WORK ARRAY
C    LEFTW - NUMBER OF WORDS LEFT IN WORK ARRAY
C    NPTRP - NUMBER OF WORDS NEEDED TO STORE TRP PARAMETERS
C---------------------------------------------------------------------
C
C  KUANG HSU - HRL - APRIL 1994
C----------------------------------------------------------------
      INCLUDE 'common/fld51'
      INCLUDE 'common/read51'
      INCLUDE 'common/comn51'
C
      DIMENSION KEYWDS(2,9),LKEYWD(9),VALUE(100),QSTOR(50),
     . QELBW(600),IQEL(2,2),LIQEL(2),OK(6),WK(*),IG(9)
      LOGICAL OK
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcinit_ssarresv/RCS/trpp51.f,v $
     . $',                                                             '
     .$Id: trpp51.f,v 1.1 1996/03/21 14:41:25 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA KEYWDS/4HRCEL,4HEV  ,4HRCDI,4HSCH ,4H3VAR,4HTABL,
     .            4HBACK,4HWATR,4HCONT,4HROL2,4HSITE,4H    ,
     .            4HENDP,4H    ,4HENDP,4HARMS,4HENDT,4HRP  /
      DATA LKEYWD/2,2,2,2,2,1,1,2,2/
      DATA NKEYWD/9/
      DATA NDKEY/2/
C
      DATA IQEL/4HFLOW,4H    ,4HELEV,4H    /
      DATA LIQEL/1,1/
      DATA NIQEL/2/
      DATA NDIQEL/2/
C
C  INITIALIZE LOCAL VARIABLES AND COUNTERS
C
      NSE = 2
      NQE = 2
      ELSTOR(1) = 0.0
      STORGE(1) = 0.0
      QSTOR(1) = 0.0
      ELSTOR(2) = 999999.
      STORGE(2) = 999999.
      QSTOR(2) = 999999.
      ICON2=1
      ISITE=2
C
      NQBK = 0
      NPTRP = 0
      LCARD = NCARD
      USEDUP = .FALSE.
C
C  6 KEYWORD = RCELEV, RCDISCH, 3VARTABL, BACKWATR,CONTROL2, SITE
      DO 3 I = 1,6
 3    OK(I) = .TRUE.
C
      DO 5 I = 1,9
 5    IG(I) = 0
C-----------------------------------------------------------------
C  NOW LOOK FOR MATCHING KEYWORDS IN INPUT STREAM
C
   10 CONTINUE
      NUMFLD = 0
      CALL UFLD51(NUMFLD,IERF)
      IF (IERF.GT.0) GO TO 9000
C
   20 CONTINUE
      NUMWD = (LEN-1)/4 + 1
      IDEST = IKEY26(CHAR,NUMWD,KEYWDS,LKEYWD,NKEYWD,NDKEY) + 1
C
      GO TO (100,300,400,500,600,700,800,1000,1000,1100) , IDEST
C
C---------------------------------------------------------------------
C  NO VALID KEYWORD FOUND
C
  100 CONTINUE
      CALL STER51(1,1)
      GO TO 10
C
C-----------------------------------------------------------------------
C   'RCELEV' FOUND
C  SET INDICATOR THAT KEYWORD HAS BEEN FOUND, IF KEYWORD HAS ALREADY
C   BEEN FOUND, IT IS AN ERROR
C
  300 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 310
      CALL STER51(39,1)
C
  305 CONTINUE
      NUMFLD = 0
      CALL UFLD51(NUMFLD,IERF)
      IF (IERF.EQ.3) GO TO 9000
      IF (ITYPE.LE.1) GO TO 305
      GO TO 20
C
C  START GETTING NUMBERS FOR CURVE DEFINITION. RULES FOR INPUT ARE
C  A CONTINUATION SYMBOL (&) MUST END THE LINE AS A STAND ALONE CHAR-
C  ACTER, NO OF DISCHARGES MUST BE EQUAL TO NO. OF ELEVATIONS
C
  310 CONTINUE
C
      NVAL=50
      CALL GLST51(1,1,X,VALUE,X,NVAL,OK(ID))
      IF (.NOT.OK(ID)) GO TO 10
C
C  ALL VALUES ARE REAL AND WE'VE NO MORE INPUT ON A LINE(NO CONTINUATION
C  NOW WE HAVE TO CHECK THE VALUES FOR A CERTAIN AMOUNT OF VALIDITY
C  BEFORE WE CAN STORE THEM. ONE IS THAT THE NUMBER OF VALUES OF
C  DISCHARGE AND ELEVATION MUST BE EQUAL, THE OTHER IS THAT
C  THE DISCHARGE VALUES ARE IN ASCENDING ORDER.
C
C
C  SEE IF VALUES ARE IN ASCENDING ORDER
C
      NQE = NVAL
      DO 357 K = 2,NQE
      IF (VALUE(K).GT.VALUE(K-1)) GO TO 357
      CALL STER51(41,1)
      OK(ID) = .FALSE.
      NUMFLD = 0
      GO TO 10
  357 CONTINUE
C
C  STORE DISCHARGE VALUES CORRESPONDING TO ELEVATION/STORAGE CURVE
C
      DO 380 I=1,NSE
      ELSTOR(I) = VALUE(I)
      STORGE(I) = 0.0
  380 CONTINUE
C
      GO TO 10
C
C-----------------------------------------------------------------------
C   'RCDISCH' FOUND
C  SET INDICATOR THAT KEYWORD HAS BEEN FOUND, IF KEYWORD HAS ALREADY
C  BEEN FOUND, IT IS AN ERROR
C
  400 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 410
      CALL STER51(39,1)
C
  405 CONTINUE
      NUMFLD = 0
      CALL UFLD51(NUMFLD,IERF)
      IF (IERF.EQ.3) GO TO 9000
      IF (ITYPE.LE.1) GO TO 405
      GO TO 20
C
C  START GETTING NUMBERS FOR CURVE DEFINITION. RULES FOR INPUT ARE
C  A CONTINUATION SYMBOL (&) MUST END THE LINE AS A STAND ALONE CHAR-
C  ACTER, NO OF DISCHARGES MUST BE EQUAL TO NO. OF ELEVATIONS
C
  410 CONTINUE
C
      NVAL=50
      CALL GLST51(1,1,X,VALUE,X,NVAL,OK(ID))
      IF (.NOT.OK(ID)) GO TO 10
C
C  ALL VALUES ARE REAL AND WE'VE NO MORE INPUT ON A LINE(NO CONTINUATION
C  NOW WE HAVE TO CHECK THE VALUES FOR A CERTAIN AMOUNT OF VALIDITY
C  BEFORE WE CAN STORE THEM. ONE IS THAT THE NUMBER OF VALUES OF
C  DISCHARGE AND ELEVATION MUST BE EQUAL, THE OTHER IS THAT
C  THE DISCHARGE VALUES ARE IN ASCENDING ORDER.
C
C
C  SEE IF VALUES ARE IN ASCENDING ORDER
C
      NQE = NVAL
      DO 457 K = 2,NQE
      IF (VALUE(K).GT.VALUE(K-1)) GO TO 457
      CALL STER51(41,1)
      OK(ID) = .FALSE.
      NUMFLD = 0
      GO TO 10
  457 CONTINUE
C
C  CHECK EQUAL NO. OF DISCHARGE AND ELEVATION/STORAGE VALUES
C  IN ELVSSTOR CURVE
C
      IF(NQE.EQ.NSE) GO TO 460
      CALL STER51(23,1)
      OK(ID) = .FALSE.
      GO TO 10
  460 CONTINUE
C
C  STORE DISCHARGE VALUES CORRESPONDING TO ELEVATION/STORAGE CURVE
C
      DO 480 I=1,NQE
      QSTOR(I) = VALUE(I)
  480 CONTINUE
C
      GO TO 10
C
C-----------------------------------------------------------------------
C   '3VARTABL' FOUND
C  SET INDICATOR THAT KEYWORD HAS BEEN FOUND, IF KEYWORD HAS ALREADY
C  BEEN FOUND, IT IS AN ERROR
C
  500 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 510
      CALL STER51(39,1)
C
  505 CONTINUE
      NUMFLD = 0
      CALL UFLD51(NUMFLD,IERF)
      IF (IERF.EQ.3) GO TO 9000
      IF (ITYPE.LE.1) GO TO 505
      GO TO 20
C
C  START GETTING NUMBERS FOR CURVE DEFINITION. RULES FOR INPUT ARE
C  A CONTINUATION SYMBOL (&) MUST END THE LINE AS A STAND ALONE CHAR-
C  ACTER, NO OF DISCHARGES MUST BE EQUAL TO NO. OF ELEVATIONS
C
  510 CONTINUE
C
      NVAL=600
      CALL GLST51(1,1,X,QELBW,X,NVAL,OK(ID))
      IF (.NOT.OK(ID)) GO TO 10
C
C  ALL VALUES ARE REAL AND WE'VE NO MORE INPUT ON A LINE(NO CONTINUATION
C  NOW WE HAVE TO CHECK THE VALUES FOR A CERTAIN AMOUNT OF VALIDITY
C  BEFORE WE CAN STORE THEM. 
C  ONE IS THAT THE NUMBER OF VALUES MUST BE AN EVEN MULTIPLES OF SEVEN
C  THE OTHER IS THAT THE SECOND INDEPENDENT VALUES ARE IN ASCENDING
C  ORDER.
C
C  THE CURVE VALUES:
C  SECOND INDENPENDENT VARIABLE (Z), FOLLOWED BY THREE PAIRS OF
C  (FIRST INDEPENDENT VARIALBE (X), DEPENDENT VARIABLE (Y)
C
  550 CONTINUE
C
      IF (MOD(NVAL,3).EQ.0) GO TO 555
      CALL STER51(65,1)
      OK(ID) = .FALSE.
      GO TO 10
C
C  SEE IF VALUES ARE IN ASCENDING ORDER
C
 555  CONTINUE
      NQBK = NVAL/3
      NQBKM = NQBK - 1
C
      DO 540 K = 1,NQBKM
C
C  SECOND INDEPENDENT VARIABLE (Z) -- DISCHARGE OR ELEVATION
      NQC1 = 3*(K-1)+1
      NQC2 = 3*K+1
      IF(QELBW(NQC2).GE.QELBW(NQC1)) GO TO 540
      CALL STER51(41,1)
      OK(ID) = .FALSE.
      GO TO 10
 540  CONTINUE
C
      GO TO 10
C
C-----------------------------------------------------------------------
C  'BACKWATR' KEYWORD FOUND, LOOK FOR VALID FOLLOWING KEYWORD
C  INDICATOR AT SITE (X) DISCHARGE OR ELEVATION
C
  600 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 610
      CALL STER51(39,1)
C
 610  NUMFLD = -2
      CALL UFLD51(NUMFLD,IERF)
C
C  IF NOTHING ON CARD AFTER 'BACKWATR', ERROR OUT
C
      IF (IERF.GE.1) GO TO 9000
      NUMWD = (LEN-1)/4 + 1
      IDEST = IKEY26(CHAR,NUMWD,IQEL,LIQEL,NIQEL,NDIQEL)
      IF (IDEST.GT.0) GO TO 620
C
C  NOT A VALID 'BACKWATR' INDICATOR, ERROR OUT
C
      CALL STER51(42,1)
      OK(ID) = .FALSE.
C
  620 CONTINUE
      ICON1 = IDEST
C
  650 CONTINUE
      GO TO 10
C
C-----------------------------------------------------------------------
C  'CONTROL2' KEYWORD FOUND, LOOK FOR VALID FOLLOWING KEYWORD
C  INDICATOR AT SITE (Z) DISCHARGE OR ELEVATION
C
  700 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 710
      CALL STER51(39,1)
C
 710  NUMFLD = -2
      CALL UFLD51(NUMFLD,IERF)
C
C  IF NOTHING ON CARD AFTER 'CONTROL2', ERROR OUT
C
      IF (IERF.GE.1) GO TO 9000
      NUMWD = (LEN-1)/4 + 1
      IDEST = IKEY26(CHAR,NUMWD,IQEL,LIQEL,NIQEL,NDIQEL)
      IF (IDEST.GT.0) GO TO 720
C
C  NOT A VALID 'CONTROL2' INDICATOR, ERROR OUT
C
      CALL STER51(42,1)
      OK(ID) = .FALSE.
C
  720 CONTINUE
      ICON2 = IDEST
C
  750 CONTINUE
      GO TO 10
C
C-----------------------------------------------------------------------
C  'SITE' KEYWORD FOUND, LOOK FOR VALID FOLLOWING KEYWORD
C  INDICATOR AT SITE (Y) DISCHARGE OR ELEVATION
C
  800 CONTINUE
      ID = IDEST - 1
      IG(ID) = IG(ID) + 1
      IF(IG(ID).LE.1) GO TO 810
      CALL STER51(39,1)
C
 810  NUMFLD = -2
      CALL UFLD51(NUMFLD,IERF)
C
C  IF NOTHING ON CARD AFTER 'SITE', ERROR OUT
C
      IF (IERF.GE.1) GO TO 9000
      NUMWD = (LEN-1)/4 + 1
      IDEST = IKEY26(CHAR,NUMWD,IQEL,LIQEL,NIQEL,NDIQEL)
      IF (IDEST.GT.0) GO TO 820
C
C  NOT A VALID 'SITE' INDICATOR, ERROR OUT
C
      CALL STER51(42,1)
      OK(ID) = .FALSE.
C
  820 CONTINUE
      ISITE = IDEST
C
  850 CONTINUE
      GO TO 10
C
C------------------------------------------------------------------
C  'ENDP' FOUND. 
C  STORE THE CURVES AND OTHER PARMS IN WORK ARRAY IF EVERYTHING OK.
C
 1000 CONTINUE
C
C  '3VARTABL' AND 'BACKWATR' ARE REQUIRED KEYWORDS
      DO 1044 I=3,4
      IF(IG(I).GT.0) GO TO 1044
      CALL STRN51(59,1,KEYWDS(1,I),LKEYWD(I))
      OK(I) = .FALSE.
 1044 CONTINUE 
C
C CHECK NO. DISCHARGES EQUALS TO NO. OF ELEVATIONS OF THE ELVSSTOR CURVE
C
      IF(IG(3).GT.0) THEN
        IF(NQE.NE.NSE) THEN
          CALL STER51(42,1)
          OK(3) = .FALSE.
        END IF
      END IF
C
      DO 1103 I=1,5
 1103 IF(.NOT.OK(I)) GO TO 9999   
C
      NPTRP = 0
C
C  STORE RESERVOIR TYPE: =0, NON-BACKWATER RESERVOIR
C  =1, UPSTREAM RESERVOIR AFFECTED BY DOWNSTREAM RESERVOIR
C  =2, DOWNSTREAM RESERVOIR AFFECTED BY TRIBUTARY FLOW
C  =3, THREE VARIABLE RELATION WITHOUT BACKWATER ROUTING
C
      RESTYP = 3.0
      CALL FLWK51(WK,IUSEW,LEFTW,RESTYP,501)
      NPTRP = NPTRP+1
C
C  STORE THE NO. OF DATA POINTS IN THE ELEVATION/STORAGE/DISCHARGE CURVE
C  FOLLOWED BY THE CURVE VALUES: ELEVATIONS, THEN STORAGES,
C  THEN DISCHARGE.
C
      COUNT = NSE
C
      CALL FLWK51(WK,IUSEW,LEFTW,COUNT,501)
      NPTRP = NPTRP+1
C
C  STORE ELEVATION VALUES
C
      DO 1620 I=1,NSE
      CALL FLWK51(WK,IUSEW,LEFTW,ELSTOR(I),501)
 1620 CONTINUE
      NPTRP = NPTRP+NSE
C
C  STORE STORAGE VALUES
C
      DO 1625 I=1,NSE
      CALL FLWK51(WK,IUSEW,LEFTW,STORGE(I),501)
 1625 CONTINUE
      NPTRP = NPTRP+NSE
C
C  STORE DISCHARGE VALUES
C
      DO 1630 I=1,NSE
      CALL FLWK51(WK,IUSEW,LEFTW,QSTOR(I),501)
 1630 CONTINUE
      NPTRP = NPTRP+NSE
C
C  STORE THE NO. OF DATA POINTS IN THE BACKWATER TABLE
C  FOLLOWED BY THE CURVE VALUES:
C  SECOND INDENPENDENT VARIABLE (Z), FOLLOWED BY THREE PAIRS OF
C  (FIRST INDEPENDENT VARIALBE (X), DEPENDENT VARIABLE(Y)
C
      COUNT = NQBK
C
      CALL FLWK51(WK,IUSEW,LEFTW,COUNT,501)
      NPTRP = NPTRP+1
C
C  STORE BACKWATER TABLES
C
      NVAL = 3*NQBK
      DO 1650 K=1,NVAL
      CALL FLWK51(WK,IUSEW,LEFTW,QELBW(K),501)
 1650 CONTINUE
      NPTRP = NPTRP+NVAL
C
C  STORE THE PARAMETER INDICATOR AT BACKWATR (=1, DISCHARGE; =2,
C  ELEVATION)
      CON1 = ICON1
      CALL FLWK51(WK,IUSEW,LEFTW,CON1,501)
      NPTRP = NPTRP+1
C
C  STORE THE PARAMETER INDICATOR AT CONTROL2 (=1, DISCHARGE; =2,
C  ELEVATION)
      CON2 = ICON2
      CALL FLWK51(WK,IUSEW,LEFTW,CON2,501)
      NPTRP = NPTRP+1
C
C  STORE THE PARAMETER INDICATOR AT SITE (=1, DISCHARGE; =2, ELEVATION)
      SITE = ISITE
      CALL FLWK51(WK,IUSEW,LEFTW,SITE,501)
      NPTRP = NPTRP+1
C
C  ALL FINISHED WITH THE TRP PARMS. EXIT NOW.
C
      GO TO 9999
C
C---------------------------------------------------------------------
C  ERROR IN UFLD51
C
 9000 CONTINUE
      IF (IERF.EQ.1) CALL STER51(19,1)
      IF (IERF.EQ.2) CALL STER51(20,1)
      IF (IERF.EQ.3) CALL STER51(21,1)
      IF (IERF.EQ.4) CALL STER51(1,1)
C
      IF (IERF.NE.3) GO TO 10
C
C-----------------------------------------------------------------------
C  ENDTRP FOUND WHERE IT SHOULDN'T BE. SIGNAL ERROR AND RETURN
C
 1100 CONTINUE
      USEDUP =.TRUE.
      CALL STER51(43,1)
      GO TO 9999
C
C--------------------------------------------------------------------
C
 9999 CONTINUE
      OKELST = OK(3)
      RETURN
      END
