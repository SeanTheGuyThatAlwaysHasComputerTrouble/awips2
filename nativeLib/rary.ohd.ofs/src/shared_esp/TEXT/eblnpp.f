C MODULE EBLNPP
C
      SUBROUTINE EBLNPP(TSESP,LT,NWORK,IDLOOP,IHZERO,W1,W2,LWP,LBPHRS,
C
     1 MAXLBP,IFIN)
C
C   THIS SUBROUTINE DOES THE PRELIMINARY PROCESSING FOR THE BLEND
C   PROCEDURE. IT CALCULATES W1,W2,LWP, AND LBP FOR THE PERIOD AND
C   CHECKS TO SEE IF THERE IS ENOUGH WORK SPACE.
C
C   THIS SUBROUTINE WAS ORIGINALLY WRITTEN BY GERALD N. DAY.
C
      LOGICAL LBUG
C
C
      DIMENSION SBNAME(2),TSESP(1),XBUF(1),IHEAD(22),TSIDF(2),OLDOPN(2)
      DIMENSION TSID(2)
C
      INCLUDE 'common/fdbug'
      INCLUDE 'common/ionum'
      INCLUDE 'common/where'
      INCLUDE 'common/fctime'
      INCLUDE 'common/etime'
      INCLUDE 'common/emod'
      INCLUDE 'common/eblend'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/shared_esp/RCS/eblnpp.f,v $
     . $',                                                             '
     .$Id: eblnpp.f,v 1.3 1998/07/06 11:10:53 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SBNAME/4HEBLN,4HPP  /
      DATA NAME/4HEBLN /
C
C
      IOLDOP=IOPNUM
      IOPNUM=0
      DO 10 I=1,2
      OLDOPN(I)=OPNAME(I)
      OPNAME(I)=SBNAME(I)
   10 CONTINUE
C
      IF(ITRACE.GE.1) WRITE(IODBUG,900)
  900 FORMAT(1H0,14HEBLNPP ENTERED)
C
      LBUG=.FALSE.
      IF (IFBUG(NAME).EQ.1) LBUG=.TRUE.
C
C
C   SET IFIN=0 , A VALUE OF 1 INDICATES THE BLEND IS FINISHED THIS PASS
C
      IFIN=0
C
C
C   BRING IN VALUES FROM TSESP
C
      TSID(1)=TSESP(LT+3)
      TSID(2)=TSESP(LT+4)
      DTYPE=TSESP(LT+5)
      W10=TSESP(LT+15)
      W20=TSESP(LT+16)
      LWP=TSESP(LT+17)
      LBP=TSESP(LT+18)
      ITP=TSESP(LT+19)
      TSIDF(1)=TSESP(LT+20)
      TSIDF(2)=TSESP(LT+21)
      IDT=TSESP(LT+6)
      LF1=TSESP(LT+23)
C
C   CHECK CB/EMOD/ TO SEE IF THERE ARE ANY RUN TIME CHANGES
C   TO BE MADE TO THE VARIABLES. FIRST CHECK IF ITP IS TEMP
C   OF PREC.
C
      IF(ITP.EQ.1) GO TO 100
C
      IF(JBLENT.EQ.0) GO TO 150
      W10=TWT1
      W20=TWT2
      LWP=ITWTLN
      LBP=ITBLEN
      GO TO 150
C
  100 IF(JBLENP.EQ.0) GO TO 150
      W10=PWT1
      W20=PWT2
      LWP=IPWTLN
      LBP=IPBLEN
C
  150 MAXLWP=LWP
      LBPHRS=LBP*24
      MAXLBP=LBPHRS
C
C   CALCULATE HOURS ALREADY BLENDED
C
      NHRSB=(IJDB-IJDLST)*24+IHB-IHLST
C
C   CALCULATE HOURS AVAILABLE
C
      NHRSA=(LDA-IDA)*24+LHR-IHZERO
      NHRST=NHRSA
      LWP=MAXLWP-NHRSB
C
C....DEBUG....
C
      IF (LBUG) WRITE(IODBUG,155) NHRSA,NHRSB,MAXLWP,MAXLBP,IDA,IDT
  155 FORMAT(4X,45HNHRSA    NHRSB  MAXLWP  MAXLBP  IDA      IDT / 6I8)
C
      IF(LWP.GT.0) GO TO 160
C
C   WEIGHTING PERIOD HAS BEEN COMPLETED
C
      LBPHRS=LBPHRS+LWP
      LWP=0
      IF(LBPHRS.LT.0) LBPHRS=0
      GO TO 180
C
C   WEIGHTING HAS NOT BEEN COMPLETED
C
  160 W1=(NHRSB+IDT)*(W20-W10)/MAXLWP+W10
C
C   CHECK TAIL END OF PERIOD
C
      IF(NHRSA.GE.LWP) GO TO 170
C
C   NOT ENOUGH HRS TO COMPLETE WEIGHTING
C
      W2=(NHRSB+NHRSA)*(W20-W10)/MAXLWP+W10
      LWP=NHRSA
      LBPHRS=0
      ICONTB=1
      GO TO 275
C
C   WEIGHTING CAN BE COMPLETED, CHECK BLENDING
C
  170 W2=(NHRSB+LWP)*(W20-W10)/MAXLWP+W10
  180 NHRSA=NHRSA-LWP
      IF(NHRSA.GE.LBPHRS) GO TO 220
C
C   NOT ENOUGH HRS TO COMPLETE BLENDING
C
      LBPHRS=NHRSA
  200 ICONTB=1
      GO TO 275
C
C   BLENDING AND WEIGHTING CAN BE COMPLETED
C
  220 IFIN=1
C
C
C   CHECK IF THERE IS ENOUGH WORK SPACE AVAILABLE FOR FUTURE DATA
C

cew set npdt to be one here, surmise npdt is the number of
cew data points per time interval
cew use rprdh to get npdt if there will ever be a case
cew of npdt not equal to one

 275  NPDT=1

      MOWORK=31*24*NPDT/IDT
      IF(MOWORK.LE.NWORK) GO TO 999
      LWORKF=LWP*NPDT/IDT
      IF(ITP.EQ.1) LWORKF=LWORKF+LBPHRS*NPDT/IDT-NPDT
      IF(LWORKF.LE.NWORK) GO TO 999
      NHRSFT=NWORK*IDT/NPDT
      NDAYSF=NHRSFT/24
      NHRSF=NHRSFT-(NDAYSF*24)
      LJDB=IJDB+NDAYSF
      LHB=IHB+NHRSF
      IF(LHB.LE.24) GO TO 280
      LJDB=LJDB+1
      LHB=LHB-24
  280 CALL MDYH1(LJDB,LHB,LMOB,LDAB,LYRB,LHRB,100,0,TZC)
      WRITE(IPR,605) TSID,DTYPE,IDT,LMOB,LDAB,LYRB,LHRB
  605 FORMAT(1H0,10X,28H**WARNING** BLEND PROCEDURE ,
     1 26HTRUNCATED FOR TIME SERIES ,2A4,2X,A4,I5,
     2 33H LAST DAY OF FUTURE DATA USED WAS,I2,1H/,I2,1H/,I4,1X,I2,
     3 5H HRS.)
      CALL WARN
C
      IF(ITP.EQ.1) GO TO 285
C
C   TEMP
C
      W2=NHRSFT*(W2-W1)/LWP+W1
      LWP=NHRSFT
      LBPHRS=LBP*24
      IF((LWP+LBPHRS).LT.NHRST) GO TO 282
      LBPHRS=NHRST-LWP
      GO TO 999
  282 IFIN=1
      GO TO 999
C
C   PREC
C
  285 IF(NHRSFT.GE.LWP) GO TO 290
      W2=NHRSFT*(W2-W1)/LWP+W1
      LWP=NHRSFT
      LBPHRS=0
      IFIN=1
      GO TO 999
  290 LBPHRS=(NHRSFT-LWP+IDT)
      IFIN=1
C
  999 CONTINUE
C
C....DEBUG.......
C
      IF(LBUG) WRITE(IODBUG,215) LBPHRS,LWP,NHRSA
  215 FORMAT(5X,39HLBPHRS     LWP     NHRSA               / 3I8)
C
      IOPNUM=IOLDOP
      OPNAME(1)=OLDOPN(1)
      OPNAME(2)=OLDOPN(2)
C
      RETURN
      END
