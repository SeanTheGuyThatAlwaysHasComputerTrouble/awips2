C MODULE PDEDLY
C-----------------------------------------------------------------------
C
      SUBROUTINE PDEDLY (ISTAFL,IUNFLG)
C
C  THIS ROUTINE EDITS DAILY DATA TYPE DATA VALUES.
C
C  ARGUMENT LIST:
C
C       NAME    TYPE  I/O   DIM   DESCRIPTION
C       ------  ----  ---   ---   -----------
C       ISTAFL   I     I     1    STATION TYPE FLAG:
C                                   0=8-CHAR STATION ID
C                                   1=STATION NUMBER
C       IUNFLG  I     I      1    UNITS FLAG:
C                                   0=ENGLISH
C                                   1=METRIC
C
      CHARACTER*4 DUNITS
      CHARACTER*50 STRNG
      DIMENSION IDSTA(2),LCMD(2),LEND(2)
      PARAMETER (LDATES=64)
      DIMENSION IDATES(LDATES)
      PARAMETER (MVALS=60)
      DIMENSION VALS(MVALS),JULHR(MVALS)
C
      INCLUDE 'uiox'
      INCLUDE 'udebug'
      INCLUDE 'ufreei'
      INCLUDE 'udatas'
      INCLUDE 'ufstcd'
      INCLUDE 'hclcommon/hdflts'
      INCLUDE 'pdbcommon/pddtdr'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppdutil/RCS/pdedly.f,v $
     . $',                                                             '
     .$Id: pdedly.f,v 1.5 2003/03/14 18:56:00 dws Exp $
     . $' /
C    ===================================================================
C
      DATA LCMD/4hTYPE,4hDATE/
      DATA LEND/4hEND ,4h    /
      DATA ICONT/4h&   /
      DATA ITF/4hTF24/,ITM/4hTFMN/,ITX/4hTFMX/,MDR/4hMDR6/,IPSR/4hPPSR/
C
C
      IF (IPDTR.GT.0) WRITE (IOGDB,*) 'ENTER PDEDLY'
C
      INDERR=0
      IREV=1
C
C  READ CARD
      IFSTCD=1
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 300
      NFLD=1
      NUM=IFSTOP(NFLD)-IFSTRT(NFLD)+1
      IDSTA(2)=IBLNK
      CALL UPACK1 (IBUF(IFSTRT(NFLD)),IDSTA,NUM)
      CALL UNAMCP (IDSTA,LCMD,IERR)
      IF (IERR.EQ.0) GO TO 30
      CALL UNAMCP (IDSTA,LEND,IERR)
      IF (IERR.EQ.0) GO TO 340
      WRITE (LP,20)
20    FORMAT ('0**ERROR** IN PDEDLY - INVALID COMMAND.')
      CALL UEROR (LP,0,-1)
      GO TO 340
C
C  GET DAILY DATA TYPE
30    NOHR=0
      NFLD=NFLD+1
      NUM=IFSTOP(NFLD)-IFSTRT(NFLD)+1
      IF (NUM.GT.4) NUM=4
      CALL UPACK1 (IBUF(IFSTRT(NFLD)),IDLYTP,NUM)
C
C  CHECK IF VALID TYPE
      IDX=IPDCDW(IDLYTP)
      IF (IDX.EQ.0) THEN
         WRITE (LP,40) IDLYTP
40       FORMAT ('0**ERROR** INVALID DATA TYPE ',A4,' CARD IGNORED.')
         CALL UEROR (LP,0,-1)
         INDERR=1
         ENDIF
C
C  GET DATE AND TIME
      NFLD=NFLD+1
      IF (IDLYTP.EQ.MDR) THEN
C     CHECK IF AN HOUR IS INPUT WITH THE DATE
         NUM=IFSTOP(NFLD)-IFSTRT(NFLD)+1
         IF (NUM.EQ.6) NOHR=1
         ENDIF
C  CONVERT DATE TO JULIAN DAY
      CALL HDATEC (IFSTRT(NFLD),IFSTOP(NFLD),0,0,1,JULDA,INTHR,JULHR(1),
     *   ISTAT)
      IF (ISTAT.NE.0) GO TO 300
      JULHR(1)=JULHR(1)+NHOPDB
      IF (IPDDB.GT.0) WRITE (IOGDB,*) 'IN PDEDLY -',
     *   ' JULDA=',JULDA,
     *   ' INTHR=',INTHR,
     *   ' JULHR(1)=',JULHR(1),
     *   ' '
C
C  CHECK IF THIS IS MDR OR STRANGER STATION
      IF (IDLYTP.EQ.MDR) GO TO 210
      IF (IDLYTP.EQ.IPSR) GO TO 180
C
C  GET STATION IDENTIFIER
      IFSTCD=1
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 300
      NFLD=1
      IDSTA(2)=IBLNK
      IF (ISTAFL.EQ.0) THEN
C     GET STATION NAME
         NUM=IFSTOP(NFLD)-IFSTRT(NFLD)+1
         IF (NUM.GT.8) NUM=8
         CALL UPACK1 (IBUF(IFSTRT(NFLD)),IDSTA,NUM)
         ELSE
C        GET STATION NUMBER
            CALL UNUMIC (IBUF,IFSTRT(NFLD),IFSTOP(NFLD),IDSTA)
         ENDIF
C
90    NFLD=NFLD+1
      NVALS=0
C
C  GET VALUES
100   DO 140 I=NFLD,NFIELD
         IF (IFTYPE(I).EQ.2.OR.IFTYPE(I).EQ.1) GO TO 120
C     CHECK FOR CONTINUATION
         IF (IBUF(IFSTRT(I)).EQ.ICONT) GO TO 150
            WRITE (LP,110) I
110   FORMAT ('0**ERROR** INVALID CHARACTER IN FIELD ',I2,'.')
            CALL UEROR (LP,0,-1)
            INDERR=1
            GO TO 280
120      IF (NVALS+1.GT.MVALS) THEN
            WRITE (LP,125) MVALS
125   FORMAT ('0**ERROR** MAXIMUM NUMBER OF DATA VALUES (',I2,
     *   ') EXCEEDED.')
            CALL UEROR (LP,0,-1)
            INDERR=1
            GO TO 280
            ENDIF
         NVALS=NVALS+1
         NUM=IFSTOP(I)-IFSTRT(I)+1
         STRNG=' '
cckwz r22-11         CALL UPACK1 (IBUF(IFSTRT(NFLD)),STRNG,NUM)
         CALL UPACK1 (IBUF(IFSTRT(I)),STRNG,NUM)
         IPRERR=1
         IBEG=1
         NCHAR=LENSTR(STRNG)
         NDEC=0
         CALL UFA2F (STRNG,IBEG,NCHAR,NDEC,VALS(NVALS),IPRERR,LP,IERR)
         IF (IERR.NE.0) INDERR=1
140      CONTINUE
      GO TO 160
C
C  READ ANOTHER CARD OF DATA VALUES
150   IFSTCD=1
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 300
      NFLD=1
      GO TO 100
C
160   IDDX=IPDCKD(IDLYTP)
      IF (IDDTDR(7,IDDX).GT.0) GO TO 180
      WRITE (LP,170) IDLYTP
170   FORMAT ('0**ERROR** TYPE ',A4,' NOT DEFINED ON PPDB.')
      CALL UEROR (LP,0,-1)
      GO TO 340
C
C  FIND UNITS FOR THE DAILY TYPE
180   CALL PDFUNT (IDLYTP,IUNFLG,DUNITS)
      IF (IDLYTP.EQ.IPSR) GO TO 220
C
C  FIND TIME INTERVAL AND NUMBER OF TIME PERIODS FOR EACH TYPE
      IDELTT=24
      IF (IDDTDR(6,IDX).GT.2) IDELTT=IDDTDR(5,IDX)
      NTP=(NVALS/IDDTDR(6,IDX))-1
      IF (IDDTDR(6,IDX).GT.2) NTP=NVALS-1
      IF (NTP.LT.0) THEN
         WRITE (LP,330) ISTAT
330   FORMAT ('0**ERROR** IN PDEDLY - NOT ENOUGH DATA FOR PERIOD.')
         CALL UEROR (LP,0,-1)
         INDERR=1
         GO TO 270
         ENDIF
      JLSTHR=JULHR(1)+NTP*IDELTT
      IF (IPDDB.GT.0) WRITE (IOGDB,190) IDELTT,NTP,JULHR(1),JLSTHR
190   FORMAT (' IN PDEDLY - IDELTT=',I2,' NTP=',I2,' JULHR(1)=',I6,
     *        ' JLSTHR=',I6)
C
      IF (IDLYTP.EQ.ITF.OR.IDLYTP.EQ.ITM.OR.IDLYTP.EQ.ITX) GO TO 200
C
      IF (INDERR.EQ.1) GO TO 280
C
C  WRITE DATA VALUES
      NTYPES=1
      CALL WPD1S (IDSTA,ISTAFL,NTYPES,IDLYTP,DUNITS,JULHR(1),JLSTHR,
     *   NVALS,VALS,IWRITE,IREV,ISTAT)
      IF (ISTAT.EQ.0) GO TO 230
      CALL PDBERR (IDSTA,1,IDLYTP,JULHR,VALS,DUNITS,NVALS,NVLPOB,MINS,
     *   RLATLN,IREV,IFUT,IWRITE,ISTAT)
      GO TO 270
C
200   IF (INDERR.EQ.1) GO TO 280
C
C  UPDATE DATA VALUES FOR FUTURE TEMPERATURE
      NTYPES=1
      JULHR(NVALS)=JLSTHR
      CALL WPD1SF (IDSTA,ISTAFL,NTYPES,IDLYTP,DUNITS,JULHR(1),JLSTHR,
     *   NVALS,VALS,LDATES,IDATES,IWRITE,IREV,ISTAT)
      IF (ISTAT.EQ.0) GO TO 230
      CALL PDBERR (IDSTA,1,IDLYTP,JULHR,VALS,DUNITS,NVALS,NVLPOB,MINS,
     *   RLATLN,IREV,IFUT,IWRITE,ISTAT)
      GO TO 270
C
C  UPDATE VALUES FOR MDR DATA
210   CALL PDEMDR (JULDA,INTHR,JULHR(1),NOHR)
      GO TO 270
C
C  UPDATE VALUES FOR STRANGER STATION DATA
220   CALL PDEPSR (JULDA,INTHR,JULHR(1),DUNITS)
      GO TO 270
C
230   IF (ISTAFL.EQ.0) THEN
         WRITE (LP,240) IDLYTP,IDSTA(1),IDSTA(2)
240   FORMAT ('0**NOTE** DATA VALUES FOR DAILY TYPE ',A4,
     *   ' EDITED FOR STATION ',2A4,'.')
         ELSE
            WRITE (LP,260) IDLYTP,IDSTA(1)
260   FORMAT ('0**NOTE** DATA VALUES FOR DAILY TYPE ',A4,
     *   ' EDITED FOR STATION NUMBER ',I6,'.')
         ENDIF
C
C  READ NEXT CARD
270   IFSTCD=1
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 300
      NFLD=1
      IF (IFTYPE(NFLD).EQ.1) THEN
         CALL UNUMIC (IBUF,IFSTRT(NFLD),IFSTOP(NFLD),IDSTA)
         GO TO 90
         ENDIF
      NUM=IFSTOP(NFLD)-IFSTRT(NFLD)+1
      IF (NUM.GT.8) NUM=8
      IDSTA(2)=IBLNK
      CALL UPACK1 (IBUF(IFSTRT(NFLD)),IDSTA,NUM)
      CALL UNAMCP (IDSTA,LCMD,IERR)
      IF (IERR.EQ.0) GO TO 30
      CALL UNAMCP (IDSTA,LEND,IERR)
      IF (IERR.EQ.0) GO TO 340
      GO TO 90
C
C  DO NOT UPDATE NEW VALUES
280   WRITE (LP,290)
290   FORMAT ('0**WARNING** IN PDEDLY - NEW VALUES WILL NOT BE ',
     *   'WRITTEN DUE TO CARD INPUT ERROR.')
      CALL UWARN (LP,0,-1)
      INDERR=0
      GO TO 270
C
300   WRITE (LP,310)
310   FORMAT ('0**ERROR** IN PDEDLY - ERROR READING INPUT CARDS.')
      CALL UEROR (LP,0,-1)
      GO TO 340
C
340   IF (IPDTR.GT.0) WRITE (IOGDB,*) 'EXIT PDEDLY'
C
      RETURN
C
      END
