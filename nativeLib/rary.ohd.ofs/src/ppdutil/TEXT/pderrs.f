C MODULE PDERRS
C-----------------------------------------------------------------------
C
      SUBROUTINE PDERRS (ISTAFL,IUNFLG,LWBUFF,IWBUFF)
C
C  THIS ROUTINE EDITS RRS DATA TYPE DATA VALUES FOR SPECIFIED
C  STATIONS
C
C  ARGUMENT LIST:
C
C     NAME    TYPE   I/O   DIM   DESCRIPTION
C     ----    ----   ---   ---   -----------
C     ISTAFL    I     I     1    STATION TYPE FLAG:
C                                  0=STATION IDENTIFIER
C                                  1=STATION NUMBER
C     IUNFLG    I     I     1    UNITS CONVERSION FLAG:
C                                  0=ENGLISH
C                                  1=METRIC
C
      PARAMETER (LOBS=100)
      DIMENSION OBS(LOBS)
C
      DIMENSION IDSTA(2),LCMD1(2),LCMD2(2),LEND(2),NCMD(2),NCARD(2)
      DIMENSION MINRAY(20)
      DIMENSION OBS1(3)
      DIMENSION IWBUFF(LWBUFF)
C
      INCLUDE 'uio'
      INCLUDE 'udebug'
      INCLUDE 'ufreei'
      INCLUDE 'udatas'
      INCLUDE 'pdbcommon/pddtdr'
      INCLUDE 'hclcommon/hdflts'
      INCLUDE 'pdbcommon/pdtrrx'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppdutil/RCS/pderrs.f,v $
     . $',                                                             '
     .$Id: pderrs.f,v 1.2 1999/01/20 14:14:42 page Exp $
     . $' /
C    ===================================================================
C
      DATA LCMD1/4HONET,4HIME /,LCMD2/4HONES,4HTN  /
      DATA ICONT/4H&   /,LEND/4HEND ,4H    /
C
C
      IF (IPDTR.GT.0) WRITE (IOGDB,10)
10    FORMAT (' *** ENTER PDERRS')
C
      CALL UMEMST (0,MINRAY,20)
      INDERR=0
      IREV=1
      NUMOBS=0
      ICONFL=0
      JERR=0
      ID=0
C
C  READ A COMMAND CARD
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      IF=1
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      NCMD(2)=IBLNK
      CALL UPACK1 (IBUF(IFSTRT(IF)),NCMD,NUM)
      CALL UNAMCP (NCMD,LCMD1,IERR)
      IF (IERR.EQ.0) GO TO 30
      CALL UNAMCP (NCMD,LCMD2,IERR)
      IF (IERR.EQ.0) GO TO 250
      CALL UNAMCP (NCMD,LEND,IERR)
      IF (IERR.EQ.0) GO TO 350
      WRITE (LP,20)
20    FORMAT ('0**ERROR** IN PDERRS - NOT A VALID COMMAND')
      GO TO 460
C
C  GET RRS TYPE
30    IF=IF+1
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      IF (NUM.GT.4) NUM=4
      CALL UPACK1 (IBUF(IFSTRT(IF)),IRSTYP,NUM)
C
C  CHECK IF VALID TYPE
      IRX=IPDCKR(IRSTYP)
      IF (IRX.NE.0) GO TO 50
         WRITE (LP,40) IRSTYP
40    FORMAT ('0**ERROR** INVALID DATA TYPE ',A4,' CARD IGNORED.')
         INDERR=1
50    NVLPOB=NVALPO(IRX)
C
C  GET DATE AND TIME
      IF=IF+1
C
C  CONVERT DATE TO JULIAN DAY
      MINRAY(1)=-1
      CALL HDATEC (IFSTRT(IF),IFSTOP(IF),0,0,1,JULDA,INTHR,JULHR,ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      JULHR=JULHR+NHOPDB
      IF (NFIELD.EQ.3) GO TO 100
      IF=IF+1
      IF (IFTYPE(IF).EQ.1) GO TO 70
         WRITE (LP,60) IF
60    FORMAT ('0**ERROR** FIELD ',I2,' IS NOT AN INTEGER.')
         INDERR=1
         GO TO 100
70    CALL UNUMIC (IBUF,IFSTRT(IF),IFSTOP(IF),MINRAY(1))
      IF (NVLPOB.EQ.2) GO TO 80
         CALL UMEMOV (MINRAY(1),OBS(3),1)
         MINRAY(1)=0
         GO TO 100
C
C  CHECK IF THIS IS INSTANTANEOUS DATA
80    IF (MINRAY(1).GE.0.AND.MINRAY(1).LT.60) GO TO 100
         WRITE (LP,90) MINRAY(1)
90    FORMAT ('0**ERROR** MINUTES OF',I6,' IS INVALID')
         INDERR=1
100   IF (MINRAY(1).GT.30) JULHR=JULHR+1
      CALL UMEMOV (JULHR,OBS(1),1)
C
C  GET STATION IDENTIFIER
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      IF=1
      IDSTA(2)=IBLNK
      IF (ISTAFL.EQ.1) GO TO 110
         NUM=IFSTOP(IF)-IFSTRT(IF)+1
         IF (NUM.GT.8) NUM=8
         CALL UPACK1 (IBUF(IFSTRT(IF)),IDSTA,NUM)
         GO TO 120
C
C  GET STATION NUMBER
110   CALL UNUMIC (IBUF,IFSTRT(IF),IFSTOP(IF),IDSTA)
C
C  GET DATA VALUE
120   IF=IF+1
      JERR=0
      CALL URELFX (ANS,IFSTRT(IF),IFSTOP(IF),JERR,ID)
      IF (JERR.EQ.0) GO TO 140
         WRITE (LP,130) IF
130   FORMAT ('0**ERROR** INVALID CHARACTER IN FIELD ',I2,'.')
         INDERR=1
         GO TO 420
140   CALL UMEMOV (ANS,OBS(2),1)
      NUMOBS=1
C
C  FIND UNITS FOR THIS TYPE
150   CALL PFDUNT (IRSTYP,IUNFLG,IUNIT)
C
      IF (INDERR.EQ.1) GO TO 420
C
C  READ CURRENT RECORD FOR FUTURE FLAG AND MINUTES IF NOT ENTERED NOW
      JULHR1=JULHR
      CALL RPDRRS (IDSTA,ISTAFL,IRSTYP,NVLPOB,JULHR1,JULHR1,3,OBS1,
     *   NUMOB1,1,MINX,LWBUFF,IWBUFF,LSTHR,ISTAT)
      IFUT=0
      IF (LSTHR.GT.0.AND.LSTHR.LT.JULHR) IFUT=1
      IF (MINRAY(1).LT.0) MINRAY(1)=MINX
      IF (IPDDB.GT.0) WRITE (IOGDB,160) IFUT,LSTHR,MINX,ISTAT
160   FORMAT (' BACK FROM RPDRRS - IFUT,LSTHR,MINX,ISTAT=',4I8)
      IF (IPDDB.GT.0) WRITE (IOGDB,170) NUMOBS
170   FORMAT (' CALLING WPDRRS - NUMOBS=',I8)
      CALL WPDRRS (IDSTA,ISTAFL,1,IRSTYP,NVLPOB,IUNIT,NUMOBS,
     *   LOBS,OBS,20,MINRAY,LWBUFF,IWBUFF,IWRITE,IFUT,LSTHR,IREV,
     *   ISTAT)
      IF (IPDDB.GT.0) WRITE (IOGDB,180) NVLPOB,ISTAT,IWRITE
180   FORMAT (' BACK FROM WPDRRS - NVLPOB,ISTAT,IWRITE=',3I5)
      IF (ISTAT.EQ.0) GO TO 190
      CALL PDBERR (IDSTA,1,IRSTYP,JULHR,OBS,IUNIT,LOBS,NVLPOB,MINRAY,
     *   RLATLN,IREV,IFUT,IWRITE,ISTAT)
      IF (ISTAT.NE.0) GO TO 240
      IF (ISTAT.LT.0.OR.ISTAT.GT.7) GO TO 380
      GO TO (360,380,400,440,380,440,380),ISTAT
C
190   IF (ISTAFL.EQ.1) GO TO 210
      WRITE (LP,200) IRSTYP,IDSTA
200   FORMAT ('0**NOTE** DATA VALUES FOR RRS TYPE ',A4,
     *   ' EDITED FOR STATION ',2A4,'.')
      GO TO 240
210   WRITE (LP,220) IRSTYP,IDSTA
220   FORMAT ('0**NOTE** DATA VALUES FOR RRS TYPE ',A4,
     *   ' EDITED FOR STATION NUMBER ',I6,'.')
C
C  CHECK IF ANOTHER STATION
240   CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      IF=1
      IF (IFTYPE(IF).EQ.1) GO TO 110
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      IF (NUM.GT.8) NUM=8
      NCARD(2)=IBLNK
      CALL UPACK1 (IBUF(IFSTRT(IF)),NCARD,NUM)
      CALL UNAMCP (NCARD,LCMD1,IERR)
      IF (IERR.EQ.0) GO TO 30
      CALL UNAMCP (NCARD,LCMD2,IERR)
      IF (IERR.EQ.0) GO TO 250
      CALL UNAMCP (NCARD,LEND,IERR)
      IF (IERR.EQ.0) GO TO 350
      CALL UMEMOV (NCARD,IDSTA,2)
      GO TO 120
C
C  GET STATION IDENTIFIER
250   IF (ICONFL.EQ.1) ICONFL=0
      IF=IF+1
      IDSTA(2)=IBLNK
      IF (IFTYPE(IF).EQ.1) GO TO 260
         NUM=IFSTOP(IF)-IFSTRT(IF)+1
         IF (NUM.GT.8) NUM=8
         CALL UPACK1 (IBUF(IFSTRT(IF)),IDSTA,NUM)
         GO TO 270
260   CALL UNUMIC (IBUF,IFSTRT(IF),IFSTOP(IF),IDSTA)
C
C  GET RRS TYPE
270   IF=IF+1
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      IF (NUM.GT.4) NUM=4
      CALL UPACK1 (IBUF(IFSTRT(IF)),IRSTYP,NUM)
C
C  CHECK IF VALID TYPE
      IRX=IPDCKR(IRSTYP)
      IF (IRX.NE.0) GO TO 280
         WRITE (LP,40) IRSTYP
         INDERR=1
280   NVLPOB=NVALPO(IRX)
      IF (ICONFL.EQ.1) ICONFL=0
C
C  GET OBSERVATION SETS
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      K=1
      IF=1
      NUMOBS=0
C
C  CHECK IF CONTINUATION FIELD FOUND
290   IF (IFTYPE(IF).EQ.1) GO TO 300
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      IF (NUM.GE.4.AND.NUM.LE.11) GO TO 300
      IF (NUM.NE.1) GO TO 300
         NUM=IBUF(IFSTRT(IF))
         IF (NUM.EQ.ICONT) ICONFL=1
         GO TO 340
300   CALL HDATEC (IFSTRT(IF),IFSTOP(IF),0,0,1,JULDA,INTHR,JULHR,ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      JULHR=JULHR+NHOPDB
      NVLPOB=NVALPO(IRX)
      CALL UMEMOV (JULHR,OBS(K),1)
      IF=IF+1
      IF (NVLPOB.EQ.2) GO TO 310
C
C  PERIOD AVERAGE TYPE - GET PERIOD
      CALL UNUMIC (IBUF,IFSTRT(IF),IFSTOP(IF),MINRAY(NUMOBS+1))
      CALL UMEMOV (MINRAY(NUMOBS+1),OBS(K+2),1)
      MINRAY(NUMOBS+1)=0
      IF=IF+1
C
C  GET DATA VALUE
310   JERR=0
      CALL URELFX (ANS,IFSTRT(IF),IFSTOP(IF),JERR,ID)
      IF (JERR.EQ.0) GO TO 320
      WRITE (LP,130) IF
      INDERR=1
      GO TO 420
320   CALL UMEMOV (ANS,OBS(K+1),1)
      NUMOBS=NUMOBS+1
      K=K+NVLPOB
      IF=IF+1
C
C  IF THIS IS INSTANTANEOUS, CHECK IF MINUTES WERE INPUT
      IF (NVLPOB.EQ.3) GO TO 290
      IF (IF.GT.NFIELD) GO TO 150
      NUM=IFSTOP(IF)-IFSTRT(IF)+1
      IF (NUM.GT.2.) GO TO 290
      CALL UNUMIC (IBUF,IFSTRT(IF),IFSTOP(IF),MINRAY(NUMOBS))
      IF (MINRAY(NUMOBS).LT.31) GO TO 330
         JULHR=JULHR+1
         KK=K-NVLPOB
         CALL UMEMOV (JULHR,OBS(KK),1)
330   IF=IF+1
      IF (IF.LE.NFIELD) GO TO 290
      GO TO 150
C
340   IF (ICONFL.EQ.0) GO TO 150
      CALL RWCARD (ISTAT)
      IF (ISTAT.NE.0) GO TO 440
      IF=1
      GO TO 290
C
350   GO TO 460
C
C  CHECK STATUS CODES FOR RRS WRITE
360   WRITE (LP,370) IDSTA,ISTAT
370   FORMAT ('0**ERROR** STATION ',2A4,' NOT FOUND. ISTAT=',I4)
      GO TO 240
380   WRITE (LP,390) IRSTYP,ISTAT
390   FORMAT ('0**ERROR** DATA TYPE ',A4,' NOT FOUND. ISTAT=',I4)
      GO TO 240
400   WRITE (LP,410) ISTAT
410   FORMAT ('0**WARNING** TIME PERIOD INVALID. ISTAT=',I4)
      GO TO 240
C
C  DO NOT UPDATE NEW VALUES
420   WRITE (LP,430)
430   FORMAT ('0**WARNING** IN PDERRS - NEW VALUES WILL NOT BE WRITTEN',
     *       ' DUE TO CARD INPUT ERROR.')
      INDERR=0
      IF (ICONFL.EQ.1) GO TO 460
      GO TO 240
C
C  SYSTEM ERROR
440   WRITE (LP,450) ISTAT
450   FORMAT ('0**ERROR** IN PDERRS - SYSTEM ERROR, ISTAT=',I4)
C
460   IF (IPDTR.GT.0) WRITE (IOGDB,470)
470   FORMAT (' *** EXIT PDERRS')
C
      RETURN
C
      END
