C MEMBER EXTR51
C--------------------------------------------------------------------
C
C@PROCESS LVL(77)
C
      SUBROUTINE EXTR51 (ITO, IH, IR, V, NC, ITR) 
C
C NOTE: THIS CODE IS FROM SSARR ROUTINE FEXTR (ITO, IH, IR, V, NC, ITR) 
C
C        ROUTINE TO EXTRACT REGULATION READINGS FROM 100 OR 101 RECORD.
C        INPUTS, 
C         ITO - PERIOD START TIME 
C         IH - PERIOD LENGTH 
C         IR(1) - REGULATION RECORD 
C        OUTPUT, 
C         V - VALUE FROM REGULATION 
C         NC - DATA CODE OF VALUE 
C        ITR - TIME OF VALUE RETURNED IN V. 
C 
C        WORD 2 OF IR IS SCAN INDEX FROM LAST USE. 
C        VALUES IN REGULATION (100) RECORD START AT WORD 8, AND ARE- 
C         WORD 8 - TIME IN TENTHS OF HOURS, BASE TIME (INTEGER) 
C         WORD 9 - VALUE, OUTFLOW, ELEVATION, OR STORAGE (REAL) 
C         WORD 10 - DATA CODE OF VALUE (INTEGER) 
C          0 - FREEFLOW, VALUE NOT USED. 
C          1 - OUTFLOW SPECIFIED 
C          2 - ELEVATION SPECIFIED 
C          3 - STORAGE CONTENT SPECIFIED 
C          4 - STORAGE CHANGE GIVEN IN TERMS OF INFLOW-OUTFLOW DIFFERENC
C          5 - ELEVATION CHANGE PER DAY. 
C          6 - STORAGE CONTENT CHANGE PER DAY. 
C         WORDS 11-13, ETC., ARE SAME AS WORDS 8-10 FOR ADDITIONAL POINT
C 
C        101 RECORD IS WATERSHED DISCHARGE RECORD. 
C        WORD 8 IS TIME OF FIRST VALUE, WORD 9 IS 1ST VALUE. 
C        WORD 10-11 ARE NEXT PAIR OF TIME-VALUE, AND ETC. 
C 
C         IF ITE IS PRIOR TO 1ST VALUE IN 100/101 RECORD, 
C         SEE STMT. 415. 
C         IF ITE IS LATER THEN LAST VALUE, RETURN LAST VALUE 
C         (500). 
CC
CC  KSH CHANGE START
CC      INCLUDE 'common/time'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/sarr51'
CC  KSH CHANGE END
CC
      EQUIVALENCE (Z,IZ),(Z2,IZ2) 
      DIMENSION IR(*) 
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_ssarresv/RCS/extr51.f,v $
     . $',                                                             '
     .$Id: extr51.f,v 1.1 1996/03/21 13:37:41 page Exp $
     . $' /
C    ===================================================================
C
CC
CC  KSH CHANGE START
C      IONE = -1
      IONE = 0
      ITR = ITO+IH
      IF(ITR.LE.0) IONE=1
CC  KSH CHANGE END
CC
      V=0. 
C       SEE IF RECORD IS EMPTY 
      IF(IR(1).GT.7) GO TO 80 
C        IT IS 
      ITR=0 
      NC=0 
      RETURN 
C       IF THIS IS A 101 RECORD, SET CONTROLS. 
 80   IF(IR(7).EQ.100) GO TO 90 
      NC=1 
      IF(IR(7).EQ.102) NC=2 
      IFC=2 
      ISWD=-1. 
      GO TO 92 
C       100 RECORD 
 90   NC=0 
      IFC=3 
      ISWD=0 
C       INSURE NSC VALID 
 92   NSC=IR(2) 
      I = 0 
      IF(NSC-8) 130, 140, 100 
 100  IF(NSC.GE.IR(1)) GO TO 130 
 120  I =(NSC-8)/IFC 
 130  NSC = IFC*I + 8 
 140  ITE = ITO + IH 
C
C        RESET SCAN DIRECTION SWITCH. 
      ISW = 0 
C 
C        TEST IN TABLE 

C 200  IF(ITE - IR(NSC)) 250, 500, 210 
CC
CC  KSH CHANGE START
 200   CONTINUE
      IF(ISWD.GE.1) ISWD=ISWD+1
      IF(IBUG.GE.2)
     & WRITE (IODBUG,1110) ISWD,ISW,ITE,ITR,NSC,IR(NSC)
 1110 FORMAT(5X,'ISWD,ISW,ITE,ITR,NSC,IR(NSC): ',
     & 2I3,2I10,I5,I10)
      ITEM = ITE+IONE
      IF(ITEM - IR(NSC)) 250, 500, 210 
CC  KSH CHANGE END
CC
C        TOO LOW 
 210  IF(ISW) 240, 220, 230 
 220  ISW = IFC 
 230  NSC = NSC + IFC 
      IF(NSC.GE.IR(1)) GO TO 450 
C        IF TIMES ARE NOT ASCENDING, ASSUME END OF TIME-SERIES. 
CC
CC  KSH CHANGE START
CC  TO ALLOW FOR TWO CONSECUTIVE EQUAL TIME
CC 235  IF(IR(NSC-IFC)-IR(NSC)) 200,450,450 
 235  IF(IR(NSC-IFC)-IR(NSC)) 200,200,450 
CC  KSH CHANGE END
CC
C        BRACKETED IN TABLE 
 240  NSC = NSC + IFC 
      GO TO 300 
C 
C        TOO HIGH 
CC
CC  KSH CHANGE START
CC  DO NOT EXIT IF THIS IS THE FIRST TIME THE PROGRAM GETS HERE
CC  AFTER TIME ITE IS ADJUSTED TO DAY START
CC 250  IF(ISW) 270, 260, 300 
 250  CONTINUE
      IF(ISWD.EQ.2) GO TO 260
      IF(ISW) 270, 260, 300 
CC  KSH CHANGE END
CC
 260  ISW = -IFC 
 270  NSC = NSC - IFC 
      IF(NSC - 8) 415 , 200, 200 
C 
C        BRACKETED 
C        IF DAY-END SWITCH ON, TIME ITE HAS BEEN ADJUSTED TO DAY START.
CC
CC  KSH CHANGE START
CC  DISABLE DAY START COMPUTATION PER PHONE CONVERSATION WITH
CC  CHUCK ORWIG, ROSS MORROW, AND ED DAVIS ON JULY 28, 1995
CC  300  IF(ISWD) 412, 310, 400 
 300  IF(ISWD) 412, 400, 400 
CC  KSH CHANGE END
CC
C        TEST FOR DATA CODE 5 OR 6 (DELTA E OR S) 
 310  IF(   IR(NSC+2) - 5) 400, 320, 320 
C        CALCULATE TIME OF BEGINNING OF DAY CONTAINING ITE. 
CC
CC  KSH CHANGE START
CC  CAN NOT GO BELOW ITME(1)! USE ITE=0 TO SEARCH FOR REGULATION OPTION
CC        TEST FOR BRACKETING READINGS WITH SAME DATA CODES. 
CC 320  I =(ITE - ITME(1))/240 
 320  I = IR(NSC+2)
CC
CC  USE FREEFLOW IF CODE CHANGED TO 5 OR 6
      IF(IR(NSC-1).NE.I) GO TO 1000
      I =(ITE - ITME(1))/240
      IF(ITE.LE.ITME(1)) GO TO 340
CC  KSH CHANGE END
CC
      I  =  ITME(1) + I*240 
      IF(I - ITE) 340, 330, 340 
 330  I = I - 240 
CC
CC  KSH CHANGE START
CC 340  ITE = I
 340  IF(I.GE.IR(NSC)) ITE = I
      ITR = ITE
      IONE = 1
CC  KSH CHANGE END
CC
      ISWD = 1 
      GO TO 200 
C 
C        TEST FOR BRACKETING READINGS WITH SAME DATA CODES. 
 400  I = IR(NSC+2) 
      IF(IR(NSC-1) - I) 420 , 410, 420 
C        INTERPOLATE 
 410  NC=I 
 412  Y = ITE - IR(NSC-IFC) 
      X = IR(NSC) - IR(NSC-IFC) 
      IZ = IR(NSC-IFC+1) 
      IZ2 = IR(NSC+1) 
      V = Z + (Y/X)*(Z2 - Z) 
      ITR = ITE 
      GO TO 1000 
C       ITE IS BEFORE FIRST VALUE IN 100/101 RECORD. 
 415  NSC = 8 
      IF(IFC.EQ.2) GO TO 1000 
      I = IR(NSC+2) 
C       IF ELEV OR STORAGE SPEC, RETURN THE VALUE. OTHERWISE, 
C       RETURN NC=0 
C
CC  KSH CHANGE START
CC 420  IF(I.EQ.2.OR.I.EQ.3) GO TO 500 
 420  IF(I.EQ.2.OR.I.EQ.3) GO TO 510
CC  KSH CHANGE END
      GO TO 1000 
C        OFF END 
 450  NSC=NSC-IFC 
C        EQUAL FOUND 
C
CC  KSH CHANGE START
CC  IF CODE WAS CHANGED TO 1 (SETQ) OR 4 (SETDQ) OR 5 (SETDH) OR
CC   6 (SETDS) USE FREEFLOW CODE ( CODE=0 )
CC 500  IZ=IR(NSC+1) 
 500  CONTINUE
      IF(ITO.GT.ITE) GO TO 210
 510  CONTINUE
      IZ=IR(NSC+1) 
CC  KSH CHANGE END
C
      V=Z 
      IF(IFC.EQ.3) NC = IR(NSC+2) 
      ITR = IR(NSC) 
C 
1000  CONTINUE 
C
CC  KSH CHANGE START
      IF(IBUG.GE.2)
     &  WRITE (IODBUG,1100) ITO,ITE,V,NC,ITR,NSC,IR(NSC),IR(NSC+2)
 1100 FORMAT(7X,3HITO,7X,3HITE,11X,1HV,8X,2HNC,7X,3HITR,7X,3HNSC,
     & 3X,7HIR(NSC),1X,9HIR(NSC+2),
     & /2I10,F12.2,5I10)
CC  KSH CHANGE END
C
      IR(2)=NSC 
      RETURN 
      END
