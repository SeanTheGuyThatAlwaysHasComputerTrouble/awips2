C MEMBER SNMAPE
C-----------------------------------------------------------------------
C
C                             LAST UPDATE: 03/07/94.10:27:07 BY $WC20SV
C
C @PROCESS LVL(77)
C
C  DESC ROUTINE FOR PERFORMING NETWORK COMPUTATIONS FOR MAPE AREAS
C
      SUBROUTINE SNMAPE (IRTYPE,LARRAY,ARRAY,STMNWT,IUEND,ISTAT)
C
      REAL XMAPE/4HMAPE/
      REAL XOLD/4HOLD /
      REAL*8 TYPERR
      REAL*8 XERROR/8HERROR   /
      REAL*8 BLNK8/8H        /
C
      DIMENSION ARRAY(LARRAY)
      DIMENSION UNUSED(5)
C
C  STAN PARAMETER ARRAYS
      DIMENSION STAID(2),STACOR(2)
C
C  MAPE PARAMETER ARRAYS
      DIMENSION PEID(2),DESC(5),CENTRD(2)
C
      INCLUDE 'uio'
      INCLUDE 'scommon/sudbgx'
      INCLUDE 'scommon/sworkx'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppinit_network/RCS/snmape.f,v $
     . $',                                                             '
     .$Id: snmape.f,v 1.1 1995/09/17 19:13:48 dws Exp $
     . $' /
C    ===================================================================
C
C
C
      IF (ISTRCE.GT.0) WRITE (IOSDBG,140)
      IF (ISTRCE.GT.0) CALL SULINE (IOSDBG,1)
C
C  SET DEBUG LEVEL
      LDEBUG=ISBUG('NTWK')
C
      ISTAT=0
      NUMERR=0
C
C  SET INDICATOR TO UPDATE PARAMETERS EVEN IF PREDETERMINED WEIGHTS USED
      INDPRE=1
C
C  PRINT HEADING
      WRITE (LP,150)
      CALL SULINE (LP,1)
      WRITE (LP,160)
      CALL SULINE (LP,2)
      WRITE (LP,170) STMNWT
      CALL SULINE (LP,2)
      IF (INDPRE.EQ.1) WRITE (LP,180)
      IF (INDPRE.EQ.1) CALL SULINE (LP,2)
C
      NAREA=0
C
C  INITIALIZE POINTERS.
      IDIM=LSWORK/10
C  STATION ID'S:
      ID1=1
C  STATION WEIGHTS:
      ID2=IDIM*2+1
C  MEAN PE:
      ID3=IDIM*3+1
C  PE CHANGE:
      ID4=IDIM*4+1
C  ARRAY POINTERS:
      ID5=IDIM*5+1
C  STATION COORDINATES:
      ID6=IDIM*6+1
C
      IPTR=0
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK IF SUFFICIENT CPU TIME AVAILABLE
10    ICKRGN=0
      ICKCPU=1
      MINCPU=10
      IPRERR=1
      IPUNIT=LP
      TYPERR=XERROR
      INCLUDE 'clugtres'
      IF (IERR.EQ.0) GO TO 20
         CALL SUFATL
         IUEND=1
         GO TO 135
C
C  READ PARAMETERS
20    CALL SUBSTR (BLNK8,1,8,PEID,1)
      IPRERR=0
      CALL SRMAPE (IVMAPE,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID3),
     *   SWORK(ID4),IDIM,NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNUSED,
     *   LARRAY,ARRAY,IPTR,IPRERR,IPTRNX,IERR)
      IF (IERR.EQ.2.AND.NAREA.EQ.0) GO TO 130
      IF (IERR.EQ.6) GO TO 130
      IF (IERR.EQ.0) GO TO 30
         CALL SRPPST (PEID,XMAPE,IPTR,LARRAY,0,IPTRNX,IERR)
         WRITE (LP,190) XMAPE,MAPE,IERR
         CALL SUERRS (LP,2,NUMERR)
         GO TO 120
C
C  CHECK IF PREDETERMINED WEIGHTS BEING USED
30    IF (IWT.NE.1) GO TO 40
         WRITE (LP,200) PEID
         CALL SULINE (LP,2)
         IF (INDPRE.EQ.1) GO TO 40
         GO TO 110
C
C  PRINT PARAMETERS
40    IF (LDEBUG.EQ.0) GO TO 50
      CALL SPMAPE ('ENGL',IVMAPE,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID3),
     *   SWORK(ID4),NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNUSED,IERR)
C
C  CHECK IF PREDETERMINED WEIGHTS BEING USED
50    IF (IWT.NE.1) GO TO 70
C
C  UPDATE PREDETERMINED STATION WEIGHTS
      DO 60 I=1,NPE
         IPOS=ID1+I*2-2
         CALL SUBSTR (SWORK(IPOS),1,8,STAID,1)
         CALL SFSCHK (LARRAY,ARRAY,STAID,'PE  ',STACOR,IPPP24,IPPPVR,
     *      IPEA24,IPTM24,NUMERR,IERR)
         IPOS=ID5+I-1
         CALL SFCONV (SWORK(IPOS),IPEA24,1)
60       CONTINUE
         GO TO 80
C
C  UPDATE 5 CLOSEST 1/D**POWER STATIONS
70    IPARM=7
      ITYPE=3
      NSEGS=0
      CALL SFWGHT (IRTYPE,PEID,IPARM,ITYPE,NSEGS,LFACTR,SWORK(ID1),
     *   SWORK(ID1),SWORK(ID1),IDIM,CENTRD(1),CENTRD(2),POWER,STMNWT,
     *   NPE,SWORK(ID1),SWORK(ID2),SWORK(ID5),SWORK(ID6),IERR)
      IF (IERR.GT.0) GO TO 110
C
80    IF (LDEBUG.EQ.0) GO TO 100
         WRITE (IOSDBG,210)
         CALL SULINE (IOSDBG,2)
         WRITE (IOSDBG,220)
         CALL SULINE (IOSDBG,2)
         DO 90 I=1,NPE
            WRITE (IOSDBG,230) (SWORK(ID1+I*2-3+J),J=1,2),SWORK(ID2+I-1)
            CALL SULINE (IOSDBG,1)
90          CONTINUE
C
C  UPDATE PARAMETERS
100   INTWK=1
      WDISP=XOLD
      CALL SWMAPE (IVMAPE,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID3),
     *   SWORK(ID4),NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNUSED,
     *   LARRAY,ARRAY,IPTR1,WDISP,IERR)
      IF (IERR.GT.0) GO TO 110
C
      NAREA=NAREA+1
C
      IF (LDEBUG.EQ.0) GO TO 110
C
C  READ PARAMETERS
      CALL SRMAPE (IVMAPE,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID3),
     *   SWORK(ID4),IDIM,NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNUSED,
     *   LARRAY,ARRAY,IPTR1,IPRERR,IPTRN1,IERR)
      IF (IERR.GT.0) GO TO 110
C
C  PRINT PARAMETERS
      CALL SPMAPE ('ENGL',IVMAPE,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID3),
     *   SWORK(ID4),NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNUSED,IERR)
C
110   IF (IPTRNX.EQ.0) GO TO 130
         IPTR=IPTRNX
         GO TO 10
C
120   ISTAT=1
C
130   WRITE (LP,240) NAREA
      CALL SULINE (LP,2)
C
135   IF (ISTRCE.GT.0) WRITE (IOSDBG,250) ISTAT
      IF (ISTRCE.GT.0) CALL SULINE (IOSDBG,1)
C
      RETURN
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
140   FORMAT (' *** ENTER SNMAPE')
150   FORMAT (1H )
160   FORMAT ('0*--> FIND 5 CLOSEST PE STATIONS FOR MAPE AREAS ',
     *   'USING 1/D**POWER.')
170   FORMAT ('0*** NOTE - MINIMUM WEIGHT OF STATIONS TO BE KEPT WHEN ',
     *   'DOING STATION WEIGHTING IS ',F5.3,'.')
180   FORMAT ('0*** NOTE - PARAMETERS WILL BE UPDATED EVEN IF AREA ',
     *   'HAS PREDETERMINED WEIGHTS.')
190   FORMAT ('0*** ERROR - IN SN',A4,' - UNSUCCESSFUL CALL TO SR',A4,
     *   ' : STATUS CODE=',I2)
200   FORMAT ('0*** NOTE - MAPE AREA ',2A4,' HAS PREDETERMINED ',
     *   'STATION WEIGHTS.')
210   FORMAT ('0CONTENTS OF NETWORK ARRAYS FOR 5 CLOSEST PE ',
     *   'STATIONS')
220   FORMAT (1H0,T5,'STAID   ',4X,'STAWT')
230   FORMAT (T5,2A4,3X,F7.4)
240   FORMAT ('0*** NOTE - ',I4,' AREAS WITH MAPE PARAMETERS ',
     *   'SUCCESSFULLY PROCESSED.')
250   FORMAT (' *** EXIT SNMAPE : STATUS CODE=',I2)
C
      END
