C MEMBER XRIN26
C  (from old member FCXRIN26)
C
C @PROCESS LVL(77)
C DESC RECONFIGURE INFLOWS AFTER 'RAINEVAP' UTILITY EXECUTION.
C----------------------------------------------------------------------
C                             LAST UPDATE: 01/12/95.08:21:07 BY $WC30KH
C
      SUBROUTINE XRIN26(CO,W,D,LOCOWS,IDPT)
C----------------------------------------------------------------------
C  SUBROUTINE TO RECONFIGURE INFLOWS AFTER EACH OF THE TWO POSSIBLE
C  SIMULATION PASSES IF 'RAINEVAP' HAS BEEN USED. IF ONLY 'RAINEVAP' IS
C  USED, THEN ONLY ONE SIMULATED PASS WILL BE MADE. IF 'BACKFLOW' IS
C  USED ALONG WITH 'RAINEVAP', THEN TWO PASSES WILL BE MADE, AND ADD'L
C  TASKS MUST BE COMPLETED DURING EACH PASS.
C  ALSO, IF 'MINQ', 'FLASHBDS', 'POWERGEN', 'RULEADJ' OR 'SUMINF' IS
C  USED FOR THIS RUN, WE MUST TRANSFER THE BEST POSSIBLE INFLOWS TO A
C  HOLDING AREA FOR THEIR USE.
C-----------------------------------------------------------------------
C
      INCLUDE 'common/resv26'
      INCLUDE 'common/exg26'
      INCLUDE 'common/xre26'
      INCLUDE 'common/xqin26'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fprog'
C
      DIMENSION CO(*),W(*),D(*),LOCOWS(*),IDPT(*),QMD(31),
     & QWORK(31),IERD(31)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_res/RCS/xrin26.f,v $
     . $',                                                             '
     .$Id: xrin26.f,v 1.3 2005/02/22 14:03:28 hsu Exp $
     . $' /
C    ===================================================================
C
C
C  DEBUG TRACE OUTPUT IF REQUESTED
C
      IF (IBUG.GE.1) WRITE(IODBUG,1600)
 1600 FORMAT('   *** ENTER XRIN26 ***')
C
C----------------------------------------------------------------------
C  CHECK TO SEE WHICH SIMULATED PASS WE'RE ON.
C
C      IF (NUMSIM .EQ. 2) GO TO 1000
C  BYPASS 1000 STATEMENT BLOCK
C  TO ALLOW FOR CASE USE SUMINF ETC BUT NOT USING BACKFLOW
C
      IF (NUMSIM .EQ. 100) GO TO 1000
C
C  WE'RE ON FIRST PASS OF SIMULATED PORTION OF RUN.
C  SEE IF WE NEED TO SET FULL ARRAYS FOR MINQ, FLASHBDS, POWERGEN,
C  RULEADJ, OR SUMINF.
C
      IF (LOCOWS(13) .EQ. 0) GO TO 500
C
C--------------------
C  FOR THOSE FIVE S/U'S WE MUST:
C   1) ADD THE ADD'L FLOW TRACE TO THE CONVERTED MEAN INFLOW TRACE,
C   2) SUM THE MEANS TO GET DAILY MEANS,
C   3) TRANSFER THE INST. INFLOW TS TRACE TO THE INST. WORK SPACE FOR
C      THOSE FIVE S/U'S,
C   4) CALL XADI26 TO COMPUTE THE INST. TRACES ACCOUNTING FOR ADD'L FLOW
C
C  ADD THE ADD'L TRACE TO THE MEAN TS VALUES.
C
      LOCQI = IDPT(1) + IDOFST*NTIM24
      LOCQIM = IDPT(2) + IDOFST*NTIM24
      DO 100 I=1,NUM
      W(LPTQI+I-1) = D(LOCQI+I-1)*NTIM24 + W(LPTADL+I-1)
      W(LPTQIM+I-1) = D(LOCQIM+I-1)*NTIM24 + W(LPTADL+I-1)
  100 CONTINUE
C
C  NOW COMPUTE THE INSTANTANEOUS DISCHARGES. FIRST WE MUST SUM UP THE
C  PERIOD MEANS TO GET THE DAILY MEANS
C
      QSUM = 0.0
      DO 200 I=1,NUM
C
      QSUM = QSUM + W(LPTQIM+I-1)
      IF (MOD(I,NTIM24) .NE. 0) GO TO 200
C
C  AT END OF DAY, SO, CONVERT THE SUM OF THE PERIOD MEANS TO CMSD AND
C  STORE THE CONVERTED VALUE.
C
      IQMD = I/NTIM24
      QMD(IQMD) = QSUM/NTIM24
      QSUM = 0.00
  200 CONTINUE
C
C  TRANSFER INST. INFLOWS FROM TIME-SERIES TO HOLDING SPACE
C
C      LOCQII = IDPT(1) + IDOFST*NTIM24
C      CALL UMEMOV(D(LOCQII),W(LPTQI),NUM)
C
C  CALL THE ADJUSTMENT ROUTINE TO ADJUST THE SIMULATED INST. TO MATCH
C  DAILY VOLUMES WITH THE SUMMED DAILY VOLUMES.
C
      TOLRNS = 0.025
      CALL XADI26(W(LPTQI),QWORK,QMD,1,IQMD,1,NUM,TOLRNS,CO(1),
     .            IORDN,MINODT,MINODT,24,D,0,MINODT,IERD)
C
C-----------------------------------------------------------------
C  IF 'BACKFLOW' IS ENABLED, MUST COMPUTE INST. AND MEAN BASES FOR USE
C  IN COMPUTING FINAL 'ADJUSTED' INFLOWS.
C
  500 CONTINUE
      IF (.NOT.DOBACK) GO TO 9000
      IF (LOCOWS(13) .EQ. 0) GO TO 9000
C
C 'BACKFLOW' ENABLED, WE MUST:
C
C   1) SUBTRACT ADD'L TRACE FROM PREVIOUSLY ADJUSTED INFLOW
C   2) SUM MEAN BASES TO GET DAILY MEAN BASES,
C   3) CALL XADI26 TO GET INST. BASES.
C
      LBFQI = LOCOWS(1)
      LBFQIM = LBFQI + NDD*NTIM24
C
C  SUBTRACT ADD'L TRACE FROM ORIGINAL ADJ. INFLOW.
C
      DO 600 I=1,NUM
C      W(LBFQIM+I-1) = W(LBFQIM+I-1) - W(LPTADL+I-1)
      REX= W(LPTADL+I-1)
      IF(I.LE.LOBSIN) REX= 0.0
      W(LPTQI+I-1) = W(LBFQI+I-1) + REX
      W(LPTQIM+I-1) = W(LBFQIM+I-1) + REX
  600 CONTINUE
C
C  NOW COMPUTE THE INSTANTANEOUS DISCHARGES. FIRST WE MUST SUM UP THE
C  PERIOD MEANS TO GET THE DAILY MEANS
C
      QSUM = 0.0
      DO 700 I=1,NUM
C
      QSUM = QSUM + W(LBFQIM+I-1)
      IF (MOD(I,NTIM24) .NE. 0) GO TO 700
C
C  AT END OF DAY, SO, CONVERT THE SUM OF THE PERIOD MEANS TO CMSD AND
C  STORE THE CONVERTED VALUE.
C
      IQMD = I/NTIM24
      QMD(IQMD) = QSUM/NTIM24
      QSUM = 0.00
  700 CONTINUE
C
C  CALL THE ADJUSTMENT ROUTINE TO ADJUST THE SIMULATED INST. TO MATCH
C  DAILY VOLUMES WITH THE SUMMED DAILY VOLUMES.
C
      TOLRNS = 0.025
C      CALL XADI26(W(LBFQI),QWORK,QMD,1,IQMD,1,NUM,TOLRNS,CO(1),
      CALL XADI26(W(LPTQI),QWORK,QMD,1,IQMD,1,NUM,TOLRNS,CO(1),
     .            IORDN,MINODT,MINODT,24,D,0,MINODT,IERD)
C
C---------------------------------------
C  NOTHING ELSE TO DO FOR FIRST PASS.
C
      GO TO 9000
C
C-----------------------------------------------------------------
C  WE'RE ON SECOND PASS NOW. WE'LL ONLY BE HERE IF 'BACKFLOW' HAS BEEN
C  ENABLED.
C
C  HERE WE MUST:
C   1) ADD ADD'L TRACE TO BASE MEANS,
C   2) SUM PERIOD MEANS TO GET DAILY MEANS,
C   3) CALL XADI26 TO GET FINAL INST. 'ADJUSTED' INFLOWS.
C
C  IF ONE OF THOSE FIVE MAGICAL S/U'S ARE ENABLED, TRANSFER THE FINAL
C  ADJUSTED INFLOWS TO THE PROPER HOLDING SPACE.
C
 1000 CONTINUE
C
C  ADD ADD'L TRACE TO BASE MEANS
C
      IF (LOCOWS(13) .EQ. 0) GO TO 9000
      LBFQI = LOCOWS(1)
      LBFQIM = LBFQI + NDD*NTIM24
C
      DO 1100 I=1,NUM
      W(LBFQIM+I-1) = W(LBFQIM+I-1) + W(LPTADL+I-1)
 1100 CONTINUE
C
C  NOW COMPUTE THE INSTANTANEOUS DISCHARGES. FIRST WE MUST SUM UP THE
C  PERIOD MEANS TO GET THE DAILY MEANS
C
      QSUM = 0.0
      DO 1200 I=1,NUM
C
      QSUM = QSUM + W(LBFQIM+I-1)
      IF (MOD(I,NTIM24) .NE. 0) GO TO 1200
C
C  AT END OF DAY, SO, CONVERT THE SUM OF THE PERIOD MEANS TO CMSD AND
C  STORE THE CONVERTED VALUE.
C
      IQMD = I/NTIM24
      QMD(IQMD) = QSUM/NTIM24
      QSUM = 0.00
 1200 CONTINUE
C
C  CALL THE ADJUSTMENT ROUTINE TO ADJUST THE SIMULATED INST. TO MATCH
C  DAILY VOLUMES WITH THE SUMMED DAILY VOLUMES.
C
      TOLRNS = 0.025
      CALL XADI26(W(LBFQI),QWORK,QMD,1,IQMD,1,NUM,TOLRNS,CO(1),
     .            IORDN,MINODT,MINODT,24,D,0,MINODT,IERD)
C
C  TRANSFER THE 'ADJUSTED' INFLOWS IF ONE OF THOSE FIVE S/U'S IS
C  ENABLED.
C
      IF (LOCOWS(13) .EQ. 0) GO TO 9000
C
      CALL UMEMOV(W(LBFQI),W(LPTQI),NUM)
      CALL UMEMOV(W(LBFQIM),W(LPTQIM),NUM)
C
C------------------------------------------------------------
C  THAT'S IT. WE'RE DONE WITH EVERYTHING.
C
 9000 CONTINUE
      IF (IBUG.GE.1) WRITE(IODBUG,1699)
 1699 FORMAT('    *** EXIT XRIN26 ***')
      RETURN
      END
