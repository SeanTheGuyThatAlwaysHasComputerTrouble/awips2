C MEMBER ERUL26
C  (from old member FCERUL26)
C
      SUBROUTINE ERUL26(RULEL,DATE,RULELV)
C
C SUBROUTINE ERUL26 IS A UTILITY SUBROUTINE THAT COMPUTES AN ARRAY OF
C RULE CURVE ELEVATIONS CORRESPONDING IN ARRAY POSITIONS TO INFLOW,
CC OUTFLOW AND  STORAGE ARRAYS.  RULE CURVE ELEVATIONS  ARE NOT ADJUSTED
C BY THE DEVIATION ADJUSTMENT COMPUTED IN ARUL26 SINCE THE ADJUSTMENT
C IS USED ONLY IN THE ADJUSTED RUN.  A RELATION OF JULIAN DATE VS RULE
C CURVE ELEVATION IS USED TO COMPUTE THE RULE CURVE ELEVATIONS.
C ALTHOUGH AN EFFECTIVE TIME OF DAY IS VERY RARELY INDICATED FOR A RULE
C CURVE, A TIME IS NEEDED IN ORDER TO PROVIDE A SMOOTH LINE OR CURVE
C RATHER THAN HAVING AN ABRUPT CHANGE IN SOME CASES AT THE BEGINNING OF
C THE NEXT DAY.  IF THE TIME AT THE END OF THE FIRST TIME INTERVAL
C (KHRBGN) SEEMS REASONABLE, KHRBGN CAN BE USED FOR THE EFFECTIVE TIME
C (KHRRUL) IF KHRRUL IS NOT SPECIFIED IN THE RESERVOIR MANUAL.
C
C THIS SUBROUTINE WAS ORIGINALLY PROGRAMMED BY
C     WILLIAM E. FOX -- CONSULTING HYDROLOGIST
C     FEBRUARY, 1982
C
C SUBROUTINE ERUL26 IS IN
C
C VARIABLES PASSED TO OR FROM THIS SUBROUTINE ARE DEFINED AS FOLLOWS:
C     BGNRCE -- RULE CURVE ELEVATION AT BEGINNING OF FIRST TIME INTERVAL
C     DATE -- JULIAN DATES FOR RULE CURVE RELATION.
C     IBUG -- NO TRACE OR DEBUG (IBUG=0), TRACE ONLY (IBUG=1), TRACE AND
C             DEBUG (IBUG=2).
C     JULDAT -- JULIAN DATE AT END OF FIRST ARRAY POSITION.
C     LOBSTO -- PERIOD NO. OF LAST OBSERVED POOL ELEVATION.
C     NODAYR -- NO. OF DAYS IN YEAR IN WHICH JULDAT IS LOCATED.
C     KHRBGN -- TIME OF HYDROLOGIC DAY AT END OF FIRST ARRAY POSITION.
C     KHRRUL -- EFFECTIVE TIME OF RULECURVE DAY 
C               FOR RULE CURVE ELEVATIONS FROM RULE CURVE.
C     NTIMES -- NO. OF PERIODS TO BLEND THE LAST OBSERVED POOL
C               ELEVATION BACK INTO RULECURVE ELEVATION.
C     NTIM24 -- NO. OF TIME INTERVALS (ARRAY POSITIONS) IN 24 HOURS.
C     NUM -- NUMBER OF VALUES FOR THE RULE CURVE ELEVATION ARRAY.  WILL
C            BE THE SAME AS THE NUMBER OF VALUES IN ARRAYS OF INFLOW, ETC.
C     RULEL -- ARRAY OF RULE CURVE ELEVATIONS.
C     RULELF -- RULE CURVE ELEVATIONS AT NTIMES PERIODS AFTER 
C               LAST OBSERVED POOL ELEVATION (LOBSTO).
C     RULELV -- ELEVATIONS FOR RULE CURVE RELATION.
C     NRUL -- NO. OF PAIRS OF DATE AND RULELV VALUES.
C
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'common/resv26'
      INCLUDE 'common/rulc26'
      DIMENSION RULEL(1),DATE(1),RULELV(1)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_res/RCS/erul26.f,v $
     . $',                                                             '
     .$Id: erul26.f,v 1.2 1996/07/12 13:45:32 dws Exp $
     . $' /
C    ===================================================================
C
C
C WRITE TRACE AND DEBUG IF REQUIRED.
C
      IF(IBUG.GE.1) WRITE(IODBUG,30)
   30 FORMAT(1H0,10X,17H** ERUL26 ENTERED)
      JHRBGN=KHRBGN+(JULDAT-1)*24
      JHR=JHRBGN
      MINODX=24/NTIM24
      KHRRUX=KHRRUL+MINODX
      DO 120 I=2,NRUL
      J = I
      JHR2=KHRRUX+(DATE(J)-1)*24
      IF(JHR.LT.JHR2) GO TO 150
  120 CONTINUE
  150 A=RULELV(J)-RULELV(J-1)
      JHR1=KHRRUX+(DATE(J-1)-1)*24
      BGNRCE=RULELV(J-1)+(JHR-JHR1)*A/(JHR2-JHR1)
      DO 290 IS2=1,NUM
      JHR = JHR+MINODX
      IADD = IS2/NTIM24
      IDSET = IDARUN + IADD
      NDAYR = 365 + LEAP26(IDSET,IHR)
      JHRYR=NDAYR*24
      IF(JHR.GT.JHRYR) JHR=MOD(JHR,JHRYR)
      DO 220 I=2,NRUL
      J = I
      JHR2=KHRRUX+(DATE(J)-1)*24
      IF(JHR.LT.JHR2) GO TO 250
  220 CONTINUE
  250 A=RULELV(J)-RULELV(J-1)
      JHR1=KHRRUX+(DATE(J-1)-1)*24
      RULEL(IS2)=RULELV(J-1)+(JHR-JHR1)*A/(JHR2-JHR1)
  290 CONTINUE
      IF(IBUG.LT.2) GO TO 600
      RULEL1=BGNRCE
      IF(NS2.GE.2) RULEL1=RULEL(NS2-1)
      RULEL2=RULEL(NS2)
      WRITE(IODBUG,510)NUM,JULDAT,NDAYR,KHRBGN,KHRRUL,RULEL1,RULEL2
  510 FORMAT(1H0,' NUM,JULDAT,NDAYR,KHRBGN,KHRRUL,RULEL1,RULEL2',
     & /1X,5I6,2F8.2)
      WRITE(IODBUG,520) (DATE(I),I=1,NRUL)
  520 FORMAT(1H0,' DATES AND RULE CURVE ELEVATION:',
     $ /(1X,10F8.0))
      WRITE(IODBUG,525) (RULELV(I),I=1,NRUL)
 525  FORMAT(1X,10F8.2)
      WRITE(IODBUG,530) (RULEL(I),I=1,NUM)
  530 FORMAT(1H0,' PERIOD RULECURVE ELEVATIONS FOR ALL PERIODS ARE',
     & /(1X,8F8.2))
  600 CONTINUE
CC
CC FOLLOWING ARE ORIGINAL CODE BY ED. FOX
CC   50 JDATE=JULDAT
C
C COMPUTE THE RULE CURVE ELEVATION (ELRULJ) FOR  JDATE AND KHRRUL.
C
CC      DAT=JDATE
CC      CALL TERP26(DAT,ELRULJ,DATE,RULELV,NRUL,IFLAG,IBUG)
C
C FOLLOWING STATEMENTS THROUGH CALL TERP26 WILL COMPUTE THE RULE CURVE
C ELEVATION (ELRULK) ON PREVIOUS OR FOLLOWING DAY.  ELRULK WILL BE USED
C WITH ELRULJ TO ADJUST THE ELEVATION FROM TIME KHRRUL TO KHRBGN.
C
CC      JDIF=KHRBGN-KHRRUL
CC      IF(JDIF)60,90,70
CC   60 JDATE=JDATE-1
CC      IF(JDATE.EQ.0) JDATE=NODAYR
CC      GO TO 80
CC   70 JDATE=JDATE+1
CC      IF(JDATE.GT.NODAYR) JDATE=1
CC   80 DAT=JDATE
CC      CALL TERP26(DAT,ELRULK,DATE,RULELV,NRUL,IFLAG,IBUG)
C
C FOLLOWING STATEMENTS COMPUTE ADJUSTMENT (ADJUST) TO ELRULJ FOR
C DIFFERENCE IN KHRBGN AND KHRRUL.
C
CC      DIF=JDIF
CC      ADJUST=(ELRULK-ELRULJ)*DIF/24.
CC      IF(JDIF.LT.0) ADJUST=-ADJUST
C
C ELRUL WILL BE THE ADJUSTED RULE CURVE ELEVATION.
C
CC      ELRUL=ELRULJ + ADJUST
CC      GO TO 100
CC   90 ELRUL=ELRULJ
CC  100 IF(IBUG.NE.2) GO TO 120
CC      WRITE(IODBUG,110) ELRUL,ELRULJ,JULDAT,ELRULK,JDATE,KHRRUL,KHRBGN
CC  110 FORMAT(1H0,33H ADJUSTED RULE CURVE ELEVATION IS,F12.3, 26H   UNADJ
CC     $USTED ELEVATION IS,F12.3,16H FOR JULIAN DATE,I6/1H0,20H RULE CURVE
CC     $ELEVATION,F12.3,16H FOR JULIAN DATE,I6,34H WAS USED IN MAKING THE
CC     $ADJUSTMENT/1H0,40H EFFECTIVE TIME OF DAY FOR RULE CURVE IS,I6,40H.
CC     $  TIME OF DAY FOR ADJUSTED ELEVATION IS,I6)
CC  120 PER24=NTIM24
CC      JBGN=1
CC      JADD=1+(KHRRUL-KHRBGN)*NTIM24/24
CC      IF(JULDAT.GE.NODAYR) GO TO 140
C
C DO LOOP 130 WILL COMPUTE POSITION OF JULDAT IN DATE ARRAY OF RULE
C CURVE RELATION.
C
CC      DO 130 I=1,NRUL
CC      J=I
CC      JDATE=DATE(J)+0.05
CC      IF(JULDAT.GE.JDATE) GO TO 130
CC      JTEST=JULDAT
CC      GO TO 150
CC  130 CONTINUE
C
C STATEMENT 140 AND THREE FOLLOWING STATEMENTS PREPARE FOR COMPUTATIONS
C FROM KHRBGN TIME ON LAST DAY OF THE YEAR TO KHRBGN TIME  ON FIRST DAY
C OF THE NEXT YEAR.  THIS 24-HR PERIOD IS HANDLED SEPARATELY DUE TO LEAP
C YEARS AND NON-LEAP YEARS.  A IS THE 24-HR DIFFERENCE IN RULE CURVE
C ELEVATION AND B IS THE NUMBER OF TIME PERIODS. THE RULE CURVE RELATION
C MUST HAVE VALUES ON THE FIRST (1) ABD LAST DAYS (366) OF THE YEAR.
C
CC  140 JEND=JADD+NTIM24
CC      A=RULELV(1)-RULELV(NRUL)
CC      B=PER24
CC      J=1
CC      GO TO 160
C
C STATEMENT 150 TO STATEMENT BEFORE 160 SETS VALUES FOR COMPUTING RULE
C CURVE ELEVATIONS WITHIN THE SAME YEAR.
C
CC  150 IF(J.EQ.NRUL) JDATE=NODAYR
CC      JEND=JADD+(JDATE-JTEST)*NTIM24
CC      A=RULELV(J)-RULELV(J-1)
CC      DAY=JDATE
CC      B=(DAY-DATE(J-1))*PER24
C
C RESET DATE TEST VALUE, COMPUTE INCREMENTAL CHANGE, AND COMPUTE VALUES
C OF RULE CURVE ELEVATION BETWEEN DATE VALUES.
C
CC  160 JTEST=DATE(J)+0.05
CC      NUMX=NTIM24*31
CC      IF(JEND.GT.NUMX) JEND=NUMX
CC      CHANGE=A/B
CC      DO 180 I=JBGN,JEND
CC      IF(I.EQ.1) GO TO 170
CC      RULEL(I)=RULEL(I-1) + CHANGE
CC      GO TO 180
CC  170 RULEL(1)=ELRUL
CC      BGNRCE=ELRUL-CHANGE
CC  180 CONTINUE
CC      IF (JEND.EQ.NUMX) GO TO 190
C
C SAVE ENDING VALUE OF COUNTER (JEND) IN DO LOOP 180 AND RESET BEGINNING
C VALUE OF COUNTER (JBGN) AND POSITION (J) IN DATE ARRAY.
C
CC      JADD=JEND
CC      JBGN=JEND+1
CC      J=J+1
CC      JDATE=DATE(J)+0.05
CC      IF(J.LE.NRUL) GO TO 150
CC      GO TO 140
CC  190 IF(IBUG-1)260,240,200
CC  200 WRITE(IODBUG,210)
CC  210 FORMAT(1H0,38H FOLLOWING ARE VALUES AT END OF ERUL26)
CC      WRITE(IODBUG,40)NUM,JULDAT,NODAYR,KHRBGN,KHRRUL,NTIM24,IBUG
CC      WRITE(IODBUG,220) (DATE(I),RULELV(I),I=1,NRUL)
CC  220 FORMAT(1H0,82H ALTERNATING VALUES OF DATES AND RULE CURVE ELEVATIO
CC     $NS FOR RULE CURVE RELATION ARE/(1X,6(F6.0,F10.2,4X)))
CC      WRITE(IODBUG,230) (RULEL(I),I=1,NUM)
CC  230 FORMAT(1H0,35H COMPUTED RULE CURVE ELEVATIONS ARE/(1X,10F12.3))
CC  240 WRITE(IODBUG,250)
CC  250 FORMAT(1H0,10X,17H** LEAVING ERUL26)
CC 260  RETURN
      IF(IBUG.GE.1) WRITE(IODBUG,550)
  550 FORMAT(1H0,10X,17H** LEAVING ERUL26)
      RETURN
      END

