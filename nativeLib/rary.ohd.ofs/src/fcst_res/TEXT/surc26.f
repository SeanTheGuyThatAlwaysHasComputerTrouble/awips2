C MODULE SURC26
C ......................................................................
      SUBROUTINE SURC26(ELVSUR,QISUR,STOR,ELEV)
C ......................................................................
C SUBROUTINE SURC26 CHECKS TO SEE IF THE PROGRAM SHOULD GO TO OR STAY IN
C THE INDUCED SURCHARGE SUBROUTINE NDUC26.  WHEN THE ELEVATION AT THE
C BEGINNING (ELEV1) OR END (ELEV2 COMPUTED IN A PREVIOUS SUBROUTINE)
C OF THE TIME PERIOD IS GREATER THAN A SPECIFIED UPPER ELEVATION
C (EUPRND), THE OPERATION IS EITHER ALREADY IN INDUCED SURCHARGE OR WILL
C GO TO INDUCED SURCHARGE.  WHEN THE POOL IS RISING AND THE ELEVATION IS
C BETWEEN THE UPPER ELEVATION AND A SPECIFIED LOWER ELEVATION (ELWRND)
C OR BETWEEN THE UPPER AND RULE CURVE ELEVATION (RULEL1 OR RULEL2),
C ENTRY INTO INDUCED SURCHARGE DEPENDS ON A RELATION BETWEEN ELEVATION
C AND INFLOW.  WHEN THE
C POOL IS FALLING, THE INDUCED SURCHARGE EVACUATION WILL BE STOPPED WHEN
C THE POOL DROPS BELOW A SPECIFIED ELEVATION (FALELB) OR RULE CURVE
C ELEVATION.
C ......................................................................
C THIS SUBROUTINE WAS ORIGINALLY PROGRAMMED BY
C     WILLIAM E. FOX -- CONSULTING HYDROLOGIST
C     FEBRUARY, 1982
C  MOD - REMOVE CHECK ON FALLING CONDITION AS PROMPT INTO SURCHARGE
C        CONDITION AS THIS WILL BE INTERCEPTED BY XU2126 (CALLING
C        ROUTINE). QUICK FIX IS TO RESET DO LOOP 150 COUNTER TO 1
C        AND TO COMMENT OUT ALL UNNECESSARY STATEMENTS).
C  MOD MADE BY - JOE OSTROWSKI - APRIL 1984
C ......................................................................
C SUBROUTINE SURC26 IS IN
C ......................................................................
C VARIABLES PASSED TO OR FROM THIS SUBROUTINE ARE DEFINED AS FOLLOWS:
C     SURCHG -- LOGICAL VARIABLE.  WHEN TRUE, THE PROGRAM WILL GO TO
C       INDUCED SURCHARGE.
C     TENDCY -- CHANGE IN POOL ELEVATION FROM STAGE PRIOR TO ELEV1 TO
C       ELEV1.
C     QIBAC1 -- INSTANTANEOUS INFLOW ONE TIME PERIOD BEFORE QI1.
C     QI1 -- INSTANTANEOUS INFLOR AT BEGINNING OF TIME PERIOD.
C     QI2 -- INSTANTANEOUS INFLOW AT END OF TIME PERIOD.
C     FRACT -- FRACTION OF TIME PERIOD OVER WHICH MEAN INFLOW FOR
C       INDUCED SURCHARGE RELATION IS COMPUTED.
C     ELBAC1 -- ELEVATION ONE TIME PERIOD PRIOR TO ELEV1.
C     ELEV1 -- POOL ELEVATION AT BEGINNING OF TIME PERIOD.
C     ELEV2 -- POOL ELEVATION AT END OF TIME PERIOD.
C     EUPRND -- SPECIFIED UPPER ELEVATION.  ABOVE EUPRND, INDUCED SUR-
C       CHARGE OPERATION IS USED.  VALUE OF -999.0 INDICATES RULE
C       CURVE ELEVATION IS USED. RULE CURVE PLUS AN ADDITION IS DEFINED
C       ADDING THE ADDITION TO -999.0.
C     ELWRND -- SPECIFIED LOWER ELEVATION.  BETWEEN ELWRND AND EUPRND
C       INDUCED SURCHARGE MAY OR MAY NOT BE REQUIRED.  VALUE OF -999.0
C       INDICATES RULE CURVE ELEVATION IS USED.  RULE CURVE PLUS AN
C       ADDITION IS DEFINED BY ADDING THE ADDITION TO -999.0.  IF ONLY
C       ONE ELEVATION IS USED,  EUPRND AND ELWRND MUST BE THE SAME.
C     FALELB -- WHEN POOL IS FALLING, THE OPERATION GOES OUT OF INDUCED
C       SURCHARGE WHEN POOL DROPS BELOW FALELB.  IF FALELB IS -999.0,
C       RULE CURVE ELEVATION IS USED FOR FALELB.  RULE CURVE PLUS AN
C       ADDITION IS DEFINED BY ADDING THE ADDITION TO -999.0.
C     SURMIN -- MINIMUM OUTFLOW SHOWN ON INDUCED SURCHARGE RELATION.
C       MAY BE MAXIMUM GENERATION DISCHARGE FOR A POWER DAM BUT COULD
C       BE A GREATER OR LESSER VALUE.
C     ELVSUR -- ELEVATION VALUES FOR ELVSUR VS QISUR RELATION.
C     QISUR -- INFLOW VALUES THAT WILL REQUIRE INDUCED SURCHARGE RELA-
C       TION.  VALUES CORRESPOND TO ELVSUR VALUES.
C     NEQSUR -- NO. OF PAIRS OF ELVSUR AND QISUR VALUES.
C     RULEL1 -- RULE CURVE ELEVATION AT BEGINNING OF TIME PERIOD,
C     RULEL2 -- RULE CURVE ELEVATION AT END OF TIME PERIOD.
C     IBUG -- NO TRACE OR DEBUG (IBUG=0), TRACE ONLY (IBUG=1), TRACE AND
C       DEBUG (IBUG=2).
C ......................................................................
      INCLUDE 'common/fdbug'
      INCLUDE 'common/resv26'
      INCLUDE 'common/srcg26'
C
      DIMENSION ELVSUR(1),QISUR(1),STOR(1),ELEV(1)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_res/RCS/surc26.f,v $
     . $',                                                             '
     .$Id: surc26.f,v 1.4 2000/12/19 15:01:13 dws Exp $
     . $' /
C    ===================================================================
C
C ......................................................................
C WRITE TRACE AND DEBUG IF REQUIRED.
C ......................................................................
      IF(IBUG-1)50,10,20
   10 WRITE(IODBUG,30)
      GO TO 50
   20 WRITE(IODBUG,30)
   30 FORMAT(1H0,10X,17H** SURC26 ENTERED)
      WRITE(IODBUG,40) SURCHG,TENDCY,QIBAC1,QI1,QI2,QIMRAC,QIMSUR,FRACT,
     & ELBAC1,ELEV1,ELEV2,HUPPER,HCHECK,HLOWER,RULEL1,RULEL2
   40 FORMAT(1H0,10X,
     $'SURCHG,TENDCY,QIBAC1,QI1,QI2,QIMRAC,QIMSUR,FRACT,',
     &/1X,L5,F10.3,5F10.0,F10.3,
     $/10X,'ELBAC1,ELEV1,ELEV2,HUPPER,HCHECK,HLOWER,RULEL1,RULEL2',
     $/1X,8F10.3)
C
C USE RULE CURVE ELEVATION FOR HUPPER OR HLOWER IF EQUAL TO -999.0.
C ......................................................................
   50 HCHECX=HCHECK
      IF(HCHECX.LT.-900.0) HCHECX=RULEL1 + HCHECK + 999.0
      HLOWEX=HLOWER
      IF(HLOWEX.LT.-900.0) HLOWEX=RULEL1 + HLOWER + 999.0
      HUPPEX=HUPPER
      IF(HUPPEX.LT.-900.0) HUPPEX=RULEL1 + HUPPER + 999.0
      TNDCY=TENDCY
      IF(ELEV1.GT.HLOWEX) GO TO 170
C
      IF(TNDCY.EQ.-999.0) TNDCY=ELEV1-ELBAC1
      IF(ELEV1.LT.HLOWEX) GO TO 160
   70 IF(TNDCY) 160,90,90
C ......................................................................
C POOL IS RISING OR STEADY.  ELVUP WILL BE THE SPECIFIED UPPER ELEVATION
C (CONSTANT, RULE CURVE, OR RULE CURVE PLUS AN ADDITION) AND ELVLW WILL
C BE THE LOWER ELEVATION.
C ......................................................................
 90   CONTINUE
      IF(HCHECX.GT.HLOWEX) GO TO 170
C
C  SET ELEVATION TO HLOWER TO START SURCHARGE OPERATION
CC      IF(HCHECX.LE.HLOWEX) GO TO 95
CC      ELEV1=HLOWEX
CC      CALL NTER26(ELEV1,S1,ELEV,STOR,NSE,IFLAG,NTERP,IBUG)
CC      GO TO 170
 95   DIF=QI1-QIBAC1
      QIFRAC=QIBAC1+DIF*(1.-FRACT)
      QIMSUR=(QI1+QIFRAC)*0.5
      IF(ELEV1.GE.HCHECX .AND. QIMSUR.GE.QCHECK) GO TO 170
  160 SURCHG=.FALSE.
      GO TO 180
  170 SURCHG=.TRUE.
  180 TENDCY=TNDCY
      IF(IBUG-1) 250,230,190
  190 WRITE(IODBUG,200)
  200 FORMAT(1H0,42H FOLLOWING ARE VALUES AT THE END OF SURC26)
      WRITE(IODBUG,40) SURCHG,TENDCY,QIBAC1,QI1,QI2,QIMRAC,QIMSUR,FRACT,
     & ELBAC1,ELEV1,ELEV2,HUPPEX,HCHECX,HLOWEX,RULEL1,RULEL2
  230 WRITE(IODBUG,240)
  240 FORMAT(1H0,10X,17H** LEAVING SURC26)
  250 RETURN
C    ===================================================================
C
C ......................................................................
C WRITE TRACE AND DEBUG IF REQUIRED.
C ......................................................................
CC      IF(IBUG-1)50,10,20
CC   10 WRITE(IODBUG,30)
CC      GO TO 50
CC   20 WRITE(IODBUG,30)
CC   30 FORMAT(1H0,10X,17H** SURC26 ENTERED)
CC      WRITE(IODBUG,40) SURCHG,TENDCY,QIBAC1,QI1,QI2,FRACT,ELBAC1,ELEV1,E
CC     $LEV2,EUPRND,ELWRND,FALELB,RULEL1,RULEL2,IBUG
CC   40 FORMAT(1H0, 96H   SURCHG,TENDCY,QIBAC1,QI1,QI2,FRACT,ELBAC1,ELEV1,
CC     $ELEV2,EUPRND,ELWRND,FALELB,RULEL1,RULEL2,IBUG/1X,L5,9F12.3/1X,4F12
CC     $.3,I6)
C ......................................................................
C WHEN ELEV1 OR ELEV2 (IF OBSERVED OR PREVIOUSLY COMPUTED) ARE ABOVE THE
C SPECIFIED ELEVATION (EUPRND), THE OPERATION IS IN OR WILL START THE
C INDUCED SURCHARGE MODE.  STATEMENT 170 SETS SURCHG=.TRUE. AND 160 SETS
C SURCHG=.FALSE.
C USE RULE CURVE ELEVATION FOR EUPRND OR ELWRND IF EQUAL TO -999.0.
C ......................................................................
CC   50 ELVUP1=EUPRND
CC      ELVUP2=EUPRND
CC      ELVLW1=ELWRND
CC      ELVLW2=ELWRND
C
C  NEED TO ADD VARIATION TO RULE CURVE IF < -900.0  (JTO - 8/83)
C
CC      IF(ELVUP1.LT.-900.0) ELVUP1=RULEL1 + EUPRND + 999.0
CC      IF(ELVUP2.LT.-900.0) ELVUP2=RULEL2 + EUPRND + 999.0
CC      IF(ELVLW1.LT.-900.0) ELVLW1=RULEL1 + ELWRND + 999.0
CC      IF(ELVLW2.LT.-900.0) ELVLW2=RULEL2 + ELWRND + 999.0
C
CC      IF(ELEV1.GT.ELVUP1.OR.ELEV2.GT.ELVUP2) GO TO 170
C
C  IF ELEVATION AT END OF PERIOD IS MISSING, SEE IF WE'LL GET INTO
C  SURCHARGE.
C
CC      IF (IFMSNG(ELEV2).EQ.1) GO TO 55
CC      IF(ELEV1.LE.ELVLW1.AND.ELEV2.LE.ELVLW2) GO TO 160
C ......................................................................
C FOR THE FOLLOWING STATEMENTS EITHER ELEV1 OR ELEV2 (BEGINNING OR
C ENDING ELEVATIONS) IS BETWEEN THE SPECIFIED UPPER ELEVATION (EUPRND)
C AND THE SPECIFIED LOWER ELEVATION (ELWRND).
C DO LOOP 150 WILL CHECK IF THE POOL IS RISING OR
C FALLING AT ELEV1 AND ELEV2 (IF OBSERVED OR PREVIOUSLY COMPUTED) AND IF
C CONDITIONS REQUIRE INDUCED SURCHARGE OPERATION.
C ......................................................................
CC   55 CONTINUE
C
C  RESET DO COUNTER TO ONE TO NOT CHECK ON FALLING CONDITION AND
C  COMMENT OUT ALL UNNNECESSARY STATEMENTS - JTO 4/84
C
C     DO 150 I=1,2
C     IF(I.EQ.2) GO TO 60
CC      TSTELV=ELEV1
CC      TNDCY=TENDCY
CC      IF(TNDCY.EQ.-999.0) TNDCY=ELEV1-ELBAC1
CC      ELV=RULEL1
C     GO TO 70
C  60 IF(ELEV2.NE.-999.0) GO TO 62
C
C ESTIMATE ENDING TIME INTERVAL ELEVATION (ESTEL2) BY USING MINIMUM OUT-
C FLOW (SURMIN) SHOWN ON THE INDUCED SURCHARG RELATION FOR MEAN OUTFLOW
C FOR THE TIME INTERVAL.
C
C     SS2=S1+QIM-SURMIN
C     CALL NTER26(SS2,ESTEL2,STOR,ELEV,NSE,IFLAG,NTERP,IBUG)
C     TSTELV=ESTEL2
C     IF(IBUG.EQ.2) WRITE(IODBUG,61) ESTEL2
C  61 FORMAT(1H0,47H ESTIMATED ELEVATION AT END OF TIME INTERVAL IS,
C    $F12.3)
C     GO TO 63
C  62 TSTELV=ELEV2
C  63 TNDCY=TSTELV-ELEV1
C     ELV=RULEL2
CC   70 IF(TNDCY) 150,90,90
C  80 IF(FALELB.LT.-900.0) GO TO 81
C     ELV=FALELB
C     GO TO 82
C  81 ELV=ELV+FALELB+999.0
C  82 IF(TSTELV.GT.ELV) GO TO 170
C     GO TO 150
C ......................................................................
C POOL IS RISING OR STEADY.  ELVUP WILL BE THE SPECIFIED UPPER ELEVATION
C (CONSTANT, RULE CURVE, OR RULE CURVE PLUS AN ADDITION) AND ELVLW WILL
C BE THE LOWER ELEVATION.
C ......................................................................
CC   90 ELVUP=EUPRND
CC      IF(ELVUP.LT.-900.0) ELVUP=ELV+ELVUP+999.0
CC      ELVLW=ELWRND
CC      IF(ELVLW.LT.-900.0) ELVLW=ELV+ELVLW+999.0
CC      IF(TSTELV.GT.ELVLW.AND.TSTELV.LE.ELVUP) GO TO 120
CC      IF(TSTELV.GT.ELVUP) GO TO 170
CC      GO TO 150
CC  120 CALL TERP26(TSTELV,REQQI,ELVSUR,QISUR,NEQSUR,IFLAG,IBUG)
C ......................................................................
C REQQI IS THE REQUIRED INFLOW FOR GOING INTO THE INDUCED SURCHARGE
C OPERATION.  COMPUTE AVERAGE INFLOW (QIMSUR) FOR SPECIFIED FRACTION OF
C TIME PERIOD (FRACT).
C ......................................................................
C     IF(I.EQ.2) GO TO 130
CC      DIF=QI1-QIBAC1
CC      QIFRAC=QIBAC1+DIF*(1.-FRACT)
CC      QIMSUR=(QI1+QIFRAC)*0.5
CC      GO TO 140
C 130 DIF=QI2-QI1
C     QIFRAC=QI1+DIF*(1.-FRACT)
C     QIMSUR=(QI2+QIFRAC)*0.5
CC  140 IF(QIMSUR.GT.REQQI) GO TO 170
CC  150 CONTINUE
CC  160 SURCHG=.FALSE.
CC      GO TO 180
CC  170 SURCHG=.TRUE.
CC  180 IF(IBUG-1) 250,230,190
CC  190 WRITE(IODBUG,200)
CC  200 FORMAT(1H0,42H FOLLOWING ARE VALUES AT THE END OF SURC26)
CC      WRITE(IODBUG,40) SURCHG,TENDCY,QIBAC1,QI1,QI2,FRACT,ELBAC1,ELEV1,E
CC     $LEV2,EUPRND,ELWRND,FALELB,RULEL1,RULEL2,IBUG
CC      WRITE(IODBUG,220) (ELVSUR(I),QISUR(I),I=1,NEQSUR)
CC  220 FORMAT(1H0,56H ALTERNATING VALUES OF ELEVATION AND REQUIRED INFLOW
CC     $ ARE/(1X,10F12.3))
CC  230 WRITE(IODBUG,240)
CC  240 FORMAT(1H0,10X,17H** LEAVING SURC26)
CC  250 RETURN
      END
