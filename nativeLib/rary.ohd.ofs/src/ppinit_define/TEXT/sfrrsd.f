C MODULE SFRRSD
C-----------------------------------------------------------------------
C
C  ROUTINE TO DEFINE RRS FLOW DISTRIBUTION PARAMETERS.
C
      SUBROUTINE SFRRSD (INULL,NFLD,NUMFLD,ITYPE,INTEGR,REAL,
     *   LCHAR,CHAR,LCHK,CHK,
     *   NREP,ISTRT,LENGTH,LASK,LLPAR,LRPAR,
     *   UNDEF,IOPTN,NOPFLD,NXOFLD,IOPFL2,IOPFL3,
     *   NRRSTP,RRSTYP,INWRRS,NVLPOB,NDIST,NUMNEW,ICVRRS,
     *   IRRDST,NMIN,FLOMIN,NFRACT,FRACT,
     *   NUMERR,NUMWRN,ISTAT)
C
C
      CHARACTER*(*) CHAR(LCHAR),CHK(LCHK)
      DIMENSION ICVRRS(*)
C
      INCLUDE 'scommon/dimrrs' 
C
      INCLUDE 'uio'
      INCLUDE 'scommon/sudbgx'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppinit_define/RCS/sfrrsd.f,v $
     . $',                                                             '
     .$Id: sfrrsd.f,v 1.2 1998/04/10 16:15:55 dws Exp $
     . $' /
C    ===================================================================
C
C
C
      IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,390)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
C  SET DEBUG LEVEL
      LDEBUG=ISBUG('RRS ')
C
      ISTAT=0
C
      GO TO (380,10,190),IOPTN
      GO TO (380,10,190),NOPFLD
         WRITE (LP,400) IOPTN,NOPFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 380
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  MINIMUM DISCHARGE BELOW WHICH MEAN DISCHARGE WILL BE DISTRIBUTED
C
C  CHECK WHICH FIELD TO BE PROCESSED
10    NGOTO=NXOFLD+1
      GO TO (20,90),NGOTO
C
C  CHECK IF OPTIONAL FIELD PREVIOUSLY PROCESSED
20    IF (IOPFL2.EQ.0) GO TO 30
         WRITE (LP,460)
         CALL SUWRNS (LP,2,NUMWRN)
         NMIN=0
C
30    IOPFL2=IOPFL2+1
C
C  CHECK FOR NULL FIELD
      IF (INULL.EQ.0) GO TO 40
         WRITE (LP,430) NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 180
C
C  CHECK FOR CHARACTER DATA
40    IF (ITYPE.EQ.2) GO TO 50
         WRITE (LP,410) NUMFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 180
C
C  CHECK FOR PARENTHESES IN FIELD
50    IF (CHAR(1).NE.')') GO TO 60
         NOPFLD=0
         NXOFLD=0
         WRITE (LP,470) NUMFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 180
60    IF (LLPAR.EQ.0) CHK(1)=CHAR(1)
      IF (LLPAR.GT.0) CALL SUBSTR (CHAR,1,LLPAR-1,CHK,1)
      IF (CHK(1).EQ.'MIN') GO TO 70
         WRITE (LP,480) CHK(1),NUMFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 180
70    NOPFLD=2
      NXOFLD=1
C
C  CHECK IF MEAN DISCHARGE DATA TYPE
      IF (NVLPOB(NRRSTP).EQ.3) GO TO 80
         WRITE (LP,500) RRSTYP(NRRSTP)
         CALL SUERRS (LP,2,NUMERR)
C
80    IF (LLPAR.EQ.0.OR.LLPAR.EQ.LENGTH) GO TO 180
C
C  CHECK FOR SPECIAL CHARACTERS
90    IF (LLPAR.EQ.LENGTH.AND.LENGTH.EQ.1) GO TO 180
      IF (LRPAR.EQ.LENGTH.AND.LENGTH.EQ.1) GO TO 180
      IF (ITYPE.NE.2) GO TO 110
         IF (LRPAR.NE.1) GO TO 100
         IF (NMIN.GT.0) GO TO 180
            WRITE (LP,490)
            CALL SUERRS (LP,2,NUMERR)
            NOPFLD=0
            NXOFLD=0
            GO TO 180
100      IF (LRPAR.EQ.0.OR.LRPAR.EQ.LENGTH) GO TO 110
            WRITE (LP,410) NUMFLD,NFLD
            CALL SUERRS (LP,2,NUMERR)
            NXOFLD=1
            GO TO 180
110   IF (LLPAR.EQ.0) IBEG=1
      IF (LLPAR.GT.0) IBEG=LLPAR+1
      IF (LASK.GT.0) IBEG=LASK+1
      IEND=LENGTH
      IF (LRPAR.EQ.0) GO TO 120
         IEND=LRPAR-1
         NOPFLD=0
         NXOFLD=0
120    CALL UFRLFX (TMIN,ISTRT,IBEG,IEND,0,IERR)
C
130   NMIN=NMIN+1
      IF (NMIN.GT.1.OR.IOPFL2.GT.1) GO TO 140
         IF (INWRRS.EQ.1) THEN
            IRRDST=NUMNEW
            NDIST=NDIST+1
            ENDIF
         IF (INWRRS.EQ.0) THEN
            IRRDST=NRRSTP
            IF (FLOMIN(NRRSTP).EQ.UNDEF) NDIST=NDIST+1
            ENDIF
         ICVRRS(NRRSTP)=1
C
C  CHECK FOR MAXIMUM MINIMUM FLOW VALUES
140   IF (NMIN.LE.1) GO TO 150
         WRITE (LP,450) NUMFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 180
C
C  CHECK IF GREATER THAN ZERO
150   IF (TMIN.GE.0.0.AND.TMIN.LE.1.E+10) GO TO 160
         WRITE (LP,510) TMIN
         CALL SUERRS (LP,2,NUMERR)
         GO TO 170
C
C  SET MEAN DISCHARGE
160   FLOMIN(NRRSTP)=TMIN
      IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,580) NMIN,FLOMIN(NRRSTP),IRRDST,NDIST
         CALL SULINE (IOSDBG,1)
         ENDIF
C
C  CHECK FOR REPEATED VALUES
170   IF (NREP.LE.1) GO TO 180
         NREP=NREP-1
         GO TO 130
C
180   NXOFLD=1
      IF (LRPAR.EQ.0) GO TO 380
         NOPFLD=0
         NXOFLD=0
         GO TO 380
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  FRACTION OF FLOW TYPICALLY OCCURING AT EACH HOUR OF THE DAY
C
C  CHECK WHICH FIELD TO BE PROCESSED
190   NGOTO=NXOFLD+1
      GO TO (200,260),NGOTO
C
C  CHECK IF OPTIONAL FIELD ALREADY SPECIFIED
200   IF (IOPFL3.EQ.0) GO TO 210
         WRITE (LP,520)
         CALL SUWRNS (LP,2,NUMWRN)
         NFRACT=0
C
210   IOPFL3=1
C
C  CHECK FOR NULL FIELD
      IF (INULL.EQ.0) GO TO 220
         WRITE (LP,430) NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 340
C
C  CHECK IF CHARACTER DATA
220   IF (ITYPE.EQ.2) GO TO 230
         WRITE (LP,410) NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 340
C
C  CHECK FOR PARENTHESES IN FIELD
230   IF (LLPAR.EQ.LENGTH.AND.LENGTH.EQ.1) GO TO 340
      IF (CHAR(1).NE.')') GO TO 240
         NOPFLD=0
         NXOFLD=0
         WRITE (LP,530) NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 340
240   IF (LLPAR.EQ.0) CHK(1)=CHAR(1)
      IF (LLPAR.GT.0) CALL SUBSTR (CHAR,1,LLPAR-1,CHK,1)
      IF (CHK(1).EQ.'DIST') GO TO 250
         WRITE (LP,540) CHK(1),NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 340
250   NOPFLD=3
      NXOFLD=1
C
      IF (LLPAR.EQ.0.OR.LLPAR.EQ.LENGTH) GO TO 340
C
C  CHECK FOR SPECIAL CHARACTERS
260   IF (LLPAR.EQ.LENGTH.AND.LENGTH.EQ.1) GO TO 340
      IF (LRPAR.EQ.LENGTH.AND.LENGTH.EQ.1) GO TO 340
      IF (ITYPE.NE.2) GO TO 280
         IF (LRPAR.NE.1) GO TO 270
         IF (NMIN.GT.0) GO TO 340
            WRITE (LP,560)
            CALL SUERRS (LP,2,NUMERR)
            NOPFLD=0
            NXOFLD=0
            GO TO 340
270      IF (LRPAR.EQ.0.OR.LRPAR.EQ.LENGTH) GO TO 280
            WRITE (LP,410) NXOFLD,NFLD
            CALL SUERRS (LP,2,NUMERR)
            NXOFLD=1
            GO TO 340
280   IF (LLPAR.EQ.0) IBEG=1
      IF (LLPAR.GT.0) IBEG=LLPAR+1
      IF (LASK.GT.0) IBEG=LASK+1
      IEND=LENGTH
      IF (LRPAR.EQ.0) GO TO 290
         IEND=LRPAR-1
         NOPFLD=0
         NXOFLD=0
290   CALL UFRLFX (TFRACT,ISTRT,IBEG,IEND,0,IERR)
C
C  CHECK FOR MAXIMUM NUMBER VALUES
300   NFRACT=NFRACT+1
      IF (NFRACT.LE.24) GO TO 310
         WRITE (LP,550) NXOFLD,NFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 340
310   IF (TFRACT.GE.0) GO TO 320
         WRITE (LP,570) NFRACT,TFRACT
         CALL SUERRS (LP,2,NUMERR)
         NXOFLD=1
         GO TO 330
C
C  SET FLOW DISTRIBUTION
320   FRACT(NFRACT,IRRDST)=TFRACT
      IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,590) NFRACT,FRACT(NFRACT,IRRDST)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
C  CHECK FOR REPEATED VALUES
330   IF (NREP.LE.1) GO TO 340
         NREP=NREP-1
         GO TO 300
C
340   NXOFLD=1
      IF (LRPAR.EQ.0) GO TO 380
         NOPFLD=0
         NXOFLD=0
C
C  CHECK NUMBER OF DISTRIBUTION VALUES
      IF (NFRACT.LE.24) GO TO 350
         WRITE (LP,600) NFRACT
         CALL SUERRS (LP,2,NUMERR)
C
C  CHECK IF DISTRIBUTION SUMS TO 1
350   SUM=0.
      DO 360 I=1,24
         IF (FRACT(I,IRRDST).GE.0) SUM=SUM+FRACT(I,IRRDST)
360      CONTINUE
      IF (SUM.GE.1-.001.AND.SUM.LE.1+.001) GO TO 380
         WRITE (LP,610) SUM
         CALL SUWRNS (LP,2,NUMWRN)
         DO 370 I=1,24
            FRACT(I,IRRDST)=FRACT(I,IRRDST)/SUM
370         CONTINUE
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
380   IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,620)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
      RETURN
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
390   FORMAT (' *** ENTER SFRRSD')
400   FORMAT ('0*** ERROR - IN SFRRSD - INVALID VALUE OF IOPTN (',I2,
     *   ') OR NOPFLD (',I2,').')
410   FORMAT ('0*** ERROR - NON-CHARACTER DATA EXPECTED IN INPUT ',
     *   'FIELD ',I2,' (CARD FIELD ',I2,').')
430   FORMAT ('0*** ERROR - NO VALUE FOUND FOR OPTIONAL INPUT FIELD ',
     *   I2,' (CARD FIELD ',I2,').')
450   FORMAT ('0*** ERROR - MAXIMUM NUMBER OF MINIMUM FLOW VALUES ',
     *   '(1) EXCEEDED IN INPUT FIELD ',I2,'+ (CARD FIELD ',I2,').')
460   FORMAT ('0*** WARNING - MINIMUM FLOW VALUE HAS ',
     *   'ALREADY BEEN DEFINED.')
470   FORMAT ('0*** ERROR - NO MINIMUM FLOW VALUES ',
     *   'FOUND IN INPUT FIELD ',I2,' (CARD FIELD ',I2,').')
480   FORMAT ('0*** ERROR - PROCESSING MINIMUM FLOW ',
     *   'INDICATOR (',A4,') IN INPUT FIELD ',I2,' (CARD FIELD ',
     *   I2,').')
490   FORMAT ('0*** ERROR - NO MINIMUM FLOW VALUE FOUND.')
500   FORMAT ('0*** ERROR - RRS DATA TYPE ',A4,' IS NOT A MEAN ',
     *   'DISHARGE TYPE.')
510   FORMAT ('0*** ERROR - MINIMUM FLOW MUST BE GREATER THAN OR ',
     *   'EQUAL TO 0 AND LESS THAN 1.E+10. VALUE INPUT IS ',F9.2,'.')
520   FORMAT ('0*** WARNING - FLOW DISTRIBUTIONS HAVE ALREADY ',
     *   'BEEN DEFINED.')
530   FORMAT ('0*** ERROR - NO FLOW DISTRIBUTIONS ',
     *   'FOUND IN INPUT FIELD ',I2,' (CARD FIELD ',I2,').')
540   FORMAT ('0*** ERROR - PROCESSING FLOW DISTRIBUTIONS ',
     *   'INDICATOR (',A4,') IN INPUT FIELD ',I2,' (CARD FIELD ',
     *   I2,').')
550   FORMAT ('0*** ERROR - MAXIMUM NUMBER OF FLOW DISTRIBUTIONS ',
     *   '(24) EXCEEDED IN INPUT FIELD ',I2,'+ (CARD FIELD ',I2,').')
560   FORMAT ('0*** ERROR - NO FLOW DISTRIBUTIONS FOUND.')
570   FORMAT ('0*** ERROR - FLOW DISTRIBUTION ',I2,' MUST BE ',
     *   'GREATER THAN OR EQUAL TO ZERO. VALUE INPUT IS ',F9.2,'.')
580   FORMAT (' MINIMUM FLOW VALUE ',I1,' SET TO : ',F9.2,3X,
     *   ' AND IRRDST SET TO : ',I2,3X,' AND NDIST SET TO : ',I2)
590   FORMAT (' FLOW DISTRIBUTION ',I2,' SET TO : ',F10.5)
600   FORMAT ('0*** ERROR - 24 VALUES ARE REQUIRED TO DEFINE THE ',
     *   'TYPICAL DAILY FLOW DISTRIBUTION. ',I2,' WERE FOUND.')
610   FORMAT ('0*** WARNING - SUM OF TYPICAL DAILY FLOW DISTRIBUTION ',
     *   'VALUES MUST BE 1. THE SUM IS ',F10.3,'. THE VALUES WILL ',
     *   'BE NORMALIZED.')
620   FORMAT (' *** EXIT SFRRSD')
C
      END
