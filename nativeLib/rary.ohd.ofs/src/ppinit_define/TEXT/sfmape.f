C MODULE SFMAPE
C-----------------------------------------------------------------------
C
C  ROUTINE TO DEFINE MAPE AREA PARAMETERS.
C
      SUBROUTINE SFMAPE (LARRAY,ARRAY,DISP,PRPARM,PRNOTE,PLOT,NFLD,
     *   IRUNCK,ISTAT)
C
      REAL ENGL/4HENGL/,XMETR/4HMETR/,XMAPE/4HMAPE/
      REAL OLD/4HOLD /,XNEW/4HNEW /,BLNK/4H    /
      REAL PRE/4HPRE /,DP/4HDP  /
      REAL XNO/4HNO  /,XYES/4HYES /
C
      CHARACTER*8 TYPERR
      CHARACTER*8 BLNK8/' '/
C
      DIMENSION ARRAY(LARRAY)
      PARAMETER (LCHAR=10,LUCHAR=10,LCHK=5)
      DIMENSION CHAR(LCHAR),UCHAR(LUCHAR),CHK(LCHK)
      DIMENSION PEID(2),DESC(5),FLTLN(2)
      DIMENSION CENTRD(2),UNSD(2)
      DIMENSION STAID(2),STACOR(2)
      PARAMETER (LWKBUF=200)
      DIMENSION IWKBUF(LWKBUF)
      PARAMETER (LXBUF=1)
      DIMENSION XBUF(LXBUF)
      DIMENSION CENOLD(2)
C
      INCLUDE 'uio'
      INCLUDE 'ufielx'
      INCLUDE 'scommon/sudbgx'
      INCLUDE 'ufreex'
      INCLUDE 'scommon/suerrx'
      INCLUDE 'scommon/suoptx'
      INCLUDE 'scommon/sugnlx'
      INCLUDE 'scommon/sworkx'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppinit_define/RCS/sfmape.f,v $
     . $',                                                             '
     .$Id: sfmape.f,v 1.4 1998/07/06 12:35:41 page Exp $
     . $' /
C    ===================================================================
C
C
C
      IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,940)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
C  SET DEBUG LEVEL
      LDEBUG=ISBUG('MAPE')
C      
      ISTAT=0
C
C  INITIALIZE POINTERS.
      IDIM=LSWORK/10
C  STATION ID'S:
      ID1=1
C  STATION WEIGHTS:
      ID2=IDIM*2+1
C  MEAN PE:
      ID3=IDIM*3+1
C  PE CHANGE:
      ID4=IDIM*4+1
C  ARRAY POINTERS:
      ID5=IDIM*5+1
C  STATION COORDINATES:
      ID6=IDIM*6+1
C  MEAN PE (CONVERTED UNITS):
      ID7=IDIM*8+1
C  PE CHANGE (CONVERTED UNITS):
      ID8=IDIM*9+1
C
C  INITIALIZE VARIABLES
      MINFLD=6
      NUMERR=0
      NUMWRN=0
      NMAPE=0
      IVER=1
      IZERO=0
      NERR=0
      IBERR=0
      IPERR=0
      UNSD(1)=-999.
      UNSD(2)=-999.
      ISTRT=-1
      NPDT=1
      IDT=24
      NVALX=0
C
C  PRINT CARD
      CALL SUPCRD
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK IF SUGNLX COMMON BLOCK FILLED
C
      IF (IUGFIL.GT.0) GO TO 20
C
C  READ USER DEFINED DEFAULTS
      CALL SUGTUG (LARRAY,ARRAY,IERR)
      IF (IERR.NE.0) GO TO 10
         IUGFIL=1
         GO TO 20
C
10    WRITE (LP,950)
      CALL SUERRS (LP,2,NUMERR)
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK IF SUFFICIENT CPU TIME AVAILABLE
20    ICKRGN=0
      MINRGN=0
      ICKCPU=1
      MINCPU=5
      IPRERR=1
      IPUNIT=LP
      TYPERR='ERROR'
      INCLUDE 'clugtres'
      IF (IERR.EQ.0) GO TO 30
         CALL SUFATL
         CALL SUEND
C
30    NUMFLD=0
      TDISP=DISP
      ILATLN=0
      IPERR=NERR
      IPECHG=0
      IFLD=0
      ISTWT=0
      JWT=1
      JID=1
      NPE=0
      MPE=0
      NMPE=1
      IWTFLD=0
      POWER=-997.
      NUMSTA=1
      IREWT=0
      CENOLD(1)=0.
      CENOLD(2)=0.
      IWTOLD=0
      CALL UREPET ('?',PEID,8)
C
40    IFLD=IFLD+1
      IF (IFLD.EQ.1.AND.NMAPE.GT.0) GO TO 110
      NULL=1
C
C  GET INPUT FIELD
50    CALL UFLDRD (NFLD,CHAR,LCHAR,LDEBUG,IERR)
C
C  CHECK FOR ERRORS
      IF (IERR.EQ.2.OR.IERR.EQ.4.OR.IERR.EQ.6) THEN
         CALL UFLDST (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,REAL,
     *      LCHAR,CHAR,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,IERR,
     *      NUMERR,NUMWRN)
         ENDIF
C
C  CHECK FOR NULL FIELD
      IF (IERR.NE.1) NULL=0
C
C  CHECK FOR END OF FILE.
      IF (IERR.NE.3) GO TO 60
         NFLD=-1
         GO TO 740
C
C  CHECK FOR DEBUG
60    CALL SUIDCK ('CMDS',CHAR,NFLD,0,ICMD,IERR)
      IF (ICMD.NE.1) GO TO 70
         CALL SBDBUG (NFLD,ISTRT,IERR)
         LDEBUG=ISBUG(XMAPE)
         GO TO 50
C
C  CHECK FOR COMMAND
70    IF (LATSGN.EQ.1) GO TO 740
C
C  CHECK FOR PARENTHESES IN FIELD
      IF (LLPAR.GT.0) CALL UFPACK (LCHK,CHK,ISTRT,1,LLPAR-1,IERR)
      IF (LLPAR.EQ.0) CALL UFPACK (LCHK,CHK,ISTRT,1,LENGTH,IERR)
      IF (NFLD.NE.1) GO TO 80
      IF (LATSGN.NE.0) GO TO 80
      IF (CHK(1).EQ.XMAPE.AND.NUMFLD.EQ.0) GO TO 80
      CALL SUIDCK ('DEFN',CHK,NFLD,0,IREF,IERR)
      IF (IERR.EQ.2) GO TO 80
      CALL SUPCRD
C
C  CHECK FOR NULL FIELD.
80    IF (NULL.EQ.0) GO TO 100
      IF (DISP.EQ.OLD.AND.TDISP.NE.XNEW) GO TO 90
      IF (IFLD.EQ.6) GO TO 90
         WRITE (LP,1160) IFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
C
90    IF (IFLD.LT.4) GO TO 40
C
100   IF (NUMFLD.EQ.0) GO TO 110
C
C  CHECK FOR APPROPRIATE FIELD.
      CALL SUIDCK ('DEFN',CHK,NFLD,0,IREF,IERR)
      IF (IERR.EQ.2) GO TO 740
      IF (ISTWT.EQ.1) GO TO 560
      IF (IFLD.GT.6.AND.ISTWT.EQ.0) GO TO 670
C
110   NUMFLD=NUMFLD+1
      GO TO (120,170,300,360,360,440),IFLD
         WRITE (LP,960) CHAR
         CALL SUERRS (LP,2,NUMERR)
         NUMFLD=NUMFLD-1
         GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  FIRST FIELD - PARAMETER TYPE
C
120   IF (ITYPE.EQ.2) GO TO 130
         WRITE (LP,970) IFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
C
130   IF (CHK(1).EQ.XMAPE) GO TO 140
         WRITE (LP,970) IFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
C
140   UNIT=ENGL
      IF (LLPAR.GT.0.AND.LRPAR.GT.0) GO TO 150
         IF (PRNOTE.NE.XYES) GO TO 40
            WRITE (LP,980) ENGL
            CALL SULINE (LP,2)
            GO TO 40
C
150   CALL UFPACK (LUCHAR,UCHAR,ISTRT,LLPAR+1,LRPAR-1,IERR)
      IF (IERR.LT.1.AND.(UCHAR(1).EQ.ENGL.OR.UCHAR(1).EQ.XMETR))
     *   GO TO 160
      WRITE (LP,1020) ENGL,XMETR,ENGL
      CALL SUWRNS (LP,2,NUMWRN)
160   IF (UCHAR(1).EQ.XMETR) UNIT=XMETR
      GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  SECOND FIELD - IDENTIFIER
C
C  CHECK LENGTH OF IDENTIFIER
170   MAXCHR=8
      IF (LENGTH.LE.MAXCHR) GO TO 180
         WRITE (LP,1220) LENGTH,MAXCHR,MAXCHR
         CALL SUWRNS (LP,2,NUMWRN)
180   CALL SUBSTR (CHAR,1,MAXCHR,PEID,1)
      NMAPE=NMAPE+1
C
C  CHECK FOR BLANK IDENTIFIER
      IF (PEID(1).NE.BLNK.OR.PEID(2).NE.BLNK) GO TO 190
         WRITE (LP,1230)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 200
190   CALL SUIDCK ('ID  ',PEID,NFLD,0,IREF,IERR)
      IF (IERR.NE.2) GO TO 200
         WRITE (LP,1240) (PEID(I),I=1,2)
         CALL SUERRS (LP,2,NUMERR)
C
C  CHECK IF PARAMETERS EXIST
200   IPTR=0
      IPRERR=0
      CALL SRMAPE (IVER,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID7),
     *   SWORK(ID8),IDIM,NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNSD,
     *   LARRAY,ARRAY,IPTR,IPRERR,IPTRNX,ISMAPE)
C
      IF (ISMAPE.NE.1) GO TO 210
         WRITE (LP,1030)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 260
C
210   IF (ISMAPE.NE.3) GO TO 220
         WRITE (LP,1040) LARRAY
         CALL SUERRS (LP,2,NUMERR)
         GO TO 260
C
220   IF (ISMAPE.EQ.0.AND.DISP.EQ.XNEW) GO TO 230
         GO TO 240
230   WRITE (LP,1050) PEID
      CALL SUERRS (LP,2,NUMERR)
      GO TO 260
C
240   IF (ISMAPE.EQ.2.AND.DISP.EQ.OLD) GO TO 250
         GO TO 260
250      WRITE (LP,1070) PEID
         TDISP=XNEW
         CALL SUWRNS (LP,2,NUMWRN)
C
260   IF (TDISP.EQ.XNEW) GO TO 290
         MPE=NPE
         POWOLD=POWER
         IWTOLD=IWT
         CENOLD(1)=CENTRD(1)
         CENOLD(2)=CENTRD(2)
         IF (UNIT.EQ.ENGL) GO TO 280
            DO 270 I=1,12
               SWORK(ID3+I-1)=SWORK(ID7+I-1)
               SWORK(ID4+I-1)=SWORK(ID8+I-1)
270            CONTINUE
            GO TO 290
280      CALL UDUCNV ('MM  ','IN  ',1,12,SWORK(ID7),SWORK(ID3),IERR)
         CALL UDUCNV ('MM  ','IN  ',1,12,SWORK(ID8),SWORK(ID4),IERR)
C
C  CHECK IF TIME SERIES EXISTS
290   CALL SFTSCK (PEID,XMAPE,LXBUF,ISMAPE,IPMWRT,ITSWRT,IDT,
     *   TDISP,NUMERR,NUMWRN,IERR)
      GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  THIRD FIELD - DESCRIPTION
C
300   IF (NULL.EQ.0) GO TO 310
      IF (DISP.EQ.XNEW.OR.TDISP.EQ.XNEW) GO TO 340
C
C  CHECK LENGTH OF DESCRIPTION
310   MAXCHR=20
      IF (LENGTH.LE.MAXCHR) GO TO 320
         WRITE (LP,1080) LENGTH,MAXCHR,MAXCHR
         CALL SUWRNS (LP,2,NUMWRN)
320   CALL SUBSTR (CHAR,1,MAXCHR,DESC,1)
C
C  CHECK FOR BLANK DESCRIPTION
      DO 330 I=1,5
         IF (DESC(I).NE.BLNK) GO TO 350
330      CONTINUE
340   WRITE (LP,1090)
      CALL SUERRS (LP,2,NUMERR)
350   GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  FOURTH AND FIFTH FIELDS - LAT/LON OF CENTROID
C
360   IF (NULL.EQ.0) GO TO 380
      IF (DISP.NE.XNEW.AND.TDISP.NE.XNEW) GO TO 370
      WRITE (LP,1160) IFLD
      CALL SUERRS (LP,2,NUMERR)
370   IFLD=IFLD+1
      GO TO 40
C
380   IF (IFLD.EQ.4.AND.LLPAR.GT.0) GO TO 390
      IF (IFLD.EQ.5.AND.LRPAR.GT.0) GO TO 390
      WRITE (LP,1120) IFLD
      CALL SUWRNS (LP,2,NUMWRN)
C
390   IBEG=LLPAR+1
      IEND=LENGTH
      IF (LRPAR.GT.0) IEND=LRPAR-1
C
      CALL UFRLFX (VALUE,ISTRT,IBEG,IEND,IZERO,IERR)
C
      IF (IERR.EQ.0) GO TO 400
      WRITE (LP,1130) IFLD
      CALL SUERRS (LP,2,NUMERR)
C
400   IF (IFLD.NE.4) GO TO 420
      IF (VALUE.GE.ULLMTS(2).AND.VALUE.LE.ULLMTS(1)) GO TO 410
      WRITE (LP,1170) 'LATITUDE',VALUE,ULLMTS(2),ULLMTS(1)
      CALL SUERRS (LP,2,NUMERR)
      GO TO 40
C
410   FLTLN(1)=VALUE
      GO TO 40
C
420   IF (VALUE.GE.ULLMTS(3).AND.VALUE.LE.ULLMTS(4)) GO TO 430
      WRITE (LP,1170) 'LONGITUDE',VALUE,ULLMTS(3),ULLMTS(4)
      CALL SUERRS (LP,2,NUMERR)
      GO TO 40
C
430   FLTLN(2)=VALUE
      ILATLN=1
C
C  CHECK FOR REDEFINE
      IF (CENTRD(1).LT.CENOLD(1)-0.001.OR.CENTRD(1).GT.CENOLD(1)+0.001)
     *   IREWT=1
      IF (CENTRD(2).LT.CENOLD(2)-0.001.OR.CENTRD(2).GT.CENOLD(2)+0.001)
     *   IREWT=1
      GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  SIXTH FIELD - TYPE OF STATION WEIGHTS
C
440   IF (NULL.EQ.1.AND.(DISP.EQ.XNEW.OR.TDISP.EQ.XNEW)) GO TO 520
      IF (NULL.EQ.1) GO TO 40

      IF (LLPAR.EQ.0) GO TO 450
         CALL UFPACK (LUCHAR,UCHAR,ISTRT,1,LLPAR-1,IERR)
         GO TO 460
450   IBEG=1
      CALL UFPACK (LUCHAR,UCHAR,ISTRT,IBEG,LENGTH,IERR)
460   IF (IERR.EQ.0) GO TO 470
         WRITE (LP,1190) UCHAR(1)
         CALL SUERRS (LP,2,NUMERR)
C
470   IF (UCHAR(1).EQ.PRE) GO TO 480
      IF (UCHAR(1).EQ.DP) GO TO 520
         WRITE (LP,1190) UCHAR(1)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
C
C  PREDETERMINED
480   IF (LLPAR.GT.0) GO TO 490
         WRITE (LP,1120)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
490   IBEG=LLPAR+1
      IEND=LENGTH
      CALL UFPACK (LUCHAR,UCHAR,ISTRT,IBEG,IEND,IERR)
      IF (IERR.EQ.0) GO TO 500
         WRITE (LP,1200) UCHAR(1),UCHAR(2)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
500   IWT=1
      ISTWT=1
      IWTFLD=1
      IF (JID.LE.IDIM*2) GO TO 510
         WRITE (LP,1180) LSWORK,JID
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
510   SWORK(ID1+JID-1)=UCHAR(1)
      SWORK(ID1+JID)=UCHAR(2)
      JID=JID+2
      GO TO 640
C
C  1/D**POWER
520   IWT=2
      POWER=DPOWER(3)
      IF (LLPAR.EQ.0) GO TO 550
         IBEG=LLPAR+1
         IEND=LENGTH
         IF (LRPAR.GT.0) IEND=LRPAR-1
         CALL UFRLFX (VALUE,ISTRT,IBEG,IEND,IZERO,IERR)
         IF (IERR.GT.0) GO TO 530
            IF (VALUE.LT.0) GO TO 530
               GO TO 540
530         WRITE (LP,1130) IFLD
            CALL SUERRS (LP,2,NUMERR)
            GO TO 40
540      POWER=VALUE
         GO TO 40
550   WRITE (LP,1210) POWER
      CALL SULINE (LP,2)
      GO TO 40
C
C  PREDETERMINED STATION WEIGHT FIELDS
560   IF (LLPAR.EQ.0) GO TO 570
         WRITE (LP,970) IFLD
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
570   IWTFLD=IWTFLD+1
      IF ((IWTFLD/2)*2.NE.IWTFLD) GO TO 610
         IF (ITYPE.NE.0.AND.ITYPE.NE.1) GO TO 580
            VALUE=REAL
            GO TO 590
580      IBEG=1
         IEND=LENGTH
         IF (LRPAR.GT.0) IEND=LRPAR-1
         CALL UFRLFX (VALUE,ISTRT,IBEG,IEND,IZERO,IERR)
590   IF (JWT.LE.IDIM) GO TO 600
         WRITE (LP,1180) LSWORK,JWT
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
600   SWORK(ID2+JWT-1)=VALUE
      JWT=JWT+1
      IF (LRPAR.GT.0) ISTWT=0
      GO TO 40
C
610   IF (LLPAR.EQ.0.AND.LRPAR.EQ.0) GO TO 620
         WRITE (LP,970) IFLD
         CALL SUERRS (LP,2,NUMERR)
620   IF (JID.LE.IDIM*2) GO TO 630
         WRITE (LP,1180) LSWORK,JID
         CALL SUERRS (LP,2,NUMERR)
         GO TO 40
630   SWORK(ID1+JID-1)=CHAR(1)
      SWORK(ID1+JID)=CHAR(2)
      JID=JID+2
C
C  CHECK IF STATION EXISTS
640   STAID(1)=SWORK(ID1+JID-3)
      STAID(2)=SWORK(ID1+JID-2)
      CALL SFSCHK (LARRAY,ARRAY,STAID,'PE  ',STACOR,IPPP24,IPPPVR,
     *   IPEA24,IPTM24,NUMERR,IERR)
      IF (IERR.EQ.0) THEN
         IF (IPEA24.EQ.0) THEN
            WRITE (LP,1250) IPEA24,STAID
            CALL SUERRS (LP,2,NUMERR)
            ENDIF
         ENDIF
C
C  CHECK FOR DUPLICATE NAMES
      IF (NUMSTA.GT.1) THEN
         DO 650 I=1,NUMSTA-1
            IF (STAID(1).EQ.SWORK(ID1+I*2-2).AND.
     *          STAID(2).EQ.SWORK(ID1+I*2-1)) THEN
               WRITE (LP,1260) STAID
               CALL SUERRS (LP,2,NUMERR)
               GO TO 660
               ENDIF
650         CONTINUE
         ENDIF
660   NUMSTA=NUMSTA+1
      SWORK(ID6+JID-3)=STACOR(1)
      SWORK(ID6+JID-2)=STACOR(2)
      CALL SFCONV (SWORK(ID5+NUMSTA-2),IPEA24,1)
      GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  MEAN PE FIELDS
C
670   IF (NULL.EQ.1) GO TO 40
      IF (LLPAR.EQ.1.OR.IPECHG.EQ.1) GO TO 680
         WRITE (LP,1110)
         CALL SUWRNS (LP,2,NUMWRN)
         GO TO 40
680   IF (LLPAR.EQ.0.AND.LRPAR.EQ.0) GO TO 720
         IBEG=LLPAR+1
         IEND=LENGTH
         IF (LRPAR.EQ.0) GO TO 700
            IEND=LRPAR-1
            IF (NMPE.EQ.12) GO TO 690
               WRITE (LP,1100)
               CALL SUERRS (LP,2,NUMERR)
               GO TO 40
690   ISTP=1
700   CALL UFRLFX (VALUE,ISTRT,IBEG,IEND,IZERO,IERR)
      IF (IERR.GT.0) GO TO 710
         IF (VALUE.LT.0) GO TO 710
            GO TO 730
710   WRITE (LP,1130) IFLD
      CALL SUERRS (LP,2,NUMERR)
720   VALUE=REAL
C
730   SWORK(ID3+NMPE-1)=VALUE
      NMPE=NMPE+1
      IPECHG=1
      GO TO 40
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK NUMBER OF FIELDS PROCESSED
740   IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,990) NUMFLD,MINFLD
         CALL SULINE (IOSDBG,2)
         ENDIF
      IF (NUMFLD.GE.MINFLD) GO TO 750
         WRITE (LP,1000)
         CALL SUERRS (LP,2,NUMERR)
C
750   IF (IWT.NE.1) GO TO 780
C
C  MAKE PREDETERMINED WEIGHT CHECKS.
      WTSUM=0.0
      NPE=IWTFLD/2
      IF (NPE.EQ.0) NPE=MPE
      IF (NPE.LE.IDIM) GO TO 760
         WRITE (LP,1010) NPE
         CALL SUERRS (LP,2,NUMERR)
760   DO 770 I=1,NPE
         WTSUM=SWORK(ID2+I-1)+WTSUM
770      CONTINUE
      IF (WTSUM.GT.0.999999.AND.WTSUM.LT.1.000001) GO TO 780
         WRITE (LP,1140) WTSUM
         CALL SUWRNS (LP,2,NUMWRN)
C
C  CHECK FOR VALID NUMBER OF MEAN PE VALUES
780   IF (NMPE.EQ.13) GO TO 790
      IF ((DISP.EQ.OLD.OR.TDISP.EQ.OLD).AND.NMPE.EQ.1) GO TO 790
         NMP=NMPE-1
         WRITE (LP,1100) NMP
         CALL SUERRS (LP,2,NUMERR)
C
790   IF (ILATLN.NE.1) GO TO 800
         CALL SBLLGD (FLTLN(2),FLTLN(1),1,CENTRD(1),CENTRD(2),1,IERR)
C
800   IF (IPECHG.NE.1) GO TO 830
         CALL SFPECH (SWORK(ID3),SWORK(ID4),IERR)
C
C  CHECK IF ERRORS ENCOUNTERED
830   IBERR=NERR-IPERR
      IF (IBERR.EQ.0) GO TO 810
         WRITE (LP,1150) PEID,IBERR
         CALL SULINE (LP,2)
         GO TO 920
C
810   IF (IPMWRT.NE.1) GO TO 920
      IF (IWT.NE.2) GO TO 820
      IF (POWER.LT.POWOLD-0.001.OR.POWER.GT.POWOLD+0.001) IREWT=1
820   IF (IWT.EQ.IWTOLD.AND.IREWT.EQ.0) GO TO 840
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
      IF (IWT.NE.2) GO TO 840
C
C  COMPUTE MAPE STATION WEIGHTS
      IPARM=7
      JTYPE=3
      CALL SFADRV (PEID,ARRAY,LARRAY,IPARM,JTYPE,POWER,STMNWT,NSEGS,
     *   LFACTR,SWORK(ID1),SWORK(ID1),SWORK(ID1),CENTRD(1),CENTRD(2),
     *   IDIM,NPE,SWORK(ID1),SWORK(ID2),SWORK(ID5),SWORK(ID6),IERR)
      IF (IERR.NE.0) GO TO 830
C
C  CHECK SIZE OF WORK ARRAY
840   NXBUF=0
      IF (ITSWRT.NE.1) GO TO 860
         CALL SUPRDW (XMAPE,LWKBUF,IDT,NPDT,NXBUF,1,LENGTH,NUMERR,IERR)
         IF (IERR.EQ.0) GO TO 850
            WRITE (LP,1060)
            CALL SULINE (LP,2)
            GO TO 830
C
C  CHECK IF RUNCHECK OPTION SPECIFIED
850   IF (IRUNCK.EQ.1) GO TO 920
C
C  CREATE TIME SERIES HEADER
      CALL SUDOPN (1,'PRD ',IERR)
      CALL WPRDH (PEID,XMAPE,IDT,'MM  ',NVALX,FLTLN,BLNK8,DESC,
     *   NXBUF,XBUF,LWKBUF,IWKBUF,IREC,IERR)
      CALL SUDWRT (1,'PRD ',IERR)
      IF (IERR.NE.0) THEN
         CALL SWPRST ('WPRDH   ',PEID,XMAPE,IDT,'MM  ',BLNK8,LWKBUF,
     *      NVALX,IERR)
         IF (IERR.NE.8) GO TO 830
         ENDIF
      GO TO 870
C
860   IF (ITSWRT.NE.2) GO TO 920
C
C  CHANGE TIME SERIES HEADER
      CALL SUDOPN (1,'PRD ',IERR)
      CALL WPRDC (PEID,XMAPE,'    ',FLTLN,DESC,BLNK8,NXBUF,XBUF,
     *   LWKBUF,IWKBUF,IREC,IERR)
      CALL SUDWRT (1,'PRD ',IERR)
      IF (IERR.NE.0) THEN
         CALL SWPRST ('WPRDC   ',PEID,XMAPE,IDT,'MM  ',BLNK8,LWKBUF,
     *      NVALX,IERR)
         IF (IERR.NE.8) GO TO 830
         ENDIF
      GO TO 870
C
870   IF (TDISP.EQ.XNEW) THEN
         WRITE (LP,1280) PEID
         CALL SULINE (LP,2)
         ENDIF
      IF (TDISP.EQ.OLD) THEN
         WRITE (LP,1290) PEID
         CALL SULINE (LP,2)
         ENDIF
C
      IF (UNIT.EQ.ENGL) GO TO 890
         DO 880 I=1,12
            SWORK(ID7+I-1)=SWORK(ID3+I-1)
            SWORK(ID8+I-1)=SWORK(ID4+I-1)
880         CONTINUE
         GO TO 900
890   CALL UDUCNV ('IN  ','MM  ',1,12,SWORK(ID3),SWORK(ID7),IERR)
      CALL UDUCNV ('IN  ','MM  ',1,12,SWORK(ID4),SWORK(ID8),IERR2)
900   IF (IERR.EQ.0.AND.IERR2.EQ.0) GO TO 910
         WRITE (LP,1300)
         CALL SUERRS (LP,2,NUMERR)
         GO TO 920
C
C  WRITE PARAMETERS
910   CALL SWMAPE (IVER,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID7),
     *   SWORK(ID8),NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNSD,
     *   LARRAY,ARRAY,IPTR,TDISP,IERR)
C
C  READ PARAMETERS
      IPTR=0
      IPRERR=1
      CALL SRMAPE (IVER,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID7),
     *   SWORK(ID8),IDIM,NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNSD,
     *   LARRAY,ARRAY,IPTR,IPRERR,IPTRNX,IERR)
      IF (IERR.NE.0) GO TO 830
C
C  PRINT PARAMETERS
      IF (PRPARM.EQ.XNO) GO TO 920
      CALL SPMAPE (UNIT,IVER,PEID,DESC,CENTRD,IWT,POWER,SWORK(ID7),
     *   SWORK(ID8),NPE,SWORK(ID1),SWORK(ID5),SWORK(ID2),UNSD,IERR)
C
920   IF (NFLD.EQ.-1) GO TO 930
      IF (CHK(1).NE.XMAPE) GO TO 930
         CALL SUPCRD
         GO TO 30
C
930   WRITE (LP,1270) NMAPE,XMAPE
      CALL SULINE (LP,2)
C
C  CHECK IF ERRORS ENCOUNTERED
      IF (NERR.GT.0) ISTAT=1
C
      IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,1310) ISTAT
         CALL SULINE (IOSDBG,1)
         ENDIF
C
      RETURN
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
940   FORMAT (' *** ENTER SFMAPE')
950   FORMAT ('0*** ERROR - MAPE AREA CANNOT BE DEFINED BECAUSE ',
     *   'GENERAL USER PARAMETERS ARE NOT DEFINED.')
960   FORMAT ('0*** ERROR - INVALID DEFINE MAPE OPTION : ',5A4)
970   FORMAT ('0*** ERROR - INVALID CHARACTER IN FIELD NUMBER ',I2,'.')
980   FORMAT ('0*** NOTE - NO UNITS WERE SPECIFIED. ',
     *   A4,' UNITS ASSUMED.')
990   FORMAT (' NUMFLD=',I3,3X,'MINFLD=',I3)
1000  FORMAT ('0*** ERROR - NOT ENOUGH INPUT FIELDS PROCESSED.')
1010  FORMAT ('0*** ERROR - IN SFMAPE - THE NUMBER OF PREDETERMINED ',
     *   'STATION WEIGHTS (',I3,') EXCEEDS THE ARRAY DIMENSION (',I3,
     *   '.')
1020  FORMAT ('0*** WARNING - UNITS MUST BE ',A4,' OR ',A4,'.',
     *   A4,' UNITS ASSUMED.')
1030  FORMAT ('0*** ERROR - SYSTEM ERROR ACCESSING FILE.')
1040  FORMAT ('0*** ERROR - IN SFMAPE - DIMENSION OF PARAMETER ARRAY (',
     *   I6,') WORK SPACE EXCEEDED.')
1050  FORMAT ('0*** ERROR - MAPE PARAMETERS EXIST FOR AREA ',2A4,'.')
1060  FORMAT ('0*** NOTE - MAPE TIME SERIES HEADER CANNOT BE ',
     *   'CREATED OR CHANGED DUE TO THE ABOVE ERROR.')
1070  FORMAT ('0*** WARNING - MAPE PARAMETER RECORD FOR AREA ',2A4,
     *   ' DOES NOT EXIST. DISP ASSUMED TO BE NEW.')
1080  FORMAT ('0*** WARNING - NUMBER OF CHARACTERS IN AREA ',
     *   'DESCRIPTION (',I2,') EXCEEDS ',I2,'. THE FIRST ',I2,
     *   ' CHARACTERS WILL BE USED.')
1090  FORMAT ('0*** ERROR - BLANK DESCRIPTION NOT ALLOWED.')
1100  FORMAT ('0*** ERROR - NUMBER OF MEAN PE VALUES ENTERED IS ',I3,
     *   '. TWELVE VALUES ARE EXPECTED.')
1110  FORMAT ('0*** WARNING - MEAN PE VALUES SHOULD BE ENCLOSED IN ',
     *   'PARENTHESES.')
1120  FORMAT ('0*** WARNING - MISSING PARENTHESIS IN FIELD ',I2,'.')
1130  FORMAT ('0*** ERROR - INVALID REAL NUMBER IN FIELD ',I2,'.')
1140  FORMAT ('0*** WARNING - PREDETERMINED STATION WEIGHTS DO NOT ',
     *   'SUM TO 1.0. ACTUAL SUM =',F5.2)
1150  FORMAT ('0*** NOTE - MAPE AREA ',2A4,' NOT DEFINED OR ',
     *   'REDEFINED BECAUSE ',I2,' ERRORS ENCOUNTERED.')
1160  FORMAT ('0*** ERROR - NULL FIELD NOT ALLOWED IN FIELD ',I2,'.')
1170  FORMAT ('0*** ERROR - THE ',A,' (',F10.2,
     *   'DOES NOT FALL IN THE USER DEFINED LIMITS OF ',
     *   F8.2,' AND ',F8.2,'.')
1180  FORMAT ('0*** ERROR - IN SFMAPE - DIMENSION OF WORK ARRAY (',I6,
     *   ') EXCEEDED. ',I5,' WORDS NEEDED.')
1190  FORMAT ('0*** ERROR - INVALID STATION WEIGHT TYPE : ',A4)
1200  FORMAT ('0*** ERROR - INVALID PE STATION ID : ',2A4)
1210  FORMAT ('0*** NOTE - USER SPECIFIED DEFAULT POWER (',F5.2,
     *   ') WILL BE USED FOR 1/D**POWER WEIGHTING.')
1220  FORMAT ('0*** WARNING - NUMBER OF CHARACTERS IN AREA ',
     *   'IDENTIFIER (',I2,') EXCEEDS ',I2,'. THE FIRST ',I2,
     *   ' CHARACTERS WILL BE USED.')
1230  FORMAT ('0*** ERROR - BLANK MAPE ID IS NOT ALLOWED.')
1240  FORMAT ('0*** ERROR - THE MAPE ID (',2A4,
     *   'CONTAINS INVALID CHARACTERS.')
1250  FORMAT ('0*** ERROR - EA24 POINTER (',I3,') INVALID FOR ',
     *   'STATION ',2A4,'.')
1260  FORMAT ('0*** ERROR - STATION ',2A4,
     *   ' HAS ALREADY BEEN SPECIFIED.')
1270  FORMAT ('0*** NOTE - ',I4,' ',A4,' AREAS PROCESSED.')
1280  FORMAT ('0*** NOTE - MAPE TIME SERIES SUCCESSFULLY WRITTEN ',
     *   'FOR AREA ',2A4,'.')
1290  FORMAT ('0*** NOTE - MAPE TIME SERIES SUCCESSFULLY UPDATED ',
     *   'FOR AREA ',2A4,'.')
1300  FORMAT ('0*** ERROR - UNIT CONVERSION FOR PE VALUES ',
     *   'NOT SUCCESSFULLY OBTAINED.')
1310  FORMAT (' *** EXIT SFMAPE - ISTAT=',I2)
C
      END
