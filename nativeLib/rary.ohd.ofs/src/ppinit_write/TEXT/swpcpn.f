C MODULE SWPCPN
C-----------------------------------------------------------------------
C
C  ROUTINE TO WRITE STATION PCPN PARAMETERS.
C
      SUBROUTINE SWPCPN (IVPCPN,STAID,NUMBER,DESCRP,STATE,STALOC,
     *   STACOR,IPROC,IPTIME,MDRBOX,PCPNCF,IPTWGT,IPNTWK,IPSWGT,IPCHAR,
     *   IPD5PT,STA5WT,STASID,IPDSPT,STASWT,IPD3PT,STA3WT,
     *   UNSD,LARRAY,ARRAY,IPTR,DISP,NSPACE,
     *   IWRITE,NPOS,ISTAT)
C
      CHARACTER*1 CARCTL
      CHARACTER*4 DISP
C
      DIMENSION ARRAY(LARRAY)
C      
      INCLUDE 'scommon/dimsta'      
      INCLUDE 'scommon/dimpcpn'
C
      INCLUDE 'uio'
      INCLUDE 'scommon/sudbgx'
      INCLUDE 'scommon/suoptx'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppinit_write/RCS/swpcpn.f,v $
     . $',                                                             '
     .$Id: swpcpn.f,v 1.2 1998/04/07 18:36:07 page Exp $
     . $' /
C    ===================================================================
C
C
C
      IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,170)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
C  SET DEBUG LEVEL
      LDEBUG=ISBUG('PCPN')
C
      IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,*)
     *      ' IVPCPN=',IVPCPN,
     *      ' UNSD=',UNSD,
     *      ' LARRAY=',LARRAY,
     *      ' '
         CALL SULINE (IOSDBG,1)
         ENDIF
C
      ISTAT=0
C
      IF (IWRITE.EQ.-1) GO TO 150
C
C  CHECK FOR SUFFICIENT SPACE IN PARAMETER ARRAY
      IF (IPTIME.LT.24) MINLEN=87
      IF (IPTIME.EQ.24) MINLEN=63
      IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,*) ' MINLEN=',MINLEN
         CALL SULINE (IOSDBG,1)
         ENDIF
      IF (MINLEN.GT.LARRAY) THEN
         WRITE (LP,180) LARRAY,MINLEN
         CALL SUERRS (LP,2,NUMERR)
         ISTAT=1
         GO TO 160
         ENDIF
C
      NPOS=0
C
C  STORE PARAMETER ARRAY VERSION NUMBER
      NPOS=NPOS+1
      ARRAY(NPOS)=IVPCPN+.01
C
C  STORE STATION IDENTIFIER
      NCHAR=4
      NWORDS=LEN(STAID)/NCHAR
      NCHK=2
      IF (NWORDS.NE.NCHK) THEN
         WRITE (LP,185) 'STAID',NWORDS,NCHK,STAID
         CALL SUERRS (LP,2,-1)
         ISTAT=1
         GO TO 160
         ENDIF
      DO 35 I=1,NWORDS
         NPOS=NPOS+1
         N=(I-1)*NCHAR+1
         CALL SUBSTR (STAID(N:N),1,4,ARRAY(NPOS),1)
35       CONTINUE 
C
C  STORE USER SPECIFIED STATION NUMBER
      NPOS=NPOS+1
      ARRAY(NPOS)=NUMBER+.01
C
C  STORE DESCRIPTIVE INFORMATION
      NCHAR=4
      NWORDS=LEN(DESCRP)/NCHAR
      NCHK=5
      IF (NWORDS.NE.NCHK) THEN
         WRITE (LP,185) 'DESCRP',NWORDS,NCHK,STAID
         CALL SUERRS (LP,2,-1)
         ISTAT=1
         GO TO 160
         ENDIF
      DO 10 I=1,NWORDS
         NPOS=NPOS+1
         N=(I-1)*NCHAR+1
         CALL SUBSTR (DESCRP(N:N),1,NCHAR,ARRAY(NPOS),1)
10       CONTINUE
C
C   STORE LOCATION (LAT/LONG IN DECIMAL DEGREES)
      DO 20 I=1,2
         NPOS=NPOS+1
         ARRAY(NPOS)=STALOC(I)
20       CONTINUE
C
C  STORE NWSRFS/HRAP COORDINATES
      DO 30 I=1,2
         NPOS=NPOS+1
         ARRAY(NPOS)=STACOR(I)
30       CONTINUE
C
C  STORE PROCESSING CODE
      NPOS=NPOS+1
      ARRAY(NPOS)=IPROC+.01
C
C  STORE DATA TIME INTERVAL (HOURS)
      NPOS=NPOS+1
      ARRAY(NPOS)=IPTIME+.01
C
C  STORE MDR BOX ASSIGNED TO THIS STATION
      NPOS=NPOS+1
      ARRAY(NPOS)=MDRBOX+.01
C
C  STORE PRECIPITATION CORRECTION FACTORS
      DO 40 I=1,2
         NPOS=NPOS+1
         ARRAY(NPOS)=PCPNCF(I)
40       CONTINUE
C
C  STORE TYPE OF 24 HOUR PRECIPITATION WEIGHTS
      NPOS=NPOS+1
      ARRAY(NPOS)=IPTWGT+.01
C
C  STORE NETWORK INDICATOR
      NPOS=NPOS+1
      ARRAY(NPOS)=IPNTWK+.01
      IF (IPNTWK.LT.0) ARRAY(NPOS)=IPNTWK-.01
C
C  STORE INDICATOR WHETHER STATION IS TO BE USED FOR WEIGHTING
      NPOS=NPOS+1
      ARRAY(NPOS)=IPSWGT+.01
C
C  STORE STATE IDENTIFIER
      NPOS=NPOS+1
      ARRAY(NPOS)=STATE
C
C  STORE ARRAY LOCATION OF CHARACTERISTICS FOR THIS STATION
      NPOS=NPOS+1
      ARRAY(NPOS)=IPCHAR+.01
      IF (IPCHAR.LT.0) ARRAY(NPOS)=IPCHAR-.01
C
      IF (IPTWGT.GT.0) GO TO 70
C
C  STORE ARRAY LOCATION OF POINTERS FOR 24 HOUR PCPN DATA FOR 5
C  CLOSEST STATIONS IN EACH QUADRANT
      DO 50 I=1,4
         DO 50 J=1,5
            NPOS=NPOS+1
            ARRAY(NPOS)=IPD5PT(J,I)+.01
            IF (IPD5PT(J,I).LT.0) ARRAY(NPOS)=IPD5PT(J,I)-.01
50       CONTINUE
C
C  STORE STATION WEIGHTS OF 5 CLOSEST 24 HOUR PCPN STATIONS IN
C  EACH QUADRANT
      DO 60 I=1,4
         DO 60 J=1,5
            NPOS=NPOS+1
            ARRAY(NPOS)=STA5WT(J,I)
60       CONTINUE
      GO TO 110
C
C  STORE IDENTIFIERS OF STATIONS WITH SIGNIFICANCE WEIGHTS
70    NCHAR=4
      NWORDS=LEN(STASID(1))/NCHAR
      NCHK=2
      IF (NWORDS.NE.NCHK) THEN
         WRITE (LP,185) 'STASID',NWORDS,NCHK,STAID
         CALL SUERRS (LP,2,-1)
         ISTAT=1
         GO TO 160
         ENDIF
      DO 80 I=1,MSTASID
         DO 75 J=1,NWORDS
            NPOS=NPOS+1
            N=(J-1)*NCHAR+1
            CALL SUBSTR (STASID(I)(N:N),1,NCHAR,ARRAY(NPOS),1)
75          CONTINUE            
80       CONTINUE
C
C  STORE ARRAY LOCATIONS OF POINTERS FOR PCPN DATA FOR STATION
      DO 90 I=1,MSTASID
         NPOS=NPOS+1
         ARRAY(NPOS)=IPDSPT(I)+.01      
         IF (IPDSPT(I).LT.0) ARRAY(NPOS)=IPDSPT(I)-.01
90       CONTINUE
C
C  STORE WEIGHTS FOR STATIONS
      DO 100 I=1,MSTASID
         NPOS=NPOS+1
         ARRAY(NPOS)=STASWT(I)
         IF (STASWT(I).LT.0.0) ARRAY(NPOS)=STASWT(I)-.01
100      CONTINUE
C
110   IF (IPTIME.EQ.24) GO TO 140
C
C  STORE ARRAY LOCATION OF POINTERS FOR <24 HOUR PCPN DATA FOR 3
C  CLOSEST STATIONS IN EACH QUADRANT
      DO 120 I=1,4
         DO 120 J=1,3
            NPOS=NPOS+1
            ARRAY(NPOS)=IPD3PT(J,I)+.01
            IF (IPD3PT(J,I).LT.0) ARRAY(NPOS)=IPD3PT(J,I)-.01
120      CONTINUE
C
C  STORE WEIGHTS FOR < 24 HOUR STATIONS
      DO 130 I=1,4
         DO 130 J=1,3
            NPOS=NPOS+1
            ARRAY(NPOS)=STA3WT(J,I)
130      CONTINUE
C
140   IF (IWRITE.EQ.0) GO TO 160
C
C  OPEN DATA BASE
150   CALL SUDOPN (1,'PPP ',IERR)
      IF (IERR.NE.0) THEN
         ISTAT=1
         GO TO 160
         ENDIF
C
C  WRITE PARAMTER RECORD TO FILE
      IF (LDEBUG.GT.0) THEN
         WRITE (IOSDBG,*) 'NPOS=',NPOS
         CALL SULINE (IOSDBG,1)
         ENDIF
      IPTR=0
      CALL WPPREC (STAID,'PCPN',NPOS,ARRAY,IPTR,IERR)
      IF (IERR.NE.0) THEN
         CALL SWPPST (STAID,'PCPN',NPOS,IPTR,IERR)
         WRITE (LP,190) IERR
         CALL SUERRS (LP,2,NUMERR)
         ISTAT=3
         ENDIF
C
      IF (ISTAT.GT.0) THEN
         IF (DISP.EQ.'NEW') THEN
            WRITE (LP,220) 'WRITTEN',STAID
            CALL SULINE (LP,2)
            ENDIF
         IF (DISP.EQ.'OLD') THEN
            WRITE (LP,220) 'UPDATED',STAID
            CALL SULINE (LP,2)
            ENDIF
         GO TO 160
         ENDIF
C
      IF (LDEBUG.GT.0) CALL SUPDMP ('PCPN','BOTH',0,NPOS,ARRAY,ARRAY)
C
      CALL SUDWRT (1,'PPP ' ,IERR)
C
C  CHECK MESSAGE LEVEL VALUE
      IF (IOPMLV.GT.1) THEN
         CARCTL=' '
         NULINE=1
         IF (NSPACE.EQ.1) THEN
            CARCTL='0'
            NULINE=2
            ENDIF
         IF (DISP.EQ.'NEW') THEN
            WRITE (LP,200) CARCTL,'WRITTEN',STAID
            CALL SULINE (LP,NULINE)
            ENDIF
         IF (DISP.EQ.'OLD') THEN
            WRITE (LP,200) CARCTL,'UPDATED',STAID
            CALL SULINE (LP,NULINE)
            ENDIF
         ENDIF
C
160   IF (ISTRCE.GT.0) THEN
         WRITE (IOSDBG,240)
         CALL SULINE (IOSDBG,1)
         ENDIF
C
      RETURN
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
170   FORMAT (' *** ENTER SWPCPN')
180   FORMAT ('0*** ERROR - IN SWPCPN - NOT ENOUGH SPACE IN PARAMETER ',
     *   'ARRAY: NUMBER OF WORDS IN PARAMETER ARRAY=',I5,3X,
     *   'NUMBER OF WORDS NEEDED=',I5)
185   FORMAT ('0*** ERROR - IN SWSTAN - NUMBER OF WORDS IN VARIABLE ',
     *   A,'(',I2,') IS NOT ',I2,' FOR STATION ',A,'.')
190   FORMAT ('0*** ERROR - IN SWPCPN - UNSUCCESSFUL CALL TO WPPREC : ',
     *   'STATUS CODE=',I3)
200   FORMAT (A,'*** NOTE - PCPN PARAMETERS SUCCESSFULLY ',A,' ',
     *   'FOR STATION ',A,'.')
220   FORMAT ('0*** NOTE - PCPN PARAMETERS NOT SUCCESSFULLY ',A,' ',
     *   'FOR STATION ',A)
240   FORMAT (' *** EXIT SWPCPN')
C
      END
