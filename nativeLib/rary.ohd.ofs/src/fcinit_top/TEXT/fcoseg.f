C MODULE FCFCOSEG
C-----------------------------------------------------------------------
C
C                             LAST UPDATE: 08/14/95.13:38:21 BY $WC21DT
C
C
C @PROCESS LVL(77)
C
C
      SUBROUTINE FCOSEG(INSEG,NDAZE,IDAY,ISHR,IER)
C
C
C DESC - PUTS DATES FOR INDIVIDUAL SEGMENTS ON CARRYOVER FILE.
C
C
C
C  FCOSEG IS SIMILAR TO CGDSEG IN DATING CARRYOVER FOR SEGMENTS.
C  IN FCOSEG, HOWEVER, A SEGMENT BELONGING TO A CARRYOVER GROUP CAN
C  NOT BE DATED BY THIS SUB.(I.E. - BY THE 'SEGDATE' COMMAND)
C
C
C
C  ROUTINE ORRIGINALLY WRITTEN BY --
C    JOE OSTROWSKI -- HRL -- 800723
C
C
C
      INCLUDE 'common/where'
      INCLUDE 'common/errdat'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fc'
      INCLUDE 'common/fd'
      INCLUDE 'common/oldc'
      INCLUDE 'common/oldp'
      INCLUDE 'common/oldt'
      INCLUDE 'common/oldts'
      INCLUDE 'common/fp'
      INCLUDE 'common/resetc'
      INCLUDE 'common/ft'
      INCLUDE 'common/fts'
      INCLUDE 'common/fcsegc'
      INCLUDE 'common/fcsegn'
      INCLUDE 'common/fcunit'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fccgd'
C
      DIMENSION SUBNAM(2),INSEG(2),OLDSUB(2),MOVETO(20)
      DIMENSION IDAY(1),ISHR(1)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcinit_top/RCS/fcoseg.f,v $
     . $',                                                             '
     .$Id: fcoseg.f,v 1.3 1997/06/24 19:50:34 page Exp $
     . $' /
C    ===================================================================
C
C
      DATA SUBNAM,SEGD,BUFW/4HFCOS,4HEG  ,4HSEGD,4HBUFW/
      DATA NADA/4H    /
C
C  SET WHERE AND BEBUG INFO.
C
      IBUG=0
      IF (IFBUG(SEGD).EQ.1) IBUG=1
      IF (IFBUG(BUFW).EQ.1) IBUG=2
C
      DO 10 I=1,2
      OLDSUB(I) = OPNAME(I)
      OPNAME(I) = SUBNAM(I)
10    CONTINUE
      IOLDOP = IOPNUM
      IOPNUM = 0
C
      IF (IBUG.GE.1) WRITE (IODBUG,20)
20    FORMAT(23H   *** ENTER FCOSEG ***)
C
      CALL FLOCSG(INSEG,IRSEG)
      IF (IRSEG.GT.0) GO TO 40
C
      WRITE (IPR,30) INSEG
30    FORMAT('0**ERROR** - SEGMENT ',2A4,20H COULD NOT BE FOUND.)
      IER = 1
      CALL ERROR
      GO TO 340
C
40    CONTINUE
      IF (IDSEGN(1).NE.INSEG(1).OR.IDSEGN(2).NE.INSEG(2)) GO TO 50
      GO TO 70
C
50    CALL FGETSG(INSEG,IRSEG,0,X,0,X,0,X,1,1,IER)
      IF (IER.EQ.0) GO TO 70
      WRITE (IPR,60) INSEG
60    FORMAT('0**ERROR** - SEGMENT ',2A4,23H COULD NOT BE READ FROM,
     .  11H THE FILES.)
C
70    CONTINUE
      IF (ICGID(1).EQ.NADA.AND.ICGID(2).EQ.NADA) GO TO 90
C
      WRITE (IPR,80) INSEG,ICGID
80    FORMAT('0**ERROR** - ONLY SEGMENTS NOT BELONGING TO CARRYOVER'
     .,07H GROUPS/22X,40HCAN BE DATED WITH THE 'SEGDATE' COMMAND./
     . 22X,08HSEGMENT ,2A4,28H BELONGS TO CARRYOVER GROUP ,2A4,02H .)
      CALL ERROR
      IER=1
      GO TO 340
C
90    CONTINUE
      CALL FCDATE(INSEG,0)
      NUMDAT=0
      DO 110 I=1,NSLOTS
      IF (ICDAYC(I).GT.0) NUMDAT=NUMDAT+1
C..........................
C  DON'T DATE SEGMENT IF ANY SLOT IS INCOMPLETE
C
      IF (INCSEG(I).EQ.1) GO TO 110
      WRITE (IPR,100) I,IDSEGN
100   FORMAT('0**ERROR**'/22X,'SLOT NO.',I3,' FOR SEGMENT ',
     .2A4,' IS INCOMPLETE.'/22X,'SEGMENT WILL NOT BE DATED.')
      CALL ERROR
      GO TO 340
110   CONTINUE
C
      DO 120 I=1,NDAZE
120   MOVETO(I)=I
C
C  NOTE-IF ALL EXISTING DAYS AR INIT AL VALUES, THEN CAN USE SAME
C       SLOTS TO DEFINE NEW DATES.
C
      IF (NUMDAT.EQ.0) GO TO 170
C
C  DEFINE MOVETO ARRAY
C
      DO 160 IDAZE=1,NDAZE
      ICLOSE=0
      NHCLOS=1000000000
      DO 130 I=1,NSLOTS
      IF (ICDAYC(I).LT.1) GO TO 130
      NH=24*(IDAY(IDAZE)-ICDAYC(I)) + (ISHR(IDAZE)-ICHRC(I))
      IF (IABS(NH).GE.NHCLOS) GO TO 130
      NHCLOS=IABS(NH)
      ICLOSE=I
130   CONTINUE
      IF (ICLOSE.GT.0) GO TO 150
      WRITE (IPR,140)IDSEGN,(ICDAYC(I),ICHRC(I),I=1,NSLOTS)
140   FORMAT('0**ERROR** UNABLE TO DEFINE MOVETO ARRAY IN ',
     .       30HSUBROUTINE FCOSEG FOR SEGMENT ,2A4,/,1H ,10X,
     .       50HLIST OF CARRYOVER DAYS AND HOURS FOR SEGMENT IS --,/,
     .  1H ,10(I8,1X,I3,1X),/,1H ,10(I8,1X,I3,1X))
      CALL ERROR
      GO TO 340
150   MOVETO(IDAZE)=ICLOSE
160   CONTINUE
C
C  MOVETO ARRAY NOW DEFINED - CALL CSRSET TO INITIALIZE CARRYOVER
C  SORT ROUTINES.  NOTE THAT CARRYOVER SORTING IS NOT NEEDED IF
C  ONLY ONE DAY OF CARRYOVER IS TO BE DEFINED(NDAZE.EQ.1) OR IF
C  ALL EXISTING CARRYOVER IS UNDATED(NUMDAT.EQ.0)
C
170   IF (IBUG.LT.1) GO TO 200
      WRITE (IODBUG,180)NSLOTS,NDAZE,NUMDAT
180   FORMAT(35H --IN FCOSEG, NSLOTS,NDAZE,NUMDAT =,3I5,/,
     .  1H ,10H    MOVETO,10H    ICDAYC,5X,5HICHRC,4X,4HIDAY,
     .  4X,4HISHR)
      WRITE (IODBUG,190)(MOVETO(I),ICDAYC(I),ICHRC(I),IDAY(I),
     .ISHR(I),I=1,NSLOTS)
190   FORMAT(1H ,5I10)
200   IF (NUMDAT.EQ.0.OR.NDAZE.EQ.1) GO TO 300
      CALL CSRSET (C,NC,ISLOT,NDAZE,NARAYS,D,MD,P,MP,OLDP,MOLDP,TS,MTS,
     .  OLDTS,MOLDTS,T,MT,OLDT,MOLDT,OLDC,MOLDC,RESETC,MRSTC,
     .  ARAY10,0,IER)
      IF (IER.EQ.0) GO TO 220
      WRITE (IPR,210)
210   FORMAT(53H0 SUBROUTINE FCOSEG TERMINATED DUE TO ERROR IN CSRSET)
      GO TO 340
C
C  READY TO PUT EXISTING CARRYOVER ARRAYS INTO PROPER POSITIONS
C  IN INTERNAL SORTING PACKAGE
C
220   DO 240 IDAZE=1,NDAZE
      ISLOT=MOVETO(IDAZE)
      CALL FGETCO (IDSEGN,ICDAYC(ISLOT),ICHRC(ISLOT),C,MC,'ERROR',IRR)
      CALL CSAVE (C,NC,IDAZE,NDAZE,NARAYS,D,MD,P,MP,OLDP,MOLDP,TS,MTS,
     .  OLDTS,MOLDTS,T,MT,OLDT,MOLDT,OLDC,MOLDC,RESETC,MRSTC,
     .  ARAY10,0,IER)
      IF (IER.EQ.0) GO TO 240
      WRITE (IPR,230)
230   FORMAT(52H0 SUBROUTINE FCOSEG TERMINATED DUE TO ERROR IN CSAVE)
      GO TO 340
240   CONTINUE
C
C  NOW CARRYOVER FOR THE NDAZE REQUIRED DAYS IS SORTED INTO SLOTS
C  1 TO NDAZE IN THE INTERNAL SORT ROUTINES.  TIME TO RETRIEVE IT
C  AND MOVE IT TO FILE.
C
      WRITE (IPR,250) IDSEGN
250   FORMAT(1H0,6X,45H*** BEGINNING FILE UPDATE FOR DATING SEGMENT ,
     . 2A4)
      DO 280 IDAZE=1,NDAZE
      CALL CRETRV (C,NC,IDAZE,NDAZE,NARAYS,D,MD,P,MP,OLDP,MOLDP,TS,MTS,
     .  OLDTS,MOLDTS,T,MT,OLDT,MOLDT,OLDC,MOLDC,RESETC,MRSTC,
     .  ARAY10,0,IER)
      IF (IER.EQ.0) GO TO 270
      WRITE (IPR,260)
260   FORMAT(53H0 SUBROUTINE FCOSEG TERMINATED DUE TO ERROR IN CRETRV)
      GO TO 340
270   CONTINUE
      CALL FPUTCO (IDSEGN,IDAY(IDAZE),ISHR(IDAZE),NOW,IDAZE,
     .  IWOCRY,C,NC,1)
280   CONTINUE
      WRITE (IPR,290)
290   FORMAT(8X,46H*** SUCCESSFUL FILE UPDATE FOR SEGMENT DATING.,/)
      GO TO 350
C
C  THIS SECTION USED WHEN CARRYOVER SORTING NOT NEEDED
C
300   WRITE (IPR,250) IDSEGN
      DO 330 IDAZE=1,NDAZE
      ISLOT=MOVETO(IDAZE)
      CALL FGETCO (IDSEGN,ICDAYC(ISLOT),ICHRC(ISLOT),C,NC,'ERROR',IRR)
      NE1=NERRS
      CALL FPUTCO (IDSEGN,IDAY(IDAZE),ISHR(IDAZE),NOW,IDAZE,
     .  IWOCRY,C,NC,1)
      IF (IBUG.GE.1) WRITE (IODBUG,310) NE1,NERRS
310   FORMAT(4X,10H*** NE1 = ,I2,13H  ** NERRS = ,I2)
      IF (NERRS.GT.NE1) GO TO 330
      ICDAYC(ISLOT) = IDAY(IDAZE)
      ICHRC(ISLOT) = ISHR(IDAZE)
      IF (IBUG.GE.1) WRITE (IODBUG,320) (IM,ICDAYC(IM),IM,ICHRC(IM),IM=1
     .,NDAZE)
320   FORMAT(4X,21H** COMMON /FCSEGC/ **,/(5X,07HICDAYC(,I2,04H) = ,I6,
     .    06HICHRC(,I2,04H) = ,I2/))
330   CONTINUE
      WRITE (IPR,290)
      GO TO 350
C
340   IER=1
      GO TO 360
C
350   IER=0
360   CONTINUE
      IF (IBUG.GE.1) WRITE (IODBUG,370)
370   FORMAT(22H   *** EXIT FCOSEG ***)
      OPNAME(1) =OLDSUB(1)
      OPNAME(2) = OLDSUB(2)
      IOPNUM = IOLDOP
C
      RETURN
      END
