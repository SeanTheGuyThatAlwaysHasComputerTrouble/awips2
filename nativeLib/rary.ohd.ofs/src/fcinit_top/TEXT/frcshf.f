C MEMBER FRCSHF
C  (from old member FCFRCSHF)
C
C @PROCESS LVL(77)
C
       SUBROUTINE FRCSHF(FACVOL,STAGE)
C                             LAST UPDATE: 10/27/94.11:18:13 BY $WC30KH
C
C
C SUBROUTINE TO CHECK MIN STAGE AND COMPUTE SHIFT FACTOR RATING CURVE
C   MEANT TO BE CALLED FROM FDEFRC AFTER EVERYTHING DEFINED AND
C   CONVERTED TO METRIC (SO ONLY UNITS CONVERSION HERE IS FOR PRINTING)
C
C AUTHOR  ED VANBLARGAN - HRL - JUNE,1983
C  MODIFIED 11/87 FOR USGS OFFSET
C
C ARGUMENT LIST:
C FACVOL - INPUT - DISCHARGE CONVERSION FACTOR
C STAGE  - IN    - WORK SPACE ARRAY
C
      DIMENSION STAGE(*)
      INCLUDE 'common/fratng'
C
      INCLUDE 'common/fdbug'
C
      INCLUDE 'common/ionum'
C
      EQUIVALENCE(HSMIN,EMPTY(3))
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcinit_top/RCS/frcshf.f,v $
     . $',                                                             '
     .$Id: frcshf.f,v 1.1 1995/09/17 18:55:05 dws Exp $
     . $' /
C    ===================================================================
C
      DATA RTCV/4HRTCV/,FT,AM/3H FT,3H M./
C
C INITIALIZE VALUES
C
      SHIFT=0.00
      IONE=1
      IBUG=IFBUG(RTCV)
      UNIT=AM
      FACLEN=FACVOL**3
      STGMPR=STGMIN*FACLEN
      IF (FACVOL.NE.1.0) UNIT=FT
C
C  INITIALIZE VALUES FOR NEW EJV SHIFT
C
C  HSMIN - STAGE BELOW WHICH SHIFT GETS APPLIED (EMPTY(3))
C  HPOS  - LOWEST POSITIVE XRC STAGE
C  HFMIN - MINIMUM STAGE TO WHICH A USGS OFFSET IS APPLIED
      HSMIN=0
      HFMIN=99999999.
      LXOFF=EMPTY(2)
      IF (LXOFF.GT.0) HFMIN=XRC(LXOFF+1)
      DO 2300 I=1,NRCPTS
        HPOS=XRC(LOCH+I-1)
        IF (HPOS.GT.0.0) GO TO 2305
2300  CONTINUE
2305  CONTINUE
C
C CHECK IF MINIMUM STAGE ALLOWED IS LE 1ST INPUT STAGE
C
      IF (STGMIN.LE.XRC(LOCH)) GO TO 3100
      WRITE(IPR,8175) STGMPR,UNIT,XRC(LOCH),UNIT
      CALL WARN
      STGMIN=XRC(LOCH)
C
C
C CHECK RATING CURVE FOR TYPE OF EXTENSION USED AT LOWER END.
C   CAN EITHER BE LINEAR OR LOG-LOG EXTENSION
C   IF LOG-LOG EXTENSION IS USED. THEN, MAY NEED TO SHIFT RATING
C      CURVE STAGES TO ASSURE NO NEGATIVE STAGES EXIST FOR LOG
C      EXTRAPOLATION.
C FIRST CHECK IF ZERO FLOW POINT DEFINED, THEN GO THRU
C AND SEE IF SHIFT IS NEEDED.
C
3100  H1=XRC(LOCH)
      Q1=XRC(LOCQ)
      IF (Q1.GT.0.0) GO TO 4700
C
C ZERO FLOW POINT IS DEFINED.
C
C   CHECK IF STGMIN IS LESS THAN ZERO FLOW STA
      IF (STGMIN.GE.H1) GO TO 4600
      HPR=H1*FACLEN
      WRITE(IPR,8215) STGMPR,UNIT,HPR,UNIT
      CALL WARN
      STGMIN=H1
C
C CHECK IF ZERO FLOW STAGE (H1) IS .GT. ZERO
C   OR IF GT LOWSET USGS OFFSET STAGE...IF SO NO SHIFT NEEDED
4600  CONTINUE
      HSMIN=H1
      IF (H1.GT.0.0 .OR. H1.GT.HFMIN) GO TO 5490
C SHIFT IS NEEDED FOR INTERPOLATN, SET = TO 0.01 - ZERO FLOW STAGE(H1)
      IF(EMPTY(4) .GT. 1.0) GO TO 5490
      SHIFT=0.01-H1
      HSMIN=AMIN1(HPOS,HFMIN)
      GO TO 5490
C
C ZERO FLOW POINT NOT DEFINED
C DETERMINE SHIFT NEEDED, IF ANY.
4700  IF (STGMIN.LE.0.0 .OR. XRC(LOCH).LE.0.0) GO TO 5210
C
C  NO SHIFT NEEDED CAUSE RC STAGE AND STGMIN ARE ALL POSITIVE
      SHIFT=0.00
      GO TO 5300
C
C  SHIFT IS NEEDED CAUSE 1ST RC STAGE OR STGMIN IS (-)
5210  CONTINUE
      IF(EMPTY(4) .GT. 1.0) GO TO 5300
      SHIFT=0.01-AMIN1(STGMIN,XRC(LOCH))
      HSMIN=AMIN1(HPOS,HFMIN)
C
C  FIGURE OUT STAGE AT 0 FLOW
5300  CONTINUE
      QZERO=0.0001
      STAGE(1)=XRC(LOCH)+SHIFT
      STAGE(2)=XRC(LOCH+1)+SHIFT
      CALL FXTRPL(QZERO,XRC(LOCQ),IONE,STAGE,HZERO,IBUG)
      HZERO=HZERO-SHIFT
      IF (SHIFT.EQ.0.0) HSMIN=HZERO
C
C CHECK THAT MIN STAGE IS .GE. ZERO FLOW STAGE
      IF (STGMIN.GE.HZERO) GO TO 5490
      HPR=HZERO*FACLEN
      WRITE(IPR,8215) STGMPR,UNIT,HPR,UNIT
      CALL WARN
      STGMIN=HZERO
C
C ALL DONE
C............DEBUG TIME.................................................
5490  IF(IBUG.GT.0) WRITE(IODBUG,8988) STGMIN,SHIFT
C.......................................................................
C
      IF(ITRACE.GE.1) WRITE(IODBUG,602)
  602 FORMAT(/'  *** EXIT FRCSHF **')
      RETURN
C
C ** FORMATS **
8175  FORMAT(1H0,10X,37H**WARNING** MINIMUM ALLOWABLE STAGE =,F10.2,A3,
     * 49H, AND IS GREATER THAN LOWEST RATING CURVE STAGE =,F10.2,A3 /
     * 11X,'WILL RESET MIN STAGE ALLOWED TO LOWEST RATING CURVE ',
     *     'STAGE.')
C
8195  FORMAT(1H0,10X,36H**WARNING** MINIMUM ALLOWABLE STAGE=,F10.2,A3,
     * 35H DIFFERS FROM CHANNEL INVERT STAGE=,F10.2,A3
     * / 11X,47HWILL RESET MIN STAGE ALLOWED TO CHANNEL INVERT.)
C
C
8215  FORMAT(1H0,10X,36H**WARNING** MINIMUM ALLOWABLE STAGE=,F10.2,A3,
     * ' PRODUCES A FLOW LESS THAN ZERO.',
     * /25X,'RESET MIN STAGE TO ',F10.2,A3)
C
8988  FORMAT(1X,13HSTGMIN,SHIFT=,2F10.2)
C
      END
