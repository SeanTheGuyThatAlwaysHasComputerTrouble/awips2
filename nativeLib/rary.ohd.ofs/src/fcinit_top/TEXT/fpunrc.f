C MEMBER FPUNRC
C  (from old member FCFPUNRC)
C-----------------------------------------------------------------------
C
C                             LAST UPDATE: 10/11/95.13:44:06 BY $WC21DT
C
C @PROCESS LVL(77)
C
C  DESC -- READS AND PUNCHES RATING CURVE DATA FROM FILE
C...................................................................
C
       SUBROUTINE FPUNRC
C
C......................................................................
C
C  SUBROUTINE FPUNRC READS DATA CARDS LISTING I.D.'S OF RATING CURVE
C  RECORDS THAT ARE TO BE PUNCHED AND DETERMINES THE FILE LOATION FOR
C   EACH CURVE (ID=RCIDEN(I)) BY CALLING SUBROUTINE FINDRC.  SUB-
C   ROUTINE FCRDRC IS THEN CALLED TO MOVE THE DATA FROM THE FILE TO
C   /FRATNG/.  THEN SUBROUTINE FPURC IS CALLED TO PUNCH THAT DATA.
C  ** NOTE **  IN CALIBRATION PROGRAM, THIS SUBROUTINE IS NOT USED
C
C
C.....................................................................
C
C  SUBROUTINE ORIGINALLY WRITTEN BY --
C      JOE OSTROWSKI - HRL - JUNE 1984
C  CHANGED TO ALLOW 100 ITEMS IN LIST TO RDLIST
C     GEORGE F. SMITH -- HRL -- 3/28/86
C
C....................................................................
C
      INCLUDE 'common/fprog'
      INCLUDE 'common/fratng'
      INCLUDE 'common/frcptr'
      INCLUDE 'common/frcfil'
      INCLUDE 'common/fcunit'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/errdat'
      INCLUDE 'common/where'
      INCLUDE 'common/fctime'
C
      CHARACTER*80 IBUF,NCARD(30),WORD
      CHARACTER*10 XCOMD(7)
C
      DIMENSION SUBNAM(2),OLDSUB(2),RTCVNM(2),
     .ALIST(5,100),UNITS(4)
      DIMENSION NAME(2),NUMC(100),RLIST(5,100)
      LOGICAL PRTALL
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcinit_top/RCS/fpunrc.f,v $
     . $',                                                             '
     .$Id: fpunrc.f,v 1.3 2002/02/11 20:20:24 dws Exp $
     . $' /
C    ===================================================================
C
      DATA RTCV,SUBNAM/4HRTCV,4HFPUN,4HRC  /,NAME/4HPUNC,4HHRC /
      DATA BLANK/4H    /
      DATA OBSO,OLETE/4HOBSO,4HLETE/
      DATA NCOMD/7/
      DATA XCOMD/'IDENTIFIER','IDS','ID','I','UNITS','U','ALLRC'/
C
      DATA UNITS/4HENGL,4HE   ,4HMETR,4HM   /
C
C  SET /WHERE/ INFO
C
      DO 10 I=1,2
      OLDSUB(I) = OPNAME(I)
10    OPNAME(I) = SUBNAM(I)
      IOLDOP = IOPNUM
      IOPNUM = -1
C
      IF (IFBUG(RTCV).EQ.1) IBUG = 1
C
      IF (ITRACE.GE.1) WRITE(IODBUG,20)
20    FORMAT(1H ,21H *** ENTER FPUNRC ***)
C
C  PRINT HEADING
C
      WRITE(IPR,30)
30    FORMAT(1H1,//,1X,80(1H*)/2H *,78X,1H*,/1X,1H*,29X,20HRATING CURVE
     1PUNCH  ,29X,1H*,/2H *,78X,1H*/1X,80(1H*),///)
C
C......................
C  READ ALL INPUT RECORDS FOR PUNCHRC COMMAND
C
      CALL CDINPT(NCARD,30,LASTCD,NAME,IERC)
      IF (IERC.GT.0) GO TO 350
C
      IF (LASTCD.EQ.0) GO TO 220
      OPTN = BLANK
      PRTALL = .FALSE.
      NVAR = 2
      ICARD = 0
      NUMRC = 0
C
40    ICARD = ICARD+1
      IF (ICARD.GT.LASTCD) GO TO 200
C
C................................
C  FUNPAK TAKES A CARD IN 20A4 FORMAT AND CONVERTS IT TO AN 80A1 FORMAT
C  FNEXT FINDS THE NEXT CHARACTER STRING ON A CARD (DELIMITED BY BLANKS
C   OR COMMAS).
C
      CALL UMEMOV (NCARD(ICARD),IBUF,20)
C
      CALL USCAN2 (IBUF,' ',1,WORD,LWORD,IERR)
C
      IF (IBUG.GE.1) WRITE(IODBUG,60) WORD
60    FORMAT(' NEXT FIELD = ',A)
      IF (WORD.EQ.'$') GO TO 40
C
C.............................
C  THE FUNCTION IFKYVL TRIES TO MATCH A CHARACTER STRING WITH AN ITEM
C  IN A LIST OF KEYWORDS.
C
C   IF IDEST = 0, NO MATCH FOUND
C            = 1,2,3,4,5,6, A LIST OF VALUES IS TO BE READ,
C            = 7, ALL NON-OBSOLETE RATING CURVES ARE TO BE PUNCHED,
C
      IDEST=0
      DO 65 L=1,NCOMD
         IF (WORD.EQ.XCOMD(L)) IDEST=L
65    CONTINUE
      IF (IBUG.GE.1) WRITE(IODBUG,70) IDEST
70    FORMAT(10H  IDEST = ,I2)
C
      ID = IDEST+1
      GO TO (330,80,80,80,80,80,80,180),ID
C
C................................
C  LIST OF ITEMS IS TO BE READ
C
80    CONTINUE
      CALL UMEMOV(NCARD(ICARD),IBUF,20)
C
C............................
C  READ LIST OF EITHER RC IDENTIFIERS OR UNITS SPECIFICATION
C
      CALL RDLIST(ICARD,LASTCD,NCARD,ALIST,NLIST,NVAR,NUMC,IERC)
      IF (IERC.GT.0) GO TO 350
      IF (NLIST.EQ.0) GO TO 40
      IF (IDEST.LE.4) GO TO 90
      GO TO 120
C
C.................................
C  LIST OF ID'S FOUND
C
90    CONTINUE
      NUMRC = NLIST
      DO 100 I=1,NUMRC
      RLIST(1,I) = ALIST(1,I)
100   RLIST(2,I) = ALIST(2,I)
      IF (IBUG.GE.1) WRITE(IODBUG,110) ((ALIST(I,J),I=1,2),J=1,NLIST)
110   FORMAT(42H  ** LIST OF RC IDENTIFIERS TO BE PUNCHED:/6(4X,2A4))
      GO TO 40
C
C........................................
C  'UNITS' SUBCOMMAND FOUND
C
120   CONTINUE
      IF (IBUG.GE.1) WRITE(IODBUG,130) (ALIST(I,1),I=1,2)
130   FORMAT(33H 'UNITS' SUBCOMMAND FOUND. ID IS ,2A4)
C
      DO 140 I=1,4
      IF (ALIST(1,1).EQ.UNITS(I)) GO TO 160
140   CONTINUE
C......................
C  NO VALID UNITS ID FOUND
      WRITE(IPR,150) ALIST(1,1),ALIST(2,1)
150   FORMAT('0**WARNING**',/22X,16HTHE UNITS TYPE ',2A4,
     . 22H' IS NOT A VALID CODE./22X,28HIT SHOULD BE EITHER 'METRIC',
     .13H OR 'ENGLISH',12H OR 'BLANK'.,/22X,27HDEFAULT UNITS WILL BE USE
     .D.)
      CALL WARN
      OPTN = BLANK
      GO TO 40
C
160   CONTINUE
      MO = 2*((I-1)/2)+1
      OPTN = UNITS(MO)
      IF (IBUG.GE.1) WRITE(IODBUG,170) OPTN
170   FORMAT(11H    OPTN = ,A4)
      GO TO 40
C
C  IF 'ALLRC' HAS BEEN ENTERED FIRST IN THE RATING CURVE LIST,
C   PUNCH ALL NON-'OBSOLETE' RATING CURVES BY GETTING LIST FROM
C   /FRCPTR/
C
180   CONTINUE
      PRTALL = .TRUE.
      IF (IBUG.GE.1) WRITE(IODBUG,190)
190   FORMAT(51H  *****   ALL RATING CURVES ARE TO BE PUNCHED *****)
      GO TO 40
C
C......................................
C  NOW LOOP THROUGH AND PUNCH RATING CURVES
C
200   CONTINUE
      IF (PRTALL) NUMRC = NRC
      IF (NUMRC.LE.0) GO TO 220
      IF ((NUMRC.GT.0).AND.(NUMRC.LE.MRC)) GOTO 240
C
      WRITE (IPR,210) NUMRC,MRC
210   FORMAT('0**ERROR** THE NUMBER OF RATING CURVES TO BE ',
     .'PUNCHED ',1H(,I4,1H),' EXCEEDS THE MAXIMUM THAT CAN BE ',
     .'PROCESSES ',1H(,I4,2H).)
      GOTO 350
C
220   WRITE(IPR,230)
230   FORMAT('0**ERROR** -- NO IDENTIFIERS PROVIDED FOR THIS',
     . 17H PUNCHRC COMMAND./22X,38HAT LEAST ONE IDENTIFIER MUST BE INPUT
     ..)
      GO TO 350
C
240   DO 320  I=1,NUMRC
      RTCVNM(1)=RLIST(1,I)
      RTCVNM(2)=RLIST(2,I)
C
C  IF 'ALLRC' IS SPECIFIED, GET RC NAME FROM /FRCPTR/.
C
      IF (.NOT.PRTALL) GO TO 250
C
      RTCVNM(1) = RCZZ(1,I)
      RTCVNM(2) = RCZZ(2,I)
C
C  CHECK FOR DELETED RC DEFINITIONS
C
      IF (RTCVNM(1).EQ.OBSO.AND.RTCVNM(2).EQ.OLETE) GO TO 320
C
C  CALL FINDRC TO LOCATE RTCVNM ON FILE
C
250   CONTINUE
      CALL FINDRC(RTCVNM,LOFREC,IFOUND)
C
C  CHECK ERROR FLAG
      IF(IFOUND.GT.0) GO TO 270
C  ERROR ENCOUNTERED
      WRITE(IPR,260) RTCVNM
260   FORMAT('0**WARNING** RATING CURVE ',2A4,' DOES NOT EXIST ',
     * 'ON THE',/20X,27HRATING CURVE FILE.  FPUNRC ,
     *23HWILL MOVE TO NEXT GIVEN,/20X,27H ID AND CONTINUE EXECUTION.)
      CALL WARN
      GO TO 320
C
270   CONTINUE
C
C  NOW CALL FCRDRC TO MOVE R.C. INFO FROM FILE TO /FRATNG/
C
      CALL FCRDRC(LOFREC,RTCVNM,IERCHK)
C
C  CHECK FCRDRC ERROR CODE
      IF(IERCHK.LT.1) GO TO 290
C  ERROR ENCOUNTERED
      WRITE(IPR,280) RTCVNM
280   FORMAT('0**WARNING**  FCRDRC ENCOUNTERED ERROR PREVENTING ',
     1 20HFPUNRC FROM PUNCHING,/,22H INFO ON RATING CURVE ,2A4,10H.  FP
     1RTRC ,23HWILL MOVE TO NEXT GIVEN,/,27H ID AND CONTINUE EXECUTION.)
      CALL WARN
      GO TO 320
C
290   CONTINUE
C
C  NOW CALL FPURC TO PUNCH NEW CONTENTS OF /FRATNG/
C
      IFMT = 0
      CALL FPURC(OPTN,IFMT)
C
      WRITE(IPR,310) RTCVNM
310   FORMAT('0**NOTE** RATING CURVE ',2A4,' SUCCESSFULLY PUNCHED.')
C
320   CONTINUE
      GO TO 400
C
330   CONTINUE
      WRITE(IPR,340) IBUF
340   FORMAT('0**ERROR**',/22X,29HNO VALID SUBCOMMAND FOUND ON
     ., 28HTHE FOLLOWING INPUT RECORD ://5X,A)
350   WRITE(IPR,360)
360   FORMAT(/52H  ***** PUNCHRC COMMAND ABORTED DUE TO ABOVE ERRORS.)
      CALL ERROR
C
      IF (ICARD.GE.LASTCD) GO TO 400
      WRITE(IPR,370)
370   FORMAT(32H  SCANNING FOR 'END' SUBCOMMAND./)
      ICARD = ICARD+1
      DO 390 K=ICARD,LASTCD
      WRITE(IPR,380) NCARD(K)
380   FORMAT(1H ,A)
390   CONTINUE
400   CONTINUE
      OPNAME(1)=OLDSUB(1)
      OPNAME(2)=OLDSUB(2)
      IOPNUM=IOLDOP
      IF(ITRACE.GE.1) WRITE(IODBUG,410)
410   FORMAT(1H ,23H  **** EXIT FPUNRC ****)
C
C
      RETURN
      END
