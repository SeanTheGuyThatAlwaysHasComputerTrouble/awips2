C MODULE HCKIDS
C-----------------------------------------------------------------------
C
      SUBROUTINE HCKIDS (IF,IOPTRC,NXOPT,NNC,ISTAT)
C
C  THIS ROUTINE CHECKS FOR IDENTIFIERS OF THE FORM 'SEG1,SEG2',
C  <SEG1,SEG2,SEG3>, AB-TT, <TT-AA>, ETC.  IT STARTS IN IBUF
C  FIELD IF (IF IS INCREMENTED TO NEXT FIELD AFTER ALL IDS)
C  IT STORES DECODED IDENTIFIER INFORMATION IN IOPTRC(NXOPT+1),
C  NXOPT IS INCREMENTED TO LAST USED LOCATION IN IOPTRC.
C
C  ARGUMENT LIST:
C
C       NAME    TYPE   I/O   DIM   DESCRIPTION
C       ------  ----   ---   ---   -----------
C       IF        I     IO    1    FIELD NUMBER IN IBUF
C       IOPTRC    I     IO    ?    OPTION BUFFER (RECEIVES DECODED
C                                    IDENTIFIERS
C       NXOPT     I     IO    1    INDEX TO IOPTRC (LAST USED LOCAT)
C       NNC       I     IO    1    NUMBER OF LAST CARD READ
C       ISTAT     I      O    1    STATUS 0=OK, >0=ERROR
C
      INCLUDE 'ufreei'
      INCLUDE 'udebug'
      INCLUDE 'uio'
      INCLUDE 'udatas'
      INCLUDE 'hclcommon/hcomnd'
C
      DIMENSION LETRAY(4)
      INTEGER RCARET
      DIMENSION IOPTRC(*)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/db_hclrw/RCS/hckids.f,v $
     . $',                                                             '
     .$Id: hckids.f,v 1.2 2000/03/14 12:13:54 page Exp $
     . $' /
C    ===================================================================
C
      DATA LETRAY/1HS,1HF,1HC,1HA/,LCARET/1H</,RCARET/1H>/
C
C
      IF (IHCLTR.GT.1) WRITE (IOGDB,10)
10    FORMAT (' ENTER HCKIDS')
C
      IFLAG=1
      IPAREN=0
      KEY1=0
      KEY=1
      NXSAV=NXOPT+1
      NX1=NXOPT+3
      NX2=NXOPT+4
      IOPTRC(NX1-1)=1
      NIDS=0
      NCRT=0
C
      IF (IF.GT.NFIELD) GO TO 300
C
C  CHECK FOR ANY IDENTIFIERS - MUST START ON CURRENT CARD
      CALL HFLPRN (IFSTRT(IF),IFSTOP(IF),IX)
      IF (IX.NE.IFSTRT(IF)) GO TO 300
      IFSTRT(IF)=IX+1
      J=IFSTRT(IF)
      IPAREN=1
      CALL HFRPRN (J,IFSTOP(IF),IX)
      IF (IX.NE.IFSTOP(IF)) GO TO 30
C
C  JUST ONE IDENTIFIER FOUND
      IPAREN=0
      IFSTOP(IF)=IX-1
      GO TO 90
C
C  CHECK IDENTIFIER TYPE
30    N=IFSTOP(IF)-J+1
      IF (N.GT.1) GO TO 90
      DO 40 I=1,4
         IF (IBUF(J).EQ.LETRAY(I)) GO TO 50
40       CONTINUE
      GO TO 90
C
50    IOPTRC(NX1-1)=I
C
60    IF=IF+1
      IF (IPAREN.EQ.0.AND.NIDS.EQ.0) GO TO 280
C
      IF (IPAREN.NE.0) GO TO 70
         IFLAG=4
         GO TO 240
70    IF (IF.LE.NFIELD) GO TO 80
      IF (NNC.EQ.NCARD) GO TO 280
C
C  READ NEXT CARD
      NNC=NNC+1
      CALL HCARDR (NNC,ISTA)
      IF (ISTA.NE.0) GO TO 310
      IF=1
C
C  CHECK FOR RIGHT PARENTHESES TO INDICATE END OF IDENTIFIERS
80    CALL HFRPRN (IFSTRT(IF),IFSTOP(IF),IX)
      IF (IX.NE.IFSTOP(IF)) GO TO 90
C
C  FOUND A RIGHT PAREN SO AT END
      IFSTOP(IF)=IX-1
      IPAREN=IPAREN-1
C
C  NOT AN ARGUMENT - MUST BE IDENTIFIERS
C
C  CHECK FOR DASH INDICATING A RANGE
90    CALL USRDSH (IBUF,IFSTRT(IF),IFSTOP(IF),IX)
      IF (IX.GT.IFSTOP(IF)) GO TO 200
      IF (NIDS.EQ.0) GO TO 100
      IFLAG=3
      GO TO 240
C
C  RANGE OF IDENTIFIERS TO BE PROCESSED
C
C  CHECK FOR <>
100   J=IFSTRT(IF)
      CALL USRCHR (LCARET,J,IFSTOP(IF),LC)
      IF (LC.NE.IFSTRT(IF)) GO TO 120
         J=J+1
         NCRT=NCRT+1
         CALL USRCHR (RCARET,J,IFSTOP(IF),IRC)
         IF (IRC.NE.IFSTOP(IF)) GO TO 120
            KEY=-1
            NCRT=NCRT-1
            IFSTOP(IF)=IFSTOP(IF)-1
120   IF (NCRT.EQ.0) GO TO 140
         WRITE (LP,130) IF
         ISTAT=1
         GO TO 60
130   FORMAT ('0**ERROR** UNBALENCED <> IN FIELD',I3,'.')
C
C  PACK FIRST PART OF RANGE
140   N=IX-J
      IF (N.LE.8) GO TO 170
150      WRITE (LP,160) IF
         ISTAT=1
         GO TO 60
160   FORMAT ('0**ERROR** IDENTIFIER IN FIELD ',I3,
     *   ' IS GREATER THAN 8 CHARACTERS.')
C
170   CALL UMEMST (IBLNK,IOPTRC(NX2),2)
      CALL UPACK1 (IBUF(J),IOPTRC(NX2),N)
      NX2=NX2+2
C
C  PACK SECOND PART
      J=IX+1
      N=IFSTOP(IF)-J+1
      IF (N.GT.8) GO TO 150
      CALL UMEMST (IBLNK,IOPTRC(NX2),2)
      CALL UPACK1 (IBUF(J),IOPTRC(NX2),N)
      IOPTRC(NX1)=1*KEY
      IF (KEY1.EQ.0.OR.KEY1.EQ.KEY) GO TO 190
         WRITE (LP,180)
         ISTAT=1
         GO TO 60
180   FORMAT ('0**ERROR** CANNOT MIX INCLUSIVE AND ALL BUT IDENTIFIERS')
190   IF (KEY1.EQ.0) KEY1=KEY
C
C  INCREMENT POINTERS RESERVING 1 WORD FOR RANGE ON/OFF FLAG
      NX1=NX1+6
      NX2=NX2+4
      IOPTRC(NXSAV)=IOPTRC(NXSAV)+1
      KEY=1
      GO TO 60
C
C NOT A RANGE - MUST BE INDIVIDUAL NAMES
C
C  KNOW THAT FIRST IS NOT ARG
200   J=IFSTRT(IF)
      N=IFSTOP(IF)-J+1
      CALL USRCHR (LCARET,J,IFSTOP(IF),LC)
      IF (LC.EQ.0) GO TO 220
C
C  IF THIS IS A CHANGE FROM INCLUDES TO EXCLUDES, SAVE THE INCLUDES
      IF (NIDS.EQ.0) GO TO 210
         IFLAG=3
         GO TO 240
210   KEY=-1
      J=J+1
      N=N-1
      NCRT=NCRT+1
C
C  CHECK FOR >
220   CALL USRCHR (RCARET,J,IFSTOP(IF),IRC)
      IF (IRC.EQ.0) GO TO 230
         N=N-1
         NCRT=NCRT-1
230   IF (N.GT.8) GO TO 150
      CALL UMEMST (IBLNK,IOPTRC(NX2),2)
      CALL UPACK1 (IBUF(J),IOPTRC(NX2),N)
      NIDS=NIDS+1
      NX2=NX2+2
C
C  CHECK IF DONE
      IFLAG=1
      IF (IRC.EQ.0) GO TO 60
C
C  SET INDICATORS FOR THIS FIELD
240   IOPTRC(NX1)=(NIDS+1)*KEY
      IF (KEY1.EQ.0.OR.KEY1.EQ.KEY) GO TO 250
         WRITE (LP,180)
         ISTAT=1
         GO TO 260
250   IF (KEY1.EQ.0) KEY1=KEY
      IOPTRC(NXSAV)=IOPTRC(NXSAV)+1
      NX1=NX2
      NX2=NX1+1
      NIDS=0
      KEY=1
      IF (NCRT.NE.0) GO TO 270
C
260   GO TO (60,210,100,280),IFLAG
C
C  END OF CARD AND <> UNBALANCED
270   WRITE (LP,130) IF
      ISTAT=1
      GO TO 320
C
280   NXOPT=NX1-1
      IF (IPAREN.EQ.0) GO TO 300
      WRITE (LP,290)
290   FORMAT ('0**ERROR** UNBALENCED PARENTHESES IN THIS OPTION.')
      ISTAT=1
      GO TO 320
C
C  RESET IDENTIFIER TYPE IF NO IDENTIFIERS FOUND
300   IF (IOPTRC(NXSAV).NE.0) GO TO 320
      IOPTRC(NXSAV+1)=0
      NXOPT=NXSAV
      GO TO 320
C
310   ISTAT=ISTA
C
320   IF (IHCLDB.GT.1) WRITE (IOGDB,330) IF,ISTAT,NXSAV,NXOPT,
     * (IOPTRC(J),J=NXSAV,NXOPT)
330   FORMAT (' IN HCKIDS - IF=',I4,' ISTAT=',I4,' NXSAV=',I4,
     *  ' NXOPT=',I4 / ' IOPTRC=',3I6,12(1X,A4)/(12X,20(1X,A4)))
C
      RETURN
C
      END
