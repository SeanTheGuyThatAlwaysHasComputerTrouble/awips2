      SUBROUTINE SOLVE55(PO,CO,Z,ST1,LTST1,T1,LTT1,STN,LTSTN,POLH,
     . LTPOLH,ITWT,LTITWT,QLJ,LTQLJ,QL,LTQL,STC,LTSTC,QTC,LTQTC,
     . QSTR,LTQSR,NCML,XX,KU,NB,YJ,NJUN,
     . ITRMX,ICT,YC,QDI,YUMN,HS,QD,DDX,NQL,KD,KRCH,KSP,KS1,KSN,LRMIX,
     . ICTR,LRT,QU,YD,YU,QC,IRT1,IRTN,ISTOP,KMIX,KSIT,MIXF,NBJ,NITT,DTH,
     . NFAILD,HFDD,YDI,NFAILO,TIDE,NPD,ISTRT,IHRCO,JHRCO,JSIZE,ICO,
     . K1,K2,K4,K5,K6,K7,K8,K9,K10,K14,K15,K16,K19,K20,K21,K28)
C
C THIS SUBROUTINE DOES N-R ITERATION FOR J-TH RIVER
C ICT(1)=0  --  NORMAL CONVERGED WITHIN ITMAX
C ICT(1)>0  --  EXTRAPOLATION
C
C  NFT=0, HFDD=FAILURE WATER ELEV.; NFT=1, HFDD=FAILURE TIME
C
      COMMON/M155/NU,JN,JJ,KIT,G,DT,TT,TIMF,F1
      COMMON/M655/KTIME,DTHYD,J1
      COMMON/M3055/EPSY,EPSQ,EPSQJ,THETA,XFACT
      COMMON/M3255/IOBS,KTERM,KPL,JNK,TEH
      COMMON/M3455/KXP,ICD,ITMAX,KWARM
      COMMON/SS55/NCS,A,B,DB,R,DR,AT,BT,P,DP,ZH
      COMMON/IT55/ITER
      COMMON/MIXX55/MIXFLO,DFR,FRC
      COMMON/METR55/METRIC
      COMMON/NPC55/NP,NPST,NPEND
      COMMON/KREV55/KREVRS
      COMMON/VS55/MUD,IWF,SHR,VIS,UW,PB,SIMUD
      COMMON/IONUM/IN,IPR,IPU
        COMMON/NETWK55/NET

      INCLUDE 'common/fdbug'
      INCLUDE 'common/ofs55'
C
      DIMENSION PO(*),CO(*),Z(*),ST1(*),LTST1(*),T1(*),LTT1(*),STN(*)
      DIMENSION POLH(*),LTPOLH(*),ITWT(*),LTITWT(*),TIDE(*)
      DIMENSION STC(*),LTSTC(*),QTC(*),LTQTC(*),QSTR(*),LTQSR(*)
      DIMENSION HS(K9,K2,K1),XX(K15),KU(K1),NB(K1),YDI(K2,K1)
      DIMENSION QD(K2,K1),NFAILD(K16,K1),NFAILO(K16,K1),HFDD(K16,K1)
      DIMENSION QU(K2,K1),YD(K2,K1),YJ(K1),YU(K2,K1),NJUN(K1)
      DIMENSION QC(K2,K1),YC(K2,K1),ITRMX(K1),ICT(1)
      DIMENSION QDI(K2,K1),YUMN(K2,K1),DDX(K2,K1),QL(*),LTQL(*)
      DIMENSION NQL(K1),KD(K1),KRCH(K2,K1),QLJ(*),LTQLJ(*)
      DIMENSION KSP(K2,K5,K1),KS1(K2,K5,K1),KSN(K2,K5,K1)
      DIMENSION LRMIX(K5,K1),ICTR(K2,K5,1),MIXF(1)
      CHARACTER*8 SNAME
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_fldwav/RCS/solve55.f,v $
     . $',                                                             '
     .$Id: solve55.f,v 1.6 2004/02/02 21:52:25 jgofus Exp $
     . $' /
C    ===================================================================
C

CCC      DATA H,Q,V/4HH   ,4HQ   ,4HV   /

      DATA SNAME/ 'SOLVE55 ' /
C
      CALL FPRBUG(SNAME,1,55,IBUG)

C      IF (MUD.GE.1) EPSQ=10.0
      J=JJ
      NBJ=NB(J)
      NBJM=NBJ-1
      KUJ=KU(J)
      IF (ISS.GT.1) KUJ=2
      IF(MIXF(J).GE.2) CALL MIX55(PO,JNK,J,LRT,IRT1,IRTN,YD,YU,QU,QD,
     * DDX,HS,PO(LOAS),Z(LZIFR),KSP,KS1,KSN,LRMIX,ICTR,Z(LZYCR),
     * KRCH,MIXF,DFR,FRC,K1,K2,K5,K7,K8,K9)
      DO 911 I=IRT1,IRTN
  911 ICTR(I,LRT,J)=0
C  LRMIX= SUB/SUPER CRITICAL FLOW ROUTING REACHES
C  EX. ALL SUB-CRITIACL, LR=1; SUB-SUPER-SUB, LR=3
      ITMX=0
      NRM=LRMIX(LRT,J)
      DO 1066 LL=1,NRM
      IQX=0
      QQMX=0.0
      IYX=0
      YYMX=0.0
      ISS=KS1(LL,LRT,J)
      ISN=KSN(LL,LRT,J)
      KSUPC=KSP(LL,LRT,J)
      N2=2*(ISN-ISS+1)
      ISSS=ISS
      ISNN=ISN
      IF(JNK.GE.11) THEN
        CALL WYQMET55(METRIC,ISS,ISN,YU(1,J),1,ISN)
        CALL WYQMET55(METRIC,ISS,ISN,QU(1,J),0,ISN)
 2152 FORMAT(1X,10F10.4)
 2153 FORMAT(1X,10F10.0)
      END IF
C      ITMAX=1
      IF(KSUPC.EQ.0) GO TO 995
 4990 ISSS=ISSS+1
      ISNN=ISSS
  995 CFACT=1.0
      DO 1005 ITER1=1,ITMAX
      ITER=ITER1
      ITERR=ITER-1
      IF(ITERR.GT.ITMX) ITMX=ITERR
      IF(KSUPC.LE.0) GO TO 4994
      CALL SUPFLO55(PO,CO,Z,ST1,LTTST1,T1,LTT1,POLH,LTPOLH,ITWT,LTITWT,
     . QLJ,LTQLJ,QL,LTQL,QDI,YDI,JNK,NCML,HS,XX,QC,QD,QU,YC,YD,YU,DDX,
     . YJ,KRCH,KU,(LCC),Z(LZD),ISS,YUMN,IOBS,MIXF,ISSS,ISN,KSUPC,
     . K1,K2,K4,K7,K8,K9,K10,K15,K16,K19,K20,K21)
      GO TO 4995
 4994 ISS1=ISS
      KR=KRCH(NBJM,J)
      NROW=1
      IF (KU(J).EQ.2 .OR. ISS.NE.1) GO TO 3
      NCL1=1
      NCL2=2
      NCL3=3
      NCL4=4
      GO TO 4
   3  NCL1=2
      NCL2=1
      NCL3=4
      NCL4=3
   4  ISN1=ISN-1
cc      if(tt.gt.354.) then
cc        print*, 'on next to last time step'
cc      endif
      CALL UBDY55(PO,QU,YU,YJ,KU,ST1,LTST1,T1,LTT1,QTC,LTQTC,YDI,QDI,
     . PO(LOSTM),Z(LZC),Z(LZD),ISS,LRT,IRT1,QSAVE,KRCH,IOBS,NROW,NCL1,
     . NCL2,PO(LOMRU),PO(LONJUM),K1,K2,K15)
      NROW=N2
      IF(J.EQ.1.AND.KD(J).EQ.0) THEN
        LTD=1
        CALL DBDY55(PO,JNK,NCML,PO(LONQCM),HS,QD,QU,YD,YU,DDX,KD,
     *   PO(LOSLFI),YJ,KR,TIDE,LTD,T1,LTT1,STT,LTSTT,Z(LZST0),Z(LZC),
     *   Z(LZD),PO(LOYQD),PO(LOQYQD),PO(LONGAG),NBJ,ISN,LRT,IRTN,
     *   Z(LZIFR),YUMN,YDI,QDI,N2,NCL3,NCL4,PO(LOMRV),NJUN,KRCH,
     *   K1,K2,K6,K7,K8,K9,K28)
      ELSE
        CALL DBDY55(PO,JNK,NCML,PO(LONQCM),HS,QD,QU,YD,YU,DDX,KD,
     *   PO(LOSLFI),YJ,KR,STN,LTSTN,T1,LTT1,STT,LTSTT,Z(LZST0),Z(LZC),
     *   Z(LZD),PO(LOYQD),PO(LOQYQD),PO(LONGAG),NBJ,ISN,LRT,IRTN,
     *   Z(LZIFR),YUMN,YDI,QDI,N2,NCL3,NCL4,PO(LOMRV),NJUN,KRCH,
     *   K1,K2,K6,K7,K8,K9,K28)
      ENDIF
      KL=0
      DO 1163 I=ISS,ISN
      IF(KRCH(I,J).LT.10.OR.KRCH(I,J).GT.30) GO TO 1163
        KL=KL+1
        NFAILD(KL,J)=NFAILO(KL,J)
        IF(NFAILD(KL,J).EQ.0) GO TO 1163
        Y=YU(I,J)
        IF(TT.LE.0.00001) Y=YDI(I,J)
        IF(KIT.LE.KWARM) GO TO 1163
        NFT=0
        IF(HFDD(KL,J).LT.-0.01) NFT=1
        IF(NFT.EQ.0.AND.NFAILD(KL,J).EQ.2.AND.Y.GE.HFDD(KL,J))
     .     NFAILD(KL,J)=3
        IF(NFT.EQ.1.AND.NFAILD(KL,J).EQ.2) THEN
          TTHF=TT-ABS(HFDD(KL,J))
          IF(TTHF.GT.0.000001) NFAILD(KL,J)=3
        ENDIF
 1163 CONTINUE

      CALL INTER55(PO,CO,Z,ST1,LTST1,T1,LTT1,POLH,LTPOLH,ITWT,LTITWT,
     . QLJ,LTQLJ,QL,LTQL,NCML,PO(LONQCM),NQL,Z(LZC),NB,NJUN,QD,QU,YD,
     1 YU,DDX,Z(LZD),PO(LOATF),Z(LZQLV),Z(LZQLSM),KRCH,KSUPC,MIXF,
     2 PO(LOKFTR),PO(LOFKEC),PO(LCTFT),PO(LOKLPI),PO(LOX),PO(LOXLOS),
     3 PO(LOQLOS),PO(LOALOS),PO(LOKLOS),QDI,PO(LOSLFI),PO(LOMRU),
     4 PO(LONJUM),PO(LOMRV),Z(LZQJ),YJ,ISS1,ISN,NCL1,NCL2,NCL3,
     5 NCL4,K1,K2,K7,K8,K9,K10,K15,K16,K19,K20,K21)
      CALL MATRX55(Z(LZC),Z(LZD),XX,N2,K15)
      IF(JNK.GT.100) THEN
        WRITE(IPR,777) J,(XX(ILL),ILL=1,N2)
  777   FORMAT(/5X,'FOR RIVER NO. ',I2,500(/' XX=',10F12.4))
      ENDIF
 4995 II=0
      IER=0
      ICT(1)=0
      IQXO=IQX
      QXO=QQMX
      QQMX=0.0
      IYXO=IYX
      YXO=YYMX
      YYMX=0.0
        IF (ITMAX.EQ.1) GOTO 1281
      DO 1280 IK=ISSS,ISNN
      ICIT=0
      I=IK
      II=II+1
      IF(KUJ-1) 1240,1240,1200
 1200 ERR=ABS(XX(II))-EPSQ
      IF(ERR.LE.0.0) GO TO 1210
      ICIT=1
      IF(ABS(XX(II)).LE.ABS(QQMX)) GO TO 1210
      QQMX=XX(II)
      IQX=I
 1210 II=II+1
      ERR=ABS(XX(II))-EPSY
      IF(ERR.LE.0.0) GO TO 1220
      ICIT=1
      IF(ABS(XX(II)).LE.ABS(YYMX)) GO TO 1220
      YYMX=XX(II)
      IYX=I
 1220 IF(ICIT.LE.0) GO TO 1280
      IER=IER+1
      ICT(IER)=IK
      GO TO 1280
 1240 ERR=ABS(XX(II))-EPSY
      IF(ERR.LE.0.0) GO TO 1250
      ICIT=1
      IF(ABS(XX(II)).LE.ABS(YYMX)) GO TO 1250
      YYMX=XX(II)
      IYX=I
 1250 II=II+1
      ERR=ABS(XX(II))-EPSQ
      IF(ERR.LE.0.0) GO TO 1260
      ICIT=1
      IF(ABS(XX(II)).LE.ABS(QQMX)) GO TO 1260
      QQMX=XX(II)
      IQX=I
 1260 IF(ICIT.LE.0) GO TO 1280
      IER=IER+1
      ICT(IER)=IK
 1280 CONTINUE
 1281 II=0
      DO 1580 IK=ISSS,ISNN
      I=IK
      II=II+1
      IF(KUJ-1) 1540,1540,1500
 1500 QU(I,J)=QU(I,J)+XX(II)*CFACT
      II=II+1
      YU(I,J)=YU(I,J)+XX(II)*CFACT
      GO TO 1580
 1540 YU(I,J)=YU(I,J)+XX(II)*CFACT
      II=II+1
      QU(I,J)=QU(I,J)+XX(II)*CFACT
 1580 CONTINUE
C
C  REDUCE CORRECTION FACTOR IF OSCILLATION OF YYMX AND QQMX OCCURED
      CFY=0.0
      CFQ=0.0
      IF(ABS(YYMX).LE.EPSY) GO TO 1400
      IF(IYX.NE.IYXO) GO TO 1400
      SGN=YXO*YYMX
      IF(SGN.GE.0.0) GO TO 1400
      CFY=ABS(YXO)/(ABS(YXO)+ABS(YYMX))
      CFACT=CFY
 1400 IF(ABS(QQMX).LE.EPSQ) GO TO 1450
      IF(IQX.NE.IQXO) GO TO 1450
      SGN=QXO*QQMX
      IF(SGN.GE.0.0) GO TO 1450
      CFQ=ABS(QXO)/(ABS(QXO)+ABS(QQMX))
      CFACT=AMAX1(CFY,CFQ)
 1450 IF(JNK.LT.10) GO TO 1009
      IF(ITERR.GE.1) GO TO 1008
      IF(ISS.EQ.ISSS) WRITE(IPR,2151) J,LRT,LL,KIT
 2151 FORMAT(1X,'RIVER=',I3,5X,'DYN/CUN REACH=',I3,5X,
     & 'SUP/SUB FLOW REACH=',I3,5X,'KIT =',I5)
      IF(KIT.GT.2 .OR. J.NE.1) GO TO 1008
      WRITE(IPR,1004)
 1004 FORMAT(5X,'MAX DQ AND MAX DY ARE FINAL MAXIMUM ERROR IN NEWTON ',
     &'RAPHSON ITERATION METHOD WHILE SOLVING ST. VENANT EQUATION')
 1008 IF(METRIC.EQ.1) QQMX=QQMX/35.32
      IF(METRIC.EQ.1) YYMX=YYMX/3.281
      WRITE(IPR,1003) QQMX,IQX,YYMX,IYX,ITERR,CFACT
 1003 FORMAT(10X,7HMAX DQ=,F6.1,2X,5HAT I=,I3,10X,7HMAX DY=,F6.3,2X,
     * 5HAT I=,I3,'  ITER=',I2,5X,'CFACT=',F7.3)
      IF(JNK.LT.11) GO TO 1009
      CALL WYQMET55(METRIC,ISSS,ISNN,YU(1,J),1,ISNN)
      CALL WYQMET55(METRIC,ISSS,ISNN,QU(1,J),0,ISNN)
 1009 IF(ICT(1).EQ.0) GO TO 1057
 1005 CONTINUE
C NOT CONVERGED AFTER ITMAX N-R ITERATION, REDUCE DT ETC
      ITRMX(J)=ITMAX
      KMIX=KMIX+1
      IF(KMIX.GE.1) KSIT=KSIT+1
      IF(KSIT.GE.3) F1=F1+0.20
      IF(KSIT.GE.5 .AND. F1.GE.1.19) GO TO 1045
      IF(F1.GE.1.0) F1=1.0
      TT=TT-DTH
      IF(TT.LE.0.) TT=0.00
C
      DO 1015 I=ISS,ISN
      QU(I,J)=QD(I,J)
      YU(I,J)=YD(I,J)
 1015 CONTINUE
C
      TTP=TT+DTH
      IF(KIT.LE.KWARM+1) TTP=0.
      IF(JNK.GE.4.AND.IER.NE.0) WRITE(IPR,1016) TTP,DTH
 1016 FORMAT(//1X,'NONCONVERGENCE FOR TT=',F10.5,' USING DTH=',F10.5)
      IF(JNK.GE.4.AND.IER.NE.0) WRITE(IPR,1017) J,(ICT(K),K=1,IER)
 1017 FORMAT(1X,'AT RIVER=',I3,'  SECT NO.=',2X,15I4,
     . 100(/26X,15I4))
      IF(KSIT.EQ.1) DTH=0.5*DTH
      IF(KSIT.EQ.2) DTH=0.25*DTH
      IF(KSIT.EQ.3) DTH=0.5*DTH
      ICTR(LL,LRT,J)=ICT(1)
      IF(JNK.GE.4) WRITE(IPR,1278) TT,DTH,F1,TT+DTH
 1278 FORMAT(1X,12HPREVIOUS TT=,F10.5,2X,8HNEW DTH=,F10.5,2X,7HNEW F1=,
     $      F5.2,2X,7HNEW TT=,F10.5)
      IF(KSIT.LE.5) GO TO 1985
 1045 WRITE(IPR,1287)TT
 1287 FORMAT(//10X,33HEXTRAPOLATION HAS OCCURRED AT TT=,F10.3/)
      ICT(1)=0
      JST=1
      JND=JN
      IF(NP.LE.-1) THEN
        JST=J
        JND=J
      END IF
      DO 1186 JI=JST,JND
      NI=NB(JI)
      DO 1186 IK=1,NI
      YU(IK,J)=YD(IK,J)
      QU(IK,J)=QD(IK,J)
 1186 CONTINUE
      NITT=NITT+1
      IF(NITT.LE.5) GO TO 1057
      CALL NONC55(PO,Z(LZCCO),T1,LTT1,QL,LTQL,STC,LTSTC,QTC,LTQTC,
     . QSTR,LTQSR,POLH,LTPOLH,ITWT,LTITWT,NB,PO(LONGAG),PO(LONGS),YD,QD,
     . Z(LZVD),PO(LONSTR),PO(LONST),PO(LCKTYP),PO(LOGZO),KTIME,NPD,JN,
     . ISTRT,DDX,IHRCO,JHRCO,JSIZE,ICO,K1,K2,K4,K10,K14,K16)
      WRITE(IPR,9346)
 9346 FORMAT(////10X,'PROGRAM TERMINATED BECAUSE NONCONVERGENCE ',
     &'LIMITATIONS HAVE BEEN EXCEEDED.')
      ISTOP=1
      GO TO 1985
 1057 CONTINUE
      IF(ITERR.GE.ITRMX(J)) ITRMX(J)=ITERR
      IF(KSUPC.EQ.1 .AND. ISNN.LT.ISN) GO TO 4990
C LOW FLOW FILTER
      IF(KREVRS.EQ.1) GO TO 1064
      DO 1065 I=ISS,ISN
      IF(QU(I,J).LE.QDI(I,J)) QU(I,J)=QDI(I,J)
      IF(YU(I,J).LE.YUMN(I,J)) YU(I,J)=YUMN(I,J)
 1065 CONTINUE
 1064 QSAVE=QU(ISN,J)
 1066 CONTINUE
 1985 RETURN
      END
