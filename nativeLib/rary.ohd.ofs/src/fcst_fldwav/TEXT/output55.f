      SUBROUTINE OUTPUT55(PO,TII,QTC,LTQTC,STC,LTSTC,NB,NPT,NQCM,
     . ITRMX,QU,YD,YU,X,YDI,VU,VD,NGS,HS,QD,DDX,NGAGE,QLSUM,KRCH,BBP,
     . YBP,SQW,SQS1,SQS2,SQO,QBRCH,QOVTP,QOTHR,NUMLAD,LAD,NRCM1,KPRINT,
     . DTH,MRV,TO,NSTR,QSTR,LTQSR,KTYP,NST,GZO,NPO,KOUT,K1,K2,K3,K4,K7,
     . K8,K9,K14,K16)
C
      COMMON/LEV55/NLEV,DHLV,NPOND,DTHLV,IDTHLV
      COMMON/M155/NU,JN,JJ,KIT,G,DT,TT,TIMF,F1
      COMMON/M655/KTIME,DTHYD,J1
      COMMON/M3055/EPSY,EPSQ,EPSQJ,THETA,XFACT
      COMMON/M3255/IOBS,KTERM,KPL,JNK,TEH
      COMMON/M3455/KXP,ICD,ITMAX,KWARM
      COMMON/M3655/TFCST
      COMMON/M3755/NINIT
      COMMON/M3855/CONS,QSUMIM,QSUMIT,QSUMOM,QSUMOT,JJKT
      COMMON/M3955/NCOH,NSAVE,DNLABL
      COMMON/SS55/NCS,A,B,DB,R,DR,AT,BT,P,DP,ZH
      COMMON/DQDT55/DQDTN
      COMMON/IT55/ITER
      COMMON/FLP55/KFLP
      COMMON/MIXX55/MIXFLO,DFR,FRC
      COMMON/METR55/METRIC
      COMMON/PRES55/KPRES
      COMMON/TDBG55/TDBG1,TDBG2,JNKDBG,JDBG1,JDBG2,LDBG1,LDBG2,MCMDBG
      COMMON/IONUM/IN,IPR,IPU
        COMMON/NETWK55/NET

      INCLUDE 'common/fdbug'
      INCLUDE 'common/ofs55'
C
      DIMENSION PO(*),TII(*),QTC(*),LTQTC(*),STC(*),LTSTC(*),TO(*)
      DIMENSION HS(K9,K2,K1),NB(K1),NPT(2,K1),NGAGE(K1),VU(K2,K1)
      DIMENSION QD(K2,K1),QU(K2,K1),YD(K2,K1),YU(K2,K1),DDX(K2,K1)
      DIMENSION NQCM(K1),X(K2,K1),ITRMX(K1),NGS(K4,K1),NST(K14,K1)
      DIMENSION YDI(K2,K1),NRCM1(K1),QSTR(*),LTQSR(*),KTYP(K14,K1)
      DIMENSION QLSUM(K2,K1),KRCH(K2,K1),MRV(K1),GZO(K14,K1)
      DIMENSION NUMLAD(K1),LAD(K16,K1),BBP(K16,K1),YBP(K16,K1),VD(K2,K1)
      DIMENSION SQW(2,K16,K1),SQS1(2,K16,K1),SQS2(2,K16,K1),NSTR(K1)
      DIMENSION SQO(2,K16,K1),QBRCH(K16,K1),QOVTP(K16,K1),QOTHR(K16,K1)
      CHARACTER*8 SNAME
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_fldwav/RCS/output55.f,v $
     . $',                                                             '
     .$Id: output55.f,v 1.2 2000/12/19 15:00:50 dws Exp $
     . $' /
C    ===================================================================
C

      DATA SNAME/ 'OUTPUT55' /
C
      CALL FPRBUG(SNAME,1,55,IBUG)
C------------------      STORE HYDROGRAPHS     -------------------------
      IF(KIT.LE.KWARM) GOTO 1000
900   IF(TT.LT.TII(KTIME)) GOTO 950
      DTX=1.0
      IF(TT.EQ.TII(KTIME)) GOTO 910
      TTD=TT-DTH
      DTX=(TII(KTIME)-TTD)/DTH
910   DO 920 J=1,JN+NET
      NGAG=NGAGE(J)
      KJ=LCAT21(1,J,NGAGE)-1
      IF(NGAG.LE.0) GOTO 920
      DO 915 K=1,NGAG
      IG=NGS(K,J)
      LST=LTSTC(KJ+K)-1
      LQT=LTQTC(KJ+K)-1
      STC(KTIME+LST)=YD(IG,J)+(YU(IG,J)-YD(IG,J))*DTX
      QTC(KTIME+LQT)=QD(IG,J)+(QU(IG,J)-QD(IG,J))*DTX
915   CONTINUE
920   CONTINUE
      KTIME=KTIME+1
      IF(KTIME.GT.K3) GOTO 950
      GOTO 900

950   IF(TT.LT.TO(KOUT)) GOTO 1000
      DTX=1.0
      IF(TT.EQ.TO(KOUT)) GOTO 960
      TTD=TT-DTH
      DTX=(TO(KOUT)-TTD)/DTH
960   DO 980 J=1,JN
      NSR=NSTR(J)
      KJ=LCAT21(1,J,NSTR)-1
      IF(NSR.EQ.0) GO TO 980
      DO 965 K=1,NSR
      IS=NST(K,J)
      LQSR=LTQSR(KJ+K)-1
      IF(KTYP(K,J).EQ.3) 
     .  QSTR(KOUT+LQSR)=VD(IS,J)+(VU(IS,J)-VD(IS,J))*DTX
      IF(KTYP(K,J).EQ.2) 
     .  QSTR(KOUT+LQSR)=QD(IS,J)+(QU(IS,J)-QD(IS,J))*DTX
      IF(KTYP(K,J).EQ.1) 
     .  QSTR(KOUT+LQSR)=(YD(IS,J)+(YU(IS,J)-YD(IS,J))*DTX)-GZO(K,J)
cc      print*, k,kout,to(kout),is,lqsr,qstr(kout+lqsr),npo,gzo(k,j)
 965  CONTINUE
 980  CONTINUE
      KOUT=KOUT+1
      IF(KOUT.GT.NPO) GOTO 1000
      GOTO 950
1000  CONTINUE
C-----------------------------------------------------------------------
      JNKS=JNK
      DTHP=DTH
      DO 1620 J=1,JN+NET
      JNK=JNKS
      IF(TT.LT.TDBG1.OR.TT.GT.TDBG2) GO TO 1116
      IF(J.LT.JDBG1.OR.J.GT.JDBG2) GO TO 1116
      JNK=JNKDBG
 1116 IF(KPRINT.NE.1.OR.JNK.LT.4) GO TO 1117
      IF(J.GE.2) GO TO 1117
CC      IF(KIT.GT.0) WRITE(IPR,1315)
      WRITE(IPR,1315)
      WRITE(IPR,2110) TT,DTHP,(ITRMX(JI),JI=1,JN)
 1117 N=NB(J)
      YU1=YU(1,J)
      YUN=YU(N,J)
      IF(METRIC.EQ.0) THEN
        QU1=QU(1,J)*0.001
        QUN=QU(N,J)*0.001
      ELSE
        QU1=QU(1,J)/35.32
        QUN=QU(N,J)/35.32
        YU1=YU1/3.281
        YUN=YUN/3.281
      ENDIF
      IF(JNK.GE.4) WRITE(IPR,1616) J,QU1,YU1,QUN,YUN
 1616 FORMAT(/3X,'RIVER= ',I3,5X,'QU(1)= ',F10.3,5X,'YU(1)= ',F10.2,
     & 5X,'QU(N)= ',F10.3,5X,'YU(N)= ',F10.2)
CC 1616 FORMAT(/3X,'RIVER= ',I3/5X,'QU(1)     YU(1)     QU(N)     YU(N)'/
CC     . 2(F10.3,F10.2))

      IF(JNK.GE.9.AND.METRIC.EQ.0.AND.KFLP.EQ.0) WRITE(IPR,1493)
 1493 FORMAT(/4H   J,4H   I,5X,5HX(MI),3X,6HH(MSL),1X,6HV(FPS),
     1 2X,8HA(TSQFT),5X,5HB(FT),4X,6HBT(FT),3X,7HQ(TCFS),
     2 3X,7HMANN. N,3X,5HWAVHT,2X,6HFROUDE,1X,7HDEP(FT),4H  KR,
     3 11H   QL(TCFS),5H  MRV)
      IF(JNK.GE.9.AND.METRIC.EQ.1.AND.KFLP.EQ.0) WRITE(IPR,1494)
 1494 FORMAT(/4H   J,4H   I,5X,5HX(KM),3X,6HH(MSL),1X,6HV(M/S),
     1 2X,8HA( SQ M),6X,4HB(M),5X,5HBT(M),4X,6HQ(CMS),
     2 3X,7HMANN. N,3X,5HWAVHT,2X,6HFROUDE,2X,6HDEP(M),4H  KR,
     3 10H   QL(CMS),5H  MRV)
      IF(JNK.GE.9.AND.METRIC.EQ.0.AND.KFLP.EQ.1) WRITE(IPR,1495)
 1495 FORMAT(/3H  J,3H  I,4X,5HX(MI),3X,6HH(MSL),2X,4H  VL,2X,4H  VC,
     1 2X,4H  VR,4X,8HA(TSQFT),4X,5HB(FT),3X,6HBT(FT),3X,7HQ(TCFS),
     2 3X,8HK/100000,3X,5HWAVHT,2X,6HFROUDE,1X,7HDEP(FT),4H  KR,
     3 11H   QL(TCFS),5H  MRV)
      IF(JNK.GE.9.AND.METRIC.EQ.1.AND.KFLP.EQ.1) WRITE(IPR,1495)
 1496 FORMAT(/3H  J,3H  I,4X,5HX(KM),3X,6HH(MSL),2X,4H  VL,2X,4H  VC,
     1 2X,4H  VR,4X,8HA(TSQM) ,4X,5HB(M) ,3X,6HBT(M) ,3X,7HQ(TCMS),
     2 3X,8HK/100000,3X,5HWAVHT,2X,6HFROUDE,1X,7HDEP(M) ,4H  KR,
     3 11H   QL(TCMS),5H  MRV)

      FRMX=0.
      FRMN=7.0
      IPR1=NPT(1,J)
      IPR2=NPT(2,J)
      DO 1600 I=1,N
      Y=YU(I,J)
C     IF(I.LT.N) YQ=0.5*(YU(I,J)+YU(I+1,J))
C     IF(I.EQ.N) YQ=Y
      YQ=Y
      CALL SECT55(PO(LCPR),PO(LOAS),PO(LOBS),HS,PO(LOASS),
     . PO(LOBSS),J,I,Y,PO(LCHCAV),PO(LCIFCV),K1,K2,K9)
      DD=A/B
      FR=ABS(VU(I,J)/(SQRT(32.2*DD)))
      IF(FR.GE.FRMX) IFRMX=I
      IF(FR.GE.FRMX) FRMX=FR
      IF(FR.LT.FRMN) IFRMN=I
      IF(FR.LT.FRMN) FRMN=FR
      AA=0.001*A
CCC      AAT=0.001*AT
      QQ=0.001*QU(I,J)
      QLP=0.001*QLSUM(I,J)
      IF(KFLP.GE.1) GO TO 1527
      IRCH=I
      IP=I+1
      IF(I.GE.N) IP=I
      NQCMJ=NQCM(J)
      NCML=ABS(NQCMJ)
      IF(NCML.EQ.0) NCML=NCS
      IRCM=IRCH
      LL=IRCH
      LLP=LL+1
      IF(LLP.GE.N) LLP=N
      IF(NQCMJ.GE.0) YQM=0.5*(YU(LL,J)+YU(LLP,J))
      IF(NQCMJ.LT.0) YQM=0.5*(QU(LL,J)+QU(LLP,J))
      CALL FRICT55(NCML,PO(LOCM),PO(LOYQCM),J,IRCM,YQM,CMU,DCMU,
     . K1,K7,K8)
      GO TO 1528
 1527 CALL CONV55(PO(LOQKC),PO(LOHKC),PO(LCBEV),PO(LCNKC),J,I,YQ,QK,DQK,
     1 BET,DBE,0,K1,K2)
      CMU=QK/100000.
      SFI=QU(I,J)/QK
1528  CONTINUE
      IF (KPRINT.EQ.0 .OR. JNK.LT.9) GOTO 1600
      IF(I.LT.IPR1 .OR. I.GT.IPR2) GO TO 1600
      WAVHT=YU(I,J)-YDI(I,J)
      DEP=YU(I,J)-HS(1,I,J)
      KR=KRCH(I,J)
      PXI=X(I,J)
      PYUI=YU(I,J)
      PVUI=VU(I,J)
      PAA=AA
      PB=B
      PBT=BT
      PQQ=QQ
      PWAVH=WAVHT
      PDEP=DEP
      PQLP=QLP
      IF(METRIC.EQ.1) THEN
        PXI=PXI*1.6093
        PYUI=PYUI/3.281
        PVUI=PVUI/3.281
        PAA=PAA*1000./10.765
        PB=PB/3.281
        PBT=PBT/3.281
        PQQ=PQQ/35.32
        PWAVH=PWAVH/3.281
        PDEP=PDEP/3.281
        PQLP=PQLP/35.32
      ENDIF
      IF (KFLP.EQ.0) GOTO 1310
      CALL SECTF55(NCS,J,I,Y,BL,AL,BR,AR,HS,PO(LOBSL),PO(LOBSR),
     * PO(LOASL),PO(LOASR),K1,K2,K9)
      CALL FRICTL55(NCS,PO(LOCML),PO(LOYQCM),J,I,Y,CMNL,DCML,K1,K7,K8)
      CALL FRICTR55(NCS,PO(LOCMR),PO(LOYQCM),J,I,Y,CMNR,DCMR,K1,K7,K8)
      QFL=1.49*SFI*AL*(AL/BL)**0.66667/CMNL
      QFR=1.49*SFI*AR*(AR/BR)**0.66667/CMNR
      VL=0.0
      VR=0.0
      IF (AL.GE.10.0) VL=QFL/AL
      IF (AR.GE.10.0) VR=QFR/AR
      QFC=QU(I,J)-QFL-QFR
      AC=1000.0*AA-AL-AR
      VC=QFC/AC
          IF (METRIC.EQ.1) THEN
          VL=0.3048*VL
          VR=0.3048*VR
          VC=0.3048*VC
          ENDIF
      WRITE(IPR,2124) J,I,PXI,PYUI,VL,VC,VR,PAA,PB,PBT,PQQ,
     1 CMU,PWAVH,FR,PDEP,KR,PQLP,MRV(J)
      GOTO 1311
 1310 WRITE(IPR,2123) J,I,PXI,PYUI,PVUI,PAA,PB,PBT,PQQ,
     1 CMU,PWAVH,FR,PDEP,KR,PQLP,MRV(J)
 1311 IF(I.EQ.N) WRITE(IPR,1313)
 1313 FORMAT(1H )
 1600 CONTINUE
1602  IF(JNK.GE.4) WRITE(IPR,1071) FRMX,IFRMX,FRMN,IFRMN
CC 1071 FORMAT(/6X,'FRMX     IFRMX      FRMN     IFRMN'/2(F10.3,I10))
 1071 FORMAT(10X,'FRMX=',F8.3,2X,'IFRMX=',I5,
     & 10X,'FRMN=',F8.3,2X,'IFRMN=',I5)
      NUM=NUMLAD(J)
      IF(NUM.LE.0.OR.JNK.LT.4) GO TO 1620
      WRITE(IPR,1617)
 1617 FORMAT(/5X,'RESERVOIR OUTFLOW INFORMATION'/3X,'   J   I        TT
     1    QU(I)  USH(MSL)   YB(MSL)  DSH(MSL)       SUB        BB     QU
     2(1)    QBRECH    QOVTOP     QOTHR')
      DO 1610 L=1,NUM
      I1=LAD(L,J)
      I2=I1+1
      QUI2=QU(I2,J)*0.001
      YUI1=YU(I1,J)
      YBCH=YBP(L,J)
      YUI2=YU(I2,J)
      SUBQW=SQW(1,L,J)
      SUBQO=SQO(1,L,J)
      SUBQS1=SQS1(1,L,J)
      SUBQS2=SQS2(1,L,J)
      SUBN=AMIN1(SUBQW,SUBQO,SUBQS1,SUBQS2)
      BB=BBP(L,J)
      QU1=QU(1,J)*0.001
      QW=QBRCH(L,J)*0.001
      QOVT=QOVTP(L,J)*0.001
      QOTH=QOTHR(L,J)*0.001
CC      QRATIO=QUI2/(QW+QOVT+QOTH)
CC      QW=QW*QRATIO
CC      QOVT=QOVT*QRATIO
CC      QOTH=QOTH*QRATIO
      IF(METRIC.EQ.1) THEN
        QUI2=QU(I2,J)/35.32
        YUI1=YUI1/3.281
        YUI2=YUI2/3.281
        YBCH=YBCH/3.281
        BB=BB/3.281
        QU1=QU(1,J)/35.32
        QW=QW*1000./35.32
        QOVT=QOVT*1000./35.32
        QOTH=QOTH*1000./35.32
      ENDIF
      WRITE(IPR,1618) J,I1,TT,QUI2,YUI1,YBCH,YUI2,SUBQW,BB,QU1,QW,QOVT,
     . QOTH
 1618 FORMAT(3X,2I4,2F10.3,5F10.2,4F10.3)
 1610 CONTINUE
 1620 CONTINUE
C     IF(KSTORE.EQ.1) KTIME=KTIME+1
      IF(KTERM) 1670,1670,1630
 1630 DO 1660 J=1,JN+NET
      JNK=JNKS
      IF(TT.LT.TDBG1.OR.TT.GT.TDBG2) GO TO 1126
      IF(J.LT.JDBG1.OR.J.GT.JDBG2) GO TO 1126
      JNK=JNKDBG
 1126 NBJM=NB(J)-1
      WRITE(IPR,*)
      WRITE(IPR,*)'    I   YU(I,J)    VU(I,J)   QU(I,J)      N          
     $TERMS (1-4)'
      DO 1660 I=1,NBJM
      IP=I+1
      QAU=0.5*(QU(I,J)+QU(IP,J))
      YUR=YU(IP,J)
      CALL SECT55(PO(LCPR),PO(LOAS),PO(LOBS),HS,PO(LOASS),
     . PO(LOBSS),J,IP,YUR,PO(LCHCAV),PO(LCIFCV),K1,K2,K9)
CCC      RUR=R
      AUR=A
      BUR=B
      YUL=YU(I,J)
      CALL SECT55(PO(LCPR),PO(LOAS),PO(LOBS),HS,PO(LOASS),
     . PO(LOBSS),J,I,YUL,PO(LCHCAV),PO(LCIFCV),K1,K2,K9)
CCC      RUL=R
      AUL=A
      BUL=B
      RAU=((AUL+AUR)/(BUL+BUR))**(2./3.)
      AAU=0.5*(AUL+AUR)
      IF(KFLP.GE.1) GO TO 1660
      NQCMJ=NQCM(J)
      NCML=ABS(NQCMJ)
      IF(NCML.EQ.0) NCML=NCS
      IRCH=I
      IRCM=IRCH
      LL=IRCH
      LLP=LL+1
      IF(LLP.GE.N) LLP=N
      IF(NQCMJ.GE.0) YQM=0.5*(YU(LL,J)+YU(LLP,J))
      IF(NQCMJ.LT.0) YQM=0.5*(QU(LL,J)+QU(LLP,J))
      CALL FRICT55(NCML,PO(LOCM),PO(LOYQCM),J,IRCM,YQM,CMU,DCMU,
     . K1,K7,K8)
      TERM1=(QU(I,J)+QU(IP,J)-QD(I,J)-QD(IP,J))/(2.*G*AAU*DT)
      TERM2=(QU(IP,J)*QU(IP,J)/AUR-QU(I,J)*QU(I,J)/AUL)/(G*AAU*DDX(I,J))
      TERM3=(YU(IP,J)-YU(I,J))/DDX(I,J)
      TERM4=CMU*CMU*ABS(QAU)*QAU/(2.208*RAU*RAU*AAU*AAU)
      WRITE(IPR,1650)I,YU(I,J),VU(I,J),QU(I,J),CMU,TERM1,TERM2,TERM3,
     . TERM4
 1650 FORMAT(I6,2F10.2,F10.0,F10.4,4F15.7)
 1660 CONTINUE
 1670 CONTINUE
 1315 FORMAT (/)
 2110 FORMAT(2X,4HTT =,F10.5,5H HRS ,5X,5HDTH =,F10.5,5H HRS ,5X,
     & 5HITMX=,7I3)
 2123 FORMAT(2I4,F10.3,F10.2,F6.2,F10.3,2F10.0,2F10.4,3F8.2,I4,F10.4,I5)
 2124 FORMAT(2I3,F9.3,F9.2,3F6.2,F10.3,2F10.0,2F10.4,3F8.3,I4,F10.4,I5)
      RETURN
      END
