      SUBROUTINE YEND55(PO,JNK,J,NCML,NQCM,NB,HS,KD,STN,LTSTN,YQD,QYQD,
     * QNM,QN,YNN,IFRN,YCR,DX,QIL,QIR,YIL,YIR,S0A,K1,K2,K6,K7,K8,K9)
      COMMON/METR55/METRIC
      COMMON/NYQDC55/NYQD
      COMMON/M3055/EPSY,EPSQ,EPSQJ,THETA,XFACT
      COMMON/SS55/NCS,A,B,DB,R,DR,AT,BT,P,DP,ZH
      COMMON/FLP55/KFLP
      COMMON/IONUM/IN,IPR,IPU

      INCLUDE 'common/fdbug'
      INCLUDE 'common/ofs55'

      DIMENSION PO(*),NQCM(K1),NB(K1),HS(K9,K2,K1),STN(*)
      DIMENSION YQD(K6),QYQD(K6),YCR(K2,K1),KD(K1)
      DIMENSION FL(3),FR(3),PF(2,2),SNAME(2)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_fldwav/RCS/yend55.f,v $
     . $',                                                             '
     .$Id: yend55.f,v 1.1 1999/04/23 18:09:00 dws Exp $
     . $' /
C    ===================================================================
C

      DATA SNAME/4HYEND,4H55  /
C
      CALL FPRBUG(SNAME,1,55,IBUG)

      N=NB(J)
      KDD=KD(J)
      IF(IFRN.EQ.1) GO TO 70
      GO TO (100,1000,300,400,500),KDD
C       STAGE BOUNDARY
  100 L1J=LTSTN
      YNN=STN(L1J)
      GO TO 1000
C       TABULAR RATING CURVE (SINGLE VALUE) BOUNDARY
  300 DO 33 K=2,NYQD
      IF(QN.LT.QYQD(K)) GO TO 35
   33 CONTINUE
      K=NYQD
   35 L=K-1
      DYQ=(YQD(K)-YQD(L))/(QYQD(K)-QYQD(L))
      YNN=YQD(L)+DYQ*(QN-QYQD(L))
      GO TO 1000
C       LOOP RATING BOUNDARY
  400 IL=N-1
      IR=N
      DHL=YIL-HS(1,IL,J)
      DHR=YIR-HS(1,IR,J)
      DHA=ABS(DHL-DHR)
      IF(DHA.LE.2.*EPSY) GO TO 1000
      DO 128 K=1,30
C  QNM=QIL= GIVEN FLOW AT N-1; QN=QIR= GIVEN FLOW AT N
C  QNL= COMPUTED FLOW AT SECTION N-1; QNR= COMPUTED FLOW AT SECTION N
C  SOLVE F1=QNM-QNL AND F2=QN-QNR USING NEWTON-RALPHSON METHOD
C  PF(1,1)*DYIL+PF(1,2)*DYIR=F1(YIL,YIR)
C  PF(2,1)*DYIL+PF(2,2)*DYIR=F2(YIL,YIR)
C  PF(1,1)=(F1(YIL+EPSY,YIR)-F1(YIL-EPSY,YIR))/(2.*EPSY)
C  PF(2,1)=(F2(YIL+EPSY,YIR)-F2(YIL-EPSY,YIR))/(2.*EPSY)
C  PF(1,2)=(F1(YIL,YIR+EPSY)-F1(YIL,YIR-EPSY))/(2.*EPSY)
C  PF(2,2)=(F2(YIL,YIR+EPSY)-F2(YIL,YIR-EPSY))/(2.*EPSY)
      DO 122 IK=1,2
      YNKO=YIL
      IF(IK.EQ.2) YNKO=YIR
      DO 121 IK1=1,3
      YNK=YNKO+(IK1-2)*EPSY
      IF(IK.EQ.1) CALL LOOPR55(PO,NCML,NQCM,J,IL,IR,QIL,QIR,YNK,YIR,DX,
     * QNL,QNR,K1,K2,K7,K8,K9)
      IF(IK.EQ.2) CALL LOOPR55(PO,NCML,NQCM,J,IL,IR,QIL,QIR,YIL,YNK,DX,
     * QNL,QNR,K1,K2,K7,K8,K9)
      FL(IK1)=QNM-QNL
  121 FR(IK1)=QN-QNR
      PF(1,IK)=(FL(3)-FL(1))/(2.0*EPSY)
      PF(2,IK)=(FR(3)-FR(1))/(2.0*EPSY)
  122 CONTINUE
      F1=FL(2)
      F2=FR(2)
      UP=-F1*PF(2,1)+PF(1,1)*F2
      DN=PF(2,1)*PF(1,2)-PF(1,1)*PF(2,2)
      DYIR=UP/DN
      DYIL=(-F2-PF(2,2)*DYIR)/PF(2,1)
      IF(DYIL.LE.EPSY .AND. DYIR.LE.EPSY) GO TO 126
      YIL=YIL+DYIL
      YIR=YIR+DYIR
      GO TO 128
  126 CALL LOOPR55(PO,NCML,NQCM,J,IL,IR,QIL,QIR,YIL,YIR,DX,QNL,QNR,
     * K1,K2,K7,K8,K9)
      IF(ABS(QN-QNL).LE.EPSQ .AND. ABS(QN-QNR).LE.EPSQ) GO TO 129
      YIL=YIL+DYIL
      YIR=YIR+DYIR
  128 CONTINUE
  129 PYIR=YIR
      PYIL=YIL
      IF(METRIC.EQ.1) THEN
        PYIR=PYIR/3.281
        PYIL=PYIL/3.281
      ENDIF
      WRITE(IPR,1) IR,PYIR
      WRITE(IPR,1) IL,PYIL
      GO TO 1100
C       NORMAL FLOW (SINGLE VALUE) BOUNDARY
 500  IRCH=N-1
      YNN=-999.0
      QO=QN
      SO=S0A
      YMN=YCR(N,J)
      YMX=HS(NCS,N,J)
      DYNX=-0.5*(HS(1,IRCH,J)-HS(1,N,J))
      CALL HNORM55(PO,JNK,NCML,NQCM,J,N,IRCH,YNN,QO,SO,YMN,YMX,DYNX,
     * ITN,K1,K2,K7,K8,K9)
      GO TO 1000
   70 YNN=YCR(N,J)
 1000 CONTINUE
      PYNN=YNN
      IF(METRIC.EQ.1) PYNN=PYNN/3.281
      IF(JNK.GT.4) WRITE(IPR,1) N,PYNN
    1 FORMAT(/3X,'WATER ELEVATION AT SECTION N= ',I3,2X,3HIS ,F10.2)
 1100 RETURN
      END
