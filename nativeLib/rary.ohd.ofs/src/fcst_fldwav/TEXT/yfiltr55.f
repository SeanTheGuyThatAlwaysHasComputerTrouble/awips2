      SUBROUTINE YFILTR55(PO,CO,Z,STN,LTSTN,ST1,LTST1,T1,LTT1,POLH,
     . LTPOLH,ITWT,LTITWT,JNK,MIXF,NJUN,NB,NQCM,IFR,YDI,YUMN,QDI,
     . X,DDX,HS,AS,BS,YN,YCR,KRCH,KU,KD,SLFI,MRV,IORDR,K1,K2,K6,
     . K7,K8,K9,K15,K16,K19,K20,K21)
C
      COMMON/M155/NU,JN,JJ,KIT,G,DT,TT,TIMF,F1
      COMMON/M3055/EPSY,EPSQ,EPSQJ,THETA,XFACT
      COMMON/SS55/NCS,A,B,DB,R,DR,AT,BT,P,DP,ZH
      COMMON/MIXX55/MIXFLO,DFR,FRC
      COMMON/METR55/METRIC
      COMMON/PRES55/KPRES
      COMMON/KREV55/KREVRS
      COMMON/IONUM/IN,IPR,IPU
        COMMON/NETWK55/NET

      INCLUDE 'common/fdbug'
      INCLUDE 'common/ofs55'
C
      DIMENSION PO(*),CO(*),Z(*),STN(*),ST1(*),LTST1(*),T1(*)
      DIMENSION LTT1(*),POLH(*),LTPOLH(*),ITWT(*),LTITWT(*),MIXF(K1)
      DIMENSION NJUN(K1),NB(K1),NQCM(K1),IFR(K2,K1)
      DIMENSION YDI(K2,K1),YUMN(K2,K1),QDI(K2,K1),X(K2,K1)
      DIMENSION DDX(K2,K1),HS(K9,K2,K1),AS(K9,K2,K1),BS(K9,K2,K1)
      DIMENSION YN(K2,K1),YCR(K2,K1),MRV(K1),IORDR(K1)
      DIMENSION KRCH(K2,K1),KU(K1),KD(K1),SLFI(K2,K1)
      CHARACTER*8 SNAME
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_fldwav/RCS/yfiltr55.f,v $
     . $',                                                             '
     .$Id: yfiltr55.f,v 1.2 2000/12/19 15:57:32 dws Exp $
     . $' /
C    ===================================================================
C

      DATA SNAME/ 'YFILTR55' /
C
      CALL FPRBUG(SNAME,1,55,IBUG)

C      WRITE(IPR,11110)
11110 FORMAT(1X,'** ENTER YFILTR **')
      DQDT=0.0
C  IF NO DAMS, LOW FILTER DEPTH EQUALS TO INITIAL WATER DEPTH
C  IF THERE DAMS, ASSUME ALL DAMS FAIL TO ITS LOWEST POINT
      IDAM=0
      DO 310 J=1,JN
      N=NB(J)
      DO 310 I=1,N
      KRA=IABS(KRCH(I,J))
      IF(KRA.LT.10 .OR. KRA.GT.30) GO TO 310
      IDAM=1
      GO TO 320
  310 CONTINUE
  320 IF(IDAM.EQ.1 .AND. KREVRS.LE.0) GO TO 340
      DO 330 J=1,JN
      N=NB(J)
      DO 330 I=1,N
  330 YUMN(I,J)=YDI(I,J)
      GO TO 430
C  THERE IS A DAM; COMPUTE LOW FILTER DEPTH!
  340 DO 300 M=1,JN
      J=IORDR(M)
      J1=MRV(J)
      JJ=J
      IF (JNK.GT.4) WRITE(IPR,1314) J
 1314 FORMAT(/1X,'** COMPUTE WATER DEPTH FOR LOW FLOW FILTER ',
     & 'FOR RIVER NO ',I2,' **')
      N=NB(J)
      NM=N-1
      NCML=ABS(NQCM(J))
      IF(NCML.EQ.0) NCML=NCS
CCC      ITRBW=0
      ITQ=0
C
      DYC=0.02
      DO 10 I=1,N
      QO=QDI(I,J)
      YDUM=0.0
      IF(BS(1,I,J).GT.0.0) YDUM=AS(1,I,J)/BS(1,I,J)
      YMN=HS(1,I,J)-YDUM
      YMX=HS(NCS,I,J)
      IF(MIXF(J).EQ.1) GO TO 5
      IDUM=I
      IF(IDUM.GE.NM) IDUM=NM
      IDUM1=IDUM+1
      IRCH=IDUM
      DYNX=0.5*(HS(1,IDUM,J)-HS(1,IDUM1,J))
      IF(I.GE.N) DYNX=-DYNX
      SO=SLFI(IRCH,J)
      GO TO 6
    5 IDUM=I
      IF(IDUM.LE.2) IDUM=2
      IDUMM=IDUM-1
      IRCH=IDUMM
      DYNX=-0.5*(HS(1,IDUMM,J)-HS(1,IDUM,J))
      SO=SLFI(IRCH,J)
    6 YNN=-999.0
      CALL HNORM55(PO,JNK,NCML,NQCM,J,I,IRCH,YNN,QO,SO,YMN,YMX,DYNX,
     1 ITN,K1,K2,K7,K8,K9)
      DEPN=YNN-HS(1,I,J)
      YN(I,J)=YNN
      YDUM=0.0
      IF(BS(1,I,J).GT.0.0) YDUM=AS(1,I,J)/BS(1,I,J)
      YMN=HS(1,I,J)-YDUM
      YMX=HS(NCS,I,J)
      YC=-999.0
      CALL HCRIT55(PO,JNK,J,I,YC,QO,YMN,YMX,ITC,K1,K2,K9)
      DEPC=YC-HS(1,I,J)
      YCR(I,J)=YC
      IF(YN(I,J).GT.YC+DYC) IFR(I,J)=0
      IF(YN(I,J).LE.YC+DYC) IFR(I,J)=1
      PYN=YNN
      PYC=YC
      XI=X(I,J)
      IF(METRIC.EQ.0) GO TO 207
      XI=XI*1.6093
      PYN=YNN/3.281
      PYC=YC/3.281
      DEPN=DEPN/3.281
      DEPC=DEPC/3.281
  207 IF(MIXF(J).EQ.0) IFR(I,J)=0
      IF(MIXF(J).EQ.1) IFR(I,J)=1
      IF(JNK.GT.4) WRITE(IPR,9) I,XI,PYN,DEPN,PYC,DEPC,IFR(I,J),ITN,ITC
    9 FORMAT(3X,2HI=,I5,3X,2HX=,F8.3,3X,3HYN=,F10.2,3X,5HDEPN=,F10.2,3X,
     * 3HYC=,F10.2,3X,5HDEPC=,F10.2,3X,4HIFR=,I2,2X,4HITN=,I5,2X,
     *  4HITC=,I5)
      IF(SLFI(I,J).LE.0.000001) IFR(I,J)=0
   10 CONTINUE
      IF(JNK.GT.4) WRITE(IPR,111)
      IF(JNK.GT.4) WRITE(IPR,11) (IFR(I,J),I=1,N)
   11 FORMAT(10I5)
  111 FORMAT(//10X,'(IFR(I,J),I=1,N)')
C  CHECK TO SEE IF MAIN RIVER WATER DEPTH CAN DROWN-OUT
C  UPSTREAM SUPERCRITICAL ELEV. AT TRIBUTARY RIVER J
      IPIFR=0
      IF(J.LE.1) GO TO 14
      IF(KU(J).EQ.0) GO TO 14
      I1=NJUN(J)
      YT=0.5*(YUMN(I1,J1)+YUMN(I1+1,J1))
      DO 1100 I=1,N
      II=N-I+1
      IF(YT.LE.YN(II,J)) GO TO 14
      IFR(II,J)=0
 1100 CONTINUE
   14 DO 1114 I=2,NM
      IM1=I-1
      IP1=I+1
      IF(IFR(IM1,J).EQ.0.AND.IFR(I,J).EQ.1.AND.IFR(IP1,J).EQ.0)
     * GO TO 1112
      IF(IFR(IM1,J).EQ.1.AND.IFR(I,J).EQ.0.AND.IFR(IP1,J).EQ.1)
     * GO TO 1113
      GO TO 1114
 1112 IFR(I,J)=0
      IPIFR=1
      GO TO 1114
 1113 IFR(I,J)=1
      IPIFR=1
 1114 CONTINUE
      IF(IFR(NM,J).NE.IFR(N,J)) IFR(N,J)=IFR(NM,J)
      IF(JNK.GT.4.AND.IPIFR.EQ.1) WRITE(IPR,11) (IFR(I,J),I=1,N)
      IND=N
      IS=N
  100 IF(IFR(IND,J).EQ.1) GO TO 160
  110 IS=IS-1
      IF(IS.EQ.1) GO TO 112
      IF(IFR(IS,J).EQ.0) GO TO 110
C      COMPUTE BACKWATER
      IS=IS+1
  112 IF(IND.EQ.N) GO TO 113
      YNN=YCR(IND,J)
      GO TO 117
  113 IF(KD(J).NE.0) GO TO 115
      II=NJUN(J)
      YNN=0.5*(YUMN(II,J1)+YUMN(II+1,J1))
      GO TO 117
C      SELECT STARTING ELEVATION AT END OF REACH
  115 QN=QDI(N,J)
      YNN=YN(N,J)
      QNM=QDI(NM,J)
      KDD=KD(J)
      IF(KDD.NE.4) GO TO 116
      IL=NM
      IR=N
      QIL=QDI(IL,J)
      QIR=QDI(IR,J)
      YIR=YN(IR,J)
      DX=DDX(IL,J)
      YMN=YCR(IL,J)
      YIL=YMN
      YMX=HS(NCS,IL,J)+0.5*(HS(NCS,IL,J)-HS(1,IL,J))
      Y1=YN(IL,J)+2.
      CALL BWATR55(PO,JNK,NCML,NQCM,J,IR,IL,QIR,QIL,YIR,YIL,DX,Y1,
     1 YMX,DQDT,ITB,K1,K2,K7,K8,K9)
  116 S0A=SLFI(N,J)
      IFRN=IFR(N,J)
      CALL YEND55(PO,JNK,J,NCML,NQCM,NB,PO(LOHS),KD,STN,LTSTN,PO(LOYQD),
     * PO(LOQYQD),QNM,QN,YNN,IFRN,YCR,DX,QIL,QIR,YIL,YIR,S0A,K1,K2,
     * K6,K7,K8,K9)
      IF(KDD.NE.4) GO TO 117
      DHL=YIL-HS(1,IL,J)
      DHR=YIR-HS(1,IR,J)
      DHA=ABS(DHL-DHR)
      IF(DHA.LE.2.*EPSY) GO TO 117
      IND=NM
      YUMN(N,J)=YIR
      YNN=YIL
  117 DEP=YNN-HS(1,IND,J)
      YUMN(IND,J)=YNN
      PYN=YUMN(IND,J)
      PDEP=PYN-HS(1,IND,J)
      IF(METRIC.EQ.1) THEN
        PYN=PYN/3.281
        PDEP=PDEP/3.281
      ENDIF
      IF(JNK.GT.4) WRITE(IPR,133) IND,PYN,PDEP
  133 FORMAT(//5X,'BACKWATER',5X,4HIND=,I3,5X,4HYNN=,F10.2,5X,4HDEP=,
     . F10.2)
      IT=IND-IS
      DO 120 I=1,IT
      IR=IND-I+1
      IL=IR-1
      IF (IL.EQ.0) GOTO 120
      KRA=IABS(KRCH(IL,J))
      QIL=QDI(IL,J)
      QIR=QDI(IR,J)
      YIR=YUMN(IR,J)
      DX=DDX(IL,J)
      YMN=YCR(IL,J)
      YIL=YMN
      YMX=HS(NCS,IL,J)+0.5*(HS(NCS,IL,J)-HS(1,IL,J))
      DYX=0.
      IF(I.GE.2) GO TO  512
      KRAA=0
      IF(KRCH(1,J).GE.10.AND.KRCH(1,J).LE.30) KRAA=1
      IF(KRAA.EQ.1) GO TO 512
      Y1=YN(IL,J)+2.
      GO TO  516
CC  512 KRA=IABS(KRCH(IR,J))
  512 IF(KRA.LT.10 .OR. KRA.GT.30) GO TO  514
      Y1=YUMN(IR,J)
      GO TO  516
  514 IF(DDX(IR,J) .GE. 0.0001)
     1 DYX=(YUMN(IR,J)-YUMN(IR+1,J))/DDX(IR,J)
      Y1=YUMN(IR,J)+DYX*DDX(IL,J)+2.
      IF(Y1.LE.YCR(IL,J)) Y1=YCR(IL,J)+2.
  516 YLS=Y1
      YRS=YIR
CCC      KRA=IABS(KRCH(IL,J))
      IF(KRA.LT.10) GO TO 518
      IF(KRA.LE.30) GO TO 517
C  BRIDGE OR CRITICAL FLOW BOUNDARY
      CALL INTBI55(PO,CO,Z,ST1,LTST1,T1,LTT1,POLH,LTPOLH,ITWT,LTITWT,
     . NCML,ITQ,2,IL,J,QIR,YLS,YRS,KRCH,Z(LZYU),HS,YCR,
     . K1,K2,K7,K8,K9,K15,K16,K19,K20,K21)
      YIL=YLS
      GO TO 526
C  DAM -- ASSUME IT IS REMOVED
  517 YIL=YUMN(IR,J)
      IF(YIL.LE.YCR(IL,J)) YIL=YCR(IL,J)
      YUMN(IL,J)=YIL
      GO TO 526
C  SKIP BACKWATER COMPUTATION IF DIFFERENCE BETW REGULAR BACKWATER
C  AND LOW FILTER BACKWATER IS LESS THAN 0.004 FEET
  518 DUMY=ABS(YDI(IR,J)-YUMN(IR,J))
      IF(DUMY.GE.0.004) GO TO 524
      ITB=0
      YIL=YDI(IL,J)
      KRA=IABS(KRCH(IL,J))
      IF(KRA.GE.10 .AND. KRA.LE.30) YIL=YUMN(IR,J)
      YUMN(IL,J)=YIL
      GO TO 526
  524 CALL BWATR55(PO,JNK,NCML,NQCM,J,IR,IL,QIR,QIL,YIR,YIL,DX,Y1,
     1 YMX,DQDT,ITB,K1,K2,K7,K8,K9)
  526 DEP=YIL-HS(1,IL,J)
      YUMN(IL,J)=YIL
      IF(JNK.LE.4) GO TO 120
      PQIL=QIL
      PYIL=YIL
      PDEP=DEP
      IF(METRIC.EQ.1) THEN
        PQIL=PQIL/35.32
        PYIL=PYIL/3.281
        PDEP=PDEP/3.281
      ENDIF
      IF(JNK.GT.4) WRITE(IPR,216) IL,PQIL,PYIL,PDEP,ITB
  216 FORMAT(10X,2HI=,I3,5X,4HQIL=,F10.0,5X,4HYIL=,F10.2,5X,4HDEP=,
     *  F10.2,5X,4HITB=,I3)
  120 CONTINUE
      IND=IND-IT-1
      IS=IND
      IF(IS.GT.1) GO TO 100
      GO TO 200
C      COMPUTE DOWNWATER
  160 IS=IS-1
      IF(IS.EQ.0) GO TO 162
      IF(IFR(IS,J).EQ.1) GO TO 160
  162 IS=IS+1
      IF(IS.EQ.1) THEN
        YUMN(1,J)=YN(1,J)
        GO TO 164
      END IF
      YUMN(IS,J)=YCR(IS,J)
CC      IF(IS.EQ.1) YUMN(1,J)=YN(1,J)
  164 PYN=YUMN(IS,J)
      PDEP=PYN-HS(1,IS,J)
      IF(METRIC.EQ.1) THEN
        PYN=PYN/3.281
        PDEP=PDEP/3.281
      ENDIF
      IF(JNK.GT.4) WRITE(IPR,143) IS,PYN,PDEP
  143 FORMAT(//5X,'DOWNWATER',5X,4HIND=,I3,5X,4HYNN=,F10.2,5X,4HDEP=,
     . F10.2)
      IS=IS+1
      DO 170 I=IS,IND
      IR=I
      IL=I-1
      KRA=IABS(KRCH(IL,J))
      QIL=QDI(IL,J)
      QIR=QDI(IR,J)
      YIL=YUMN(IL,J)
      DX=DDX(IL,J)
      YRS=0.5*(HS(1,IR,J)+YIL)
      YLS=YIL
      IF(KRA.LT.10) GO TO 168
      IF(KRA.LE.30) GO TO 167
C  BRIDGE OR CRITICAL FLOW BOUNDARY
      CALL INTBI55(PO,CO,Z,ST1,LTST1,T1,LTT1,POLH,LTPOLH,ITWT,LTITWT,
     . NCML,ITQ,3,IL,J,QIR,YLS,YRS,KRCH,Z(LZYU),
     * HS,YCR,K1,K2,K7,K8,K9,K15,K16,K19,K20,K21)
      YUMN(IR,J)=YRS
      GO TO 170
C  DAM -- ASSUME IT IS REMOVED
  167 YUMN(IR,J)=YN(IR,J)
      GO TO 170
  168 YDUM=0.0
      IF(BS(1,I,J).GT.0.0) YDUM=AS(1,I,J)/BS(1,I,J)
      YMN=HS(1,I,J)-YDUM
      YMX=YCR(I,J)
      YIR=YMN
      Y1=YN(IR,J)
      CALL DWATR55(PO,JNK,NCML,NQCM,J,IL,IR,QIL,QIR,YIL,YIR,DX,Y1,YMX,
     1 DQDT,ITD,K1,K2,K7,K8,K9)
      DEP=YIR-HS(1,IR,J)
      YUMN(IR,J)=YIR
      IF(JNK.LE.4) GO TO 170
      PQIR=QIR
      PYIR=YIR
      PDEP=DEP
      IF(METRIC.EQ.1) THEN
        PQIR=PQIR/35.32
        PYIR=PYIR/3.281
        PDEP=PDEP/3.281
      ENDIF
      IF(JNK.GT.4) WRITE(IPR,217) IR,PQIR,PYIR,PDEP,ITD
  217 FORMAT(10X,2HI=,I3,5X,4HQIR=,F10.0,5X,4HYIR=,F10.2,5X,
     *  4HDEP=,F10.2,5X,4HITD=,I3)
  170 CONTINUE
      IF(IS.EQ.2) GO TO 200
      IND=IS-1
      IS=IND
      GO TO 110
C     CHECK FOR SUBMERGENCE OF UPSTREM YI DUE TO D/S YI
C
  200 ISUB=0
      DO 205 II=1,NM
      I=N-II
      IP=I+1
      IF(YUMN(IP,J).LT.YUMN(I,J)) GO TO 205
      IF(IFR(I,J).EQ.0) GO TO 205
      YSUP=YUMN(I,J)
      QQ=QDI(I,J)
      YDUM=0.0
      IF(BS(1,I,J).GT.0.0) YDUM=AS(1,I,J)/BS(1,I,J)
      YMN=HS(1,I,J)-YDUM
      YMX=HS(NCS,I,J)
      CALL HSEQ55(PO,JNK,J,I,QQ,YSUP,YSEQ,YMN,YMX,ITS,K1,K2,K9)
      IF(YUMN(IP,J).LT.YSEQ) GO TO 205
      ISUB=1
      IFR(I,J)=0
      YUMN(I,J)=YUMN(IP,J)
  205 CONTINUE
      IF(ISUB.EQ.1) GO TO 14
C  IF LEVEL POOL ROUTING USED
C  RESET YUMN AT IMMEDIATE UPSTREAM OF DAM
      DO 211 I=1,NM
      IP=I+1
  211 IF(KRCH(IP,J).LT.0) YUMN(I,J)=YUMN(IP,J)
  300 CONTINUE
  430 CONTINUE
      IF (JNK.LE.4) GOTO 999
      WRITE(IPR,499)
  499 FORMAT(//1X,'WATER ELEVATION FOR LOW FILTER:')
      DO 420 J=1,JN
      WRITE(IPR,490) J
  490 FORMAT(/5X,'YUMN FOR RIVER ',I3)
      N=NB(J)
        DO 489 I=1,N
          IF(YDI(I,J).LT.YUMN(I,J)) YUMN(I,J)=YDI(I,J)
  489   CONTINUE

      CALL WYQMET55(METRIC,1,N,YUMN(1,J),1,N)
  491 FORMAT(5X,8F10.2)
  420 CONTINUE

      IF(JNK.LT.4) GO TO 999
      DO 2000 J=1,JN+NET
        WRITE(IPR,1500) J
 1500   FORMAT(//20X,'INITIAL CONDITIONS FOR RIVER NO.',I3//
     .   4X,'I',4X,'DISTANCE',4X,'FLOW',4X,'WSEL',6X,'DEPTH',3X,
     .   'MIN WSEL',3X,'BOTTOM')

         IF(METRIC.EQ.0) WRITE(IPR,1502)
 1502    FORMAT(11X,4HMILE,7X,3HCFS,5X,2HFT,8X,2HFT,8X,2HFT,8X,2HFT)
         IF(METRIC.EQ.1) WRITE(IPR,1504)
 1504    FORMAT(12X,2HKM,7X,3HCMS,7X,1HM,9X,1HM,9X,1HM,9X,1HM)
        N=NB(J)
        DO 1510 I=1,N
          XDIST=X(I,J)
          QFLOW=QDI(I,J)
          YLEVL=YDI(I,J)
          YMNN=YUMN(I,J)
          BOTM=HS(1,I,J)
          IF(METRIC.EQ.1) THEN
            XDIST=XDIST*1.6093
            QFLOW=QFLOW/35.32
            YLEVL=YLEVL/3.281
            YMNN=YMNN/3.281
            BOTM=BOTM/3.281
          ENDIF
          DEP=YLEVL-BOTM
          WRITE(IPR,1506) I,XDIST,QFLOW,YLEVL,DEP,YMNN,BOTM
 1506     FORMAT(I5,F10.3,F10.0,4F10.3)
 1510   CONTINUE
 2000 CONTINUE

C      WRITE(IPR,11111)
11111 FORMAT(1X,'** EXIT YFILTR **')
999   RETURN
      END
