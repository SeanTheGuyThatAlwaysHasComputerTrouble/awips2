C MODULE SMGBOX
C-----------------------------------------------------------------------
C
C  ROUTINE TO OUTPUT GRID BOX PARAMETERS.
C
      SUBROUTINE SMGBOX (LARRAY,ARRAY,OUTPUT,SUMARY,SORT,NFLD,ISTAT)
C
C
      REAL XGBOX/4HGBOX/
      REAL XALL/4HALL /
      REAL NO/4HNO  /
      REAL BYID/4HID  /,BYNUM/4HNUM /
      REAL QUES/4H????/
      REAL MDR/4HMDR /,MDRT/4HMDRT/
      REAL PRNT/4HPRNT/,PNCH/4HPNCH/,BOTH/4HBOTH/
C
      DIMENSION ARRAY(LARRAY),ISWORK(1)
      DIMENSION CHAR(5),CHK(5)
      DIMENSION UNUSED(10)
      INCLUDE 'scommon/dimgbox'
C
      INCLUDE 'uio'
      INCLUDE 'udebug'
      INCLUDE 'scommon/sudbgx'
      INCLUDE 'ufreex'
      INCLUDE 'scommon/suoptx'
      INCLUDE 'scommon/sworkx'
C
      EQUIVALENCE (SWORK(1),ISWORK(1))
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/ppinit_dump/RCS/smgbox.f,v $
     . $',                                                             '
     .$Id: smgbox.f,v 1.3 1998/07/06 12:41:42 page Exp $
     . $' /
C    ===================================================================
C
C
C
      IF (ISTRCE.GT.0) WRITE (IOSDBG,310)
      IF (ISTRCE.GT.0) CALL SULINE (IOSDBG,1)
C
C  SET DEBUG LEVEL
      LDEBUG=ISBUG(4HDUMP)
C
      ISTAT=0
C
      LCHAR=5
      LCHK=5
      ILPFND=0
      IRPFND=0
      NUMERR=0
      NUMWRN=0
      NUMOPT=0
      IDLIST=0
      IALL=0
      LPUNCH=NPUCRD
      IDEFLT=0
      IENDIN=0
C
      NGBOX=0
C
C  SET INDICATOR TO REREAD CURRENT FIELD
      ISTRT=-1
C
C  CHECK SORT OPTION
      ISORT=0
      IF (SORT.EQ.BYID) ISORT=1
      IF (SORT.EQ.BYNUM) ISORT=3
      IF (ISORT.EQ.1.OR.ISORT.EQ.3) GO TO 20
         WRITE (LP,10) SORT
10    FORMAT ('0*** WARNING - SORT BY ',A4,' NOT AVAILABLE. SORT ',
     *   'OPTION SET TO ID.')
         CALL SUWRNS (LP,2,NUMWRN)
         ISORT=1
C
C  PRINT HEADER LINE
20    IF (ISLEFT(10).GT.0) CALL SUPAGE
      WRITE (LP,320)
      CALL SULINE (LP,2)
      WRITE (LP,540)
      CALL SULINE (LP,1)
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK FIELDS FOR DUMP GBOX OPTIONS
C
30    CALL UFIELD (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,REAL,LCHAR,
     *   CHAR,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,IERR)
      IF (NFLD.EQ.-1) GO TO 70
      IF (LDEBUG.GT.0)
     * CALL UPRFLD (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,REAL,LCHAR,
     *   CHAR,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,IERR)
      IF (IERR.NE.1) GO TO 40
         IF (LDEBUG.GT.0) WRITE (IOSDBG,440) IFIELD
         IF (LDEBUG.GT.0) CALL SULINE (IOSDBG,1)
         GO TO 30
C
40    IF (LDEBUG.GT.0) WRITE (IOSDBG,450) CHAR
      IF (LDEBUG.GT.0) CALL SULINE (IOSDBG,1)
C
      CALL SUPFND (ILPFND,IRPFND,NFLD,0)
      IF (LLPAR.GT.0) ILPFND=1
C
      IF (LRPAR.GT.0) IRPFND=1
C  CHECK FOR PARENTHESIS IN FIELD
      IF (LLPAR.GT.0) CALL UFPACK (LCHK,CHK,ISTRT,1,LLPAR-1,IERR)
      IF (LLPAR.EQ.0) CALL UFPACK (LCHK,CHK,ISTRT,1,LENGTH,IERR)
C
C  CHECK IF 'ALL' OPTION SPECIFIED
      IF (CHK(1).NE.XALL) GO TO 50
         IALL=1
         IDLIST=0
         GO TO 110
C
C  CHECK FOR GROUP
50    CALL SUIDCK (4HDUMP,CHK,NFLD,0,IKEYWD,IERR)
      IF (IERR.EQ.0) GO TO 60
         GO TO 70
C
C  CHECK FOR COMMAND
60    IF (LATSGN.EQ.0) GO TO 80
70       IENDIN=1
         IF (IALL.EQ.1) GO TO 260
         IF (IDLIST.EQ.1) GO TO 240
         IALL=1
         GO TO 115
C
C  CHECK FOR INVALID DUMP OPTION
80    IF (IALL.EQ.0) GO TO 90
         WRITE (LP,410) CHAR
         CALL SUERRS (LP,2,NUMERR)
         IALL=0
         GO TO 30
C
C  SET GRID BOX IDENTIFIER
90    IF (LENGTH.LE.8) GO TO 100
         WRITE (LP,460) LENGTH,CHAR
         CALL SUWRNS (LP,2,NUMWRN)
100   CALL SUBSTR (CHAR,1,8,GBOXID,1)
      IALL=0
      IDLIST=1
      GO TO 120
C
110   IF (NFLD.EQ.1) CALL SUPCRD
      IF (IOPNWP.EQ.1.AND.NFLD.EQ.1) CALL SUPAGE
C
115   IF (LDEBUG.GT.0) WRITE (IOSDBG,340) IALL
      IF (LDEBUG.GT.0) CALL SULINE (IOSDBG,1)
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
120   IPRERR=0
      IPTR=0
      IPTRNX=0
      NUMID=0
C
C  CHECK IF ALL OPTION SPECIFIED
      IF (IALL.EQ.0) GO TO 160
C
      IXSORT=ISORT
      IF (IXSORT.EQ.0) GO TO 150
         IPRERR=0
         ISTATE=0
         IF (IXSORT.EQ.0.OR.IXSORT.EQ.1) NWORDS=2
         IF (IXSORT.EQ.2) NWORDS=5
         MAXID=LSWORK/(NWORDS+1)
         ISWORK(MAXID*NWORDS+1)=1
         IPRMSG=1
         CALL SURIDS (XGBOX,IXSORT,MAXID,ISTATE,NWORDS,
     *      ISWORK,ISWORK(MAXID*NWORDS+1),NUMID,
     *      LARRAY,ARRAY,IPRMSG,IPRERR,IERR)
         IF (IERR.EQ.0) GO TO 140
            IF (IERR.NE.2) GO TO 130
               WRITE (LP,480)
               CALL SULINE (LP,2)
               GO TO 240
130         WRITE (LP,470)
            CALL SUWRNS (LP,2,NUMWRN)
            IXSORT=0
140      INWFIL=0
C
150   CALL UREPET (1H ,GBOXID,8)
      IF (IXSORT.EQ.0) IPTR=IPTRNX
      IF (IXSORT.GT.0) IPTR=ISWORK(MAXID*NWORDS+NGBOX+1)
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  READ GRID BOX PARAMETERS
C
160   CONTINUE
      INCLUDE 'scommon/callsrgbox'
      IF (IERR.EQ.0) GO TO 190
         IF (IALL.EQ.0) GO TO 170
            IF (IERR.EQ.6) GO TO 220
            IF (NUMID.GT.0) GO TO 240
               WRITE (LP,510)
               CALL SULINE (LP,2)
               GO TO 240
170      IF (IERR.EQ.2) GO TO 180
            CALL SRPPST (GBOXID,XGBOX,IPTR,LARRAY,0,IPTRNX,IERR)
            WRITE (LP,530) IERR
            CALL SUERRS (LP,2,NUMERR)
            GO TO 240
180      WRITE (LP,520) GBOXID
         CALL SUWRNS (LP,2,NUMERR)
         GO TO 240
C
190   IF (SUMARY.EQ.NO) GO TO 200
C
C  PRINT SUMARY
C
      IF (NGBOX.EQ.0.AND.ISLEFT(10).GT.0) CALL SUPAGE
      IF (NGBOX.EQ.0) WRITE (LP,490)
      IF (NGBOX.EQ.0) CALL SULINE (LP,3)
      XMDR=QUES
      IF (IBXMDR.EQ.0) XMDR=MDR
      IF (IBXMDR.EQ.1) XMDR=MDRT
      IF (ISNWPG(LP).EQ.1) WRITE (LP,490)
      IF (ISNWPG(LP).EQ.1) CALL SULINE (LP,4)
      NUM=NGBOX+1
      WRITE (LP,500) NUM,GBOXID,NUGBOX,BOXLOC(1),BOXLOC(2),IBXADJ,XMDR
      CALL SULINE (LP,1)
      IF (ISNWPG(LP).EQ.1) WRITE (LP,490)
      IF (ISNWPG(LP).EQ.1) CALL SULINE (LP,4)
      GO TO 210
C
200   IF (OUTPUT.NE.PRNT.AND.OUTPUT.NE.BOTH) GO TO 210
      INCLUDE 'scommon/callspgbox'
C
210   IF (OUTPUT.EQ.PNCH.OR.OUTPUT.EQ.BOTH)
     *   CALL SCGBOX (IVGBOX,GBOXID,NUGBOX,BOXLOC,IBXADJ,IBXMDR,IERR)
C
220   NGBOX=NGBOX+1
C
      GO TO 230
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C
C  CHECK IF ALL GRID BOXES PROCESSED
230   IF (IALL.EQ.0) GO TO 240
         IF (IXSORT.GT.0.AND.NGBOX.EQ.NUMID) GO TO 240
         IF (IXSORT.EQ.0.AND.IPTRNX.EQ.0) GO TO 240
         GO TO 150
C
240   NUMOPT=NUMOPT+1
C
250   IF (IENDIN.EQ.1) GO TO 260
C
C  CHECK IF 'ALL' DEFAULTED
      IF (IENDIN.EQ.0.AND.IDEFLT.EQ.1.AND.NFLD.EQ.1) CALL SUPCRD
      IF (IDEFLT.EQ.1) IALL=0
      GO TO 30
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C  CHECK NUMBER OF OPTIONS PROCESSED
260   IF (NUMOPT.GT.0) GO TO 270
         WRITE (LP,550)
         CALL SULINE (LP,2)
C
270   IF (OUTPUT.EQ.PRNT) GO TO 280
C
C  PRINT NUMBER OF CARD IMAGES OUTPUT
      NPUNCH=NPUCRD-LPUNCH
      IF (NPUNCH.GT.0) WRITE (LP,560) NPUNCH
      IF (NPUNCH.GT.0) CALL SULINE (LP,2)
C
280   IF (NGBOX.EQ.0) WRITE (LP,570)
      IF (NGBOX.GT.0) WRITE (LP,580) NGBOX
      CALL SULINE (LP,2)
C  CHECK NUMBER OF ERRORS ENCOUNTERED
290   IF (NUMERR.EQ.0) GO TO 300
         WRITE (LP,590) NUMERR
         CALL SULINE (LP,2)
C
300   IF (ISTRCE.GT.0) WRITE (IOSDBG,600)
      IF (ISTRCE.GT.0) CALL SULINE (IOSDBG,1)
C
      RETURN
C
C- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
310   FORMAT (' *** ENTER SMGBOX')
320   FORMAT ('0*--> DUMP GRID BOX PARAMETERS')
330   FORMAT ('0*** NOTE - RIGHT PARENTHESIS ASSUMED IN FIELD ',I2,
     *   '.')
340   FORMAT (' IALL=',I1)
350   FORMAT ('0*** WARNING - NO LEFT PARENTHESIS FOUND. SORT OPTION ',
     *   'SET TO ',A8,'.')
360   FORMAT (' SORT OPTION SET TO ',I2)
370   FORMAT ('0*** ERROR - INVALID SORT OPTION : ',5A4)
380   FORMAT ('0*** WARNING - SORT OPTION NOT CURRENTLY AVAILABLE. ',
     *   'SORT OPTION CANCELLED.')
400   FORMAT ('0*** ERROR - PROCESSING OPTION : ',A4)
410   FORMAT ('0*** ERROR - INVALID DUMP GBOX OPTION : ',5A4)
420   FORMAT ('0*** ERROR - ERROR PROCESSING OPTION : ',5A4)
440   FORMAT (' BLANK STRING FOUND IN FIELD ',I2)
450   FORMAT (' INPUT FIELD = ',5A4)
460   FORMAT ('0*** WARNING - NUMBER OF CHARACTERS (',I2,') IN ',
     *   'GRID BOX IDENTIFIER ',5A4,' EXCEEDS 8. THE FIRST 8 ',
     *   'CHARACTERS WILL BE USED.')
470   FORMAT ('0*** WARNING - SORTED LIST OF STATIONS NOT ',
     *   'SUCCESSFULLY OBTAINED. SORT OPTION CANCELLED.')
480   FORMAT ('0*** NOTE - NO GRID BOXES ARE DEFINED.')
490   FORMAT (1H0,
     *   T7,'GBOX ID ',3X,'BOX NUMBER',3X,' LAT  ',3X,' LON  ',3X,
     *      'ADJACENT GRID BOXES',8X,'MDR USAGE OPTION' /
     *   T7,8(1H-),3X,10(1H-),3X,6(1H-),3X,6(1H-),3X,
     *      24(1H-),3X,16(1H-))
500   FORMAT (1H ,I4,1X,2A4,7X,I2,7X,2(F6.2,3X),8(I2,1X),10X,A4)
510   FORMAT ('0*** NOTE - NO GRID BOXES ARE DEFINED.')
520   FORMAT ('0*** WARNING - GRID BOX PARAMETERS FOR IDENTIFIER ',2A4,
     *   ' ARE NOT DEFINED.')
530   FORMAT ('0*** ERROR - IN SMGBOX - UNSUCCESSFUL CALL TO SRGBOX',
     *   ' : STATUS CODE=',I2)
540   FORMAT (1H )
550   FORMAT ('0*** NOTE - NO DUMP GBOX OPTIONS SUCCESSFULLY ',
     *   'PROCESSED.')
560   FORMAT ('0*** NOTE - ',I4,' CARD IMAGES OUTPUT.')
570   FORMAT ('0*** NOTE - NO GRID BOX IDENTIFIERS PROCESSED.')
580   FORMAT ('0*** NOTE - ',I2,' GRID BOX IDENTIFIERS PROCESSED.')
590   FORMAT ('0*** NOTE - ',I3,' ERRORS ENCOUNTERED IN DUMP GBOX ',
     *   'COMMAND.')
600   FORMAT (' *** EXIT SMGBOX')
C
      END
