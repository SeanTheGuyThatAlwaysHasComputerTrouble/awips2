C MODULE VSOLAR
C-----------------------------------------------------------------------
C
C  THIS ROUTINE ESTIMATES SOLAR RADIATION FROM EITHER PERCENT SUNSHINE 
C  OR FROM CLOUD COVER.
C
C  INPUTS:
C    - THE SIN, COSINE, SINSQUARED AND 2SINCOS OF THE SOLAR DECLINATION
C      ANGLE. THESE HAVE BEEN COMPUTED FOR EACH STATION IN ROUTINE VLOC.
C    - FOURIER COEFFICIENTS A0,A1,A2,A3,B1,B2 STORED IN THE PE PARMETERS
C    - INTERNAL POINTERS TO DATASETS
C    - TYPE OF MEASUREMENT RELATED TO SOLAR RADIATION (PERCENT
C      SUNSHINE OR CLOUD COVER.) THIS IS INDICATED BY THE INDEX KQS.
C
C   OUTPUTS:
C     - ESTIMATE OF SOLAR RADIATION IN LANGLEYS
C
      SUBROUTINE VSOLAR (KQS,QS,CLDCVR,PCTSS,PARM,LRY,JPTR,KPARMX)
C
      CHARACTER*8 OLDOPN
      DIMENSION PARM(KPARMX)
      DIMENSION C(12,10)
      COMMON /VSLR/ COSX,SINX,SINSQ,SIN2CS
      COMMON /VTIME/ JDAYO,IYRS,MOS,JDAMOS,IHRO,IHRS,JDAMO,JDAYYR
      INCLUDE 'common/ionum'
      INCLUDE 'common/pudbug'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_mape/RCS/vsolar.f,v $
     . $',                                                             '
     .$Id: vsolar.f,v 1.2 1999/07/06 16:35:32 page Exp $
     . $' /
C    ===================================================================
C
C   DEFINE ARRAY POINTERS.
      DATA  C/4.0,3.0,0.0,-2.0,-4.0,-5.0,-5.0,-4.0
     *,-2.0,0.0,2.0,4.0,3.5,2.5,0.5,-1.5,-3.5,-4.5,-4.0,-3.5,-1.5,0.0
     *,1.5,3.5,3.0,2.0,1.0,-1.0,-3.0,-4.0,-3.0,-3.0,-1.0,0.0,1.0,3.0,
     *3.0,2.5,1.0,-0.5,-2.0,-2.5,-2.0,-2.0,-0.5,0.5,1.5,3.0,3.0,3.0,1.0,
     *0.0,-1.0,-1.0,-1.0,-1.0,0.0,1.0,2.0,3.0,3.0,3.0,1.5,0.5,0.0,-0.5,
     *-0.5,0.0,0.5,1.5,2.5,3.0,3.0,3.0,2.0,1.0,1.0,0.0,0.0,1.0,1.0,2.0,
     *3.0,3.0,2.5,2.5,2.0,1.5,1.5,1.0,1.0,1.5,1.5,2.0,2.5,2.5,2.0,2.0,
     *2.0,2.0,2.0,2.0,2.0,2.0,2.0,2.0,2.0,2.0,1.0,1.0,1.0,1.0,1.0,1.0,
     *1.0,1.0,1.0,1.0,1.0,1.0/
C
C
      IF (IPTRCE.GT.0) WRITE (IOPDBG,*) 'ENTER VSOLAR'
C
      IOPNUM=-1
      CALL FSTWHR ('VSOLAR  ',IOPNUM,OLDOPN,IOLDOP)      
C
      IDEBUG=IPBUG('VSOL')
C    
      IF(IDEBUG.GT.0)WRITE(IOPDBG,20)JPTR
20    FORMAT (' IN VSOLAR: JPTR=',I3)
      IF(IDEBUG.GT.0)WRITE(IOPDBG,30)PARM(JPTR+18),PARM(JPTR+19),
     1 PARM(JPTR+20),PARM(JPTR+21),PARM(JPTR+22),PARM(JPTR+23)
30    FORMAT (' IN VSOLAR: A0=',F8.2,' A1=',F8.2,' A2=',F8.2,
     1 ' A3=',F6.2,' B1=',F6.2,' B2=',F6.2)
C
C  COMPUTE Y100=A0+A1*COSX+A2*(1.0-2.0*SINSQ)+
C               A3*COSX*(1.0-4.0*SINSQ)+B1*SINX+
C               B2*2.0*SINX*COSX
      Y100=PARM(JPTR+18)+PARM(JPTR+19)*COSX+
     1     PARM(JPTR+20)*(1.0-2.0*SINSQ)+
     2     PARM(JPTR+21)*COSX*(1.0-4.0*SINSQ)+
     3     PARM(JPTR+22)*SINX+PARM(JPTR+23)*SIN2CS
      IF (KQS.GT.1) GO TO 80
      IF (CLDCVR.GT.-0.01) GO TO 60
         WRITE (IPR,40) KQS,CLDCVR,PCTSS
40    FORMAT ('0**WARNING** RADIATION TYPE FOR THIS STATION IS SET ',
     1  'TO ',I2,' INDICATING SKY COVER IS TO BE USED. SKY COVER IS ',
     2  F6.2,'.' /
     3 T14,'WILL CHECK TO SEE IF PCT SUNSHINE (',F7.2,') IS AVAILABLE.')
         CALL WARN
         IF (PCTSS.GT.0.01) GO TO 80
         QS=-99.9
         GO TO 190
C
60    QS=Y100*(PARM(JPTR+15)+(1-CLDCVR)**0.61*(1.0-PARM(JPTR+15)))
      IF (IDEBUG.GT.3) WRITE (IOPDBG,70) Y100,PARM(JPTR+15),CLDCVR
70    FORMAT(' IN VSOLAR USING THOMPSON CLOUDCOVER METHOD. '/
     1 ' Y100=',F10.2,' B3=',F4.3,' CLDCVR=',F4.2)
      IF (IDEBUG.GT.0) WRITE (IOPDBG,180) QS,Y100
      GO TO 190
C
80    IF (PCTSS.LT.-0.01) GO TO 100
      IF (PCTSS-96.0) 90,110,110
90    I=(PCTSS+10.0)/10.0
      JX=MOS
      GO TO 120
100   IF(CLDCVR.GT.(-0.01))GO TO 60
      QS=-99.0
      GO TO 190
110   I=1
      JX=3
C
C  SET STARTING AND STOPPING INDICES FOR WRITING OUT THE SOLAR 
C  COMPUTATION CONSTANTS
120   JSTR=JPTR+49
      JEND=JPTR+54
      ALAT=PARM(JPTR+10)
      IF(IDEBUG.GT.0)WRITE(IOPDBG,130)(PARM(KQX),KQX=JSTR,JEND),ALAT
130   FORMAT(' AFTER STATEMENT 120 IN VSOLAR.'/
     1' EXP1=',F8.2,' EXP2=',F8.2,' XLAT1=',F8.2,' XLAT2=',F8.2,
     2' XLAT=',F8.2,' XLAT4=',F8.2,'LAT=',F6.2)
      I=MAX0(I,1)
C
C  CHECK IF THE STATION IS NORTH OF 43 DEG N LAT
      IF(PARM(JPTR+10)-43.0)140,140,150
C
C  EXP1=PARM(49),EXP2=PARM(50)
C  XLAT1=PARM(51),XLAT2=PARM(52),ETC
140   YREDU=PARM(JPTR+51)*PCTSS**PARM(JPTR+49 )+PARM(JPTR+52)+C(JX,I)
      GO TO 160
C
150   YREDU=PARM(JPTR+53)*PCTSS**PARM(JPTR+50)+PARM(JPTR+54)+C(JX,I)
C
160   LR=Y100*YREDU/100.0
      IF(IDEBUG.GT.3)WRITE(IOPDBG,170)Y100,YREDU,PCTSS,C(JX,I)
170   FORMAT(' IN VSOLAR USING HWW % SS METHOD: ',
     1 ' Y100=',F8.2,' YREDU=',F10.3,' PCTSS=',F5.0,' C=',F6.2)
      QS=LR
      IF(IDEBUG.GT.0)WRITE(IOPDBG,180)QS,Y100,I
180   FORMAT(' IN VSOLAR: QS=',F8.2,' Y100=',F8.2,' I=',I5)
C
190   CALL FSTWHR (OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      IF (IPTRCE.GT.0) WRITE(IOPDBG,*) 'EXIT VSOLAR'
C
      RETURN
C
      END
