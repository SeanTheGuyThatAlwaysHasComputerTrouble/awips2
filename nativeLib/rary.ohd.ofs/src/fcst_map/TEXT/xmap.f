C MODULE XMAP
C-----------------------------------------------------------------------
C
      SUBROUTINE XMAP (TSMAP,LTSMAP,WKBUF,LWBF,TMPREC,WORK,NX,LWORK,
     1 IERR)
C.......................................
C     THIS ROUTINE READS THE DATA FOR EACH MAP AREA FOR EACH DAY
C       FROM THE TEMPORARY FILES, COMPUTES THE MAP TIME SERIES, AND
C       WRITES THE TIME SERIES TO THE PDB.
C.......................................
C     WRITTEN BY -- ERIC ANDERSON, HRL -- MARCH 1983
C.......................................
      CHARACTER*4 TSUNT,TSUNTW
      INTEGER*2 MSNG24,MSNG6,MSGMDR,MSNGSR
      DIMENSION TSMAP(LTSMAP),TMPREC(1),WORK(1),WKBUF(1)
      DIMENSION SNAME(2),AREAID(2),AREADS(5),BASNID(2),ND(12)
C
C     COMMON BLOCKS
      COMMON/PUDBUG/IOPDBG,IPTRCE,NDBUG,PDBUG(20),IPALL
      COMMON/WHERE/IA(2),IND,SUB(2)
      COMMON/FCTIME/IZDA,IJHRUN,LZDA,LJHRUN,LZDOBS,LJHOBS,NOW(5),
     1 LOCAL,NOUTZ,NOUTDS,NLSTZ,IDA,IHR,LDA,LHR,IZHHDA
      COMMON/XSIZE/NMAP,NDUPL,NSLT24,NSLOT6,LDATA6,LMDR,LPPSR,
     1 MSNG24,MSNG6,MSGMDR,MSNGSR,NRECTP,MXTEMP,SMALL
      COMMON/XOPT/IXTYPE,XNAME(2),IESTPX,ICONVC,CNVDIS,CVNISW,NOEST6,
     1 IUSESR,PPUSER(2),IMOSUM,IMOWTR,IWTEST
      COMMON/IONUM/IN,IPR,IPU
      COMMON/XDISPL/MDRPRT,MDRCOM,IPRT24,IPLT24,IPRT6,IPRSSR,
     1 IPRSRW,MAPPRT,METRIC,LASTDY,IPRDAY,IPLTMP
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/ofs/src/fcst_map/RCS/xmap.f,v $
     . $',                                                             '
     .$Id: xmap.f,v 1.4 1999/01/20 13:41:44 page Exp $
     . $' /
C    ===================================================================
C
C
C     DATA STATEMENTS
      DATA SNAME/4HXMAP,4H    /
      DATA AMAP,UNIT/4HMAP ,4HIN  /
      DATA ND/31,28,31,30,31,30,31,31,30,31,30,31/
      DATA BASN/4HBASN/
      DATA REWT/4HREWT/
      DATA XBSN,XRTF,XWPR/4HXBSN,4HXRTF,4HXWPR/
C.......................................
C     CHECK TRACE LEVEL
      IF(IPTRCE.GE.1) WRITE(IOPDBG,900)
  900 FORMAT(' ** XMAP ENTERED')
C.......................................
C     SET WHERE COMMON BLOCK
      IND=-1
      SUB(1)=SNAME(1)
      SUB(2)=SNAME(2)
C.......................................
C     CHECK FOR DEBUG OUTPUT
      IBUG=0
      IF(IPBUG(AMAP).EQ.1) IBUG=1
      JBUG=0
      IF (IPBUG(XBSN).EQ.1) JBUG=1
      KBUG=0
      IF (IPBUG(XRTF).EQ.1) KBUG=1
      LBUG=0
      IF (IPBUG(XWPR).EQ.1) LBUG=1
C.......................................
C     INITIAL VALUES
      IERR=0
      NDAYS=LZDA-IZDA+1
      MX=NX+LWORK-1
      IREC=0
C
C     VALUES NEEDED BY ALL PDB WRITES
      IJHPDB=IJHRUN+IHR+IZHHDA
      IDT=6
C
C     VALUES NEEDED TO DETERMINE IF WINTER OR SUMMER
      I=1
      CALL MDYH1(IDA,I,MO,ID,IY,IH,NLSTZ,0,TZCODE)
      KWS=0
      IF((MO.GE.IMOSUM).AND.(MO.LT.IMOWTR)) KWS=1
      LWS=ND(MO)
      IF((MO.EQ.2).AND.((IY/4)*4.EQ.IY)) LWS=LWS+1
      MO=MO+1
      IF(MO.GT.12) MO=1
      NXWS=0
      IF((MO.GE.IMOSUM).AND.(MO.LT.IMOWTR)) NXWS=1
      IDWS=ID
C.......................................
C.......................................
C     BEGIN LOOP THROUGH ALL TEMPORARY RECORDS FOR EACH AREA
      DO 100 N=1,NRECTP
      LMAP=0
      LREWT=0
      LBASN=0
      NW=1
C.......................................
C     BEGIN LOOP THROUGHT ALL DAYS FOR CURRENT AREA.
      DO 110 I=1,NDAYS
      IUTMP=69+I
      KDA=IDA+I-1
      NP=4
      KHR=24
      IF(I.LT.NDAYS) GO TO 111
      NP=LHR/6
      KHR=LHR
  111 K=(I-1)*4+1
C
C     READ TEMPORARY FILE RECORD
      READ(IUTMP)AREAID,MAPRN,KONLY,KDIST,N24,N6,NMR,NSR,NFULL,
     1 (TMPREC(J),J=1,NFULL)
      IF (KBUG.EQ.1) WRITE(IOPDBG,905) AREAID,MAPRN,KONLY,KDIST,N24,N6,
     1  NMR,NSR,NFULL
  905 FORMAT (' XMAP DEBUG--',2A4,2X,8I5)
      IF(KONLY.NE.1) GO TO 120
C
C     MAP TO BE COMPUTED TOTALLY FROM MDR DATA.
      IAMT=1
      J=0
      CALL XMAPMR(NP,IAMT,TMPREC,J,NMR,TMAP,TSMAP(K))
      GO TO 110
C.......................................
C     COMPUTE 24 HOUR MAP FROM GAGE DATA.
  120 IF(LMAP.GT.0) GO TO 125
C
C     READ MAP PARAMETERS FROM PPPDB.
      LW=LWORK-NW+1
      CALL RPPREC(AREAID,AMAP,MAPRN,LW,WORK(NW),NFILL,L,ISTAT)
      IF(ISTAT.EQ.0) GO TO 124
      CALL PSTRDC(ISTAT,AMAP,AREAID,J,LW,NFILL)
  121 WRITE(IPR,901)
  901 FORMAT('0**FATAL ERROR** THE ABOVE ERROR IS FATAL.')
      CALL KILLFN(8HMAP     )
      IERR=1
      GO TO 99
  124 IF(IBUG.EQ.1) CALL PDUMPA(NFILL,WORK(NW),AMAP,AREAID,1)
      LMAP=NW
      NW=NW+NFILL
      IBASN=0
      ITIME=WORK(LMAP+11)
      NT=1
      IF (ITIME.EQ.1) NT=0
      ITYPE=WORK(LMAP+14)
      IF((ITYPE.EQ.2).OR.(ITYPE.EQ.3)) IBASN=1
      CALL UMEMOV (WORK(LMAP+3),AREADS,5)
      BASNID(1)=WORK(LMAP+9)
      BASNID(2)=WORK(LMAP+10)
      POWER=WORK(LMAP+12)
      XC=WORK(LMAP+17)
      YC=WORK(LMAP+18)
      NSTWT=WORK(LMAP+13)
      NPCPN=WORK(LMAP+21)
      NSETS=WORK(LMAP+22)
      LSTWT=LMAP+23+2*NSTWT
      LPCPN=LMAP+23+3*NSTWT+2*NPCPN+2*NSTWT*NT
      LSTID=LMAP+23+3*NSTWT+2*NSTWT*NT
      LSTXY=LMAP+23+3*NSTWT+2*NPCPN+NPCPN*NSETS+2*NSTWT*NT
  125 IF(NSR.GT.0) GO TO 130
C.......................................
C     NO STRANGER REPORTS--COMPUTE FROM STATION DATA
      L=LPCPN
      IF(ITYPE.GT.1) GO TO 126
C
C     PREDETERMINE WEIGHTS, CHECK IF TWO SETS
      IF(NSETS.EQ.1) GO TO 126
      IWS=KWS
      IF((IDWS+I-1).GT.LWS) IWS=NXWS
      L=L+NPCPN*IWS
  126 CALL XMAP24(NPCPN,TMPREC,WORK(L),TMAP)
      GO TO 160
C.......................................
C     STRANGER REPORTS ARE AVAILABLE--RECOMPUTE WEIGHTS
  130 IF((IBASN.EQ.0).OR.(LBASN.GT.0)) GO TO 135
C
C     READ BASIN BOUNDARY PARAMETERS
      J=0
      LW=LWORK-NW+1
      CALL RPPREC(BASNID,BASN,J,LW,WORK(NW),NFILL,L,ISTAT)
      IF(ISTAT.EQ.0) GO TO 134
      CALL PSTRDC(ISTAT,BASN,BASNID,J,LW,NFILL)
      GO TO 121
  134 IF(JBUG.EQ.1) CALL PDUMPA(NFILL,WORK(NW),BASN,BASNID,1)
      LBASN=NW
      NW=NW+NFILL
      NBPTS=WORK(LBASN+21)
      NGPTS=WORK(LBASN+22)
      LGPTS=LBASN+23+2*NBPTS
  135 IF(LREWT.EQ.0) GO TO 140
C
C     RECOMPUTED WEIGHTS AVAILABLE FOR A PREVIOUS DAY--
C        CHECK IF CAN USE FOR CURRENT DAY.
      IF((N24+NSR).NE.NREWT) GO TO 140
C
C     SAME NUMBER OF STATIONS--CHECK IF SAME STRANGER
C          REPORTS AS FOR PREVIOUS DAY.
      WRITE (IPR,909) 'XSRSME'
909   FORMAT ('0**WARNING** IN PPXMAP - ROUTINE ',A,
     *   ' IS NOT INCLUDED IN THIS VERSION.')
      CALL WARN
      ISTAT=1
CCC   CALL XSRSME(AREAID,N24,NSR,WORK(LTMP),TMPREC,WORK(LPP24),
CCC  1 IPRSRW,KDA,KHR,TZCODE,ISTAT)
      IF(ISTAT.EQ.1) GO TO 155
      GO TO 145
C
C     EITHER NUMBER NOT THE SAME AS FOR A PREVIOUS DAY OR
C         NO PREVIOUS DAY VALUES--ALLOCATE SPACE FOR CURRENT DAY.
  140 NREWT=N24+NSR
      LREWT=NW
      LTMP=NW+NREWT
      LPP24=LTMP+((N24+3*NSR)-1)/2+1
      L=NREWT+N24+2*NSR
      J=NX+NW+L-2
      L=J-MX
      IF(L.EQ.0) GO TO 141
      CALL XSPACE(MX,L,REWT)
      CALL KILLFN(8HMAP     )
      IERR=1
      GO TO 99
  141 L=((N24+3*NSR)-1)/2+1
      DO 142 J=1,L
  142 WORK(LTMP+J-1)=TMPREC(J)
C
C     PERFORM REWEIGHT COMPUTATIONS
  145 IF(IBASN.EQ.1) GO TO 150
C
C     RECOMPUTE WEIGHTS USING ONE OVER DISTANCE TO A POWER
C         FROM THE CENTROID OF THE AREA.
      WRITE (IPR,909) 'XREDP'
      CALL WARN
      ISTAT=1
CCC   CALL XREDP(AREAID,N24,NSR,WORK(LTMP),XC,YC,POWER,WORK(LSTXY),
CCC  1 IPRSRW,KDA,KHR,TZCODE,WORK(LSTID),WORK(LREWT),WORK(LPP24))
      GO TO 155
C
C     RECOMPUTE WEIGHTS FROM BASIN BOUNDARY DEFINITION
  150 CONTINUE
      WRITE (IPR,909) 'XREBSN'
      CALL WARN
CCC   CALL XREBSN(AREAID,N24,NSR,WORK(LTMP),NGPTS,WORK(LGPTS),
CCC  1 WORK(LSTXY),ITYPE,IPRSRW,KDA,KHR,TZCODE,WORK(LSTID),
CCC  2 WORK(LREWT),WORK(LPP24))
C
C     COMPUTE MAP USING RECOMPUTED WEIGHTS
  155 CALL XMAP24(NREWT,WORK(LPP24),WORK(LREWT),TMAP)
C.......................................
C     TIME DISTRIBUTE 24 HOUR MAP VALUE.
  160 IF(KDIST.NE.1) GO TO 170
C
C     TIME DISTRIBUTION BASED ON MDR
      IAMT=0
      J=N24+3*NSR
      CALL XMAPMR(NP,IAMT,TMPREC,J,NMR,TMAP,TSMAP(K))
      GO TO 110
C
C     TIME DISTRIBUTION BASED ON 6 HOUR STATION DATA
  170 J=N24+3*NSR
      CALL XMAP6(NP,TMPREC,J,N6,WORK(LSTWT),TMAP,TSMAP(K))
  110 CONTINUE
C     END OF DAY LOOP
C.......................................
C     WRITE MAP TIME SERIES TO THE PDB.
      J=0
      L=0
      IF (LBUG.EQ.0) GO TO 175
      WRITE(IOPDBG,906) AREAID,AMAP,IJHPDB,IDT,LTSMAP,UNIT,IREC
  906 FORMAT (' XMAP DEBUG--',2A4,3X,A4,I10,2I5,1X,A4,I5)
      WRITE(IOPDBG,907) (TSMAP(I),I=1,LTSMAP)
  907 FORMAT (1H ,20F6.3)
  175 CALL WPRDD(AREAID,AMAP,IJHPDB,IDT,LTSMAP,UNIT,LTSMAP,LTSMAP,TSMAP,
     1 J,L,LWBF,WKBUF,IREC,ISTAT)
      IF (ISTAT.EQ.0) THEN
C     CHECK IF TO PRINT TIME SERIES DATA      
         IF (MAPPRT.EQ.1) THEN
C        SET TIME SERIES DATA UNITS
            CALL UMEMOV (UNIT,TSUNT,1)
            TSUNTW=TSUNT
C        CHECK IF METRIC OPTION SPECIFIED            
            IF (METRIC.EQ.1) THEN
C           CONVERT DATA            
               TSUNTW='MM'
               ICONV=1
               CALL UDUCNV (TSUNT,TSUNTW,ICONV,LTSMAP,TSMAP,TSMAP,IERR)
               ENDIF
C        GET NUMBER DECIMAL PLACES TO BE USED FOR PRINTING DATA VALUES
            CALL UDUNDC (TSUNTW,NDEC,IERR)
            IF (IERR.NE.0) NDEC=2
            WRITE (IPR,908) AREAID,AREADS
908   FORMAT ('0AREA ID = ',2A4,5X,'DESCRIPTION = ',5A4)
C        PRINT TIME SERIES DATA
            NVPTS=1
            CALL PTSDAT (IJHPDB,TSMAP,LTSMAP,IDT,NVPTS,NDEC)
            ENDIF
         GO TO 100
         ENDIF
      IF((ISTAT.EQ.2).OR.(ISTAT.EQ.7)) GO TO 180
      WRITE(IPR,902)AREAID,ISTAT
  902 FORMAT('0**ERROR** MAP TIME SERIES FOR AREA=',2A4,
     1 ' COULD NOT BE WRITTEN TO THE PDB--WPRDD STATUS CODE=',I2)
      CALL ERROR
      GO TO 100
  180 WRITE(IPR,903)AREAID
  903 FORMAT('0**WARNING** MAP TIME SERIES FOR AREA=',2A4,
     1 ' COULD NOT ALL BE WRITTEN TO THE PDB--TRUNCATED AT THE END.')
      CALL WARN
  100 CONTINUE
C     END OF AREA LOOP
C.......................................
C.......................................
C     CLOSE TEMPORARY FILES BY REWINDING ALL OF THEM
   99 DO 95 I=1,NDAYS
         IUTMP=69+I
         REWIND IUTMP
95       CONTINUE
C.......................................
      IF(IPTRCE.GE.1) WRITE(IOPDBG,904)
  904 FORMAT(' ** EXIT XMAP')
C
      RETURN
C
      END
