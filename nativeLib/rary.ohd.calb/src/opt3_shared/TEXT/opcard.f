C     MEMBER OPCARD
C
      SUBROUTINE OPCARD(P,MP,OA,MOA,LEFTOA,NPARM,ILOCOA,MILOC,A,MA)
C
C.......................................
C     THIS SUBROUTINE CALLS THE ROUTINES TO READ THE INPUT
C     FOR THE OPTIMIZATION PART OF OPT3.
C.......................................
C     SUBROUTINE INITIALLY WRITTEN BY
C            LARRY BRAZIL - HRL   APRIL 1981   VERSION 1
C.......................................
C
      DIMENSION P(MP),OA(MOA),FIX(3),PER(3),ILOCOA(MILOC),A(MA)
      DIMENSION OPID(2),OPNEW(2),PARM(2)
      DIMENSION OLDOPN(2)
C
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/sysbug'
      INCLUDE 'common/fprog'
      INCLUDE 'ocommon/opschm'
      INCLUDE 'common/errdat'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/calb/src/opt3_shared/RCS/opcard.f,v $
     . $',                                                             '
     .$Id: opcard.f,v 1.4 2003/08/26 17:43:58 wkwock Exp $
     . $' /
C    ===================================================================
C
      integer, parameter::MaxNopt=100
	  integer, parameter::MaxNpg=2*MaxNopt+1,MaxNpt=MaxNopt*MaxNpg
C
      DATA FIX/4H(ABS,4H. VA,4HLUE)/
      DATA PER/4H(PER,4HCENT,4HAGE)/
C
C     TRACE LEVEL=1.
      IF(ITRACE.GE.1) WRITE(IODBUG,1000)
 1000 FORMAT(1H0,17H** OPCARD ENTERED)
C
      CALL FSTWHR('OPCARD  ',0,OLDOPN,IOLDOP)
C
C     INITIALIZE VARIABLES.
      NPARM=0
      IUSEOA=0
      IERO=0
      PRMCTR=0
C
C     CALL ROUTINE TO READ OPT SCHEME INPUT.
C
      CALL OPTION
C
C     READ OPERATIONS AND PARAMETERS TO BE OPTIMIZED.
C
      WRITE(IPR,900)
  900 FORMAT(1H0,//,1X,43HTHE FOLLOWING PARAMETERS WILL BE OPTIMIZED:,//
     */)
C
      WRITE(IPR,902)
  902 FORMAT(89X,40HOTHER OPERATIONS AFFECTED BY THIS CHANGE,/38X,43HINI
     *TIAL    LOWER    UPPER    INCREMENT USED)
C
      IF(NPER.EQ.1) GO TO 110
      WRITE(IPR,904) FIX
      GO TO 112
  110 WRITE(IPR,904) PER
  904 FORMAT(4X,64HOPERATION    NAME    PARAMETER     VALUE     BOUND   
     * BOUND     ,3A4,9X,4HNAME,6X,30HRATIO OR DIFFERENCE MAINTAINED)
C
  112 WRITE(IPR,906)
  906 FORMAT(4X,9(1H-),4X,4(1H-),4X,9(1H-),4X,7(1H-),4X,5(1H-),4X,5(1H-)
     *,4X,14(1H-),8X,4(1H-),6X,30(1H-))
C
  113 IF(IERO.EQ.1) GO TO 99
C      IF(PRMCTR.GE.16) GO TO 700
C Change to allow # of parameter upto MaxNopt ---10/15/01
      IF(PRMCTR.GE.MaxNopt) GO TO 700
      READ(IN,800) OPID,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER
  800 FORMAT(2A4,2X,2A4,2X,2A4,2X,3F5.2,I5)
      PRMCTR=PRMCTR+1
C
C     CHECK OPERATION I.D. AND GET INTERNAL NUMBER.
C
      CALL FOPCDE(OPID,NUMOP)
      IF(NUMOP.NE.0) GO TO 114
C
      CALL OBADID(OPID)
      GO TO 113
  114 IF(NUMOP.EQ.-1) GO TO 99
      NPARM=NPARM+1
      ILOCOA(NPARM)=IUSEOA+1
C
C     CALL SUBROUTINES TO LOAD OA() AND PRINT INPUT.
C
      IF(NUMOP.NE.1) GO TO 120
C
      CALL OSACIN(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  120 IF(NUMOP.NE.2) GO TO 122
C
      CALL OUGIN(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  122 IF(NUMOP.NE.19) GO TO 123
C
      CALL OSNOIN(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  123 IF (NUMOP.NE.24) GO TO 124
      CALL OAPIIN(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  124 IF(NUMOP.NE.34) GO TO 126
      CALL OSLCIN(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  126 IF(NUMOP.NE.36) GO TO 130
      CALL OXININ(OPID,NUMOP,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER,OA,
     *MOA,P,MP,A,MA,NPARM,IUSEOA,LEFTOA,IERO)
      GO TO 113
C
  130 WRITE(IPR,910) OPID
  910 FORMAT(1H0,10X,12H**WARNING** ,2A4,1X,42HIS NOT AN OPERATION THAT 
     *CAN BE OPTIMIZED.)
      CALL WARN
      GO TO 113
C
  700 WRITE(IPR,710)MaxNopt
      WRITE(IPR,720)
C  710 FORMAT(1H0,61H**WARNING** ONLY 16 PARAMETERS CAN BE OPTIMIZED AT  
C Change 16 to MaxNopt for # of parameters upto MaxNopt, see variable PRMCTR above---10/15/01
  710 FORMAT(1H0,17H**WARNING** ONLY ,I3,42H PARAMETERS CAN BE OPTIMIZED
     * AT ONE TIME. )
  720 FORMAT(1H0,37HANY EXTRA PARAMETERS WILL BE IGNORED. )
      CALL WARN
C
  730 READ(IN,800) OPID,OPNEW,PARM,DELTA,CHECKL,CHECKU,NOTHER
      CALL FOPCDE(OPID,NUMOP)
      IF(NUMOP .NE. -1) GO TO 730
C
   99 IF(NPARM.GT.0) GO TO 100
      NERRS=NERRS+1
      WRITE(IPR,735)
  735 FORMAT(1H0,10X,'**ERROR** NO VALID PARAMETERS REMAIN FOR          
     *OPTIMIZATION.')
      CALL ERROR
C
  100 CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      IF(ITRACE.GE.1) WRITE(IODBUG,1002)
 1002 FORMAT(1H0,14H** EXIT OPCARD)
      RETURN
      END
