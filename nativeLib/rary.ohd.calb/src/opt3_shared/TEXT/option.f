C MODULE OPTION
C.......................................
C     THIS SUBROUTINE READS THE OPTIMIZATION SCHEME INPUT FOR OPT3.
C.......................................
C     SUBROUTINE INITIALLY WRITTEN BY
C            LARRY BRAZIL - HRL   APRIL 1981   VERSION 1
C     UPDATED 2/88 FOR INCLUSION OF ADAPTIVE RANDOM SEARCH SCHEME
C     UPDATED 10/91 FOR INCLUSION OF SHUFFLED COMPLEX EVOLUTION BY
C            QINGYUN DUAN - UNIVERSITY OF ARIZONA
C.......................................
      SUBROUTINE OPTION
C
      DIMENSION JUNK(18)
      DIMENSION PS(2),SID(2),OID(2),IDRP1(3),IDRP2(3)
      DIMENSION ARS(2),SCE(2),SCHEME(2),CRIT(4,6)
      DIMENSION OLDOPN(2)
C
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/fctime'
      INCLUDE 'ocommon/opschm'
      INCLUDE 'ocommon/odrop'
      INCLUDE 'ocommon/optts'
C
      INCLUDE 'common/calbrt'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob81/ohd/calb/src/opt3_shared/RCS/option.f,v $
     . $',                                                             '
     .$Id: option.f,v 1.4 2006/10/18 17:14:57 hank Exp $
     . $' /
C    ===================================================================
C
C
      DATA PS/4HPATS,4HERCH/
      DATA ARS/4HARS ,4H    /
      DATA SCE/4HSCE-,4HUA  /
      DATA MCP3/4HMCP3/
      DATA DL3/4HL3  /
      DATA IBUG/4HOPT /
      DATA JBUG/4HOPT2/
      DATA CRIT/4HDAIL,4HY RM,4HS ER,4HROR ,4HMO V,4HOL R,4HMS E,4HRROR,
     *4H/O-S,'/**E',4HXP  ,4H    ,4H/LOG,4HS-LO,'GO/*',4H*EXP,4H1.-M,4HO
     *D R,4H COE,4HFF  ,4HML E,4HST. ,4H(HML,4HE)  /
C
C     TRACE LEVEL=1.
      IF(ITRACE.GE.1) WRITE(IODBUG,1000)
 1000 FORMAT(1H0,17H** OPTION ENTERED)
C
      CALL FSTWHR('OPTION  ',0,OLDOPN,IOLDOP)
C
C     INITIALIZE VARIABLES.
      ISCHEM=0
      NDRP=0
      NDRPN=1
      IDRP=0
      AREA=1.0
      IPUNCH=0
      MCP=0
      LHOUR=24
      NINDRP = 0
      NBUFMO=0
C
C     PRINT HEADING
C
      WRITE(IPR,910)
  910 FORMAT(1H1,42(1H*),//,1X,40HAUTOMATIC PARAMETER OPTIMIZATION OPTIO
     *NS,//,1X,42(1H*))
C
C     READ CARDS FOR OPT SCHEME INPUT.
C
      READ(IN,800) SCHEME,NBUFMO,NDRP,MCC,IPUNCH,IDETAL
  800 FORMAT(2A4,2X,2I5,1X,A4,2I5)
C
C     DETERMINE TYPE OF OPT SCHEME.
C
      IF(SCHEME(1).EQ.PS(1).AND.SCHEME(2).EQ.PS(2)) ISCHEM=1
      IF(SCHEME(1).EQ.ARS(1).AND.SCHEME(2).EQ.ARS(2)) ISCHEM=2
      IF(SCHEME(1).EQ.SCE(1).AND.SCHEME(2).EQ.SCE(2)) ISCHEM=3
C
      IF(ISCHEM.EQ.1.OR.ISCHEM.EQ.2.OR.ISCHEM.EQ.3) GO TO 102
      WRITE(IPR,900) SCHEME
  900 FORMAT(1H0,10X,12H**WARNING** ,2A4,36H IS NOT A VALID OPTIMIZATION
     * SCHEME.,/22X,68HTHE PATTERN SEARCH SCHEME WILL BE USED FOR OPTIMI
     *ZATION IF POSSIBLE.)
C
      CALL WARN
C
      ISCHEM=1
  102 CONTINUE
C
C     READ OPTIMIZATION CRITERION INFORMATION
      READ(IN,810) IOPTIM,MAXN,EXPO,AREA,QMIN
  810 FORMAT(I5,I5,F5.2,2F10.2)
C
C  CHECK OBJECTIVE FUNCTION
      IF(IOPTIM.GE.1.AND.IOPTIM.LE.6) GO TO 201
      WRITE(IPR,820) IOPTIM
  820 FORMAT(1H0,10X,12H**WARNING** ,I1,42H IS NOT A VALID OBJECTIVE FUN
     *CTION OPTION.,/22X,46HDAILY RMS ERROR WILL BE USED FOR OPTIMIZATIO
     *N.)
C
      IOPTIM=1
C
      CALL WARN
C
  201 IF(EXPO.LT.0.001) EXPO=2.0
C
      IF(AREA.GT.0.0) GO TO 202
      WRITE(IPR,822) AREA
  822 FORMAT(1H0,10X,'**ERROR** THE AREA VALUE ',F10.2,' IS LESS THAN OR
     * EQUAL TO ZERO.')
C
      CALL ERROR
C
  202 CONTINUE
C
      WRITE(IPR,824)
  824 FORMAT(1H0,//,6X,'OPTIMIZATION',18X,'MAX NO.',14X,'BASIN AREA',
     *   16X,'EXPONENT',/,7X,'CRITERION',20X,'OF RUNS',17X,'SIZE',
     *   17X,'IN CRIT 3 & 4',/,6X,12(1H-),18X,7(1H-),14X,10(1H-),14X,
     *   13(1H-))
C
      WRITE(IPR,826) (CRIT(K,IOPTIM),K=1,4),MAXN,AREA,EXPO
  826 FORMAT(1H0,4X,4A4,16X,I5,2(14X,F10.2))
      IF(QMIN.GT.0.00001) WRITE(IPR,828) QMIN
  828 FORMAT(1H0,/,1X,44HSTATISTICS WILL NOT BE KEPT FOR FLOWS BELOW ,
     *   F8.4,6H CMSD.)
C
      GO TO (20,30,40),ISCHEM
   20 CALL OSCHIN
C
C     DEBUG OUPTUT
      IF(IFBUG(JBUG) .NE. 1) GO TO 25
      WRITE(IODBUG,1100)
 1100 FORMAT(/5X,'OPTION DEBUG OUTPUT')
      WRITE(IODBUG,1110)
 1110 FORMAT(/5X,'COMMON BLOCK OPSCHM')
      WRITE(IODBUG,1120) ISCHEM,IOPTIM,EXPO,NPER,MAXN,KC,KSTOP,PCENTO
 1120 FORMAT(5X,I5,2X,I5,2X,F5.1,2X,I5,2X,I5,2X,I5,2X,I5,2X,F5.1)
      WRITE(IODBUG,1130) MCP,AREA,IPUNCH,NNBEST,OPTIM,PBIAS,RCOF,IDETAL
 1130 FORMAT(5X,I5,2X,F10.3,2X,I5,2X,I5,2X,F10.5,2X,F10.5,2X,F10.5,2X,I5
     &)
      WRITE(IODBUG,1140)
 1140 FORMAT(/5X,'COMMON BLOCK ODROP - NBUFMO,NDRP,IDRP,IND,QMIN')
      WRITE(IODBUG,1150) NBUFMO,NDRP,IDRP,IND,QMIN
 1150 FORMAT(5X,I5,2X,I5,2X,I5,2X,I5,2X,F10.3)
C
   25 GO TO 100
   30 CALL OARSIN
   35 GO TO 100
   40 CALL OSCEIN
C
  100 IF(NBUFMO.GE.0.AND.NBUFMO.LE.6) GO TO 103
C
      WRITE(IPR,905) NBUFMO
  905 FORMAT(1H0,10X,12H**WARNING** ,I5,40H IS NOT A VALID NUMBER OF BUF
     *FER MONTHS.,/22X,37HA 6 MONTH BUFFER PERIOD WILL BE USED.)
      NBUFMO=6
C
      CALL WARN
C
  103 IF(NDRP.GE.0.AND.NDRP.LE.10) GO TO 104
      IF(NDRP .LT. 0) GO TO 700
      NINDRP = NDRP
      WRITE(IPR,970) NDRP
  970 FORMAT(1H0,10X,12H**WARNING** ,I5,39H IS NOT A VALID NUMBER OF DRO
     *P PERIODS.,/22X,40HONLY FIRST 10 DROP PERIODS WILL BE USED.)
      CALL WARN
      NDRP = 10
      GO TO 104
  700 WRITE(IPR,906) NDRP
  906 FORMAT(1H0,10X,12H**WARNING** ,I5,39H IS NOT A VALID NUMBER OF DRO
     *P PERIODS.,/22X,29HNO DROP PERIODS WILL BE USED.)
      CALL WARN
      NDRP=0
C
  104 IF(NBUFMO.EQ.0) GO TO 105
      NDRP=NDRP+1
      NINDRP = NINDRP + 1
      NDRPN=2
      IDT(1)=IDARUN
      LBUFMO=IMO+NBUFMO
      LBUFYR=IYR
      IF(LBUFMO.LE.12) GO TO 300
      LBUFMO=LBUFMO-12
      LBUFYR=LBUFYR+1
  300 CONTINUE
      CALL FCTZC (100,0,TZCODE)
      CALL JULDA (IDT(2),LBUFHR,LBUFMO,1,LBUFYR,LHOUR,100,0,TZCODE)
      IDRP=1
      GO TO 106
C
  105 CONTINUE
      IF(NDRP.GT.0) IDRP=1
C
C     READ OPT. TIME SERIES INFO.
C
  106 READ(IN,804) SID,STYPE,IDTS,OID,OTYPE,IDTO
  804 FORMAT(2(2A4,2X,A4,4X,I2,5X))
C
      IVALUE=1
      IMISS=1
      IDIMEN=1
C
      CALL CHEKTS(SID,STYPE,IDTS,IDIMEN,DL3,IMISS,IVALUE,IERR)
      CALL CHEKTS(OID,OTYPE,IDTO,IDIMEN,DL3,IMISS,IVALUE,IERR)
C
C     CHECK THAT TIME INTERVALS ARE EQUAL.
C
      IF(IDTS.EQ.IDTO) GO TO 114
C
      WRITE(IPR,907) IDTS,IDTO
  907 FORMAT(1H0,10X,57H**ERROR** THE TIME INTERVAL OF THE SIMULATED TIM
     *E SERIES(,I2,17H) IS NOT EQUAL TO/21X,46HTHE TIME INTERVAL OF THE 
     *OBSERVED TIME SERIES(,I2,2H).)
C
      CALL ERROR
C
  114 CONTINUE
      CALL FINDTS(SID,STYPE,IDTS,LDS,LTSS,DIM)
      CALL FINDTS(OID,OTYPE,IDTO,LDO,LTSO,DIM)
      LDDS=LDS
      LDDO=LDO
      IDTOS=IDTS
C
      IF(MCC.NE.MCP3) GO TO 160
      WRITE(IPR,934)
      WRITE(IPR,929)
      MCP=1
  929 FORMAT(1H0,95HMCP RUN WILL BE MADE WITH PARAMETER VALUES OBTAINED 
     *ON THE RUN WITH THE LOWEST CRITERION VALUE.)
  160 CONTINUE
C
      IF(IPUNCH.EQ.1) WRITE(IPR,928)
  928 FORMAT(1H0,41HOPERATIONS TABLE WITH PARAMETERS FROM RUN,
     *50H WITH BEST OPTIMIZATION CRITERION WILL BE PUNCHED.)
C
C     DEBUG OUTPUT
      IF(IFBUG(JBUG) .NE. 1) GO TO 175
      WRITE(IODBUG,1160)
 1160 FORMAT(/5X,'COMMON BLOCK OPSCHM')
      WRITE(IODBUG,1170) ISCHEM,IOPTIM,EXPO,NPER,MAXN,KC,KSTOP,PCENTO
 1170 FORMAT(5X,I5,2X,I5,2X,F5.1,2X,I5,2X,I5,2X,I5,2X,I5,2X,F5.1)
      WRITE(IODBUG,1180) MCP,AREA,IPUNCH,NNBEST,OPTIM,PBIAS,RCOF,IDETAL
 1180 FORMAT(5X,I5,2X,F10.3,2X,I5,2X,I5,2X,F10.5,2X,F10.5,2X,F10.5,2X,I5
     &)
      WRITE(IODBUG,1190)
 1190 FORMAT(/5X,'COMMON BLOCK ODROP-NBUFMO,NDRP,IDRP,IND,QMIN')
      WRITE(IODBUG,1200) NBUFMO,NDRP,IDRP,IND,QMIN
 1200 FORMAT(5X,I5,2X,I5,2X,I5,2X,I5,2X,F10.3)
C
  175 WRITE(IPR,934)
      IF(NBUFMO.GT.0) GO TO 121
      WRITE(IPR,935)
  935 FORMAT(1H0,31HNO BUFFER PERIOD IS BEING USED.)
      GO TO 123
C
  121 WRITE(IPR,930) NBUFMO
  930 FORMAT(1H0,27HBUFFER PERIOD TO BE USED IS,I5,19H CALENDAR MONTH(S)
     *.)
C
  123 IF(NDRPN.LE.NDRP) GO TO 125
      WRITE(IPR,931)
  931 FORMAT(1H0,49HNO DROP PERIODS HAVE BEEN SPECIFIED FOR THIS RUN.)
      GO TO 140
  125 NDRPA=NDRP
      IF(NBUFMO.GT.0) NDRPA=NDRP-1
      WRITE(IPR,932) NDRPA
  932 FORMAT(1H0,39HNUMBER OF DATA PERIODS TO BE DROPPED IS,I3,1H.)
      WRITE(IPR,934)
  934 FORMAT(1H0)
      IF(NDRPN .EQ. 1) GO TO 980
C     BUFFER SPECIFIED
      J2=3
      MM=J2
      NN=NDRP*2-1
      IC=IDT(2)+1
      GO TO 801
C     NO BUFFER SPECIFIED
  980 J2=1
      MM=J2
      NN=NDRP*2-1
      IC=IDARUN
C
  801 DO 130 J=MM,NN,2
      READ(IN,802) (IDRP1(I),I=1,3),(IDRP2(I),I=1,3)
  802 FORMAT(2(I2,3X,I2,3X,I4,1X))
C
C       INSERT DROP PERIOD CHECKS HERE.
C
      CALL FCTZC (100,0,TZCODE)
      CALL JULDA (IDT(J2),IDTHR,IDRP1(1),IDRP1(2),IDRP1(3),LHOUR,
     *   100,0,TZCODE)
      CALL JULDA (IDT(J2+1),IDTHR,IDRP2(1),IDRP2(2),IDRP2(3),LHOUR,
     *   100,0,TZCODE)
C
      IF(IDT(J2) .GE. IC) GO TO 750
      IF(NBUFMO .EQ. 0) GO TO 780
      WRITE (IPR,760)
      WRITE (IPR,770)
  760 FORMAT(1H0,45HTHE NEXT D P STARTS WITHIN THE BUFFER PERIOD. )
  770 FORMAT(1H0,43HIT WILL BE STARTED AFTER THE BUFFER PERIOD. )
      GO TO 850
  780 WRITE(IPR,790)
  790 FORMAT(1HO,'THE NEXT DP STARTS BEFORE THE FIRST DAY IN THE CALIBRA
     &TION PERIOD.',/,1X,'OPTIMIZATION WILL BEGIN AFTER THE FIRST DAY.')
  850 IDT(J2)=IC
  750 J2=J2+2
      WRITE(IPR,936) (IDRP1(I),I=1,3),(IDRP2(I),I=1,3)
  936 FORMAT(1H ,10X,I2,1H/,I2,1H/,I4,6H  TO  ,I2,1H/,I2,1H/,I4)
C
  130 CONTINUE
C
      IF(NINDRP .LE. NDRP) GO TO 140
      JSTART=NDRP+1
      DO 710 J=JSTART,NINDRP
      READ(IN,720) JUNK
  720 FORMAT(A72)
  710 CONTINUE
C
  140 CONTINUE
      WRITE(IPR,940)
  940 FORMAT(1H0,//,1X,20X,34HTIME SERIES USED FOR OPTIMIZATION.)
      WRITE(IPR,942)
  942 FORMAT(1H0,15X,8HCONTENTS,5X,4HI.D.,7X,4HTYPE,5X,13HTIME INTERVAL)
      WRITE(IPR,944) SID,STYPE,IDTS
  944 FORMAT(1H0,15X,9HSIMULATED,2X,2A4,5X,A4,7X,I2,1X,5HHOURS)
      WRITE(IPR,946) OID,OTYPE,IDTO
  946 FORMAT(1H ,15X,8HOBSERVED,3X,2A4,5X,A4,7X,I2,1X,5HHOURS)
C
C     CHECK IF DEBUG IS NEEDED.
      IF(IFBUG(IBUG).NE.1) GO TO 155
      GO TO 165
  155 IF(IFBUG(JBUG).NE.1) GO TO 150
      WRITE(IODBUG,1210)
 1210 FORMAT(/5X,'COMMON BLOCK OPSCHM')
      WRITE(IODBUG,1220) ISCHEM,IOPTIM,EXPO,NPER,MAXN,KC,KSTOP,PCENTO
 1220 FORMAT(5X,I5,2X,I5,2X,F5.1,2X,I5,2X,I5,2X,I5,2X,I5,2X,F5.1)
      WRITE(IODBUG,1230) MCP,AREA,IPUNCH,NNBEST,OPTIM,PBIAS,RCOF,IDETAL
 1230 FORMAT(5X,I5,2X,F10.3,2X,I5,2X,I5,2X,F10.5,2X,F10.5,2X,F10.5,2X,I5
     &)
      WRITE(IODBUG,1240)
 1240 FORMAT(/5X,'COMMON BLOCK ODROP-NBUFMO,NDRP,IDRP,IND,QMIN')
      WRITE(IODBUG,1250) NBUFMO,NDRP,IDRP,IND,QMIN
 1250 FORMAT(5X,I5,2X,I5,2X,I5,2X,I5,2X,F10.3)
  165 WRITE(IODBUG,950) LDDS,LDDO,(IDT(I),I=1,22)
  950 FORMAT(1H0,10I12)
  150 CONTINUE
      CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      IF(ITRACE.GE.1) WRITE(IODBUG,1002)
 1002 FORMAT(1H0,14H** EXIT OPTION)
      RETURN
      END
