C     MEMBER ORESET
C
      SUBROUTINE ORESET(P,MP,OA,MOA,LEFTOA,A,MA,IZY,ILOCOA,MILOC,NPARM,
     * NCOUN,NN,IBEST,POLD,IPMOVE,IERROR)
C
C..................................
C     THIS SUBROUTINE CHANGES THE PARAMETER VALUES IN THE P ARRAY
C     TO THE VALUES DETERMINED BY THE OPT ROUTINE.  PARAMETER
C     VALUES FOR OTHER AFFECTED OPERATIONS ALSO ARE COMPUTED.
C.................................
C     SUBROUTINE INITIALLY WRITTEN BY
C            LARRY BRAZIL - HRL   JUNE 1981   VERSION 1
C.................................
C
      DIMENSION P(MP),OA(MOA),A(MA),PARM(2),OPNEW(2),POLD(MP)
      DIMENSION ETL(2),ETH(2),ILOCOA(MILOC),XGSS(2)
      DIMENSION OLDOPN(2)
C
      INCLUDE 'common/fdbug'
      INCLUDE 'common/sysbug'
      INCLUDE 'common/ionum'
      INCLUDE 'ocommon/opschm'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/calb/src/opt3_shared/RCS/oreset.f,v $
     . $',                                                             '
     .$Id: oreset.f,v 1.3 2006/03/16 16:40:53 xfan Exp $
     . $' /
C    ===================================================================
C
C
      DATA ETL/4HETLO,4HW   /
      DATA ETH/4HETHI,4HGH  /
      DATA UH/4HUGH /
      DATA UV/4HUGV /
      DATA XGSS/4HKG+K,4HSS  /
      DATA XKSS/4HKSS /
      DATA BLNK/4H    /
      DATA IBUG/4HOPT /
C
C
C     TRACE LEVEL FOR THIS SUBROUTINE=1.
      IF(ITRACE.GE.1) WRITE(IODBUG,1000)
 1000 FORMAT(1H0,17H** ORESET ENTERED)
C
C     CHECK IF DEBUG IS NEEDED.
C
      IF(IFBUG(IBUG).NE.1) GO TO 50
      WRITE(IODBUG,900) (OA(KK),KK=1,MOA)
  900 FORMAT(1H0,10F12.3)
   50 CONTINUE
      CALL FSTWHR('ORESET  ',0,OLDOPN,IOLDOP)
C
C
C     BEGIN LOOP TO RESET PARAMETER VALUES
C
      JB=0
   80 JB=JB+1
      IF(JB.GT.NPARM) GO TO 300
      ICUR=ILOCOA(JB)
C
C     FIND LOCATION IN P() OF PARAMETER VALUE.
      ICURR=OA(ICUR+4)
C
C     SET VALUE FOR OTHER AFFECTED OPERATIONS.
      NOTHER=OA(ICUR+8)

C dws    "dws" comments refer to code that was changed to avoid
C dws     compiler warnings ... 2006-01-23

C dws     FIND LOCATION OF OPERATION NAME.
C dws     OPNEW(1)=P(OA(ICUR)-5)
C dws     OPNEW(2)=P(OA(ICUR)-4)

      JL = OA(ICUR)
      OPNEW(1) = P(JL-5)
      OPNEW(2) = P(JL-4)
C
C     CHECK TO SEE IF CURRENT PARAMETER IS FOR ET,UNIT GRAPH,
C     KSS, OR KG+KSS.
C
      PARM(1)=OA(ICUR+2)
      PARM(2)=OA(ICUR+3)
      IF((PARM(1).EQ.ETL(1).AND.PARM(2).EQ.ETL(2)).OR.(PARM(1).EQ.ETH(1)
     *.AND.PARM(2).EQ.ETH(2))) GO TO 122
C
      IF(PARM(1).EQ.UH.OR.PARM(1).EQ.UV) GO TO 240
      IF(PARM(1).EQ.XKSS) GO TO 270
      IF(PARM(1).EQ.XGSS(1).AND.PARM(2).EQ.XGSS(2)) GO TO 271
C
C     PARAMETER IS NOT FOR ET,UNIT GRAPH,KSS OR KG+KSS.
C
      P(ICURR)=A(JB)
C
C     CHECK TO SEE IF OTHER OPERATIONS ARE AFFECTED.
      IF(NOTHER.EQ.0) GO TO 290
C     RESET PARAMETERS FOR OTHER OPERATIONS.
C
      DO 120 I=1,NOTHER
C
C     FIND LOCATION IN P() OF PARAMETER VALUE.
      IRDIFF=OA(ICUR+12+(I-1)*4)
      INLOC=OA(ICUR+14+(I-1)*4)
C
      IF(IRDIFF.EQ.1) GO TO 110
      P(INLOC)=P(ICURR)+POLD(INLOC)-POLD(ICURR)
      GO TO 120
  110 P(INLOC)=(POLD(INLOC)/POLD(ICURR))*P(ICURR)
  120 CONTINUE
      GO TO 290
  122 CONTINUE
C
C     COMPUTE NEW ET CURVE AND STORE IN P().
C
C
C  CHECK TO SEE IF THIS ET CURVE WAS ALREADY ADJUSTED ON THIS PASS
      IF(JB.EQ.1) GO TO 130
      JBM1=JB-1
C
      DO 126 I=1,JBM1
C dws     IL=ILOCOA(I)
C dws     PM=OA(IL+2)
C dws     IF((PM.NE.ETL(1).AND.PM.NE.ETH(1)).OR.P(OA(IL)-5).NE.
C dws    * OPNEW(1).OR.P(OA(IL)-4).NE.OPNEW(2)) GO TO 126
C dws     GO TO 290

        IL = ILOCOA(I)
        JL = OA(IL)
        PM = OA(IL+2)
        IF( (PM.NE.ETL(1) .AND. PM.NE.ETH(1)) .OR.
     *      P(JL-5).NE.OPNEW(1) .OR. P(JL-4).NE.OPNEW(2) ) GO TO 126
        GO TO 290
  126 CONTINUE
C
C     FIND ETHIGH AND ETLOW VALUES.
  130 CALL OPETCK(P,MP,OA,MOA,A,MA,PARM,ILOCOA,MILOC,JB,ETHIGH,ETLOW,
     *NPARM,OPNEW)
C
      CALL OPECRV(ETHIGH,ETLOW,POLD(ICURR),P(ICURR),OPNEW)
C
      IF(IBEST.EQ.1) GO TO 140
      IF(IDETAL.NE.1) GO TO 140
C
C     PRINT REVISED EVAP VALUES.
C
      WRITE(IPR,902)
  902 FORMAT(1H )
      WRITE(IPR,904) NCOUN,NN
  904 FORMAT(2H *,I3,2X,I3,1H ,114(1H*))
      WRITE(IPR,906) (P(ICURR+I-1),I=1,12)
  906 FORMAT(38H REVISED EVAPORATION VALUES  (JAN-DEC),11X,12(1X,F5.2))
      WRITE(IPR,908)
  908 FORMAT(1H ,124(1H*))
      WRITE(IPR,902)
C
C     CHECK TO SEE IF OTHER OPERATIONS ARE AFFECTED.
C
  140 IF(NOTHER.EQ.0) GO TO 290
C
C     RESET ET CURVES FOR OTHER SAC-SMA OPERATIONS.
C
      DO 200 I=1,NOTHER
C
C     RESET VALUES IN P().
      ILOC=OA(ICUR+14+(I-1)*4)
      IF(ETHIGH.LT.OA(ICUR+10)) ETHIGH=OA(ICUR+10)
      IF(ETHIGH.GT.OA(ICUR+11)) ETHIGH=OA(ICUR+11)
      IF(ETLOW.LT.OA(ICUR+10)) ETLOW=OA(ICUR+10)
      IF(ETLOW.GT.OA(ICUR+11)) ETLOW=OA(ICUR+11)
C
      CALL OPECRV(ETHIGH,ETLOW,POLD(ILOC),P(ILOC),OPNEW)
C
  200 CONTINUE
C
      GO TO 290
C
  240 CONTINUE
C
C  CHECK TO SEE IF THIS UG WAS ALREADY ADJUSTED ON THIS PASS.
      IF(JB.EQ.1) GO TO 243
      JBM1=JB-1
C
      DO 242 I=1,JBM1
C dws     IL=ILOCOA(I)
C dws     PM=OA(IL+2)
C dws     IF((PM.NE.UH.AND.PM.NE.UV).OR.P(OA(IL)-5).NE.OPNEW(1).
C dws    *OR.P(OA(IL)-4).NE.OPNEW(2)) GO TO 242
C dws     GO TO 290

        IL = ILOCOA(I)
        JL = OA(IL)
        PM = OA(IL+2)
        IF( (PM.NE.UH .AND. PM.NE.UV) .OR. P(JL-5).NE.OPNEW(1) .OR.
     *      P(JL-4).NE.OPNEW(2) ) GO TO 242
        GO TO 290
  242 CONTINUE
C
C     COMPUTE NEW UNIT GRAPH AND STORE IN P().
C
C     DETERMINE UGH AND UGV VALUES.
C
  243 CALL OPUGCK(P,MP,OA,MOA,A,MA,PARM,ILOCOA,MILOC,JB,UGH,UGV,
     *NPARM,OPNEW)
C
C     FIND NO. OF ORDINATES AND THEIR LOCATION IN P().
      NUMORD=OA(ICUR+9)
C
C     COMPUTE WORK SPACE.
C
      NUM2=(NUMORD+1)*2
      IF(LEFTOA.GE.NUM2) GO TO 244
      WRITE(IPR,910)
  910 FORMAT(1H0,10X,73H**ERROR** UNIT HYDROGRAPH ADJUSTMENT REQUIRES MO
     *RE SPACE IN THE OA ARRAY.)
      IERROR=1
      CALL ERROR
      GO TO 300
C
  244 IWORK=MOA-LEFTOA+1
      IWORK2=MOA-(LEFTOA/2)+2
C
C     ADJUST UNIT GRAPH.
      CALL OPUGAJ(UGH,UGV,POLD(ICURR),P(ICURR),OA(IWORK),OA(IWORK2),
     *NUMORD,VADJ,ISTUG)
C
      IF(ISTUG.EQ.0) GO TO 250
      IF(ISTUG.EQ.1) WRITE(IPR,920) UGH
  920 FORMAT(46H **NOTE** UGH RESET TO MAXIMUM ALLOWED VALUE: ,F6.2)
  922 FORMAT(46H **NOTE** UGV RESET TO MAXIMUM ALLOWED VALUE: ,F6.2)
  924 FORMAT(57H **NOTE** UGH & UGV RESET TO MAXIMUM ALLOWED VALUES: UGH
     *=,F6.3,5H UGV=,F6.3)
      IF(ISTUG.EQ.2) WRITE(IPR,922) UGV
      IF(ISTUG.EQ.3) WRITE(IPR,924) UGH,UGV
  250 CONTINUE
C
      JBP1=JB+1
      IF(PARM(1).NE.UH) GO TO 254
      A(JB)=UGH
C
      DO 252 I=JBP1,NPARM
C dws     IL=ILOCOA(I)
C dws     IF((OA(IL+2).NE.UV).OR.(P(OA(IL)-5).NE.OPNEW(1)).
C dws    * OR.(P(OA(IL)-4).NE.OPNEW(2))) GO TO 252
C dws     A(I)=UGV
C dws     GO TO 260

        IL = ILOCOA(I)
        JL = OA(IL)
        IF( OA(IL+2).NE.UV .OR. P(JL-5).NE.OPNEW(1) .OR.
     *      P(JL-4).NE.OPNEW(2) ) GO TO 252
        A(I)=UGV
        GO TO 260
  252 CONTINUE
      GO TO 260
C
  254 A(JB)=UGV
      DO 256 I=JBP1,NPARM

C dws     IL=ILOCOA(I)
C dws     IF((OA(IL+2).NE.UH).OR.(P(OA(IL)-5).NE.OPNEW(1)).
C dws    * OR.(P(OA(IL)-4).NE.OPNEW(2))) GO TO 256
C dws     A(I)=UGH
C dws     GO TO 260

        IL = ILOCOA(I)
        JL = OA(IL)
        IF( OA(IL+2).NE.UH .OR. P(JL-5).NE.OPNEW(1) .OR.
     *      P(JL-4).NE.OPNEW(2) ) GO TO 256
        A(I)=UGH
        GO TO 260
  256 CONTINUE
  260 CONTINUE
C
      IF(IBEST.EQ.1) GO TO 262
      IF(IDETAL.NE.1) GO TO 262
C
C     PRINT ADJUSTED UNIT GRAPH.
C
      WRITE(IPR,902)
      WRITE(IPR,904) NCOUN,NN
      WRITE(IPR,912)
  912 FORMAT(38H REVISED UNIT HYDROGRAPH VALUES (CMS):)
C
C
      WRITE(IPR,914) (P(ICURR+I-1),I=1,NUMORD)
  914 FORMAT(5X,15F8.2)
      WRITE(IPR,908)
      WRITE(IPR,902)
C
C
C     CHECK TO SEE IF OTHER OPERATIONS ARE AFFECTED.
  262 IF(NOTHER.EQ.0) GO TO 290
C
C     RESET UNIT GRAPH ORDINATES FOR OTHER UNIT-HG OPERATIONS.
C
      DO 280 I=1,NOTHER
C
C     RESET VALUES IN P().
C
      ILOC=OA(ICUR+14+(I-1)*4)
      INUMO=OA(ICUR+15+(I-1)*4)
      IF(UGH.LT.OA(ICUR+10)) UGH=OA(ICUR+10)
      IF(UGH.GT.OA(ICUR+11)) UGH=OA(ICUR+11)
      IF(UGV.LT.OA(ICUR+10)) UGV=OA(ICUR+10)
      IF(UGV.GT.OA(ICUR+11)) UGV=OA(ICUR+11)
C
C     COMPUTE WORK SPACE.
C
      IN2=INUMO*2
      IF(LEFTOA.GE.IN2) GO TO 264
      WRITE(IPR,910)
      IERROR=1
      CALL ERROR
      GO TO 300
C
  264 IWORK=MOA-LEFTOA+1
      IWORK2=MOA-(LEFTOA/2)+1
C
      CALL OPUGAJ(UGH,UGV,POLD(ILOC),P(ILOC),OA(IWORK),
     * OA(IWORK2),INUMO,VADJ,IST)
C
  280 CONTINUE
      GO TO 290
C     COMPUTE NEW KSS AND KG VALUES.
C     KSS CHANGED - CHANGE KG AND KEEP KG+KSS THE SAME.
  270 SKGKSS=P(ICURR)+P(ICURR+1)
      P(ICURR)=A(JB)
      P(ICURR+1)=SKGKSS-A(JB)
      GO TO 274
C     KG+KSS CHANGED - CHANGE KG AND KSS BY SAME RATIO.
  271 RKSSKG=A(JB)/(P(ICURR)+P(ICURR+1))
      P(ICURR)=P(ICURR)*RKSSKG
      P(ICURR+1)=P(ICURR+1)*RKSSKG
  274 IF(IBEST.EQ.1) GO TO 275
      IF(IDETAL.NE.1) GO TO 275
C     PRINT REVISED KSS AND KG VALUES.
      WRITE(IPR,902)
      WRITE(IPR,904) NCOUNT,NN
      WRITE(IPR,930)
  930 FORMAT(35H REVISED XIN-SMA COEFFICIENTS  KSS=,F5.3,3X,3HKG=,F5.3)
      WRITE(IPR,908)
      WRITE(IPR,902)
C     CHECK IF OTHER OPERATIONS AFFECTED.
  275 IF(NOTHER.EQ.0) GO TO 290
C     RESET PARAMETERS FOR OTHER OPERATIONS.
      DO 276 I=1,NOTHER
      INLOC=OA(ICUR+14+(I-1)*4)
      P(INLOC)=(POLD(INLOC)/POLD(ICURR))*P(ICURR)
      P(INLOC+1)=(POLD(INLOC+1)/POLD(ICURR+1))*P(ICURR+1)
  276 CONTINUE
C
  290 GO TO 80
C
  300 CALL FSTWHR(OLDOPN,IOLDOP,OLDOPN,IOLDOP)
C
      IF(ITRACE.GE.1) WRITE(IODBUG,1002)
 1002 FORMAT(1H0,14H** EXIT ORESET)
C
      RETURN
      END
