C MODULE OARSCH
C-----------------------------------------------------------------------
C
      SUBROUTINE OARSCH(A,MA,IEND,IPASS1,OA,MOA,ILOCOA,MILOC,N)
C
C   THIS SUBROUTINE PERFORMS THE ADAPTIVE RANDOM SEARCH OPTIMIZATION.
C
C   IF1 = NUMBER OF RANGE LEVELS
C   IF2 = ACTUAL NUMBER OF TRIALS PER RANGE LEVEL (COMPUTED)
C           IF2 POINTS ARE GENERATED WITH K-TH VARIANCE
C   IF3 = MAXIMUM NUMBER OF TRIALS PER RANGE LEVEL
C   IF4 = NUMBER OF LOCAL ITERATIONS
C   IF5 = NUMBER OF SUCCESSIVE CYCLES THAT OPTIMIZATION MUST BE IN
C           MINIMUM RANGE TO STOP
C   IQ1 = NUMBER OF CYCLES OPTIMIZATION IS IN MINIMUM RANGE
C   A( )  = PARAMETER VALUES (UP TO 16 ALLOWED)
C   N = NUMBER OF PARAMETERS BEING OPTIMIZED
C   MA = DIMENSION OF A ARRAY
C   IPASS1 = FIRST PASS FLAG
C          = 1 => FIRST PASS
C          = 0 => ALL PASSES AFTER FIRST
C
C   NLOCAL = NUMBER OF LOCAL SEARCHS
C   VAR( ) = RANGE FOR ALL PARAMETERS FOR EACH K LEVEL (SHRINKS FOR EACH
C              RANGE)
C   BL,BU = LOWER,UPPER BOUNDS ON PARAMETER
C   L = TRIAL NUMBER WITHIN CURRENT (K) RANGE
C   IBT = TRIAL NUMBER WITH BEST OBJECTIVE FUNCTION VALUE
C   Q = BEST OBJECTIVE FUNCTION VALUE FOR EACH K LEVEL
C   IEND = SEARCH COMPLETE FLAG
C
C   XX( ) = INTERMEDIATE VALUES OF PARAMETERS
C   XS( ) =       "       "     "      "
C   XN( ) =       "       "     "        "
C   XOPT( ) =     "       "     "        "
C   ZPM = INTERMEDIATE VARIABLE FOR COMPUTING VAR
C   KOPT = K LEVEL WITH BEST TRIAL
C   QOPT = OBJECTIVE FUNCTION ASSOCIATED WITH BEST TRIAL
C   BESTQ = MINIMUM OBJECTIVE FUNCTION VALUE FOR ALL PREVIOUS K AND L
C             LEVELS
C   IBTRL = NUMBER OF BEST TRIAL
C
      integer, parameter::MaxNopt=100
	  integer, parameter::MaxNpg=2*MaxNopt+1,MaxNpt=MaxNopt*MaxNpg
C
      DIMENSION OA(MOA),ILOCOA(MILOC),A(MA)
C      DIMENSION XN(16),XS(16),XX(16,5),Q(5)
C      DIMENSION BL(16),BU(16),VAR(16,5),IBT(5)
C      DIMENSION XOPT(16),XROPT(16)
      DIMENSION XN(MaxNopt),XS(MaxNopt),XX(MaxNopt,5),Q(5)
      DIMENSION BL(MaxNopt),BU(MaxNopt),VAR(MaxNopt,5),IBT(5)
      DIMENSION XOPT(MaxNopt),XROPT(MaxNopt)
C
      INCLUDE 'common/ionum'
      INCLUDE 'common/fdbug'
      INCLUDE 'common/sysbug'
      INCLUDE 'ocommon/opschm'
      INCLUDE 'ocommon/opars'
      COMMON/ARS/BL,BU,VAR,ITRIAL,K,L,IBT,Q,QOPT,KOPT,IQ1,BESTQ,IBTRL,
     *   NLOCAL,XS,XX,XN,XOPT,IF2,ILCL1
      SAVE
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/calb/src/opt3_shared/RCS/oarsch.f,v $
     . $',                                                             '
     .$Id: oarsch.f,v 1.6 2003/08/26 17:42:24 wkwock Exp $
     . $' /
C    ===================================================================
C
C
CC    DATA IBUG/4HARS /
C
      IF(ITRACE.GE.1) WRITE(IODBUG,1000)
 1000 FORMAT(1H0,17H** OARSCH ENTERED)
      IF(IPASS1.EQ.1) THEN
        ICYCLE=1
        YOPT=1.0E+20
      END IF
C
      NUM1=N
      IF(N.GT.8) NUM1=8
      IF(IPASS1.EQ.0) GO TO 34
C
      DO 10 I=1,N
      XN(I)=A(I)
      XOPT(I)=A(I)
   10 CONTINUE
C
      DO 14 I=1,N
      DO 12 J=1,IF1
      XX(I,J)=A(I)
   12 CONTINUE
   14 CONTINUE
C
C   FIRST TRIAL INITIALIZATION
C
      ITRIAL=1
C     NLOCAL=0
      IQ1=0
      QOPT=OPTIM
      IBTRL=1
      NNBEST=1
C
      DO 20 I=1,N
      BL(I)=OA(ILOCOA(I)+6)
      BU(I)=OA(ILOCOA(I)+7)
   20 CONTINUE
C
C   COMPUTE SEARCH VARIANCE MATRIX
C
      ZP=3.0
      DO 30 K=1,IF1
      ZPM=ZP**(1-K)
C
      DO 24 I=1,N
      VAR(I,K)=ZPM*(BU(I)-BL(I))
   24 CONTINUE
   30 CONTINUE
C
      K=1
      L=1
C     NLOCAL=0
C
      WRITE(IPR,710)
C
C     PRINT THE INITIAL POINT AND ITS STATISTICS
C
 200  WRITE(IPR,580)
      WRITE(IPR,582) (OA(ILOCOA(J)+2),OA(ILOCOA(J)+3),J=1,NUM1)
      WRITE(IPR,584) (XOPT(J),J=1,NUM1)
      IF (N.LT.9) GO TO 201
      WRITE(IPR,582) (OA(ILOCOA(J)+2),OA(ILOCOA(J)+3),J=9,N)
      WRITE(IPR,584) (XOPT(J),J=9,N)
  201 CONTINUE
      WRITE(IPR,586) DRMS,VRMS,SABSDF,SABSLG,PBIAS,RMOD1,RCOF,
     *               HMLE,TLAMDA
      WRITE(IPR,605)
      YOPTIM = 1.0E+20
C
C   BEGIN SEARCH
C
   34 CONTINUE
      IF(OPTIM.LE.YOPTIM) THEN
        YDRMS = DRMS
        YVRMS = VRMS
        YSABDF = SABSDF
        YSABLG = SABSLG
        YRMOD1 = RMOD1
        YHMLE = HMLE
        YPBIAS = PBIAS
        YRCOF = RCOF
        YLAMDA = TLAMDA
        YOPTIM = OPTIM
      END IF
      IF(OPTIM.LE.YOPT) THEN
        YOPT = OPTIM
        YCOF = RCOF
        YBIAS = PBIAS
        IYTRL = ITRIAL
        IK = K
      END IF
      IF(IPFLAG.NE.0) THEN
         IF(MOD(ITRIAL,5).NE.1) GO TO 235
         WRITE(IPR,610) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=1,NUM1)
         IF(N.LT.9) GO TO 235
         WRITE(IPR,620) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=9,N)
         WRITE(IPR,730)
  235    CONTINUE
         WRITE(IPR,630) ICYCLE,K,ITRIAL,OPTIM,PBIAS,RCOF,(A(I),I=1,NUM1)
         IF(N.LT.9) GO TO 240
         WRITE(IPR,640) (A(I),I=9,N)
C
  240    CONTINUE
      END IF
C     IF(NLOCAL.GT.0.AND.NLOCAL.LT.IF4) GO TO 100
C     NLOCAL=0
      IF(L.GT.1) GO TO 50
C
      IF2=IF3/K
      Q(K)=OPTIM
C
      DO 45 I=1,N
      XS(I)=XOPT(I)
   45 CONTINUE
C
   50 CONTINUE
      L=L+1
      ITRIAL=ITRIAL+1
C
C   TEST FOR MAXN TRIALS
C
      IF(ITRIAL.LE.MAXN) GO TO 54
         IEND=1
         GO TO 79
C
   54 CONTINUE
      IF(OPTIM.GT.Q(K)) GO TO 60
      Q(K)=OPTIM
      IBT(K)=ITRIAL-1
C
      DO 55 I=1,N
      XX(I,K)=XN(I)
   55 CONTINUE
C
   60 CONTINUE
      IF(L .GT. IF2) GO TO 150
      CALL POINT(N,XS,XN,ISEED,K,BL,BU,VAR)
      GO TO 120
C
  150 L=1
      K=K+1
      IF(K .GT. IF1) GO TO 160
      CALL POINT(N,XS,XN,ISEED,K,BL,BU,VAR)
      GO TO 120
C
C     END OF CYCLE
  160 K=1
C
C   SELECT THE OPTIMUM VARIANCE
C
   79 BESTQ=1.E10
      IFTEMP=IF1
      IF(ITRIAL.GT.MAXN) IFTEMP = IK
      DO 80 I=1,IFTEMP
      IF(Q(I).GT.BESTQ) GO TO 80
      BESTQ=Q(I)
      KOPT=I
      IBTRL=IBT(I)
   80 CONTINUE
C
C   NEW OPTIMUM
C
      IF(BESTQ.GT.QOPT) GO TO 92
      QOPT=BESTQ
      DO 90 I=1,N
      XS(I)=XX(I,KOPT)
      XOPT(I)=XX(I,KOPT)
   90 CONTINUE
      NNBEST=IBTRL
C
   92 CONTINUE
      DO 93 I=1,N
        XROPT(I)=XX(I,KOPT)
   93 CONTINUE
C     PRINT RESULTS FOR THE LOOP
C
      IF(IPFLAG.EQ.1) GO TO 40
      IF(ICYCLE.NE.1) GO TO 35
      WRITE(IPR,610) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=1,NUM1)
      IF(N.LT.9) GO TO 35
      WRITE(IPR,620) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=9,N)
   35 CONTINUE
      WRITE(IPR,630) ICYCLE,IK,IYTRL,YOPTIM,YBIAS,YCOF,(XROPT(I),I=1,
     CNUM1)
      IF(ITRIAL.GT.MAXN) WRITE(IPR,845) MAXN
      IF(N.LT.9) GO TO 40
      WRITE(IPR,640) (XROPT(I),I=9,N)
C
   40 CONTINUE
      IF(ITRIAL.GT.MAXN) GO TO 129
      ICYCLE=ICYCLE+1
      YOPT = 1.0E+20
C      DO 41 I = 1,16
       DO 41 I = 1,MaxNopt
        XROPT(I) = 0.
   41 CONTINUE
C     WRITE(IPR,1) KOPT,IBTRL,BESTQ,NNBEST,QOPT
      CALL POINT(N,XS,XN,ISEED,K,BL,BU,VAR)
C
C   CHECK STOP CRITERION
C
      IF(KOPT.EQ.IF1) IQ1=IQ1+1
      IF(KOPT.NE.IF1) IQ1=0
      IF(IQ1.NE.IF5) GO TO 120
      IEND=1
C
C STOP AND PRINT FINAL RESULTS  -- OPTIMUM HAS BEEN FOUND
C
 129  WRITE(IPR,830)
      WRITE(IPR,582) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=1,NUM1)
      WRITE(IPR,584) (XOPT(J),J=1,NUM1)
      IF(N.LT.9) GO TO 91
      WRITE(IPR,582) (OA(ILOCOA(I)+2),OA(ILOCOA(I)+3),I=9,N)
      WRITE(IPR,584) (XOPT(J),J=9,N)
   91 CONTINUE
      WRITE(IPR,586) YDRMS,YVRMS,YSABDF,YSABLG,YPBIAS,YRMOD1,YRCOF,
     C               YHMLE,YLAMDA
      GO TO 130
C
C***********************************************************************
C  92 CONTINUE
C     ILCL1=1
C
C   CONTINUE SEARCH WITH OPTIMAL VARIANCE
C
C 100 CONTINUE
C
C     NLOCAL=NLOCAL+1
C     IF(KOPT.NE.IF1) IQ1=0
C     IF(ILCL1.EQ.1) GO TO 110
C     WRITE(IPR,2) IQ1,QOPT,ILCL1,KOPT
C
C     IF(OPTIM.GE.QOPT) GO TO 118
C     QOPT=OPTIM
C
C     DO 106 I=1,N
C     XOPT(I)=XN(I)
C 106 CONTINUE
C     GO TO 118
C
C 110 CONTINUE
C     ILCL1=0
C
C 118 CONTINUE
C     CALL POINT(N,XOPT,XN,ISEED,KOPT,BL,BU,VAR)
C
C***********************************************************************

  120 CONTINUE
      DO 124 I=1,N
      A(I)=XN(I)
  124 CONTINUE
      GO TO 140
C
  130 CONTINUE
      DO 134 I=1,N
      A(I)=XOPT(I)
  134 CONTINUE
  140 CONTINUE
      IF(ITRACE.GE.1) WRITE(IODBUG,1002)
 1002 FORMAT(1H0,'** EXIT OARSCH')
      RETURN
    1 FORMAT(' ',4('*'),1X,'KOPT=',I2,2X,'IBTRL=',I4,2X,'BESTQ=',E12.4,
     *   2X,'NNBEST=',I4,2X,'QOPT=',E12.4,1X,50('*'))
    2 FORMAT(' ',5X,'IQ1=',I3,2X,'QOPT=',F7.4,2X,'ILCL1=',I2,2X,
     *   'KOPT=',I3)
  710 FORMAT(1H1)
  580 FORMAT(1H0,//,1X,'*** PRINT THE INITIAL POINT AND ITS STATISTICS',
     *           ' ***',/,1X,62(1H=))
  582 FORMAT(1H0,/,3X,13(2X,2A4))
  584 FORMAT(1H0,13F10.3)
  586 FORMAT(1H0,/,2X,'DAILY RMS',6X,'MON VRMS',5X,'/O-S/**EXP',2X,
     *       '/LOG ERR/**EXP',3X,'% BIAS',6X,'1.-MOD RCOF',6X,'R COEF',
     *       6X,'HMLE VALUE',3X,'LAMDA VALUE',/,2X,9(1H-),6X,8(1H-),5X,
     *       10(1H-),2X,14(1H-),3X,6(1H-),6X,11(1H-),6X,6(1H-),6X,
     *       10(1H-),3X,11(1H-),//,9(E12.4,2X))
  605 FORMAT(1H0,//,1X,'*** PRINT THE RESULTS OF THE ARS SEARCH ***',/,
     *       1X,62(1H=))
  610 FORMAT(1H0,1X,'CYCLE RANGE  TRIAL     CRITERION  % BIAS  R',
     *       ' COEF',2X,8(2X,2A4))
  620 FORMAT(1H0,51X,8(2X,2A4))
  630 FORMAT(1H0,I5,1X,I5,2X,I5,3X,E12.4,F8.2,F8.4,8F10.3)
  640 FORMAT(1H0,51X,8F10.3)
  730 FORMAT(1H0,/,1X,'PRINT THE POPULATION AT LOOP ',I5)
  740 FORMAT(23X,E12.4,F8.2,F8.4,8F10.3)
  750 FORMAT(51X,8F10.3)
  770 FORMAT(1H ,I4,3X,I3,3X,I3,E12.4,F8.2,F8.4,8F10.3)
  780 FORMAT(44X,8F10.3)
  830 FORMAT(1H0,//,1X,'*** PRINT THE FINAL PARAMETER ESTIMATES AND',
     *       ' THE STATISTICS ***',/,1X,62(1H=))
845   FORMAT ( 66H0*** OPTIMIZATION TERMINATED BECAUSE THE MAXIMUM NUMBE
     1R OF RUNS  (,I5,20H)  HAS BEEN REACHED.   )
      END
