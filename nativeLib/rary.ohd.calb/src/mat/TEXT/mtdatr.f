C$PRAGMA C (GET_APPS_DEFAULTS)
C MODULE MTDATR
C-----------------------------------------------------------------------
C
      SUBROUTINE MTDATR (IYR,LYR,IMO,LMO,LASTDA,PXNAME,NDUMST,LPNT,
     *   NFLD,NSTA,ITUNIT,LDEBUG,
     *   MXSTA,MAXCF,MAXOB,NWSST,ITCGE,TMAXC,TMINC,TIMEOB,IOBCGE,DUNITI)
C
C  ROUTINE TO READ STATION TEMPS AND MAKE CORRECTIONS FOR PROGRAM MAT.
C
C MODIFIED BY JAY BREIDENBACH 5/96 TO READ IN INDIVIDUAL STATION FILES
C WHICH ARE SPECIFIED AFTER THE Q CARD.  THE ACTUAL FILES ARE LOCATED IN
C <TRAN_DATA_DIR>/tempt/
C
      CHARACTER*4 DUNITI
C
      INTRINSIC   LEN
      INTEGER     LEN
C
      INCLUDE 'uiox'
      INCLUDE 'clbcommon/crwctl'
      INCLUDE 'clbcommon/bhtime'
C
      CHARACTER FILEMX*32,FILEMN*32
      CHARACTER OFORMAT*12,DIRNAM*80,FILENAM*112
      CHARACTER STAID*12,DESCRP*20,TYPE*4
C      
      REAL MFAC,AFAC
      INTEGER M1, Y1, M2, Y2, AM1X, AM2X, AM1N, AM2N
C      
      DIMENSION PXNAME(MXSTA,5),NDUMST(MXSTA),TIME(2)
      DIMENSION NWSST(MXSTA),ITCGE(MXSTA,11),TMAXC(MXSTA,11)
      DIMENSION TMINC(MXSTA,11),TIMEOB(MXSTA,11),IOBCGE(MXSTA,11)
      DIMENSION TEM(126),TEMPMX(31),TEMPMN(31),LASTDA(2,12)
      DIMENSION TEMP(62)
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/calb/src/mat/RCS/mtdatr.f,v $
     . $',                                                             '
     .$Id: mtdatr.f,v 1.6 2002/02/11 18:57:36 dws Exp $
     . $' /
C    ===================================================================
C
      DATA TIME/3HMIN,3HMAX/
C
C      
      IUNITMX=0
      IUNITMN=0
C
      IF (LDEBUG.GT.0) THEN
         WRITE (LP,*) 'MAXCF=',MAXCF,
     *      ' MAXOB=',MAXOB
         DO 20 I=1,NSTA
            WRITE (LP,10) I,(TMAXC(I,J),J=1,11)
10          FORMAT (' I=',I2,1X,'TMAXC(I,1...11)=',11(F7.2,1X))
20          CONTINUE
         DO 40 I=1,NSTA
            WRITE (LP,30) I,(TMINC(I,J),J=1,11)
30          FORMAT (' I=',I2,1X,'TMINC(I,1...11)=',11(F7.2,1X))
40          CONTINUE
         DO 60 I=1,NSTA
            WRITE (LP,50) I,(TIMEOB(I,J),J=1,11)
50          FORMAT (' I=',I2,1X,'TIMEOB(I,1...11)=',11(F7.2,1X))
60          CONTINUE
         DO 80 I=1,NSTA
            WRITE (LP,70) I,(IOBCGE(I,J),J=1,11)
70          FORMAT (' I=',I2,1X,'IOBCGE(I,1...11)=',11(I7,1X))
80          CONTINUE
         DO 100 I=1,NSTA
            WRITE (LP,90) I,(ITCGE(I,J),J=1,11)
90          FORMAT (' I=',I2,1X,'ITCGE(I,1...11)=',11(I7,1X))
100         CONTINUE
         ENDIF
C
      IF (LPNT.EQ.1) WRITE (LP,550)
      
      ISTOP=0
      ISTOP2=0
      ITYPER=0
      IONCE=1
      IRG=1
      NBMO=IYR*12+IMO
      NEMO=LYR*12+LMO
C
110   MONUM=1
      IERROR=0
      IPHEAD=1
      MISIDC=0
      LASTMO=0
      IEND=0
      IP=3
      NOBC=1
      NTC=1
      TEM(1)=999.0
      TEM(2)=999.0
      NUM=IRG
      IF (NDUMST(IRG).EQ.0) GO TO 140
C
C  DUMMY STATION
120   IL=126
      DO 130 I=IP,IL
         TEM(I)=999.0
130      CONTINUE
      GO TO 460
C
140   IMOX=0
      IYRX=0
      LMOX=0
      LYRX=0
C      
      NFLD=0
      ISTRT=0
C
C  READ MAX-TEMPERATURE TIME SERIES FILE NAME
CCC      NCHAR=-LEN(TYPE)
      NCHAR=LEN(TYPE)/4
      CALL UFIELD (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,UREAL,
     *   NCHAR,TYPE,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
CCC      NCHAR=-LEN(FILEMX)
      NCHAR=LEN(FILEMX)/4
      CALL UFIELD (NFLD,ISTRT,LENGTH,ITYPEU,NREP,INTEGR,UREAL,
     *   NCHAR,FILEMX,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
C  IF TYPE READ IN IS NOT MAXIMUM (AND FIRST DETECTION OF SUCH ERROR),
C  THEN CARDS IN WRONG ORDER. SET STOP FLAG, BUT CONTINUE TO READ CARDS
      IF (TYPE.NE.'TAMX'.AND.ITYPER.EQ.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,600) 'TAMX',TYPE
         ITYPER=1
         ENDIF
C
C  GET NAME OF DATA DIRECTORY
      CALL GET_APPS_DEFAULTS('calb_sta_ts_dir',15,DIRNAM,LDIRNAM)
C      
C  MAKE WHOLE PATHNAME     
C  TRUNCATE THE BLANK SPACES OFF THE END OF FILEMX, THEN APPEND IT TO
C  THE END OF THE FILE NAME WHERE THE OUTPUT TIME SERIES IS WRITTEN.
      CALL ULENTH(FILEMX,LEN(FILEMX),ILEN)
      FILENAM = ' '
      IF (LDIRNAM.GT.0 .AND. LDIRNAM+ILEN+7.LE.112) THEN
         FILENAM=DIRNAM(1:LDIRNAM)//'/tempt/'//FILEMX(1:ILEN)
         ENDIF
      IF (LDIRNAM.EQ.0) THEN
         FILENAM=FILEMX(1:ILEN)
         ENDIF   
      IF (FILENAM .EQ. ' ') THEN
         IERROR = 1
         ISTOP2 = 1
         WRITE (LP,640)
         GOTO 540
         ENDIF
C
C  CALL CARDLO TO LOCATE THE TIME SERIES AND SEE IF ANY UNITS CONVERSION
C  IS NEEDED. CARDLO WILL ALSO RETURN THE BEGINNING AND ENDING DATES AND
C  THE DATA FORMAT OF THE INPUT DATA FILE. 
      CALL CARDLO (IMOX,IYRX,LMOX,LYRX, M1, Y1, M2, Y2,
     +             DUNITI, UNITS, FILENAM, TYPE, ITIMEX, STAID,
     +             DESCRP, IUNITMX, OFORMAT, MFAC, AFAC, AM1X, AM2X,
     +             IERROR)    
      IF (IERROR.EQ.1) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,620)
         GO TO 540
         ENDIF
C
      NBMOX=IYRX*12+IMOX
      NEMOX=LYRX*12+LMOX
      IF (NEMOX.LT.NBMO) GO TO 150
      IF (NBMOX.GT.NEMO) GO TO 150
      GO TO 160
C
C  DATA IS ALL OUTSIDE PERIOD NEEDED - TREAT AS DUMMY STATION
150   NDUMST(IRG)=1
      IF (LDEBUG.GE.2) WRITE (LP,570) IRG,(PXNAME(IRG,I),I=1,5)
      GO TO 180
C
C  CHECK IF DATA STARTS BEFORE PERIOD NEEDED
160   IF (NBMOX.GE.NBMO) GO TO 180
      NN=NBMO-1
      DO 170 I=NBMOX,NN
         ICYR=(I-1)/12
         ICMO=I-ICYR*12       
CCC         CALL RDFILE (1,FILEMX,1,NXRX,ISEQX,1,ICMO,ICYR,1,31,TEMPMX) 
         CALL CARDRD (1,IUNITMX,OFORMAT,AM1X,AM2X,MFAC,AFAC,ITIMEX,
     +                ICMO,ICYR,TEMPMX,1,IERROR)
170      CONTINUE
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
      IMOX=IMO
      IYRX=IYR
      NBMOX=IYRX*12+IMOX
C
C  READ MIN-TEMPERATURE TIME SERIES FILE NAME
180   IMON=0
      IYRN=0
      LMON=0
      LYRN=0
CCC      NCHAR=-LEN(TYPE)
      NCHAR=LEN(TYPE)/4
      CALL UFIELD (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,UREAL,
     *   NCHAR,TYPE,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
CCC      NCHAR=-LEN(FILEMN)
      NCHAR=LEN(FILEMN)/4
      CALL UFIELD (NFLD,ISTRT,LENGTH,ITYPE,NREP,INTEGR,UREAL,
     *   NCHAR,FILEMN,LLPAR,LRPAR,LASK,LATSGN,LAMPS,LEQUAL,ISTAT)
C
C IF TYPE READ IN IS NOT MINIMUM (AND FIRST DETECTION OF SUCH ERROR),
C THEN CARDS IN WRONG ORDER. SET STOP FLAG, BUT CONTINUE TO READ CARDS
      IF (TYPE.NE.'TAMN'.AND.ITYPER.EQ.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,600) 'TAMN',TYPE
         ITYPER=1
         ENDIF
C
      IF (NDUMST(IRG).EQ.1) GO TO 120
C
C  MAKE WHOLE PATHNAME     
C  TRUNCATE THE BLANK SPACES OFF THE END OF FILEMX, THEN APPEND IT TO
C  THE END OF THE FILE NAME WHERE THE OUTPUT TIME SERIES IS WRITTEN.
C
      CALL ULENTH(FILEMN,LEN(FILEMN),ILEN)
      FILENAM = ' '
      IF (LDIRNAM.GT.0 .AND. LDIRNAM+ILEN+7.LE.112) THEN
         FILENAM=DIRNAM(1:LDIRNAM)//'/tempt/'//FILEMN(1:ILEN)
         ENDIF   
      IF (LDIRNAM.EQ.0) THEN
         FILENAM=FILEMN(1:ILEN)
         ENDIF

      IF (FILENAM .EQ. ' ') THEN
         IERROR = 1
         ISTOP2 = 1
         WRITE (LP,640)
         GOTO 540
         ENDIF
C
      CALL CARDLO (IMON,IYRN,LMON,LYRN, M1, Y1, M2, Y2,
     +             DUNITI, UNITS, FILENAM, TYPE, ITIMEN, STAID,
     +             DESCRP, IUNITMN, OFORMAT, MFAC, AFAC, AM1N, AM2N,
     +             IERROR)    
      IF (IERROR.EQ.1) GO TO 530
      IF (IERROR.GT.1) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,620)
         GO TO 540
         ENDIF
      NBMON=IYRN*12+IMON
      NEMON=LYRN*12+LMON
      IF (NEMON.LT.NBMO) GO TO 190
      IF (NBMON.GT.NEMO) GO TO 190
      GO TO 200
C
C  DATA OUTSIDE PERIOD - TREAT AS DUMMY STATION
190   NDUMST(IRG)=1
      IF (LDEBUG.GE.2) WRITE (LP,570) IRG,(PXNAME(IRG,I),I=1,5)
      GO TO 120
C      
C  CHECK IF IF DATA STARTS BEFORE NBMO
200   IF (NBMON.GE.NBMO) GO TO 220
      NN=NBMO-1
      DO 210 I=NBMON,NN
         ICYR=(I-1)/12
         ICMO=I-ICYR*12       
CCC         CALL RDFILE (1,FILEMN,1,NXRN,ISEQN,1,ICMO,ICYR,1,31,TEMPMN)
         CALL CARDRD (1,IUNITMN,OFORMAT,AM1N,AM2N,MFAC,AFAC,ITIMEN,
     +                ICMO,ICYR,TEMPMN,1,IERROR)
210      CONTINUE
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
      IMON=IMO
      IYRN=IYR
      NBMON=IYRN*12+IMON
C
C  CHECK IF MAX AND MIN ARE POSITIONED TO START AT THE SAME MONTH
220   IF (NBMOX.EQ.NBMON) GO TO 260
      IF (NBMOX.LT.NBMON) GO TO 240
C
C  MINIMUM STARTS FIRST
      NN=NBMOX-1
      DO 230 I=NBMON,NN
         ICYR=(I-1)/12
         ICMO=I-ICYR*12     
CCC         CALL RDFILE (1,FILEMN,1,NXRN,ISEQN,1,ICMO,ICYR,1,31,TEMPMN)
         CALL CARDRD (1,IUNITMN,OFORMAT,AM1N,AM2N,MFAC,AFAC,ITIMEN,
     +                ICMO,ICYR,TEMPMN,1,IERROR)
230      CONTINUE
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
      NCMO=NBMOX
      GO TO 270
C
C  MAXIMUM STARTS FIRST
240   NN=NBMON-1
      DO 250 I=NBMOX,NN
         ICYR=(I-1)/12
         ICMO=I-ICYR*12       
CCC         CALL RDFILE (1,FILEMX,1,NXRX,ISEQX,1,ICMO,ICYR,1,31,TEMPMX)
         CALL CARDRD (1,IUNITMX,OFORMAT,AM1X,AM2X,MFAC,AFAC,ITIMEX,
     +                ICMO,ICYR,TEMPMX,1,IERROR)
250      CONTINUE
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
C         
260   NCMO=NBMON
270   NLMO=NEMOX
      IF (NLMO.GT.NEMON)NLMO=NEMON
      IF (NLMO.GT.NEMO)NLMO=NEMO
      GO TO 290
C
C  READ DATA FOR NEXT MONTH
280   IF (NCMO.LT.NLMO) NCMO=NCMO+1
      IF (IEND.EQ.1) GO TO 320
      IF (NCMO.EQ.NLMO) IEND=1
      IF (IEND.EQ.1) IPHEAD=1
290   ICYR=(NCMO-1)/12
      ICMO=NCMO-ICYR*12
CCC      CALL RDFILE (1,FILEMX,1,NXRX,ISEQX,1,ICMO,ICYR,1,31,TEMPMX)
      CALL CARDRD (1,IUNITMX,OFORMAT,AM1X,AM2X,MFAC,AFAC,ITIMEX,
     +             ICMO,ICYR,TEMPMX,1,IERROR)
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
      DO 300 I=1,31
         IF (IFMSNG(TEMPMX(I)).EQ.1) TEMPMX(I)=999.0
300      CONTINUE
CCC      CALL RDFILE (1,FILEMN,1,NXRN,ISEQN,1,ICMO,ICYR,1,31,TEMPMN)
      CALL CARDRD (1,IUNITMN,OFORMAT,AM1N,AM2N,MFAC,AFAC,ITIMEN,
     +             ICMO,ICYR,TEMPMN,1,IERROR)    
      IF (IERROR.GT.0) THEN
         CALL UEROR (LP,0,-1)
         WRITE (LP,630)
         GO TO 540
         ENDIF
      DO 310 I=1,31
         IF (IFMSNG(TEMPMN(I)).EQ.1) TEMPMN(I)=999.0
310      CONTINUE
C
320   IF (MONUM.EQ.(NCMO-NBMO+1)) GO TO 350
      MISIDC=1
      IL=IP+62-1
      DO 330 I=IP,IL
         TEM(I)=999.0
330      CONTINUE
      NYR=(MONUM-1)/12
      IYRC=IYR+NYR
      NMO=MONUM-NYR*12
      IMOC=IMO+NMO-1
      IF (IMOC.LT.13) GO TO 340
      IMOC=IMOC-12
      IYRC=IYRC+1
340   LY=0
      IF ((IYRC-4*(IYRC/4)).EQ.0) LY=1
      LAST=LASTDA((LY+1),IMOC)
      MONUM=MONUM+1
      IF (MONUM.EQ.2) GO TO 450
      GO TO 460
350   MONUM=MONUM+1
      MISIDC=0
      LY=0
      IF ((ICYR-4*(ICYR/4)).EQ.0) LY=1
      LAST=LASTDA((LY+1),ICMO)
      HR=TIMEOB(IRG,NOBC)
      TXC=TMAXC(IRG,NTC)
      TNC=TMINC(IRG,NTC)
      IF (LDEBUG.GT.0) WRITE (LP,*) 'IRG=',IRG,' NTC=',NTC,' TNC=',TNC
      IF ((MONUM-1).LT.IOBCGE(IRG,NOBC)) GO TO 360
         NOBC=NOBC+1
         HR=TIMEOB(IRG,NOBC)
         IPHEAD=1
360   IF ((MONUM-1).LT.ITCGE(IRG,NTC)) GO TO 370
         NTC=NTC+1
         TXC=TMAXC(IRG,NTC)
         IPHEAD=1
         TNC=TMINC(IRG,NTC)
         IF (LDEBUG.GT.0) THEN
            WRITE (LP,*) 'IRG=',IRG,' NTC=',NTC,' TNC=',TNC
            ENDIF
370   IF (HR.LT.13.0) GO TO 380
         IS=IP+1
         GO TO 390
380   IS=IP-1
390   DO 410 I=1,31
         J=IS+(I-1)*2
         IF (TEMPMX(I).GT.998.0) GO TO 400
            TEMPMX(I)=TEMPMX(I)+TXC
400         TEM(J)=TEMPMX(I)
410      CONTINUE
      IF (HR.LT.13.0) TEM(IS+62)=999.0
      IF (LPNT.EQ.1) IPHEAD=1
      IF (IPHEAD.EQ.0) GO TO 420
         IF (LPNT.EQ.1.AND.LDEBUG.GE.2.AND.IONCE.EQ.1)
     *      WRITE (LP,590) IRG,(PXNAME(IRG,I),I=1,5)
         IONCE=0
         IF (LPNT.EQ.1) WRITE (LP,580) TIME(2),(TEMPMX(I),I=1,LAST)
C
420   IPHEAD=0
      DO 440 I=1,31
         J=IP+(I-1)*2
         IF (TEMPMN(I).GT.998.0) GO TO 430
            TEMPMN(I)=TEMPMN(I)+TNC
            IF (LDEBUG.GT.0) WRITE (LP,*) 'TNC=',TNC
430         TEM(J)=TEMPMN(I)
440      CONTINUE
      IF (LPNT.EQ.1) WRITE (LP,580) TIME(1),(TEMPMN(I),I=1,LAST)
      IF (MONUM.EQ.2) GO TO 450
      GO TO 460
450   IP=(LAST+1)*2+1
      IF (MISIDC.EQ.1) GO TO 320
      GO TO 280
C
460   IF (ISTOP2.EQ.1) GO TO 480
C
      DO 470 I=1,62
         TEMP(I)=TEM(I+2)
470      CONTINUE
C
C  WRITE MAX-MIN DATA TO SCRATCH FILE
      WRITE (UNIT=ITUNIT,REC=NUM) TEMP
      IF (LDEBUG.GE.3) THEN
         WRITE (LP,999) TEMP
         ENDIF
999   FORMAT (' TEMP=',10F10.3)     
C
480   IF (LASTMO.EQ.1) GO TO 530
      IF (NDUMST(IRG).EQ.1) GO TO 500
C
C  SHIFT DATA
      DO 490 I=1,62
         TEM(I+2)=TEM(IP+I-1)
490      CONTINUE
      IP=(LAST+1)*2+1
500   NUM=NUM+NSTA
      IF (NDUMST(IRG).EQ.1)MONUM=MONUM+1
      IF (MONUM.EQ.(NEMO-NBMO+2)) GO TO 510
      IF (NDUMST(IRG).EQ.1) GO TO 460
      IF (MISIDC.EQ.1) GO TO 320
      GO TO 280
C
C  LAST MONTH AT EACH STATION
510   IF (NDUMST(IRG).EQ.1) GO TO 520
         HR=TIMEOB (IRG,NOBC)
         IF (HR.GT.12.0) GO TO 520
         TEM(IP-1)=TEM(IP-3)
520   LASTMO=1
      GO TO 460
530   CALL CCLOSL
      IF (IRG.EQ.NSTA) GO TO 540
      IF (IERROR.EQ.1) ISTOP2=1
      IRG=IRG+1
      IONCE=1
      GO TO 110
C
540   IF (ISTOP2.EQ.1.OR.ITYPER.EQ.1) THEN
         IUSTOP=0
         CALL USTOP (LP,IUSTOP)
         ENDIF

      RETURN
C
C-----------------------------------------------------------------------
C
550   FORMAT ('1',10X,'*** INPUT TEMPERATURE DATA ***' /)
570   FORMAT (1X,'DATA OUTSIDE PERIOD NEEDED BY MAT ---> STATION #',
     *  I3,' *** ',5A4,' *** NOW A DUMMY STATION.')
580   FORMAT (1H ,A3,1X,31F4.0)
590   FORMAT (1X,'STATION #',I3,'  NAME: ',5A4)
600   FORMAT ('0*** ERROR - DATA TYPE ',A,' EXPECTED AND TYPE ',
     *  A4,' FOUND. TIME SERIES MAXIMUM DATA ',
     *  '(TAMX) MUST PRECEDE MINIMUM DATA (TAMN).')
620   FORMAT ('0*** ERROR - RETURNED FROM CARDLO IN ROUTINE MTDATR.')
630   FORMAT ('0*** ERROR - RETURNED FROM RDFILE IN ROUTINE MTDATR.')
640   FORMAT ('0*** ERROR - A FILENAME WAS TOO LONG OR MISSING.')
C
      END
