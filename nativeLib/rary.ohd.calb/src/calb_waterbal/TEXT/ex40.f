C MEMBER EX40
C  (from old member MCEX40)
C-----------------------------------------------------------------------
C
C                             LAST UPDATE: 12/17/93.09:40:26 BY $WC20SV
C
      SUBROUTINE EX40(PO,CO,P,MP,C,MC,LOCPS,LOCCS,LOCPL,LOCCL,QO,QS,WORK
     &)
C***************************************
C
C     THIS IS THE EXECUTION SUBROUTINE FOR THE 'WATERBAL' OPERATION.
C
C     THIS SUBROUTINE WAS INITIALLY WRITTEN BY:
C     ROBERT M. HARPER     HRL      APRIL, 1991
C***************************************
C
      DIMENSION PO(1),CO(1),P(MP),C(MC),QO(1),QS(1),WORK(1)
      DIMENSION LOCPS(1),LOCPL(1),LOCCS(1),LOCCL(1)
      DIMENSION MON(12),NDA(12),SNAME(2)
C
      INCLUDE 'common/fdbug'
      INCLUDE 'common/ionum'
      INCLUDE 'common/fctime'
      INCLUDE 'common/fnopr'
      INCLUDE 'common/fwyds'
      INCLUDE 'common/fwydat'
      INCLUDE 'common/fengmt'
C
C    ================================= RCS keyword statements ==========
      CHARACTER*68     RCSKW1,RCSKW2
      DATA             RCSKW1,RCSKW2 /                                 '
     .$Source: /fs/hseb/ob72/rfc/calb/src/calb_waterbal/RCS/ex40.f,v $
     . $',                                                             '
     .$Id: ex40.f,v 1.2 1996/07/11 19:21:58 dws Exp $
     . $' /
C    ===================================================================
C
C
      DATA MON/'JAN ','FEB ','MAR ','APR ','MAY ','JUN ','JUL ','AUG ','
     &SEP ','OCT ','NOV ','DEC '/
      DATA NDA/31,28,31,30,31,30,31,31,30,31,30,31/
      DATA SNAME/'EX40','    '/
      DATA API/'API-'/
      DATA BLANK/'    '/
C***************************************
C
      CALL FPRBUG(SNAME,1,40,IBUG)
C
C     RETURN IMMEDIATELY IF PRINTER OUTPUT NOT ALLOWED
      IF(NOPROT .EQ. 1) RETURN
C***************************************
C
C     CONTROL VARIABLES
      NOSUB=PO(14)
      LWY=PO(16)
      LZN=PO(17)
      NVAL=30
      ITOTDA=(LDARUN-IDARUN)+1
      IAPI=0
C
      IF(PO(34) .EQ. API) IAPI=1
      IF(IAPI .EQ. 1) NVAL=16
C***************************************
C
C     DEBUG OUTPUT - CONTENTS OF THE LOCPS,LOCCS,LOCPL,LOCCL ARRAYS.
      IF(IBUG .EQ. 0) GO TO 5
      WRITE(IODBUG,900)
  900 FORMAT(/5X,'EX40 DEBUG OUTPUT')
      WRITE(IODBUG,910)
  910 FORMAT(/5X,'THE CONTENTS OF THE POINTER ARRAY LOCPS')
      WRITE(IODBUG,920) (LOCPS(K),K=1,NOSUB)
  920 FORMAT(5X,I5)
      WRITE(IODBUG,930)
  930 FORMAT(/5X,'THE CONTENTS OF THE POINTER ARRAY LOCCS')
      WRITE(IODBUG,940) (LOCCS(K),K=1,NOSUB)
  940 FORMAT(5X,I5)
      WRITE(IODBUG,950)
  950 FORMAT(/5X,'THE CONTENTS OF THE POINTER ARRAY LOCPL')
      WRITE(IODBUG,960) (LOCPL(K),K=1,NOSUB)
  960 FORMAT(5X,I5)
      WRITE(IODBUG,970)
  970 FORMAT(/5X,'THE CONTENTS OF THE POINTER ARRAY LOCCL')
      WRITE(IODBUG,980) (LOCCL(K),K=1,NOSUB)
  980 FORMAT(5X,I5)
C***************************************
C
C     DETERMINE CURRENT MONTH
    5 CALL MDYH1(LDA,LHR,MONTH,LD,KYEAR,IX,NOUTZ,NOUTDS,TZCODE)
C***************************************
C
C     COMPUTE VALUES FOR TABLES 1-3 AND WRITE MONTHLY TOTALS TO WATER
C     YEAR SCRATCH FILE.
      MOWY=MONTH+3
      IF(MOWY .GT. 12) MOWY=MOWY-12
C
C     DETERMINE FIRST RECORD FOR THIS MONTH
      NREC=LWY+(NOSUB*(MOWY-1))
      CALL WTWY40(PO,P,MP,C,MC,LOCPS,LOCPL,LOCCS,LOCCL,NREC,NOSUB,IBUG,I
     &API,NVAL)
C***************************************
C
C     COMPUTE VALUES FOR MULTI-YEAR WATER BALANCE AND FILL CO()
      IDAY=1
      LASTDA=NDA(MONTH)
      IF((KYEAR .EQ.((KYEAR/4)*4)) .AND. (MONTH .EQ. 2)) LASTDA=LASTDA+1
      CALL MYWB40(PO,P,CO,LOCPS,LOCPL,QO,QS,NOSUB,IOPT1,IDAY,LASTDA,MOWY
     &,ITOTDA,IBUG,IAPI)
C
      IF(IAPI .EQ. 1) GO TO 10
C***************************************
C
      IOPT2=0
      IF(PO(17) .LT. 1.0) GO TO 10
      IOPT2=1
C
C     COMPUTE VALUES FOR THE OPTIONAL MULTI-YEAR ZONE CONTENTS TABLE
C     AND WRITE VALUES TO THE WATER YEAR SCRATCH FILE.
      CALL MYZC40(PO,C,MC,LOCCL,NOSUB,MOWY,MONTH,KYEAR,IBUG)
C***************************************
C     CHECK IF PLOT SHOULD BE GENERATED THIS MONTH.
   10 IF((MONTH .EQ. 9) .OR. (LDA .EQ. LDARUN)) GO TO 20
      RETURN
C
C     ALL APPROPRIATE MONTHLY VALUES HAVE BEEN COMPUTED AND STORED IN
C     THE SCRATCH FILE AND CO().
C***************************************
C
C     PRINT WATER BALANCE TABLES.
C     CHECK IF THIS IS THE LAST YEAR OF THE RUN.
   20 LASTYR=0
      IF(LDA .EQ. LDARUN) LASTYR=1
C
C     DETERMINE CURRENT WATER YEAR
      KWY=KYEAR
      IF(MONTH .GT. 9) KWY=KWY+1
C
C     CHECK IF THIS RUN BEGAN DURING INITIAL WATER YEAR.
      IHOUR=IHRRUN
      IF(IHOUR .EQ.0) IHOUR=1
      CALL MDYH1(IDARUN,IHOUR,IMONTH,ID,IYEAR,IX,NOUTZ,NOUTDS,TZCODE)
      IWY=IYEAR
      IF(IMONTH .GT. 9) IWY=IWY+1
      IF(IWY .EQ. KWY) GO TO 30
      IMONTH=10
C***************************************
C
C     BEGIN YEARLY MONTHLY PLOTTING LOOP FOR WATER BALANCE SUMMARY.
   30 DO 40 N=1,NOSUB
        I1=23+(N-1)*17
        WT=PO(I1+5)
        KMO=IMONTH
        KYR=KWY
        IF(KMO .GT. 9) KYR=KWY-1
        IEND=0
        L=0
        LPL=LOCPL(N)
        IFI=P(LPL+23)
        ISV=P(LPL+13)
C
C       DETERMINE THE FIRST RECORD ON THE SCRATCH FILE FOR CURRENT
C       SUBAREA.
        NREC=LWY+(N-1)
C
C       READ MONTHLY SUMS FOR TABLES 1-3 FROM SCRATCH FILE TO WY() ONE
C       MONTH AT A TIME.
   80   MOWY=KMO+3
        IF(MOWY .GT. 12) MOWY=MOWY-12
        READ(IRWY,REC=NREC) WY
C
C       DEBUG OUPTPUT - CONTENTS OF WY() BEFORE PRINTING WATER BALANCE
C       TABLES.
        IF(IBUG .EQ. 0) GO TO 60
        WRITE(IODBUG,1110) N
 1110   FORMAT(/,5X,'EX40 DEBUG OUTPUT-CONTENTS OF WY() BEFORE PRINTING
     &WATER BALANCE TABLES. SUBAREA NO.',I5)
        IF(IAPI .EQ. 1) GO TO 65
        WRITE(IODBUG,1120) (WY(I),I=1,14)
 1120   FORMAT(5X,14(F7.2,1X))
        WRITE(IODBUG,1130) (WY(I),I=15,21)
 1130   FORMAT(5X,7(F7.2,1X))
        WRITE(IODBUG,1140) (WY(I),I=22,30)
 1140   FORMAT(5X,9(F7.2,1X))
        GO TO 60
   65   WRITE(IODBUG,1145) (WY(I),I=1,16)
 1145   FORMAT(4X,16(F7.2,1X))
C
C       TRANSFER MONTHLY VALUES FROM WY() TO WORK()
   60   DO 55 K=1,30
          WORK(L+K)=WY(K)
   55   CONTINUE
C
C       DEBUG OUTPUT-CONTENTS OF WORK() BEFORE PRINTING WATER BALANCE
C       TABLES.
        IF(IBUG .EQ. 0) GO TO 67
        WRITE(IODBUG,1147)
 1147   FORMAT(/,5X,'EX40 DEBUG OUTPUT-CONTENTS OF WORK() BEFORE PRINTIN
     &G WATER BALANCE TABLES.')
        WRITE(IODBUG,1146) NVAL
 1146   FORMAT(5X,'NVAL=',I5)
        II=L+1
        MM=L+16
        WRITE(IODBUG,1145) (WORK(I),I=II,MM)
C
C       PERFORM NECESSARY UNIT CONVERSIONS DEPENDING ON RAINFALL-RUNOFF
C       MODEL TYPE.
   67   IF(IAPI .EQ. 1) GO TO 75
C       UNIT CONVERSIONS IF SACRAMENTO MODEL USED
        IF(METRIC .EQ. 1) GO TO 150
C       ENGLISH UNITS REQUESTED
        DO 140 K=1,NVAL
          IF(K .EQ. 29) GO TO 140
          WORK(L+K)=WORK(L+K)/25.4
  140   CONTINUE
        GO TO 150
C
C       UNIT CONVERSIONS IF CONTINUOUS API MODEL USED
   75   IF(METRIC .EQ. 0) GO TO 145
C       METRIC UNITS REQUESTED-ALL API-CONT VALUES CONVERTED FROM IN TO
C       MM
        IF(PO(I1+6) .NE. BLANK) GO TO 85
        WORK(L+1)=WORK(L+1)*25.4
   85   DO 95 K=6,14
          IF (K .EQ. 12) GO TO 95
          WORK(L+K)=WORK(L+K)*25.4
   95   CONTINUE
        IF(IFI .EQ. 0) GO TO 97
        WORK(L+15)=(WORK(L+15)-32.0)/1.8
   97   IF(ISV .NE. 0) GO TO 155
        WORK(L+16)=0.0
        GO TO 150
  155   IF(ISV .EQ. 1) GO TO 105
C       ATI
        WORK(L+16)=(WORK(L+16)-32.0)/1.8
        GO TO 150
C       AEI
  105   WORK(L+16)=WORK(L+16)*25.4
        GO TO 150
C       ENGLISH UNITS REQUESTED-ALL SNOW-17 VALUES CONVERTED FROM MM TO
C       IN
  145   IF(PO(I1+6) .EQ. BLANK) GO TO 150
        DO 175 K=1,5
          WORK(L+K)=WORK(L+K)/25.4
  175   CONTINUE
C
  150   NREC=NREC+NOSUB
        IF(KMO .NE. MONTH) GO TO 50
        IEND=1
   50   IF(IEND .EQ. 1) GO TO 70
        L=L+30
        KMO=KMO+1
        IF(KMO .LT. 13) GO TO 80
        KMO=1
        GO TO 80
C
C       PLOT WATER BALANCE TABLES.
   70   CALL PLOTWB(PO,WORK(1),WORK(361),MON,IMONTH,MONTH,KWY,KYR,I1,WT,
     &IAPI,ISV,IFI)
   40 CONTINUE
      IF(IAPI .EQ. 1) GO TO 120
      IF((LASTYR .EQ. 1) .AND. (IOPT2 .EQ. 1)) GO TO 90
      GO TO 120
C
C     END OF RUN. BEGIN PLOTTING LOOP FOR OPTIONAL MULTI-YEAR AVERAGE
C     ZONE CONTENTS DISPLAY.
   90 DO 130 K=1,NOSUB
        I1=23+(K-1)*17
C
C       TRANSFER MULTI-YEAR AVERAGE ZONE CONTENTS FROM WY() TO WORK()
C       FOR EACH SUBAREA.
        READ(IRWY,REC=LZN) WY
        DO 100 I=1,192
          WORK(I)=WY(I)
  100   CONTINUE
        IF(METRIC .EQ. 1) GO TO 160
C
C       ENGLISH UNITS REQUESTED
        DO 170 I=1,192
          WORK(I)=WORK(I)/25.4
  170   CONTINUE
  160   LZN=LZN+1
C
C       PLOT MULTI-YEAR AVERAGE ZONE CONTENTS DISPLAY.
        CALL PLOTZC(PO,WORK,MON,I1,K)
  130 CONTINUE
  120 IF((IOPT1 .NE. 1) .AND. (LASTYR .NE. 1)) GO TO 110
C
C     PLOT APPROPRIATE (MULTI-YEAR/YEARLY) WATER BALANCE SUMMARY FOR THE
C     ENTIRE AREA.
      CALL PLOTMY(PO,CO,IMONTH,KYR,MONTH,KWY,IOPT1,IOPT2,LASTYR,IAPI)
      IF(LASTYR .NE. 1) GO TO 110
      ICO=CO(10)
      IF(ICO .EQ. ITOTDA) GO TO 110
      MISQO=ITOTDA-ICO
      WRITE(IPR,1150) MISQO
 1150 FORMAT(/5X,'**WARNING** A TOTAL OF',I6,' OBSERVED DISCHARGE VALUES
     & ARE MISSING DURING THE RUN PERIOD.')
C***************************************
C
C     TRACE LEVEL=1
  110 IF(ITRACE .GE. 1) WRITE(IODBUG,1100) SNAME
 1100 FORMAT(/1X,'** ',2A4,' EXITED')
C
      RETURN
      END
