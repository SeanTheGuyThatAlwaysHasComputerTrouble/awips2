
/*******************************************************************************
* FILENAME:            read_rwprefs.c
* NUMBER OF MODULES:   2
* GENERAL INFORMATION:
*   MODULE 1:          select_default_display
* DESCRIPTION:         Sets the default display to a product being generated
*                      by MPE FieldGen.
*   MODULE 2:          read_rwprefs
* DESCRIPTION:         Reads the number of hours to display in the choose hour
*                      window from the RWPrefs table in the IHFS database.
*                      Also, reads the MPE field to initially display in 
*                      Hydroview/MPE by default when an hour is chosen.
*
* ORIGINAL AUTHOR:     Bryon Lawrence
* CREATION DATE:       March 19, 2004
* ORGANIZATION:        OHD/HL/HSEB
* OPERATING SYSTEM:    Redhat Linux 7.2
* MODIFICATION HISTORY:
*   MODULE #        DATE         PROGRAMMER        DESCRIPTION/REASON
*          1        3/19/2004    Bryon Lawrence    Restructured based on
*                                                  old read_rwprefs routine.
********************************************************************************
*/

#include <stdio.h>
#include <string.h>

#include "DbmsDefs.h"
#include "DbmsUtils.h"
#include "GeneralUtil.h"
#include "get_mpe_product_state.h"
#include "mpe_field_names.h"
#include "mpe_log_utils.h"
#include "read_rwprefs.h"
#include "rfcwide.h"
#include "RWPrefs.h"
#include "stage3.h"


/*******************************************************************************
* MODULE NUMBER: 1 
* MODULE NAME:   select_default_display
* PURPOSE:       Sets the default display type to a product which is being 
*                created by MPE FieldGen
*
* ARGUMENTS:
*   None
* RETURNS:
*   None
*
* APIs UTILIZED:
*   NAME                                    HEADER FILE DESCRIPTION
*   get_mpe_product_state    get_mpe_product_state.h Indicates if a given
*                                                    MPE product is on or off.
*   get_qpe_fields_array     get_mpe_product_state.h Returns an array of
*                                                    qpe fields recognized
*                                                    by get_mpe_product_state.
* LOCAL DATA ELEMENTS (OPTIONAL):
*   DATA TYPE  NAME                         DESCRIPTION
*   char *     pProduct            Points to the MPE Product whose state 
*                                  is currently being tested.
*   char **    pQpeFields          Points to the array of QPE fields
*                                  recognized by the get_mpe_product_state
*                                  routine.
*   int        i                   A loop index.
*   int        mpe_product_state   Indicates if the default field type is
*                                  being generated by MPE FieldGen.  
*   int        product_name_length The length of the default displat type. 
*                                  selected from the RWPrefs table.
*   int        status              Contains return codes from functions.
*   int        verbose             Verbose flag.  1 = log to stdout and stderr.
*                                  0 = Do not log to stdout and stderr.
*
*
* DATA FILES AND/OR DATABASE:
*   None
*
* ERROR HANDLING:
*   None
********************************************************************************
*/
static void select_default_display ( )
{
   const char * pProduct = NULL ;
   const char ** pQpeFields = NULL ;
   int i ;
   int mpe_product_state ;
   int product_name_length ;
   int status ;
   const int verbose = 1 ;

   /* Get the array of MPE qpe fields. */
   pQpeFields = get_qpe_fields_array ( ) ;

   /* Attempt to pick a default field type. */
   for ( i = 0; i < NUM_BEST_PRODUCTS; ++i )
   {
      pProduct = pQpeFields [ i ] ;
      product_name_length = strlen ( pProduct ) ;
      get_mpe_product_state ( pProduct, & product_name_length,
                              & verbose , & mpe_product_state , & status ) ;

      if ( mpe_product_state == 1 ) break ;
   }

   if ( mpe_product_state == 1 )
   {
      flogMessage ( stdout, "\nThe product '%s' has been chosen as the\n"
                        "default display type.\n", pProduct ) ;  
      strcpy ( default_display_type, pProduct ) ;
   }
   else
   {
      /* This should never happen. */
      flogMessage ( stderr, "\nCould not set the default display type.\n" );
   }

   return ;
}

/*******************************************************************************
* MODULE NUMBER: 2
* MODULE NAME:   read_rwprefs.c
* PURPOSE:       Retrieve the number of hours to use for the choose hour window 
*                and the default MPE field to display from the IHFS database
*                RWPrefs table. This is done on a user by user basis.
*
*                If there is not a row in the RWPrefs table for the user,
*                then use the default values given by RWPREFS_DEFAULT_NUM_HOURS
*                and RWPREFS_DEFAULT_DISPLAY_TYPE manifest constants defined 
*                in the read_rwprefs.h header file.
*
* ARGUMENTS:
*  None 
*
* RETURNS:
*  None 
*
* APIs UTILIZED:
*   NAME                     HEADER FILE             DESCRIPTION
*   chgupper                 strutil.h               Changes all characters in
*                                                    a string to upper case.
*   FreeRWPrefs              RWPrefs.h               Deallocates the memory 
*                                                    used by the Linked List 
*                                                    of RWPrefs structures.
*   get_mpe_field_names      mpe_field_names.h       Returns an array of
*                                                    all products created
*                                                    by MPE.
*   get_mpe_product_state    get_mpe_product_state.h Indicates if a given
*                                                    MPE product is on or off.
*   get_qpe_fields_array     get_mpe_product_state.h Returns an array of
*                                                    qpe fields recognized
*                                                    by get_mpe_product_state.
*   GetRWPrefs               RWPrefs.h               Retrieves rows from the 
*                                                    RWPrefs table based on 
*                                                    the user supplied where 
*                                                    clause.
*   IsNull                   DbmsUtils.h             Determines if a field 
*                                                    returned from the RWPrefs 
*                                                    table is null.
*
* LOCAL DATA ELEMENTS:
*   DATA TYPE  NAME                DESCRIPTION
*   char [ ]   LOGNAME             Contains the user's Linux account id.
*   char **    mpe_field_names     An array containing the name of all of
*                                  the products generated by MPE.
*   char *     pProduct            Points to the MPE Product whose state 
*                                  is currently being tested.
*   char **    pQpeFields          Points to the array of QPE fields
*                                  recognized by the get_mpe_product_state
*                                  routine.
*   char [ ]   userid              Contains the user's id, limited to the
*                                  number of columns of the userid field in
*                                  the RWPrefs table.
*   char [ ]   where_clause        Contains the where clause to retrieve a row
*                                  from the RWPrefs table for a specific user.
*   int        i                   A loop index.
*   int        isnull              Contains the result of the IsNull call.
*                                  Either ISNULL or NOTNULL.
*   int        mpe_product_state   Indicates if the default field type is
*                                  being generated by MPE FieldGen.  
*   int        product_name_length The length of the default displat type. 
*   RWPrefs *  pRWPrefsHead        A pointer to the head of the linked list of
*                                  RWPrefs structures contain information
*                                  selected from the RWPrefs table.
*   int        status              Contains return codes from functions.
*
* DATA FILES AND/OR DATABASE:
*
* Uses the RWPrefs table in the IHFS database.
*
* ERROR HANDLING:
* None
*
* CONSTANTS
*   NAME                         HEADER          DESCRIPTION
*   MOSAIC_TYPE_LEN              DbmsDefs.h      The length of an MPE product
*                                                name.
*   NOTNULL                      DbmsUtils.h     Return value from IsNull 
*                                                indicating non null value.
*   RWPREFS_DEFAULT_DISPLAY_TYPE read_rwprefs.h  The default display type.
*   RWPREFS_DEFAULT_NUM_HOURS    read_rwprefs.h  The default number of hours.
*   USERID_LEN                   DbmsDefs.h      The maximum length of a
*                                                user id in the IHFS database.
*
********************************************************************************
*/

void read_rwprefs ( )
{
   extern char LOGNAME [ ] ;
   const char ** mpe_field_names = NULL ;
   char userid [ USERID_LEN + 1 ] ;
   char where_clause [ 17 + USERID_LEN + 1 ] ; 
                         /* "WHERE userid = ''" + USERID_LEN + 1 */
   int i;
   int isnull ;
   int mpe_product_state ;
   int product_name_length ;
   int status ;
   const int verbose = 1 ;
   RWPrefs * pRWPrefsHead = NULL ;

   /*--------------------------------------*/
   /*   Read from RWPrefs table            */
   /*   This was modified on 3/19/2004     */
   /*   to use dbgen routines.             */
   /*--------------------------------------*/

   /* Copy LOGNAME to userid.  Limit the number of characters
      to match the max number of columns in the userid column
      of the RWPrefs table. */
   memset ( userid , '\0' , USERID_LEN + 1 ) ;
   strncpy ( userid , LOGNAME , USERID_LEN ) ;
   memset ( where_clause , '\0' , 23 + USERID_LEN + 1 ) ;
   sprintf ( where_clause , "WHERE userid = '%s'" ,  
             userid ) ;
   
   /* Set default values for the duration hours and the default display
      field. */
   NUMHRS = RWPREFS_DEFAULT_NUM_HOURS ;
   memset ( default_display_type , '\0' , MOSAIC_TYPE_LEN + 1 ) ;
   strcpy ( default_display_type , RWPREFS_DEFAULT_DISPLAY_TYPE ) ; 

   /* Retrieve the information from the RWPrefs table. */
   pRWPrefsHead = GetRWPrefs ( where_clause ) ;

   if ( pRWPrefsHead != NULL )
   {
      /* Retrieve the user-specified duration hours. */
      isnull = IsNull ( INT , & pRWPrefsHead->num_hours_wind ) ;
  
      if ( isnull == NOTNULL )
      {
         NUMHRS = pRWPrefsHead->num_hours_wind ; 
      }
      
      /* Retrieve the user-specified default display field. */
      isnull = IsNull ( CHAR , pRWPrefsHead->def_display_type ) ;

      if ( isnull == NOTNULL )
      {
         /* Test the RWPrefs specified default field type to see if it
            is being created by MPEfieldgen. */ 
         strcpy ( default_display_type , pRWPrefsHead->def_display_type ) ; 
        
         /* Make it upper case. */
         chgupper ( default_display_type ) ;
      }

      /* Free the memory that is used by the linked list of RWPrefs
         structures. */
      FreeRWPrefs ( pRWPrefsHead ) ;
      pRWPrefsHead = NULL ;
   }

   /* Check to determine if the default field type is being created
      by MPE FieldGen. */
   product_name_length = strlen ( default_display_type ) ;
   get_mpe_product_state ( default_display_type, & product_name_length,
                           & verbose , & mpe_product_state, & status ) ;

   if ( status == 0 )
   {
      /* The product was recognized as a QPE field. */
      if ( mpe_product_state != 1 )
      {
         flogMessage ( stderr, "In routine 'read_rwprefs':\n"
                           "MPE FieldGen is not generating the default\n"
                           "field type '%s'. The mpe_generate_list\n"
                           "token needs to be modified. Attempting to\n"
                           "set the default display type...\n",
                           default_display_type ) ;
         select_default_display ( ) ;
      }
   }
   else if ( status == -1 ) 
   {
      /* get_mpe_product_state encountered an error. */
      flogMessage ( stderr, "\nIn routine 'read_rwprefs':\n"
                        "The call to get_mpe_product_state failed.\n"
                        "Could not determine if %s is being generated by\n"
                        "MPE FieldGen.\n", default_display_type ) ;
   }
   else
   {
      /* get_mpe_product_state did not recognize the default display type. 
         It could be the Best Estimate QPE, a reference field, or a typo. */
      mpe_field_names = get_mpe_field_names ( ) ;

      status = 1 ;

      for ( i = 0 ; i < NUM_COLORUSE_ITEMS ; ++ i )
      {
         status = strcmp ( default_display_type , mpe_field_names [ i ] ) ;

         if ( status == 0 ) break ;
      }

      if ( status != 0 )
      {
         flogMessage ( stdout, "\nIn routine 'read_rwprefs':\n"
                           "Routine get_mpe_product_state did not recognize\n"
                           "%s.  Attempting to set the "
                           "default display type...\n", 
                           default_display_type ) ; 
         select_default_display ( ) ;
      }
   }

   return ;

/*  ==============  Statements containing RCS keywords:  */
{static char rcs_id1[] = "$Source$";
 static char rcs_id2[] = "$Id$";}
/*  ===================================================  */

}
